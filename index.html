<!DOCTYPE html>
<html lang="vi">
<head>
  <title>Hẹn Giờ Chuông Báo - Điều khiển Internet</title>
  <meta name="viewport" content="width=device-width,user-scalable=0" charset="utf-8">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js" type="text/javascript"></script>
  
  <style type="text/css">
    /* --- CÀI ĐẶT CHUNG & SỬA LỖI TRÀN KHUNG --- */
    * {
        box-sizing: border-box;
    }
    body {
        background: linear-gradient(135deg, #3a4750 0%, #4a627a 100%);
        font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        color: #f5f6fa;
        min-height: 100vh;
        margin: 0;
        /* [MỚI] Thêm padding-bottom để không bị thanh hành động che mất nội dung */
        padding-bottom: 80px; 
        font-size: 15px;
    }
    /* File: index 4.html (bên trong thẻ <style>) */

/* === [BƯỚC 2] CSS CHO GIAO DIỆN GÓI/MỞ CỦA TAB HẸN GIỜ === */
.scenario-setup-details {
    border: none;
    background: transparent;
    box-shadow: none;
    margin: 0 15px 15px 15px; /* Căn lề cho đồng bộ */
}
.scenario-setup-details > summary {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 12px 15px;
    font-size: 1.1em;
    font-weight: 700;
    letter-spacing: 1px;
    border-radius: 10px;
    background: linear-gradient(90deg, #2c3e50, #34495e);
    color: #3498db;
    border: 2px solid #3498db;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.2);
    transition: all 0.2s ease-in-out;
}
.scenario-setup-details > summary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
}
.scenario-setup-details[open] > summary {
    background: #3498db;
    color: #fff;
}
.scenario-setup-details > summary svg {
    width: 20px;
    height: 20px;
    margin-right: 10px;
}
.scenario-setup-details .details-content {
    border: 1px solid #414345;
    border-top: none;
    border-radius: 0 0 10px 10px;
    margin-top: -5px;
    padding: 10px;
    background: #232526;
}
/* ======================================================= */
    #main {
        margin: 24px auto;
        width: 380px;
        max-width: 98vw;
    }

    /* --- KHUNG NỘI DUNG CHÍNH --- */
    #content {
        background: #2c3e50;
        border: none;
        width: 100%;
        /*float: left;*/
        border-radius: 18px;
        padding-bottom: 24px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
    }
    /* File: index 1.html (bên trong thẻ <style>) */

/* === [PHƯƠNG ÁN MỚI] CSS CHO HIỂN THỊ NGÀY ĐÃ LƯU === */
.saved-days-container {
    text-align: center;
    margin-top: 12px;
    padding: 5px;
}
.day-badge {
    display: inline-block;
    padding: 6px 12px;
    background-color: #f1c40f; /* Màu vàng đặc trưng */
    color: #232526; /* Màu chữ tối cho dễ đọc */
    font-weight: 700;
    border-radius: 8px;
    margin: 3px;
    font-size: 0.95em;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.day-badge-label {
    color: #bdc3c7;
    font-weight: bold;
    margin-right: 8px;
}
/* =================================================== */

    /* === [MỚI] THANH HÀNH ĐỘNG CỐ ĐỊNH (STICKY ACTION BAR) === */
    .sticky-action-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(35, 37, 38, 0.85);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 10px;
        display: flex;
        justify-content: center;
        gap: 15px;
        z-index: 100;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        border-top: 1px solid #414345;
    }
    .sticky-action-bar .modern-btn {
    flex: 1;
    max-width: 350px; /* Tăng chiều rộng tối đa */
    margin: 0;
}
    /* Làm cho nút Lưu nổi bật hơn */
    .sticky-action-bar .save-button {
        transform: scale(1.05);
        box-shadow: 0 8px 24px #00e6ff55;
    }

    /* === [MỚI] HỆ THỐNG TAB CHÍNH === */
    .main-tabs {
        display: flex;
        background-color: #232526;
        border-radius: 16px 16px 0 0;
        padding: 5px;
        margin-bottom: 15px;
        border-bottom: 2px solid #414345;
    }
    .main-tab-button {
        flex: 1;
        padding: 10px 5px;
        cursor: pointer;
        background: transparent;
        border: none;
        color: #bdc3c7;
        font-weight: 700;
        font-size: 0.8em;
        transition: all 0.2s ease-out;
        border-radius: 12px;
        text-transform: uppercase;
    }
    .main-tab-button:hover {
        background-color: #414345;
        color: #fff;
    }
    .main-tab-button.active {
        background: #f1c40f;
        color: #232526;
        box-shadow: 0 2px 10px #f1c40f55;
    }
    .main-tab-content {
        display: none; /* Mặc định ẩn tất cả nội dung tab */
    }
    .main-tab-content.active {
        display: block; /* Chỉ hiện nội dung của tab đang active */
    }
    
    /* === KHU VỰC THÔNG BÁO PHẢN HỒI === */
    #notification-area {
        position: fixed;
        top: 15px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1010;
        width: 90%;
        max-width: 360px;
    }
    .notification {
        padding: 10px 15px;
        border-radius: 8px;
        color: #fff;
        font-weight: bold;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        opacity: 0;
        transform: translateY(-20px);
        transition: opacity 0.3s, transform 0.3s;
        margin-bottom: 10px;
        font-size: 0.9em;
    }
    .notification.show {
        opacity: 1;
        transform: translateY(0);
    }
    .notification.success {
        background: linear-gradient(90deg, #27ae60, #2ecc71);
    }
    .notification.error {
        background: linear-gradient(90deg, #c0392b, #e74c3c);
    }
    .notification.info {
        background: linear-gradient(90deg, #2980b9, #3498db);
    }

    /* --- TIÊU ĐỀ & MÀU SẮC NỔI BẬT --- */
    h2 {
        font-size: 1.6em;
        margin-top: 20px;
        margin-bottom: 10px;
        text-align: center;
        color: #f39c12;
        text-shadow: 0 4px 12px rgba(243, 156, 18, 0.18), 0 2px 4px rgba(0,0,0,0.08);
        letter-spacing: 1px;
        font-weight: 800;
    }
    h3 {
        margin-top: 28px;
        margin-bottom: 18px; 
        text-align: center;
        font-size: 1.15em;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        padding: 12px 18px;
        background: linear-gradient(90deg, #232526 60%, #414345 100%);
        border-radius: 12px;
        margin-left: 15px;
        margin-right: 15px;
        border-left: 5px solid;
        border-right: 5px solid;
        position: relative;
        z-index: 2;
        box-shadow: 0 4px 24px 0 #00000044, 0 2px 8px rgba(0,0,0,0.08);
    }
    #header-sang { 
        color: #2ecc71 !important;
        text-shadow: 0 0 12px #2ecc71, 0 2px 8px #000;
        border-color: #2ecc71;
        box-shadow: 0 4px 24px 0 #00000044, 0 2px 8px rgba(0,0,0,0.08),
                    inset 5px 0 10px -5px #2ecc71,
                    inset -5px 0 10px -5px #2ecc71;
    }
    #header-chieu { 
        color: #3498db !important;
        text-shadow: 0 0 12px #3498db, 0 2px 8px #000;
        border-color: #3498db;
        box-shadow: 0 4px 24px 0 #00000044, 0 2px 8px rgba(0,0,0,0.08),
                    inset 5px 0 10px -5px #3498db,
                    inset -5px 0 10px -5px #3498db;
    }
    hr { border: none; height: 1px; background: linear-gradient(90deg, #f1c40f 0%, #e0eafc 100%); margin: 28px 15px; border-radius: 2px; opacity: 0.5; }

    /* --- [MỚI] THANH TRẠNG THÁI & ĐỒNG HỒ --- */
    #school-name-status {
        transition: color 0.5s ease; /* Hiệu ứng chuyển màu mượt mà */
    }
    .status-color-connected { 
        color: #43e97b !important; /* Xanh lá cây */
    }
    .status-color-disconnected { 
        color: #ff5858 !important; /* Đỏ */
    }
    .status-color-connecting { 
        color: #00e6ff !important; /* Xanh dương (màu gốc) */
    }

    .clock-container { 
        text-align: center; 
        margin: 15px auto; 
        background: linear-gradient(120deg, #232526 60%, #414345 100%); 
        border: 2px solid #f1c40f; 
        border-radius: 14px; 
        padding: 8px 10px;
        box-shadow: 0 2px 12px rgba(241, 196, 15, 0.10), 0 2px 5px rgba(0,0,0,0.08);
        width: 90%;
        cursor: pointer; /* << THÊM DÒNG NÀY */
    }
    .clock {
        font-size: 2.5em;
        color: #f1c40f;
        text-shadow: 0 0 10px #f1c40f88;
        letter-spacing: 2px;
        font-family: 'Courier New', Courier, monospace;
    }
    .date-display { font-size: 0.9em; color: #ecf0f1; margin-top: 5px; font-weight: 500; }

    /* --- KHU VỰC NÚT ĐIỀU KHIỂN --- */
    /* [SỬA ĐỔI] Giữ lại .button-section cho các nút trong tab Hệ thống */
    .button-section {
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 0 15px;
        margin-top: 24px;
    }
    .modern-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 45px;
        padding: 0 15px;
        border: none;
        border-radius: 10px;
        font-size: 0.9em;
        font-weight: 700;
        letter-spacing: 1px;
        transition: all 0.2s ease-out;
        cursor: pointer;
        outline: none;
        position: relative;
        overflow: hidden;
        z-index: 1;
        text-transform: uppercase;
        width: 100%;
        text-decoration: none;
    }
    .modern-btn:hover {
        transform: translateY(-2px);
        filter: brightness(1.1);
    }
    .modern-btn svg {
        width: 1.1em;
        height: 1.1em;
        margin-right: 10px;
    }
    .modern-btn:active {
        transform: scale(0.97);
        filter: brightness(0.97);
        box-shadow: 0 2px 8px 0 #0004;
    }
    .save-button {
        background: linear-gradient(90deg, #232526 60%, #414345 100%);
        color: #00e6ff;
        border-left: 4px solid #00e6ff;
        border-right: 4px solid #00e6ff;
        text-shadow: 0 0 12px #00e6ff, 0 2px 8px #000;
        box-shadow: 0 4px 18px 0 #00000044;
    }
    .save-button:hover {
        box-shadow: 0 8px 24px #00e6ff55;
    }
    .test-button {
        background: linear-gradient(90deg, #232526 60%, #414345 100%);
        color: #f1c40f;
        border-left: 4px solid #f1c40f;
        border-right: 4px solid #f1c40f;
        text-shadow: 0 0 12px #f1c40f, 0 2px 8px #000;
        box-shadow: 0 4px 18px 0 #00000044;
    }
    .test-button:hover {
        box-shadow: 0 8px 24px #f1c40f55;
    }
    .interface-button {
        background: linear-gradient(90deg, #232526 60%, #414345 100%);
        color: #ab47bc;
        border-left: 4px solid #ab47bc;
        border-right: 4px solid #ab47bc;
        text-shadow: 0 0 12px #ab47bc, 0 2px 8px #000;
        box-shadow: 0 4px 18px 0 #00000044;
    }
    .interface-button:hover {
        box-shadow: 0 8px 24px #ab47bc55;
    }
    .advanced-button {
        background: linear-gradient(90deg, #485563 0%, #29323c 100%);
        color: #bdc3c7;
        border-left: 4px solid #bdc3c7;
        border-right: 4px solid #bdc3c7;
        text-shadow: 0 0 12px #bdc3c7, 0 2px 8px #000;
        box-shadow: 0 4px 18px 0 #00000044;
    }
    .advanced-button:hover {
        box-shadow: 0 8px 24px #bdc3c755;
    }
    .logout-button {
        background: linear-gradient(90deg, #232526 60%, #414345 100%);
        color: #e74c3c;
        border-left: 4px solid #e74c3c;
        border-right: 4px solid #e74c3c;
        text-shadow: 0 0 12px #e74c3c, 0 2px 8px #000;
        box-shadow: 0 4px 18px 0 #00000044;
    }
    .logout-button:hover {
        box-shadow: 0 8px 24px #e74c3c55;
    }
    
.tab { display: flex; justify-content: space-around; border-bottom: 2px solid #414345; margin: 0 15px 0 15px; position: relative; z-index: 1; }
    .tab button {
        flex-grow: 1; border: none; outline: none; cursor: pointer; padding: 10px 5px 8px 5px;
        transition: all 0.2s ease-out;
        font-size: 0.9em; font-weight: 700; border-radius: 8px 8px 0 0; margin: 0 2px;
        position: relative; top: 2px; border-bottom: 3px solid transparent;
        background: transparent; color: #bdc3c7;
    }
    .tab button:hover {
        background: #414345; color: #fff;
        transform: translateY(-2px);
    }
    .tablinks-sang.active { 
        background: linear-gradient(90deg, #2ecc71 60%, #27ae60 100%);
        color: #fff; 
        border-bottom-color: #2ecc71;
        z-index: 2;
    }
     .tablinks-chieu.active { 
        background: linear-gradient(90deg, #3498db 60%, #2980b9 100%);
        color: #fff; 
        border-bottom-color: #3498db;
        z-index: 2;
    }
    .tabcontent { 
        display: none; 
        padding: 10px; 
        background: #232526;
        border-radius: 0 0 12px 12px;
        margin: 0 15px 8px 15px;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height 0.5s ease-in-out, opacity 0.4s ease-in-out, padding 0.5s ease-in-out;
    }
    .tabcontent.active {
        display: block;
        max-height: 1000px;
        opacity: 1;
        padding: 15px 10px 10px 10px;
    }
    .tabcontent h3 {
        font-size: 1em; 
        margin: 0; 
        margin-bottom: 10px;
        padding: 10px 15px;
        color: #f1c40f; 
        font-weight: 700;
        cursor: pointer;
        position: relative;
        border-bottom: 1px solid #414345;
        background: rgba(44, 62, 80, 0.5);
        border-radius: 8px;
        text-align: center;
    }
    .tabcontent h3::after {
        content: '▼';
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%) scale(0.9);
        font-size: 0.8em;
        transition: transform 0.3s ease-in-out;
    }
    .tabcontent h3.expanded::after {
        transform: translateY(-50%) scale(0.9) rotate(180deg);
    }
    .session-subtitle {
        font-size: 0.8em;
        font-weight: normal;
        text-transform: none;
        color: #bdc3c7;
    }
    .collapsible-settings {
        overflow: hidden;
        max-height: 0;
        opacity: 0;
        transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out, margin-top 0.4s ease-in-out;
        margin-top: 0;
    }
    .collapsible-settings.expanded {
        max-height: 500px;
        opacity: 1;
        margin-top: 10px;
    }
/* === [THÊM MỚI] CSS CHO BẢNG KỊCH BẢN HẸN GIỜ === */
    .scenario-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    .scenario-table th, .scenario-table td {
        border: 1px solid #414345;
        padding: 9px 5px;
        text-align: center; /* Căn giữa nội dung trong ô */
        font-size: 0.9em;
    }
    .scenario-table th {
        background-color: #3498db;
        color: #fff;
        font-weight: bold;
    }
    .scenario-table tbody tr:nth-child(odd) {
        background-color: #2c3e50;
    }
    .scenario-table tbody tr:nth-child(even) {
        background-color: #34495e;
    }
    /* Phân chia độ rộng các cột cho đều */
    .scenario-table th:nth-child(1), .scenario-table td:nth-child(1) { width: 15%; } /* Cột STT */
    .scenario-table th:nth-child(2), .scenario-table td:nth-child(2) { width: 42.5%; } /* Cột Thời gian */
    .scenario-table th:nth-child(3), .scenario-table td:nth-child(3) { width: 42.5%; } /* Cột Số hồi */
    
    /* [THÊM MỚI] CSS cho Bảng Kịch Bản Đã Lưu (Yêu cầu nền đen chữ vàng) */
    #saved-scenario-table-wrapper .scenario-table {
        background: #232526; /* Nền đen */
        border-radius: 8px; /* Bo góc cho đồng bộ */
        overflow: hidden; /* Ẩn tràn viền khi bo góc */
    }
    #saved-scenario-table-wrapper .scenario-table th {
        background: #f1c40f; /* Nền vàng (như bảng chi tiết) */
        color: #232526; /* Chữ đen (như bảng chi tiết) */
    }
    #saved-scenario-table-wrapper .scenario-table tbody tr:nth-child(odd) {
        background: #232526; /* Nền đen */
        color: #ecf0f1;
    }
    #saved-scenario-table-wrapper .scenario-table tbody tr:nth-child(even) {
        background: #414345; /* Nền xám tối (như bảng chi tiết) */
        color: #ecf0f1;
    }
    /* [THÊM MỚI] CSS cho Nút Xóa Kịch Bản */
    .delete-scenario-button-container {
        padding: 15px 0 5px 0; /* Căn lề cho nút xóa */
    }
            
    /* === CÀI ĐẶT NÚT GẠT (TOGGLE SWITCH) DẠNG BOX === */
    .toggle-actions-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 0 5px 10px 5px;
    }
    .toggle-action-item {
        display: flex;
        align-items: center;
        background-color: #2c3e50;
        border-radius: 8px;
        padding: 8px 12px;
        border-left: 4px solid #4a4e54;
        transition: all 0.3s ease;
    }
    .toggle-action-icon {
        flex-shrink: 0;
        margin-right: 12px;
        color: #bdc3c7;
    }
    .toggle-action-icon svg {
        width: 24px;
        height: 24px;
        display: block;
    }
    .toggle-action-text {
        flex-grow: 1;
        font-weight: bold;
        font-size: 0.9em;
    }
    .toggle-action-item .switch {
        margin-left: auto;
    }
    .toggle-action-item.disabled {
        opacity: 0.5;
        pointer-events: none;
        background-color: #232526;
    }
    .toggle-action-item.active {
        border-left-color: #2ecc71;
    }
    .toggle-action-item.active.chieu-style {
        border-left-color: #3498db;
    }
    .toggle-action-item.active .toggle-action-icon {
        color: #f1c40f;
    }
    .switch {
        position: relative;
        display: inline-block;
        width: 46px; height: 24px;
        flex-shrink: 0;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
        position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
        background-color: #4a4e54;
        transition: .3s;
        border-radius: 24px;
    }
    .slider:before {
        position: absolute; content: "";
        height: 18px; width: 18px;
        left: 3px; bottom: 3px;
        background-color: #bdc3c7;
        transition: .3s cubic-bezier(.4,0,.2,1);
        border-radius: 50%;
    }
    input:checked + .slider { background: linear-gradient(90deg, #27ae60, #2ecc71); }
    .chieu-toggle input:checked + .slider { background: linear-gradient(90deg, #2980b9, #3498db); }
    input:checked + .slider:before { transform: translateX(22px); background-color: white; }

    /* --- KHU VỰC CÀI ĐẶT (DETAILS) --- */
    details {
        border: 1px solid #414345; border-radius: 10px; margin-bottom: 12px;
        background: #232526; box-shadow: 0 2px 8px rgba(0,0,0, 0.1);
        overflow: hidden; transition: box-shadow 0.2s;
    }
    summary {
        font-weight: bold; padding: 12px 15px; cursor: pointer; outline: none;
        transition: background 0.2s, color 0.2s; list-style: none;
        font-size: 0.9em;
    }
    summary::-webkit-details-marker, summary::marker { display: none; }
    
    .sohoi-container {
        padding: 0 15px;
    }
    summary#header-sohoi {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        height: 50px;
        border-radius: 10px;
        background: linear-gradient(90deg, #232526 60%, #414345 100%);
        color: #f1c40f;
        border-left: 4px solid #f1c40f;
        border-right: 4px solid #f1c40f;
        text-shadow: 0 0 12px #f1c40f, 0 2px 8px #000, 0 0 24px #fff;
        box-shadow: 0 4px 18px 0 #f1c40f33, 0 2px 8px #fff2;
    }
    summary#header-sohoi div:first-child {
        font-size: 1em;
        font-weight: 700;
        letter-spacing: 1.5px;
    }
    .details-content { padding: 12px 15px 16px 15px; border-top: 1px solid #414345; }
    
    .tabcontent details summary {
        text-align: center;
        font-size: 1em;
        border-radius: 8px 8px 0 0;
        background: #2c3e50;
        color: #f1c40f;
    }
    details[open] > .tabcontent details summary { 
        background: #f1c40f;
        color: #232526; 
    }
    
    /* --- BẢNG LỊCH CHI TIẾT --- */
    .details-container {max-height: 250px;overflow-y: auto;}
    .details-container::-webkit-scrollbar {width: 8px;}
    .details-container::-webkit-scrollbar-track {background: #2c3e50;border-radius: 4px;}
    .details-container::-webkit-scrollbar-thumb {background-color: #f1c40f;border-radius: 4px;border: 2px solid #2c3e50;}
    .details-container table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #232526; border-radius: 8px; overflow: hidden; }
    .details-container th, .details-container td { border: 1px solid #414345; padding: 8px 5px; text-align: center; font-size: 0.9em; }
    .details-container th { background: #f1c40f; color: #232526; font-weight: bold; }
    .details-container tbody tr { transition: background-color 0.2s; }
    .details-container tbody tr:hover { background-color: #f1c40f22; }
    .details-container tbody tr:nth-child(odd) { background: #232526; color: #ecf0f1; }
    .details-container tbody tr:nth-child(even) { background: #414345; color: #ecf0f1; }
    .divider-yellow {width: 90%; height: 2px; background: linear-gradient(90deg, #f1c40f 0%, #fff200 100%);border-radius: 2px; margin: 24px auto 18px auto; box-shadow: 0 2px 8px #f1c40f55;}

    /* --- GIAO DIỆN LƯỚI "THÔNG MINH" CHO CÀI ĐẶT --- */
/* --- GIAO DIỆN LƯỚI "THÔNG MINH" CHO CÀI ĐẶT --- */
.settings-grid-container {
    /* [SỬA ĐỔI] Giới hạn chiều cao và thêm thanh cuộn tự động */
    max-height: 380px; 
    overflow-y: auto;
    padding-right: 5px; /* Thêm khoảng đệm nhỏ để thanh cuộn không quá sát */
    padding-bottom: 30px; /* THÊM DÒNG NÀY: Tạo khoảng đệm ở cuối vùng cuộn */
    
    /* Giữ nguyên các thuộc tính cũ */
    opacity: 1;
    transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out;
}
/* [THÊM MỚI] Tùy chỉnh giao diện thanh cuộn cho đồng bộ */
.settings-grid-container::-webkit-scrollbar {
    width: 8px;
}
.settings-grid-container::-webkit-scrollbar-track {
    background: #2c3e50;
    border-radius: 4px;
}
.settings-grid-container::-webkit-scrollbar-thumb {
    background-color: #f1c40f;
    border-radius: 4px;
    border: 2px solid #2c3e50;
}
    .settings-grid-container.hidden {
        max-height: 0;
        opacity: 0;
    }
    .settings-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        padding: 8px 0;
    }
    .setting-item {
        background: #232526;
        border: 1px solid #414345;
        border-radius: 8px;
        padding: 8px;
        display: flex;
        align-items: center;
        transition: all 0.2s ease-in-out;
    }
    .setting-item:hover {
        border-color: #f1c40f;
        transform: translateY(-1px);
    }
    .setting-item.full-width {
        grid-column: 1 / -1;
    }
    .setting-item-icon {
        flex-shrink: 0;
        margin-right: 10px;
        color: #f1c40f;
    }
    .setting-item-icon svg {
        width: 22px;
        height: 22px;
    }
    .input-wrapper {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    .input-wrapper label {
        font-size: 0.8em;
        font-weight: 600;
        color: #bdc3c7;
        margin-bottom: 4px;
    }
    .unit-input {
        display: flex;
        align-items: center;
    }
    .unit-input input {
        width: 100%;
        margin-right: 8px;
    }
    .unit-input span {
        font-size: 0.9em;
        color: #bdc3c7;
    }
    .setting-item input[type="time"] {
        width: 100%;
        padding: 8px;
        font-size: 0.9em;
    }
    /* [MỚI] CSS cho Hướng dẫn nhỏ */
    .input-helper-text {
        font-size: 0.75em;
        color: #7f8c8d;
        font-style: italic;
        margin-top: 4px;
        text-align: right;
    }
    .copy-button-container {
        padding: 5px 5px 15px 5px;
    }
    .copy-button {
        padding: 8px 12px;
        font-size: 0.8em;
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.18s;
        font-weight: 700;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        text-shadow: 0 1px 2px #00000044;
        width: 100%;
    }
    .copy-button:active {
        transform: scale(0.96);
        filter: brightness(0.95);
    }
    .copy-button.sang {
        background: linear-gradient(90deg, #16a085 0%, #43e97b 100%);
    }
    .copy-button.chieu {
        background: linear-gradient(90deg, #2980b9 0%, #6dd5fa 100%);
    }

    /* === Giao diện cho Modal Chung === */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
    }
    .modal-overlay.visible {
        opacity: 1;
        visibility: visible;
    }
    .modal-content {
        background: #2c3e50;
        padding: 20px;
        border-radius: 15px;
        border-top: 5px solid #f1c40f;
        width: 95%;
        max-width: 400px;
        box-shadow: 0 5px 25px rgba(0,0,0,0.4);
        transform: scale(0.9);
        transition: transform 0.3s;
    }
    .modal-overlay.visible .modal-content {
        transform: scale(1);
    }
    .modal-content h4 {
        margin-top: 0;
        margin-bottom: 20px;
        color: #f1c40f;
        text-align: center;
        font-size: 1.2em;
        text-transform: uppercase;
    }
    .modal-buttons {
        display: flex;
        gap: 15px;
        margin-top: 20px;
    }
    .modal-buttons button {
        flex-grow: 1;
        padding: 10px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.2s;
    }
    .modal-confirm-btn {
        background: #f1c40f;
        color: #232526;
    }
    /* [MỚI] CSS cho các nút ưu tiên trong modal cảnh báo */
    .modal-confirm-btn.priority-scenario {
        background: #27ae60;
        color: #fff;
    }
    .modal-confirm-btn.priority-schedule {
        background: #2980b9;
        color: #fff;
    }
    .modal-cancel-btn {
        background: #7f8c8d;
        color: #fff;
    }
    
    .modal-input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 2px solid #7f8c8d;
        background-color: #2c3e50;
        color: #ecf0f1;
        font-size: 1em;
        margin-bottom: 15px;
    }
    .modal-input:focus {
        outline: none;
        border-color: #f1c40f;
    }
    /* [MỚI] CSS cho phần mô tả trong modal */
    #conflict-modal-description {
        text-align: center; 
        margin-top: -10px; 
        margin-bottom: 20px; 
        color: #bdc3c7; 
        font-size: 0.9em; 
        line-height: 1.5;
    }
    #conflict-modal-description strong {
        color: #e74c3c;
    }

    /* === Giao diện cho Modal Cài đặt Nâng cao === */
    #advanced-settings-modal .modal-content {
        background: #232526;
        border-top-color: #f39c12;
        color: #f5f6fa;
    }
    #advanced-settings-modal h4 {
        color: #f39c12;
        text-shadow: 0 0 10px #f39c12;
    }
    .adv-modal-tabs {
        display: flex;
        border-bottom: 2px solid #414345;
        margin-bottom: 15px;
    }
    .adv-modal-tab {
        flex-grow: 1;
        padding: 10px 2px;
        text-align: center;
        cursor: pointer;
        font-weight: bold;
        color: #7f8c8d;
        border-bottom: 3px solid transparent;
        transition: all 0.2s;
        font-size: 0.75em;
    }
    .adv-modal-tab.active {
        color: #f39c12;
        border-bottom-color: #f39c12;
    }
    .adv-modal-tab-content {
        display: none;
    }
    .adv-modal-tab-content.active {
        display: block;
    }
    .adv-modal-tab-content h5 {
        text-align: center;
        color: #f39c12;
        text-transform: uppercase;
        margin: 10px 0 15px 0;
        letter-spacing: 1px;
        font-size: 0.9em;
    }
    
    /* === Giao diện cho Tab Hệ thống & Reset WiFi === */
    .actions-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .action-item {
        display: flex;
        align-items: center;
        background: #2c3e50;
        border-radius: 8px;
        padding: 12px;
        border-left: 4px solid #f39c12;
        transition: background-color 0.2s;
    }
    .action-item:hover {
        background-color: #34495e;
    }
    .action-icon {
        flex-shrink: 0;
        margin-right: 15px;
        color: #f39c12;
    }
    .action-icon svg {
        width: 28px;
        height: 28px;
    }
    .action-text {
        flex-grow: 1;
    }
    .action-text .title {
        font-weight: bold;
        font-size: 1em;
        color: #f5f6fa;
    }
    .action-text .description {
        font-size: 0.8em;
        color: #bdc3c7;
    }
    .action-text .description.connected { color: #2ecc71; }
    .action-text .description.disconnected { color: #e74c3c; }

    .action-btn {
        padding: 7px 15px;
        font-size: 0.8em;
        font-weight: bold;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        background-color: #f39c12;
        color: #232526;
    }
    .action-btn:disabled {
        background-color: #7f8c8d;
        cursor: not-allowed;
    }
    .action-btn.reset {
        background-color: #c0392b;
        color: #fff;
    }
    
    /* === Giao diện cho Quản lý Vệ tinh === */
    .device-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 280px;
        overflow-y: auto;
        padding: 5px;
        background: #2c3e50;
        border-radius: 8px;
    }
    .device-item {
        display: flex;
        flex-direction: column;
        padding: 10px;
        background: #34495e;
        border-radius: 8px;
        border-left: 4px solid #f1c40f;
        gap: 8px;
    }
    .device-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .device-name {
        font-weight: bold;
        font-size: 1em;
        color: #ecf0f1;
    }
    .device-status {
        font-size: 0.85em;
        font-weight: bold;
    }
    .device-status.connected { color: #2ecc71; }
    .device-status.disconnected { color: #e74c3c; }
    
    .device-info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
        font-size: 0.8em;
        color: #bdc3c7;
    }
    .device-info-grid span {
        background-color: #2c3e50;
        padding: 4px 6px;
        border-radius: 4px;
    }
    .device-info-grid .label {
        font-weight: bold;
        color: #ecf0f1;
    }
    
    .device-actions {
        display: flex;
        gap: 8px;
    }
    .device-action-btn {
        padding: 5px 10px;
        border: none;
        border-radius: 5px;
        color: #fff;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
        font-size: 0.75em;
        flex-grow: 1;
    }
    .device-action-btn:hover {
        filter: brightness(1.1);
        transform: scale(1.05);
    }
    .add-btn { background-color: #27ae60; }
    .remove-btn { background-color: #c0392b; }
    .cancel-btn { background-color: #7f8c8d; }

    .list-placeholder {
        text-align: center;
        padding: 20px;
        color: #7f8c8d;
        font-size: 0.9em;
    }

    /* === Giao diện cho Tab OTA === */
    .ota-device-selection {
        background-color: #2c3e50;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 15px;
    }
    .ota-device-selection label {
        display: flex;
        align-items: center;
        padding: 8px;
        cursor: pointer;
        border-radius: 6px;
        transition: background-color 0.2s;
    }
    .ota-device-selection label:hover {
        background-color: #34495e;
    }
    .ota-device-selection input[type="checkbox"] {
        margin-right: 10px;
        width: 18px;
        height: 18px;
    }
    #ota-progress-container {
        display: none;
        width: 100%;
        background-color: #2c3e50;
        border-radius: 8px;
        padding: 3px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        margin-bottom: 10px;
    }
    #ota-progress-bar {
        width: 0%;
        height: 20px;
        background: linear-gradient(90deg, #f1c40f, #f39c12);
        border-radius: 5px;
        text-align: center;
        line-height: 20px;
        color: #232526;
        font-weight: bold;
        transition: width 0.3s ease-in-out;
    }
    #ota-status-text, #ota-progress-details {
        text-align: center;
        color: #bdc3c7;
        min-height: 18px;
        font-size: 0.9em;
        font-style: italic;
    }
    #ota-device-status-list {
        display: flex;
        flex-direction: column;
        gap: 5px;
        margin-top: 10px;
        font-size: 0.85em;
    }

    /* === CSS CHO CẤU TRÚC TAB GỘP === */
    .tablinks-day {
        background: #414345;
        color: #bdc3c7;
        flex-grow: 1;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 10px 5px 8px 5px;
        transition: all 0.2s ease-out;
        font-size: 0.9em;
        font-weight: 700;
        border-radius: 8px;
        margin: 0 2px;
        border-bottom: 3px solid transparent;
    }
    .tablinks-day:hover {
        background: #2c3e50;
        color: #fff;
    }
    .tablinks-day.active {
        background: #f1c40f;
        color: #232526;
        border-bottom-color: #f39c12;
    }
    .tab-session {
        display: flex;
        padding: 0 15px;
        gap: 10px;
        margin-top: 15px;
        margin-bottom: 15px;
    }
    .tablinks-session {
        flex-grow: 1;
        padding: 12px 10px;
        border: 2px solid #414345;
        background: #232526;
        color: #bdc3c7;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
        font-size: 1em;
        text-transform: uppercase;
        transition: all 0.3s;
    }
    .tablinks-session.active[onclick*="'sang'"] {
        background: linear-gradient(90deg, #2ecc71 60%, #27ae60 100%);
        color: #fff;
        border-color: #2ecc71;
        box-shadow: 0 0 15px #2ecc7188;
    }
    .tablinks-session.active[onclick*="'chieu'"] {
        background: linear-gradient(90deg, #3498db 60%, #2980b9 100%);
        color: #fff;
        border-color: #3498db;
        box-shadow: 0 0 15px #3498db88;
    }

    /* === [MỚI] Giao diện cho Modal Cài đặt Giao diện === */
    #interface-settings-modal .modal-content {
        max-width: 500px;
    }
    #interface-settings-modal h4 {
        color: #ab47bc;
    }
    .interface-table-container {
        max-height: 250px;
        overflow-y: auto;
        border: 1px solid #414345;
        border-radius: 8px;
    }
    .interface-table-container table {
        width: 100%;
        border-collapse: collapse;
    }
    .interface-table-container th, .interface-table-container td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #414345;
        font-size: 0.9em;
    }
    .interface-table-container th {
        background-color: #232526;
        color: #ab47bc;
        position: sticky;
        top: 0;
    }
    .interface-table-container tbody tr {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .interface-table-container tbody tr:hover {
        background-color: #34495e;
    }
    .interface-table-container tbody tr.selected-row {
        background-color: #ab47bc;
        color: #fff;
    }
    .interface-controls {
        margin-top: 20px;
        padding: 15px;
        background-color: #232526;
        border-radius: 8px;
    }
    .control-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }
    .control-grid .full-width {
        grid-column: 1 / -1;
    }
    .control-group {
        display: flex;
        flex-direction: column;
    }
    .control-group label {
        margin-bottom: 5px;
        font-size: 0.8em;
        color: #bdc3c7;
        font-weight: bold;
    }
    .control-group input, .control-group select {
        width: 100%;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #7f8c8d;
        background-color: #2c3e50;
        color: #ecf0f1;
        font-size: 0.9em;
    }
    .control-group input[type="color"] {
        padding: 2px;
        height: 38px;
    }
    .interface-action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    /* === [PHẦN ĐÃ XÓA THEO YÊU CẦU] === */
    /* .interface-action-buttons button { ... } ĐÃ XÓA */
    /* .reset-btn { ... } ĐÃ XÓA */
    /* .save-btn { ... } ĐÃ XÓA */
    
    /* === [MỚI] GIAO DIỆN LỊCH NGHỈ LỄ === */
    .holiday-calendar-container {
        padding: 0 15px;
        margin-top: 25px;
    }
    .holiday-calendar-container details summary {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        height: 50px;
        border-radius: 10px;
        background: linear-gradient(90deg, #485563 0%, #29323c 100%);
        color: #e74c3c;
        border-left: 4px solid #e74c3c;
        border-right: 4px solid #e74c3c;
        text-shadow: 0 0 12px #e74c3c, 0 2px 8px #000;
        box-shadow: 0 4px 18px 0 #00000044;
    }
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background-color: #34495e;
        border-radius: 8px 8px 0 0;
    }
    .calendar-header button {
        background: none;
        border: none;
        color: #f1c40f;
        font-size: 1.5em;
        cursor: pointer;
    }
    #month-year-display {
        color: #f1c40f;
        font-weight: bold;
        font-size: 1.1em;
    }
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        padding: 10px;
        background-color: #2c3e50;
        border-radius: 0 0 8px 8px;
    }
    .calendar-day, .calendar-day-header {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 35px;
        border-radius: 6px;
        font-weight: bold;
    }
    .calendar-day-header {
        color: #bdc3c7;
        font-size: 0.8em;
    }
    .calendar-day {
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
    }
    .calendar-day:not(.empty):hover {
        background-color: #34495e;
        transform: scale(1.05);
    }
    .calendar-day.holiday {
        background-color: #c0392b;
        color: #fff;
        box-shadow: 0 0 10px #e74c3c88;
    }
    .calendar-day.today {
        border: 2px solid #f1c40f;
    }
    .calendar-day.empty {
        cursor: default;
        opacity: 0.3;
    }

    .music-player-container {
        padding: 0 15px;
        margin-top: 25px;
    }
    .music-player-container > details > summary {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        height: 50px;
        border-radius: 10px;
        background: linear-gradient(90deg, #41295a 0%, #2F0743 100%);
        color: #ab47bc;
        border-left: 4px solid #ab47bc;
        border-right: 4px solid #ab47bc;
        text-shadow: 0 0 12px #ab47bc, 0 2px 8px #000;
        box-shadow: 0 4px 18px 0 #00000044;
    }
    .music-player-content h5 {
        text-align: center;
        color: #ab47bc;
        text-transform: uppercase;
        margin: 10px 0 10px 0;
        letter-spacing: 1px;
        font-size: 0.9em;
    }
    #music-playlist-container {
        max-height: 180px;
        overflow-y: auto;
        background-color: #2c3e50;
        border-radius: 8px;
        padding: 8px;
        border: 1px solid #414345;
    }
    #music-playlist-container::-webkit-scrollbar {width: 6px;}
    #music-playlist-container::-webkit-scrollbar-track {background: #232526;}
    #music-playlist-container::-webkit-scrollbar-thumb {background-color: #ab47bc; border-radius: 3px;}
    .playlist-item {
        padding: 8px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 0.9em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .playlist-item:hover {
        background-color: #34495e;
    }
    .playlist-item.playing {
        background-color: #ab47bc;
        color: #fff;
        font-weight: bold;
    }
    #now-playing-info {
        text-align: center;
        margin-top: 15px;
        padding: 8px;
        background-color: #232526;
        border-radius: 8px;
        min-height: 40px;
    }
    #now-playing-title {
        font-weight: bold;
        color: #f1c40f;
    }
    .music-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin: 15px 0;
    }
    .control-btn {
        background: none;
        border: none;
        color: #ecf0f1;
        cursor: pointer;
        padding: 10px;
        border-radius: 50%;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .control-btn:hover {
        background-color: #34495e;
        transform: scale(1.1);
    }
    .control-btn svg {
        width: 24px;
        height: 24px;
    }
    #play-pause-btn {
        background-color: #ab47bc;
        transform: scale(1.2);
    }
    #play-pause-btn:hover {
        background-color: #8e44ad;
        transform: scale(1.3);
    }
    .progress-volume-section {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin: 10px 0;
    }
    .progress-container {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.8em;
    }
    input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        height: 6px;
        background: #414345;
        border-radius: 3px;
        outline: none;
        transition: opacity .2s;
        cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #f1c40f;
        cursor: pointer;
    }
    input[type="range"].volume-slider::-webkit-slider-thumb {
        background: #ab47bc;
    }
    #volume-slider::-webkit-slider-thumb {
        background: #ab47bc;
    }
    .extra-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 5px;
    }
    .extra-controls .control-btn.active {
        color: #ab47bc;
    }
    .music-schedule-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        align-items: center;
    }
    .music-schedule-form .full-width {
        grid-column: 1 / -1;
    }
    .day-selector { display: flex; justify-content: space-around; background: #2c3e50; padding: 5px; border-radius: 6px; }
    .day-selector label { font-size: 0.8em; padding: 5px; border-radius: 4px; cursor: pointer; }
    .day-selector input { display: none; }
    .day-selector input:checked + span { background-color: #ab47bc; color: #fff; }
    #music-schedule-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85em; }
    #music-schedule-table th, #music-schedule-table td { border: 1px solid #414345; padding: 6px; text-align: center; }
    #music-schedule-table th { background: #ab47bc; color: #fff; }
    #music-schedule-table .delete-schedule-btn { background: #c0392b; color: #fff; border: none; cursor: pointer; padding: 3px 6px; border-radius: 4px; }
    
    /* === [THÊM MỚI] CSS CHO TÍCH HỢP PHÁT NHẠC VÀO LỊCH HỌC === */
    .bell-action-item {
        background: #232526;
        border: 1px solid #414345;
        border-radius: 8px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        transition: all 0.2s ease-in-out;
    }
    .bell-action-item:hover {
        border-color: #f1c40f;
    }
    .bell-action-header {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .bell-action-header .setting-item-icon {
        flex-shrink: 0;
        margin: 0;
        color: #f1c40f;
    }
    .bell-action-header .input-wrapper {
        flex-grow: 1;
    }
    .bell-action-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    .bell-action-controls select {
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #7f8c8d;
        background-color: #2c3e50;
        color: #ecf0f1;
        font-size: 0.9em;
        flex-grow: 1;
    }
    .music-options {
        display: none; /* Mặc định ẩn */
        flex-direction: column;
        gap: 12px;
        padding: 10px;
        background-color: #2c3e50;
        border-radius: 8px;
        border-top: 2px solid #f1c40f;
        margin-top: 10px;
    }
    .music-options.visible {
        display: flex; /* Hiện khi cần */
    }
    .music-options .control-group {
        width: 100%;
    }
    .music-options .control-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 0.8em;
        color: #bdc3c7;
        font-weight: bold;
    }
    .music-options .control-group select {
        width: 100%;
    }
    .random-play-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9em;
        cursor: pointer;
    }

    /* === [THÊM MỚI] CSS CHO TÍNH NĂNG HẸN GIỜ THEO KỊCH BẢN === */
    .scenario-timer-container {
        padding: 0 15px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .scenario-input-group {
        background: #232526;
        border: 1px solid #414345;
        border-radius: 8px;
        padding: 12px;
    }
    .scenario-input-group label {
        display: flex;
        align-items: center;
        font-size: 1em;
        font-weight: 600;
        color: #bdc3c7;
        margin-bottom: 8px;
    }
    .scenario-input-group label svg {
        width: 20px;
        height: 20px;
        margin-right: 8px;
        color: #f1c40f;
    }
    .scenario-input-group input {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #7f8c8d;
        background-color: #2c3e50;
        color: #ecf0f1;
        font-size: 1.1em;
    }
    .scenario-helper-text {
        font-size: 0.8em;
        color: #7f8c8d;
        font-style: italic;
        margin-top: 5px;
    }
    .scenario-actions {
    display: flex;
    flex-direction: column; /* <-- DÒNG MỚI THÊM VÀO */
    gap: 10px;
    margin-top: 10px;
}
    #scenario-preview-table-container {
        max-height: 250px;
        overflow-y: auto;
    }
    #scenario-preview-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 0.9em;
    }
    #scenario-preview-table th, #scenario-preview-table td {
        border: 1px solid #414345;
        padding: 8px;
        text-align: center;
    }
    #scenario-preview-table th {
        background: #f1c40f;
        color: #232526;
    }
    /* === [CHỈNH SỬA THEO YÊU CẦU] === */
    /* Biến #scenario-day-selector thành thanh tab */
    #scenario-day-selector {
        display: flex;
        justify-content: space-around;
        border-bottom: 2px solid #414345;
        position: relative;
        z-index: 1;
        background: transparent; /* Bỏ background cũ */
        padding: 0; /* Bỏ padding cũ */
        border-radius: 0; /* Bỏ border-radius cũ */
    }
    #scenario-day-selector label {
        flex-grow: 1;
        margin: 0 2px;
        padding: 0; /* Bỏ padding cũ */
        border-radius: 0; /* Bỏ border-radius cũ */
    }
    #scenario-day-selector span {
        display: block; /* Làm cho span chiếm toàn bộ không gian của label */
        border: none;
        outline: none;
        cursor: pointer;
        padding: 10px 5px 8px 5px;
        transition: all 0.2s ease-out;
        font-size: 0.9em;
        font-weight: 700;
        border-radius: 8px 8px 0 0;
        position: relative;
        top: 2px;
        border-bottom: 3px solid transparent;
        background: transparent;
        color: #bdc3c7;
        text-align: center;
    }
    #scenario-day-selector label:hover span {
        background: #414345;
        color: #fff;
        transform: translateY(-2px);
    }
    #scenario-day-selector input:checked + span {
        background: #f1c40f; /* Màu vàng như yêu cầu */
        color: #232526;
        border-bottom-color: #f39c12;
        /* Xóa các thuộc tính cũ không cần thiết */
        box-shadow: none;
        transform: none;
    }
    
  </style>
</head>
<body>
    <div id="notification-area"></div>

  <div id="main">
    <div id="content">
      <div style="text-align: center; padding: 15px 0 5px 0;">
        <h2 id="index-main-title" style="margin: 0; padding: 0;">CHUÔNG BÁO TỰ ĐỘNG</h2>
        <p id="school-name-status" style="margin: 5px 0 0 0; padding: 0; font-size: 1.1em; font-weight: bold; text-shadow: 0 2px 8px #000; letter-spacing: 1.2px;">THPT YÊN KHÁNH A</p>
      </div>
     <div class="clock-container" id="clock-wrapper" style="display: none;" onclick="manualSyncTime()">
        <div id="clock" class="clock">--:--:--</div>
        <div id="date" class="date-display">Đang chờ đồng bộ...</div>
      </div>
      <div id="countdown-status" style="text-align: center; color: #00e6ff; font-weight: bold; font-size: 1.1em; margin-top: -5px; margin-bottom: 10px; height: 25px; text-shadow: 0 0 8px #00e6ff88;">
    </div>
      <div class="main-tabs">
        <button class="main-tab-button active" onclick="openMainTab(event, 'tab-lich-hoc')">🗓️ Lịch Học</button>
        <button class="main-tab-button" onclick="openMainTab(event, 'tab-hen-gio')">⏱️ Hẹn Giờ</button>
        <button class="main-tab-button" onclick="openMainTab(event, 'tab-cai-dat')">⚙️ Cài Đặt</button>
        <button class="main-tab-button" onclick="openMainTab(event, 'tab-phat-nhac')">🎶 Phát Nhạc</button>
        <button class="main-tab-button" onclick="openMainTab(event, 'tab-he-thong')">🛠️ Hệ Thống</button>
      </div>

      <div class="main-tab-content-container">
        <div id="tab-lich-hoc" class="main-tab-content active">
          <h3 id="index-schedule-title" style="text-align: center; font-size: 1.15em; font-weight: 900; text-transform: uppercase; letter-spacing: 1.5px; color: #ecf0f1; background: none; border: none; box-shadow: none; margin-bottom: 10px; margin-top: 5px;">
            CÀI ĐẶT LỊCH HỌC
          </h3>
          <div class="tab" id="tab_day">
            <button class="tablinks-day" onclick="selectDay(event, 't2')">T2</button>
            <button class="tablinks-day" onclick="selectDay(event, 't3')">T3</button>
            <button class="tablinks-day" onclick="selectDay(event, 't4')">T4</button>
            <button class="tablinks-day" onclick="selectDay(event, 't5')">T5</button>
            <button class="tablinks-day" onclick="selectDay(event, 't6')">T6</button>
            <button class="tablinks-day" onclick="selectDay(event, 't7')">T7</button>
            <button class="tablinks-day" onclick="selectDay(event, 'cn')">CN</button>
          </div>

          <div class="tab-session" id="tab_session">
            <button class="tablinks-session" onclick="selectSession(event, 'sang')">Sáng</button>
            <button class="tablinks-session" onclick="selectSession(event, 'chieu')">Chiều</button>
          </div>
          
          <div id="tab-content-wrapper"></div>
        </div>

        <div id="tab-hen-gio" class="main-tab-content" >
            <h3 id="title-scenario-tab" style="text-align: center ; font-size: 1.15em; font-weight: 900; text-transform: uppercase; letter-spacing: 1.5px; color: #ecf0f1; background: none; border: none; box-shadow: none; margin-bottom: 15px; margin-top: 5px;">
                HẸN GIỜ THEO KỊCH BẢN
            </h3>

           <div class="scenario-timer-container">
    
    <details class="scenario-setup-details">
        <summary>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v5.414l3.293 3.293 1.414-1.414L13 11.586z"></path></svg>
            <span id="summary-new-scenario-text">THIẾT LẬP KỊCH BẢN MỚI</span>
        </summary>
        
        <div class="details-content" style="padding-top: 20px; display: flex; flex-direction: column; gap: 15px;">
            <div class="scenario-input-group">
                <label for="scenario-start-time">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v5.414l3.293 3.293 1.414-1.414L13 11.586z"></path></svg>
                    Thời gian bắt đầu
                </label>
                <input type="time" id="scenario-start-time">
            </div>

            <div class="scenario-input-group">
                <label for="scenario-intervals">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 9a3 3 0 0 0-3 3h6a3 3 0 0 0-3-3z"></path><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path></svg>
                    Lặp lại sau (phút)
                </label>
                <input type="text" id="scenario-intervals" placeholder="Ví dụ: 45,7,4,10">
                <p class="scenario-helper-text">Nhập các khoảng thời gian chờ, cách nhau bằng dấu phẩy (,)</p>
            </div>

            <div class="scenario-input-group">
                <label for="scenario-bells">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13.586V10c0-3.217-2.185-5.927-5-6.758V2h-4v1.242C7.185 4.073 5 6.783 5 10v3.586l-1.707 1.707A.996.996 0 0 0 3 16v2a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1v-2a.996.996 0 0 0-.293-.707L19 13.586zM19 17H5v-.586l1.707-1.707A.996.996 0 0 0 7 14v-4c0-2.757 2.243-5 5-5s5 2.243 5 5v4c0 .266.105.52.293.707L19 16.414V17zM12 22a2.98 2.98 0 0 0 2.818-2H9.182A2.98 2.98 0 0 0 12 22z"></path></svg>
                    Số hồi chuông tương ứng
                </label>
                <input type="text" id="scenario-bells" placeholder="Ví dụ: 6,3,2,6,3">
                <p class="scenario-helper-text">Nhập số hồi chuông cho giờ bắt đầu và các lần lặp lại</p>
            </div>

            <div class="scenario-input-group">
                <label>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 4h-2V2h-2v2H9V2H7v2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2zm-1 15H6V7h12v12z"></path></svg>
                    Áp dụng cho các ngày
                </label>
                <div class="day-selector" id="scenario-day-selector">
                    <label><input type="checkbox" name="scenario-day" value="t2"><span>T2</span></label>
                    <label><input type="checkbox" name="scenario-day" value="t3"><span>T3</span></label>
                    <label><input type="checkbox" name="scenario-day" value="t4"><span>T4</span></label>
                    <label><input type="checkbox" name="scenario-day" value="t5"><span>T5</span></label>
                    <label><input type="checkbox" name="scenario-day" value="t6"><span>T6</span></label>
                    <label><input type="checkbox" name="scenario-day" value="t7"><span>T7</span></label>
                    <label><input type="checkbox" name="scenario-day" value="cn"><span>CN</span></label>
                </div>
            </div>
            <div class="scenario-actions">
                <button class="modern-btn test-button" onclick="previewScenario()">Xem Trước Kịch Bản</button>
                <button class="modern-btn save-button" onclick="sendScenario()" style="background: linear-gradient(90deg, #27ae60, #2ecc71); border-color: #2ecc71; color: white;">Gửi Lệnh Lên Thiết Bị</button>
            </div>
        </div>
    </details>

    <div id="saved-scenario-container" style="padding: 0; margin-top: 20px;">
        <h5 id="title-saved-scenario" style="text-align: center; color: #3498db; text-transform: uppercase; margin: 10px 0 15px 0;">
            KỊCH BẢN HIỆN TẠI ĐANG LƯU TRÊN THIẾT BỊ
        </h5>
        <div id="saved-scenario-table-wrapper" style="max-height: 250px; overflow-y: auto; display: none;">
        </div>
        <p id="saved-scenario-placeholder" class="list-placeholder" style="padding: 10px; display: block;">
            Đang chờ dữ liệu từ thiết bị...
        </p>
        <div id="saved-scenario-priority" style="text-align: center; font-size: 0.9em; color: #bdc3c7; margin-top: 10px; font-style: italic;">
        </div>
        <div id="saved-scenario-days-display" class="saved-days-container">
        </div>
        <div class="delete-scenario-button-container">
            <button class="modern-btn logout-button" onclick="deleteSavedScenario()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
                 <span id="btn-delete-scenario">Xóa Kịch Bản Đã Lưu</span>
            </button>
        </div>
    </div>
    
    <div id="scenario-preview-table-container" style="margin-top: 20px;">
    </div>
    </div>
  </div>
        <div id="tab-cai-dat" class="main-tab-content">
            <div class="sohoi-container" style="margin-top: 5px;">
              <details> <summary id="header-sohoi">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24px" height="24px" style="margin-right: 10px; flex-shrink: 0;">
                                <path d="M19 13.586V10c0-3.217-2.185-5.927-5-6.758V2h-4v1.242C7.185 4.073 5 6.783 5 10v3.586l-1.707 1.707A.996.996 0 0 0 3 16v2a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1v-2a.996.996 0 0 0-.293-.707L19 13.586zM19 17H5v-.586l1.707-1.707A.996.996 0 0 0 7 14v-4c0-2.757 2.243-5 5-5s5 2.243 5 5v4c0 .266.105.52.293.707L19 16.414V17zM12 22a2.98 2.98 0 0 0 2.818-2H9.182A2.98 2.98 0 0 0 12 22z"></path>
                            </svg>
                            <div>
                                <div id="sohoi-title">CÀI ĐẶT CHUÔNG BÁO & ÂM THANH</div>
                            </div>
                        </summary>
                  <div class="details-content">
                      <div class="settings-grid" style="grid-template-columns: 1fr; gap: 12px;"> <div class="bell-action-item">
                              <div class="bell-action-header">
                                  <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13.586V10c0-3.217-2.185-5.927-5-6.758V2h-4v1.242C7.185 4.073 5 6.783 5 10v3.586l-1.707 1.707A.996.996 0 0 0 3 16v2a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1v-2a.996.996 0 0 0-.293-.707L19 13.586zM19 17H5v-.586l1.707-1.707A.996.996 0 0 0 7 14v-4c0-2.757 2.243-5 5-5s5 2.243 5 5v4c0 .266.105.52.293.707L19 16.414V17zM12 22a2.98 2.98 0 0 0 2.818-2H9.182A2.98 2.98 0 0 0 12 22z"></path></svg></div>
                                  <div class="input-wrapper">
                                      <label for="sohoi_batdau" id="label-sohoi-batdau">Bắt đầu buổi học</label>
                                      <div class="unit-input"><input id="sohoi_batdau" type="number" value="6"><span>hồi</span></div>
                                  </div>
                              </div>
                              <div class="bell-action-controls">
                                  <select id="sohoi_batdau_action" onchange="toggleActionOptions('batdau')">
                                      <option value="bell">Hành động: Reo chuông báo</option>
                                      <option value="music">Hành động: Phát âm thanh</option>
                                  </select>
                              </div>
                              <div id="music_options_batdau" class="music-options">
                                  <div class="control-group">
                                      <label for="sohoi_batdau_track">Chọn file âm thanh</label>
                                      <select id="sohoi_batdau_track"></select>
                                  </div>
                                  <div class="control-group">
                                      <label for="sohoi_batdau_volume">Âm lượng</label>
                                      <input type="range" id="sohoi_batdau_volume" min="0" max="30" value="25" class="volume-slider">
                                  </div>
                              </div>
                          </div>

                          <div class="bell-action-item">
                               <div class="bell-action-header">
                                  <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13 16.438V7.562a1 1 0 0 0-1.555-.832L8 9.562v4.876l3.445 2.832A1 1 0 0 0 13 16.438zM12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path></svg></div>
                                  <div class="input-wrapper">
                                      <label for="sohoi_vaotiet" id="label-sohoi-vaotiet">Vào tiết</label>
                                      <div class="unit-input"><input id="sohoi_vaotiet" type="number" value="5"><span>hồi</span></div>
                                  </div>
                              </div>
                              <div class="bell-action-controls">
                                  <select id="sohoi_vaotiet_action" onchange="toggleActionOptions('vaotiet')">
                                      <option value="bell">Hành động: Reo chuông báo</option>
                                      <option value="music">Hành động: Phát âm thanh</option>
                                  </select>
                              </div>
                              <div id="music_options_vaotiet" class="music-options">
                                  <div class="control-group">
                                      <label for="sohoi_vaotiet_track">Chọn file âm thanh</label>
                                      <select id="sohoi_vaotiet_track"></select>
                                  </div>
                                  <div class="control-group">
                                      <label for="sohoi_vaotiet_volume">Âm lượng</label>
                                      <input type="range" id="sohoi_vaotiet_volume" min="0" max="30" value="25" class="volume-slider">
                                  </div>
                              </div>
                          </div>

                          <div class="bell-action-item">
                               <div class="bell-action-header">
                                  <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18 5h-2V2H8v3H6c-1.654 0-3 1.346-3 3v6c0 1.654 1.346 3 3 3h1v1c0 .552.447 1 1 1h6c.553 0 1-.448 1-1v-1h1c1.654 0 3-1.346 3-3V8c0-1.654-1.346-3-3-3zm1 9c0 .552-.447 1-1 1H6c-.553 0-1-.448-1-1V8c0-.552.447-1 1-1h12c.553 0 1 .448 1 1v6z"></path></svg></div>
                                  <div class="input-wrapper">
                                      <label for="sohoi_rachoi" id="label-sohoi-rachoi">Ra chơi</label>
                                      <div class="unit-input"><input id="sohoi_rachoi" type="number" value="3"><span>hồi</span></div>
                                  </div>
                              </div>
                              <div class="bell-action-controls">
                                  <select id="sohoi_rachoi_action" onchange="toggleActionOptions('rachoi')">
                                      <option value="bell">Hành động: Reo chuông báo</option>
                                      <option value="music">Hành động: Phát âm thanh</option>
                                  </select>
                              </div>
                              <div id="music_options_rachoi" class="music-options">
                                  <div class="control-group">
                                      <label for="sohoi_rachoi_track">Chọn file âm thanh</label>
                                      <select id="sohoi_rachoi_track"></select>
                                  </div>
                                  <div class="control-group">
                                      <label for="sohoi_rachoi_volume">Âm lượng</label>
                                      <input type="range" id="sohoi_rachoi_volume" min="0" max="30" value="20" class="volume-slider">
                                  </div>
                                  <div class="control-group">
                                      <label class="random-play-label">
                                          <input type="checkbox" id="sohoi_rachoi_random">
                                          Phát ngẫu nhiên trong danh sách
                                      </label>
                                  </div>
                              </div>
                          </div>

                          <div class="bell-action-item">
                               <div class="bell-action-header">
                                  <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M14 12V8h-4v4H8l4 4 4-4h-2z"></path></svg></div>
                                  <div class="input-wrapper">
                                      <label for="sohoi_duvao" id="label-sohoi-duvao">Dự vào lớp</label>
                                      <div class="unit-input"><input id="sohoi_duvao" type="number" value="2"><span>hồi</span></div>
                                  </div>
                              </div>
                              <div class="bell-action-controls">
                                  <select id="sohoi_duvao_action" onchange="toggleActionOptions('duvao')">
                                      <option value="bell">Hành động: Reo chuông báo</option>
                                      <option value="music">Hành động: Phát âm thanh</option>
                                  </select>
                              </div>
                              <div id="music_options_duvao" class="music-options">
                                  <div class="control-group">
                                      <label for="sohoi_duvao_track">Chọn file âm thanh</label>
                                      <select id="sohoi_duvao_track"></select>
                                  </div>
                                  <div class="control-group">
                                      <label for="sohoi_duvao_volume">Âm lượng</label>
                                      <input type="range" id="sohoi_duvao_volume" min="0" max="30" value="25" class="volume-slider">
                                  </div>
                              </div>
                          </div>

                          <hr style="margin: 10px 0; background: #414345; height: 1px; opacity: 0.8;">

                          <h5 style="text-align: center; color: #f1c40f; margin: 10px 0;">CÀI ĐẶT CHUNG CHO CHUÔNG REO</h5>
                          <div class="settings-grid" style="grid-template-columns: 1fr 1fr; padding: 0;">
                              <div class="setting-item">
                                  <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v5.414l3.293 3.293 1.414-1.414L13 11.586z"></path></svg></div>
                                  <div class="input-wrapper">
                                      <label for="sohoi_tg_reo" id="label-sohoi-tgreo">Thời gian reo (ms)</label>
                                      <div class="unit-input"><input id="sohoi_tg_reo" type="number" value="1000"><span>ms</span></div>
                                  </div>
                              </div>
                              <div class="setting-item">
                                  <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M12 12.586-8.707 9.293l-1.414 1.414L12 15.414l7.121-7.121-1.414-1.414z"></path></svg></div>
                                  <div class="input-wrapper">
                                      <label for="sohoi_tg_nghi" id="label-sohoi-tgnghi">Thời gian nghỉ (ms)</label>
                                      <div class="unit-input"><input id="sohoi_tg_nghi" type="number" value="1000"><span>ms</span></div>
                                  </div>
                              </div>
                          </div>
                          <div style="padding: 15px 0 0 0;">
                          <button class="modern-btn test-button" onclick="publishTestBell()">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                              <span id="btn-test-bell">Thử Chuông Báo Chung</span>
                          </button>
                      </div>
                </div>
              </details>
            </div>
            <div class="holiday-calendar-container">
                <details>
                    <summary>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24px" height="24px" style="margin-right: 10px; flex-shrink: 0;">
                            <path d="M19 4h-2V2h-2v2H9V2H7v2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2zm-1 15H6V7h12v12z"></path>
                        </svg>
                        <div id="title-holiday-calendar">LỊCH NGHỈ LỄ</div>
                    </summary>
                    <div class="details-content">
                        <div class="calendar-header">
                            <button onclick="changeMonth(-1)">&#8249;</button>
                            <div id="month-year-display">Tháng 9 2024</div>
                            <button onclick="changeMonth(1)">&#8250;</button>
                        </div>
                        <div class="calendar-grid" id="calendar-grid">
                            </div>
                    </div>
                </details>
            </div>
        </div>

        <div id="tab-phat-nhac" class="main-tab-content">
            <div class="music-player-container" style="margin-top: 5px;">
              <details open>
                  <summary>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24px" height="24px" style="margin-right: 10px; flex-shrink: 0;">
                            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"></path>
                        </svg>
                    <div id="title-music-player">ĐIỀU KHIỂN PHÁT NHẠC</div>
                    </summary>
                  <div class="details-content music-player-content">
                      <h5 id="title-music-playlist">DANH SÁCH PHÁT</h5>
                      <div id="music-playlist-container">
                          <p class="list-placeholder">Đang chờ danh sách nhạc từ thiết bị...</p>
                      </div>
                      <div id="now-playing-info">
                          <span id="now-playing-title">Chưa có bài hát nào được chọn</span>
                      </div>
                      <div class="progress-volume-section">
                          <div class="progress-container">
                              <span id="current-time">00:00</span>
                              <input type="range" id="music-progress-bar" value="0" min="0" max="100">
                              <span id="total-time">00:00</span>
                          </div>
                      </div>
                      <div class="music-controls">
                          <button class="control-btn" id="prev-btn" onclick="handleMusicControl('prev')">
                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12V6.5c0-.83-.67-1.5-1.5-1.5S9 5.67 9 6.5v4.05l-2.71-2.7c-.59-.59-1.54-.59-2.12 0-.59.58-.59 1.54 0 2.12L7.05 12l-2.88 2.87c-.59.58-.59 1.54 0 2.12.58.59 1.53.59 2.12 0L9 14.45V18.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5v-5.5zM12 12l2.88 2.87c.58.59 1.53.59 2.12 0 .59-.58.59-1.54 0-2.12L14.12 12l2.88-2.88c.59-.58.59-1.54 0-2.12-.58-.59-1.54-.59-2.12 0L12 10.5V6.5c0-.83-.67-1.5-1.5-1.5S9 5.67 9 6.5v11c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5V12z"></path></svg>
                          </button>
                          <button class="control-btn" id="play-pause-btn" onclick="handleMusicControl('play_pause')">
                              <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 6v12l10-6z"></path></svg>
                              <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="display:none;"><path d="M6 18h4V6H6v12zm8-12v12h4V6h-4z"></path></svg>
                          </button>
                          <button class="control-btn" id="next-btn" onclick="handleMusicControl('next')">
                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12v5.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5v-4.05l2.71 2.7c.59.59 1.54.59 2.12 0 .59-.58.59-1.54 0-2.12L16.95 12l2.88-2.87c.59-.58.59-1.54 0-2.12-.58-.59-1.53-.59-2.12 0L15 9.55V5.5c0-.83-.67-1.5-1.5-1.5S12 4.67 12 5.5v6.5zm0 0L9.12 9.13c-.58-.59-1.53-.59-2.12 0-.59.58-.59 1.54 0 2.12L9.88 12l-2.88 2.88c-.59.58-.59-1.54 0 2.12.58.59 1.54.59 2.12 0L12 13.5v4c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5v-11c0-.83-.67-1.5-1.5-1.5S12 4.67 12 5.5v6.5z"></path></svg>
                          </button>
                      </div>
                      <div class="extra-controls">
                          <button class="control-btn" id="shuffle-btn" onclick="togglePlayMode('shuffle')">
                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10.59 9.17 5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"></path></svg>
                          </button>
                           <div class="progress-container" style="flex-grow: 1; margin: 0 10px;">
                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>
                              <input type="range" id="volume-slider" value="50" min="0" max="100">
                          </div>
                          <button class="control-btn" id="repeat-btn" onclick="togglePlayMode('repeat')">
                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"></path></svg>
                          </button>
                      </div>
                      <hr style="margin: 20px 0; background: #414345; height: 1px; opacity: 0.5;">
                      <details style="border-color: #ab47bc;">
                           <summary style="background: #2c3e50; color: #ab47bc; text-align: center; display: flex; align-items: center; justify-content: center;" id="summary-music-schedule">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20px" height="20px">
                                    <path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v5.414l3.293 3.293 1.414-1.414L13 11.586z"></path>
                                </svg>
                                <span style="margin-left: 8px;">HẸN GIỜ PHÁT NHẠC</span>
                            </summary>
                          <div class="details-content">
                              <div class="music-schedule-form">
                                  <div class="control-group">
                                      <label for="schedule-music-time">Thời gian</label>
                                      <input type="time" id="schedule-music-time" class="modal-input" style="padding: 8px; margin: 0;">
                                  </div>
                                  <div class="control-group">
                                      <label for="schedule-music-track-select">Chọn bài hát</label>
                                      <select id="schedule-music-track-select" class="modal-input" style="padding: 8px; margin: 0;"></select>
                                  </div>
                                  <div class="control-group full-width">
                                      <label id="label-music-repeat-days">Lặp lại vào các ngày</label>
                                      <div class="day-selector">
                                          <label><input type="checkbox" name="music-day" value="t2"><span>T2</span></label>
                                          <label><input type="checkbox" name="music-day" value="t3"><span>T3</span></label>
                                          <label><input type="checkbox" name="music-day" value="t4"><span>T4</span></label>
                                          <label><input type="checkbox" name="music-day" value="t5"><span>T5</span></label>
                                          <label><input type="checkbox" name="music-day" value="t6"><span>T6</span></label>
                                          <label><input type="checkbox" name="music-day" value="t7"><span>T7</span></label>
                                          <label><input type="checkbox" name="music-day" value="cn"><span>CN</span></label>
                                      </div>
                                  </div>
                                  <button class="action-btn full-width" style="background-color: #ab47bc; color: #fff;" onclick="addMusicSchedule()">Thêm Lịch Phát</button>
                              </div>
                              <table id="music-schedule-table">
                                  <thead><tr><th>Thời gian</th><th>Bài hát</th><th>Ngày</th><th>Xóa</th></tr></thead>
                                  <tbody>
                                      </tbody>
                              </table>
                          </div>
                      </details>
                  </div>
              </details>
            </div>
        </div>
        
        <div id="tab-he-thong" class="main-tab-content">
  <div class="button-section">
    
    <button class="modern-btn interface-button" onclick="openInterfaceSettingsModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path><path d="M12 22.31V12h10.31"></path><path d="M12 12H1.69"></path><path d="m12 12 5.66-5.66"></path></svg>
        <span id="btn-interface-settings">Cài đặt giao diện</span>
    </button>
    <button class="modern-btn advanced-button" onclick="openAdvancedSettingsModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
        <span id="btn-advanced-settings">Cài đặt nâng cao</span>
    </button>
    <div class="divider-yellow" style="margin: 10px auto;"></div>
    <button class="modern-btn logout-button" onclick="logout()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
        <span id="btn-logout">Đăng xuất</span>
    </button>
  </div>
</div>

      </div>
      </div>
  </div>
<div class="sticky-action-bar">
  <button class="modern-btn save-button" onclick="publishUpdate()">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
      <span id="btn-save-schedule">Lưu và gửi cập nhật</span>
  </button>
</div>
<div class="modal-overlay" id="advanced-settings-modal">
    <div class="modal-content">
        <h4>Cài đặt nâng cao</h4>
        <div class="adv-modal-tabs">
            <div class="adv-modal-tab active" onclick="switchAdvTab(event, 'adv-tab-satellites')">Vệ tinh</div>
            <div class="adv-modal-tab" onclick="switchAdvTab(event, 'adv-tab-system')">Hệ thống</div>
            <div class="adv-modal-tab" onclick="switchAdvTab(event, 'adv-tab-reset-wifi')">Reset WiFi</div>
            <div class="adv-modal-tab" onclick="switchAdvTab(event, 'adv-tab-reset-esp')">Reset ESP</div>
            <div class="adv-modal-tab" onclick="switchAdvTab(event, 'adv-tab-change-pass')">Mật khẩu</div>
            <div class="adv-modal-tab" onclick="switchAdvTab(event, 'adv-tab-ota')">Cập nhật OTA</div>
        </div>
        
        <div id="adv-tab-satellites" class="adv-modal-tab-content active">
            <h5>CÁC THIẾT BỊ ĐANG QUẢN LÝ</h5>
            <div id="managed-devices-list" class="device-list">
                <p class="list-placeholder">Chưa có thiết bị nào được quản lý.</p>
            </div>
            <hr style="margin: 20px 0; background: #414345; height: 1px; opacity: 0.5;">
            <h5>CÁC THIẾT BỊ ĐÃ PHÁT HIỆN</h5>
            <div id="discovered-devices-list" class="device-list">
                <p class="list-placeholder">Đang chờ tín hiệu từ các thiết bị...</p>
            </div>
        </div>

        <div id="adv-tab-system" class="adv-modal-tab-content">
            <div id="system-info-actions-list" class="actions-list">
                </div>
        </div>

        <div id="adv-tab-reset-wifi" class="adv-modal-tab-content">
            <div id="reset-wifi-actions-list" class="actions-list">
                </div>
        </div>

        <div id="adv-tab-reset-esp" class="adv-modal-tab-content">
    <h5>CẤU HÌNH TỰ ĐỘNG KHỞI ĐỘNG LẠI</h5>
    <div class="actions-list" style="margin-bottom: 20px;">
        <div class="action-item" style="flex-direction: column; align-items: stretch; gap: 10px;">
            <div style="display: flex; align-items: center;">
                <div class="action-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v5.414l3.293 3.293 1.414-1.414L13 11.586z"></path></svg>
                </div>
                <div class="action-text">
                    <div class="title">Chế độ bảo trì tự động</div>
                    <div class="description">Hệ thống sẽ tự khởi động lại khi đủ thời gian hoạt động.</div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding-left: 45px;">
                <div class="control-group">
                    <label style="font-size: 0.8em; color: #bdc3c7;">Chu kỳ (Ngày)</label>
                    <input type="number" id="auto-restart-days-input" class="modal-input" style="padding: 5px; text-align: center;" min="0" max="30" placeholder="0 để tắt">
                </div>
                <div class="control-group">
                    <label style="font-size: 0.8em; color: #bdc3c7;">Thực hiện lúc (Giờ:Phút)</label>
                    <input type="time" id="auto-restart-time-input" class="modal-input" style="padding: 5px; text-align: center;">
                </div>
            </div>
            <button class="action-btn" onclick="saveAutoRestartConfig()" style="background-color: #27ae60; margin-left: 45px; margin-top: 5px;">Lưu Cấu Hình</button>
        </div>
    </div>

    <hr style="margin: 10px 0; background: #414345; height: 1px; opacity: 0.5;">

    <div id="reset-esp-actions-list" class="actions-list">
    </div>
</div>

        <div id="adv-tab-change-pass" class="adv-modal-tab-content">
            <h5>THAY ĐỔI MẬT KHẨU QUẢN TRỊ</h5>
            <div class="actions-list" style="gap: 15px; padding-top: 10px;">
                <input type="password" id="old-admin-password" class="modal-input" placeholder="Mật khẩu cũ..." autocomplete="current-password">
                <input type="password" id="new-admin-password" class="modal-input" placeholder="Mật khẩu mới..." autocomplete="new-password">
                <input type="password" id="confirm-admin-password" class="modal-input" placeholder="Xác nhận mật khẩu mới..." autocomplete="new-password">
                <button class="action-btn" style="width: 100%; height: 40px; font-size: 0.9em;" onclick="handleChangePassword()">Lưu Thay Đổi</button>
            </div>
        </div>
        
        <div id="adv-tab-ota" class="adv-modal-tab-content">
            <h5>CẬP NHẬT FIRMWARE (OTA)</h5>
            <div class="actions-list" style="gap: 15px; padding-top: 10px;">
                
                <h5>1. CHỌN THIẾT BỊ CẦN CẬP NHẬT</h5>
                <div id="ota-device-selection-list" class="ota-device-selection">
                    <p class="list-placeholder">Đang chờ danh sách thiết bị...</p>
                </div>
                
                <h5>2. CHỌN FILE FIRMWARE (.bin)</h5>
                <input type="file" id="ota-file-input" accept=".bin" style="display: none;">
                <button class="action-btn" id="ota-select-file-btn" onclick="document.getElementById('ota-file-input').click();" style="display: flex; align-items: center; justify-content: center; width: 100%; height: 40px; font-size: 0.9em;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    Chọn File (.bin)
                </button>
                <div id="ota-file-name" style="text-align: center; color: #f1c40f; font-weight: bold; min-height: 20px; font-size: 0.9em;">Chưa chọn tệp nào</div>

                <h5>3. BẮT ĐẦU CẬP NHẬT</h5>
                <div id="ota-progress-container">
                    <div id="ota-progress-bar">0%</div>
                </div>
                <div id="ota-status-text"></div>
                <div id="ota-progress-details"></div>
                
                <div id="ota-device-status-list"></div>

                <button class="action-btn" id="ota-upload-btn" style="width: 100%; height: 40px; font-size: 0.9em; background-color: #27ae60; color: #fff; display: none;" onclick="handleOtaUpload()">Bắt đầu Cập nhật</button>
            </div>
        </div>

        <div class="modal-buttons">
            <button class="modal-cancel-btn" onclick="closeAdvancedSettingsModal()">Đóng</button>
        </div>
    </div>
  </div>

  <div class="modal-overlay" id="password-modal-overlay">
      <div class="modal-content">
          <h4 id="password-modal-title">Xác thực quyền Quản trị</h4>
          <p id="password-modal-description" style="text-align: center; margin-top: -10px; margin-bottom: 20px; color: #bdc3c7; font-size: 0.9em;">Vui lòng nhập mật khẩu để tiếp tục.</p>
          <input type="password" id="admin-password-input" class="modal-input" placeholder="Mật khẩu quản trị..." autocomplete="current-password">
          <div class="modal-buttons">
              <button class="modal-cancel-btn" onclick="closePasswordModal()">Hủy</button>
              <button class="modal-confirm-btn" onclick="confirmAction()">Xác nhận</button>
          </div>
      </div>
  </div>

  <div class="modal-overlay" id="conflict-modal-overlay">
      <div class="modal-content" style="border-top-color: #e74c3c;">
          <h4 style="color: #e74c3c;">Cảnh báo: Phát hiện xung đột!</h4>
          <div id="conflict-modal-description">Nội dung xung đột sẽ được hiển thị ở đây.</div>
          <p style="text-align: center; font-size: 0.9em; color: #f1c40f; font-weight: bold;">Ông muốn ưu tiên thực hiện lệnh nào?</p>
          <div class="modal-buttons" style="flex-direction: column; gap: 10px;">
              <button class="modal-confirm-btn priority-scenario" onclick="handleConflictChoice('scenario')">Ưu tiên Kịch Bản Hẹn Giờ</button>
              <button class="modal-confirm-btn priority-schedule" onclick="handleConflictChoice('schedule')">Ưu tiên Lịch Học Hôm Nay</button>
              <button class="modal-cancel-btn" onclick="handleConflictChoice('cancel')">Hủy bỏ</button>
          </div>
      </div>
  </div>

  <div class="modal-overlay" id="interface-settings-modal">
    <div class="modal-content">
        <h4 id="interface-modal-title">Cài đặt Giao diện</h4>
        <div class="interface-table-container">
            <table>
                <thead>
                    <tr>
                        <th>Mô tả</th>
                        <th>Nội dung hiện tại</th>
                    </tr>
                </thead>
                <tbody id="text-elements-table-body">
                    </tbody>
            </table>
        </div>
        <div class="interface-controls">
            <div class="control-grid">
                <div class="control-group full-width">
                    <label for="text-editor-input" id="interface-label-content">Nội dung</label>
                    <input type="text" id="text-editor-input" placeholder="Chọn một dòng trong bảng để sửa...">
                </div>
                <div class="control-group">
                    <label for="color-picker-input" id="interface-label-color">Màu chữ</label>
                    <input type="color" id="color-picker-input">
                </div>
                <div class="control-group">
                    <label for="font-size-input" id="interface-label-fontsize">Cỡ chữ (px)</label>
                    <input type="number" id="font-size-input" min="8" max="40">
                </div>
                <div class="control-group full-width">
                    <label for="font-family-select" id="interface-label-fontfamily">Font chữ</label>
                    <select id="font-family-select">
                        <option value="'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif">Mặc định (Segoe UI)</option>
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="Verdana, sans-serif">Verdana</option>
                        <option value="Tahoma, sans-serif">Tahoma</option>
                        <option value="'Courier New', Courier, monospace">Courier New</option>
                        <option value="'Times New Roman', Times, serif">Times New Roman</option>
                    </select>
                </div>
            </div>
            <div class="interface-action-buttons">
                <button class="modern-btn logout-button" onclick="resetInterfaceSettings()" style="width: 100%;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 10px;"><path d="M13.5 2.5a1 1 0 1 0-2 0v2.4a6.5 6.5 0 1 0 9.9 7.4 1 1 0 1 0-1.8-1a4.5 4.5 0 1 1-6.6-5.9V8a1 1 0 1 0 2 0V2.5z"></path></svg>
                    <span id="interface-btn-reset">Reset về Mặc định</span>
                 </button>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="modal-cancel-btn" onclick="closeInterfaceSettingsModal()"><span id="interface-btn-close">Đóng</span></button>
        </div>
    </div>
  </div>
  <script>
   // [MỚI] HÀM ĐIỀU KHIỂN CÁC TAB CHÍNH
    function openMainTab(evt, tabName) {
        // Lấy tất cả các phần tử có class="main-tab-content" và ẩn chúng đi
        const tabcontent = document.getElementsByClassName("main-tab-content");
        for (let i = 0; i < tabcontent.length; i++) {
            tabcontent[i].classList.remove("active");
        }

        // Lấy tất cả các phần tử có class="main-tab-button" và xóa class "active"
        const tablinks = document.getElementsByClassName("main-tab-button");
        for (let i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
        }

        // Hiển thị tab hiện tại và thêm một class "active" vào nút đã mở tab
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");

        // [SỬA ĐỔI] Ẩn/hiện thanh hành động tùy theo tab
        const actionBar = document.querySelector('.sticky-action-bar');
        if (tabName === 'tab-lich-hoc' || tabName === 'tab-cai-dat') {
            actionBar.style.display = 'flex';
        } else {
            actionBar.style.display = 'none';
        }
    }
    
    // =======================================================
    // === [BẮT ĐẦU] JS MỚI CHO HẸN GIỜ & CẢNH BÁO XUNG ĐỘT ===
    // =======================================================

    // Biến toàn cục để xử lý Promise của modal
    let resolveConflictPromise = null;
    // [CHỈNH SỬA THEO YÊU CẦU] Biến toàn cục để lưu kịch bản xem trước
    let previewedScenarioData = null;


    /**
     * Mở modal cảnh báo xung đột và trả về một Promise
     * @param {string} message - Nội dung HTML của cảnh báo
     * @returns {Promise<string>} - Promise sẽ resolve với lựa chọn của người dùng ('scenario', 'schedule', 'cancel')
     */
    function openConflictModal(message) {
        const modal = document.getElementById('conflict-modal-overlay');
        const description = document.getElementById('conflict-modal-description');
        
        description.innerHTML = message;
        modal.classList.add('visible');

        return new Promise(resolve => {
            resolveConflictPromise = resolve;
        });
    }

    /**
     * Đóng modal cảnh báo xung đột
     */
    function closeConflictModal() {
        const modal = document.getElementById('conflict-modal-overlay');
        modal.classList.remove('visible');
    }

    /**
     * Xử lý lựa chọn của người dùng từ modal cảnh báo
     * @param {string} choice - Lựa chọn ('scenario', 'schedule', 'cancel')
     */
    function handleConflictChoice(choice) {
        if (resolveConflictPromise) {
            resolveConflictPromise(choice);
            resolveConflictPromise = null;
        }
        closeConflictModal();
    }
    
    /**
     * [NÂNG CẤP] Hàm hỗ trợ tính toán khoảng thời gian hoạt động của một buổi học.
     * Trả về object chứa thời gian bắt đầu và kết thúc (tính bằng phút).
     */
    function getSessionTimeRange(scheduleObject) {
        if (!scheduleObject || !scheduleObject.enabled) return null;

        const hasSpecial = scheduleObject.has_special_event || false;
        const hasDuVao = scheduleObject.has_duvao_bell === undefined ? true : scheduleObject.has_duvao_bell;

        const startTime = timeToMinute(scheduleObject.gio);
        const lessonTime = scheduleObject.tiethoc || 45;
        const lessonCount = scheduleObject.sotiet || 0;
        const prepareTime = hasDuVao ? (scheduleObject.duvaotiet || 3) : 0;

        const breakTimeStr = scheduleObject.rachoi || '5';
        const breakTimes = breakTimeStr.split(',').map(s => parseInt(s.trim()) || 0);

        const specialEventTime = hasSpecial ? (scheduleObject.chaoco || scheduleObject.chunhiem || 0) : 0;
        const specialPrepareTime = hasSpecial ? (scheduleObject.prepare_after_special || 2) : 0;

        if (startTime === 0 || lessonTime === 0 || lessonCount === 0) return null;

        let totalDuration = 0;
        if (hasSpecial && specialEventTime > 0) {
            totalDuration += specialEventTime;
            if (specialPrepareTime > 0) {
                totalDuration += specialPrepareTime;
            }
        }
        
        totalDuration += lessonTime * lessonCount;

        for (let i = 0; i < lessonCount - 1; i++) {
            const currentBreakTime = breakTimes[i] ?? breakTimes[breakTimes.length - 1];
            if (currentBreakTime > 0) {
                totalDuration += currentBreakTime;
                if (prepareTime > 0) {
                    totalDuration += prepareTime;
                }
            }
        }

        const endTime = startTime + totalDuration;
        return { start: startTime, end: endTime };
    }


    /**
     * [NÂNG CẤP] Kiểm tra xung đột giữa kịch bản và lịch học của những ngày đã chọn.
     * Logic mới sẽ kiểm tra xem thời gian kịch bản có nằm TRONG KHOẢNG thời gian bận rộn không.
     */
    async function checkForConflicts(scenario, selectedDays) {
        if (!scenario || scenario.length === 0 || !window.allData || !selectedDays || selectedDays.length === 0) {
            return { conflicting: false };
        }

        for (const dayId of selectedDays) {
            const morningScheduleData = window.allData.lich.sang[dayId];
            const afternoonScheduleData = window.allData.lich.chieu[dayId];

            const morningRange = getSessionTimeRange(morningScheduleData);
            const afternoonRange = getSessionTimeRange(afternoonScheduleData);

            for (const scenarioEvent of scenario) {
                const scenarioTimeInMinutes = timeToMinute(scenarioEvent.time);
                
                let conflictFound = false;
                let conflictSession = '';

                if (morningRange && scenarioTimeInMinutes >= morningRange.start && scenarioTimeInMinutes <= morningRange.end) {
                    conflictFound = true;
                    conflictSession = 'buổi sáng';
                } else if (afternoonRange && scenarioTimeInMinutes >= afternoonRange.start && scenarioTimeInMinutes <= afternoonRange.end) {
                    conflictFound = true;
                    conflictSession = 'buổi chiều';
                }

                if (conflictFound) {
                    const dayNameMap = {t2: 'Thứ Hai', t3: 'Thứ Ba', t4: 'Thứ Tư', t5: 'Thứ Năm', t6: 'Thứ Sáu', t7: 'Thứ Bảy', cn: 'Chủ Nhật'};
                    const dayName = dayNameMap[dayId] || dayId;
                    const message = `Cảnh báo: Thời gian <strong>${scenarioEvent.time}</strong> trong kịch bản của ông trùng với lịch học <strong>${conflictSession}</strong> của ngày <strong>${dayName}</strong>.`;
                    return { conflicting: true, message: message };
                }
            }
        }

        return { conflicting: false };
    }


    /**
     * [GIỮ NGUYÊN & ĐẢM BẢO] Hàm tính toán và trả về một danh sách (mảng) các sự kiện,
     * đảm bảo mỗi sự kiện sẽ được hiển thị trên một dòng riêng.
     */
    function calculateScenario() {
        const startTimeEl = document.getElementById('scenario-start-time');
        const intervalsEl = document.getElementById('scenario-intervals');
        const bellsEl = document.getElementById('scenario-bells');

        if (!startTimeEl.value) {
            showNotification("Vui lòng nhập thời gian bắt đầu!", "error");
            return null;
        }

        const intervalsStr = intervalsEl.value.trim();
        const bellsStr = bellsEl.value.trim();

        if (!bellsStr) {
            showNotification("Vui lòng nhập chuỗi số hồi chuông!", "error");
            return null;
        }
        
        const intervals = intervalsStr === '' ? [] : intervalsStr.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
        const bells = bellsStr.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
        
        let currentTimeInMinutes = timeToMinute(startTimeEl.value);
        let scenario = [];

        if (bells.length === 0) {
            showNotification("Chuỗi số hồi chuông không hợp lệ!", "error");
            return null;
        }

        scenario.push({
            time: minuteToTime(currentTimeInMinutes),
            bell: bells[0]
        });

        const loopCount = Math.min(intervals.length, bells.length - 1);
        for (let i = 0; i < loopCount; i++) {
            currentTimeInMinutes += intervals[i];
            scenario.push({
                time: minuteToTime(currentTimeInMinutes),
                bell: bells[i + 1]
            });
        }

        return scenario;
    }
    
    // [CHỈNH SỬA THEO YÊU CẦU] Hàm mới chỉ để xem trước
    function previewScenario() {
        const scenario = calculateScenario();
        // SỬA LỖI: Hiển thị bảng xem trước
        const previewContainer = document.getElementById('scenario-preview-table-container');

        if (!scenario || scenario.length === 0) {
            previewContainer.innerHTML = ''; // Xóa xem trước cũ nếu có lỗi
            // Hàm calculateScenario đã tự thông báo lỗi
            return;
        }
        const selectedDays = Array.from(document.querySelectorAll('input[name="scenario-day"]:checked')).map(cb => cb.value);

        // Lưu dữ liệu đã tính toán vào biến toàn cục để hàm "sendScenario" sử dụng
        previewedScenarioData = {
            scenario: scenario,
            days: selectedDays
        };

        // Tạo HTML cho bảng xem trước
        let tableHTML = `<h5 style="text-align: center; color: #f1c40f; text-transform: uppercase; margin: 10px 0 15px 0;">BẢNG XEM TRƯỚC</h5>
                         <table class="scenario-table">
                            <thead>
                                <tr><th>STT</th><th>Thời gian</th><th>Số hồi</th></tr>
                            </thead>
                            <tbody>`;
        scenario.forEach((event, index) => {
            tableHTML += `<tr>
                            <td>${index + 1}</td>
                            <td>${event.time}</td>
                            <td>${event.bell} hồi</td>
                        </tr>`;
        });
        tableHTML += `</tbody></table>`;
        
        previewContainer.innerHTML = tableHTML;
        showNotification("Đã tạo kịch bản xem trước. Nhấn 'Gửi Lệnh' để lưu.", "info");
    }

    // [CHỈNH SỬA THEO YÊU CẦU] Hàm mới dùng để gửi lệnh (trước đây là addScenario)
    async function sendScenario() {
        if (!client || !client.connected) {
            return showNotification("Chưa kết nối máy chủ!", 'error');
        }

        if (!previewedScenarioData) {
            showNotification("Vui lòng nhấn 'Xem Trước Kịch Bản' trước khi gửi lệnh.", "error");
            return;
        }

        const { scenario, days } = previewedScenarioData;

        if (days.length === 0) {
            return showNotification("Vui lòng chọn ít nhất một ngày để áp dụng kịch bản!", "error");
        }
        if (!scenario || scenario.length === 0) {
            return; 
        }

        let userPriority = 'none'; 
        const conflict = await checkForConflicts(scenario, days);

        if (conflict.conflicting) {
            const userChoice = await openConflictModal(conflict.message);
            if (userChoice === 'cancel') {
                showNotification("Đã hủy gửi lệnh do có xung đột.", "info");
                return;
            }
            userPriority = userChoice;
        }

        // Đây là payload của MỘT kịch bản
        const payload = {
            scenario: scenario,
            priority: userPriority,
            days: days
        };

        // === [SỬA LỖI QUAN TRỌNG] ===
        // Chúng ta gửi MỘT kịch bản đến topic "ADD" (THÊM)
        const SCENARIO_ADD_TOPIC = "esp32/bell/scenario/add"; 
        client.publish(SCENARIO_ADD_TOPIC, JSON.stringify(payload), { qos: 1 });
        // ==============================

        showNotification("Đã gửi lệnh THÊM kịch bản mới!", "success");
        
        // Không cần tự cập nhật localStorage, vì ESP32 sẽ gửi lại danh sách mới
        // và hàm _load() sẽ xử lý (XÓA CÁC DÒNG LIÊN QUAN ĐẾN localStorage TỪ HÀM CŨ)
        
        document.getElementById('scenario-preview-table-container').innerHTML = '';
        previewedScenarioData = null;
    }

    // [THÊM MỚI] Hàm xóa kịch bản đã lưu
    function deleteSavedScenario() {
        if (!client || !client.connected) {
            return showNotification("Chưa kết nối máy chủ!", 'error');
        }
        
        if (!confirm("Ông có chắc chắn muốn XÓA TẤT CẢ kịch bản đã lưu trên thiết bị không? Hành động này không thể hoàn tác.")) {
            return;
        }

        // === [SỬA LỖI QUAN TRỌNG] ===
        // Gửi một chuỗi mảng rỗng "[]"
        const payload = "[]"; 
        
        // Gửi đến topic "SET" (để GHI ĐÈ/XÓA)
        const SCENARIO_SET_TOPIC = "esp32/bell/scenario/set"; 
        client.publish(SCENARIO_SET_TOPIC, payload, { qos: 1 }); 
        // ==============================
        
        showNotification("Đã gửi lệnh XÓA TẤT CẢ kịch bản!", "success");
        // Không cần xóa localStorage, ESP32 sẽ gửi lại danh sách rỗng và hàm _load() sẽ cập nhật
    } // <--- [ĐÃ SỬA] DẤU NGOẶC NHỌN KẾT THÚC HÀM deleteSavedScenario ĐƯỢC DI CHUYỂN LÊN ĐÂY
    
        // === [THÊM HÀM MỚI NÀY] ===
    function deleteSingleScenario(index) { // <-- [ĐÃ SỬA] HÀM NÀY BÂY GIỜ NẰM NGOÀI, Ở PHẠM VI TOÀN CỤC
        if (!confirm(`Ông có chắc chắn muốn XÓA KỊCH BẢN #${index + 1} không?`)) {
            return;
        }
        if (!client || !client.connected) {
            return showNotification("Chưa kết nối máy chủ!", 'error');
        }
        
        // 1. Định nghĩa topic mới
        const SCENARIO_DELETE_TOPIC = "esp32/bell/scenario/delete";
        
        // 2. Gửi đi VỊ TRÍ (index) của kịch bản cần xóa
        client.publish(SCENARIO_DELETE_TOPIC, String(index), { qos: 1 }); 
        
        showNotification(`Đã gửi lệnh xóa kịch bản #${index + 1}...`, 'info');
    }
    // =======================================================
    // PHẦN MÃ GỐC (GIỮ NGUYÊN)
    // =======================================================
    if("true"!==sessionStorage.getItem("isLoggedIn"))window.location.href="login.html";
    
    let client, serverTime = null, targetDevice = null, targetAction = null, otaInProgress = false;
    let selectedDay = 't2', selectedSession = 'sang';
    let todaySchedule = []; 
    const brokerUrl="wss://8bdef73996bb4030affe9483eecde31b.s1.eu.hivemq.cloud:8884/mqtt";
    const options={username:"ngoctuyka",password:"Tu12345678@",clientId:"WebAppClient_"+parseInt(1e3*Math.random()),reconnectPeriod:2e3,protocolVersion: 4};
    
    // TOPICS MQTT CŨ
    const ONLINE_STATUS_TOPIC = "esp32/bell/status/online";
    const DATA_STATUS_TOPIC = "esp32/bell/data/status";
    const SET_DATA_TOPIC = "esp32/bell/data/set";
    const GET_DATA_TOPIC = "esp32/bell/data/get";
    const CONTROL_TOPIC = "esp32/bell/control";
    const SYS_INFO_TOPIC = "esp32/bell/status/sysinfo";
    const MANAGE_ADD_TOPIC = "esp32/bell/manage/add";
    const MANAGE_REMOVE_TOPIC = "esp32/bell/manage/remove";
    const MANAGE_STATUS_TOPIC = "esp32/bell/manage/status";
    const COMMAND_ACK_TOPIC = "esp32/bell/command/ack";
    const OTA_COMMAND_TOPIC = "esp32/bell/ota/command";
    const OTA_DATA_TOPIC = "esp32/bell/ota/data";
    const OTA_STATUS_TOPIC = "esp32/bell/ota/status";
    const OTA_SATELLITE_COMMAND_TOPIC_PREFIX = "esp32/bell/ota/satellite/command/";
    const OTA_SATELLITE_DATA_TOPIC_PREFIX = "esp32/bell/ota/satellite/data/";
    const OTA_SATELLITE_STATUS_TOPIC = "esp32/bell/ota/satellite/status";
    
    // [MỚI] TOPICS MQTT CHO ĐIỀU KHIỂN NHẠC
    const MUSIC_CONTROL_TOPIC = "esp32/bell/music/control";
    const MUSIC_STATUS_TOPIC = "esp32/bell/music/status";


    function connectToMqtt(){
        console.log("Đang kết nối đến MQTT broker...");
        const schoolNameStatus = document.getElementById("school-name-status");
        schoolNameStatus.className = 'status-color-connecting';
        
        client=mqtt.connect(brokerUrl,options);
        
        client.on("connect",()=>{
            console.log("Đã kết nối thành công đến MQTT broker!");
            const topicsToSubscribe = [
                DATA_STATUS_TOPIC, 
                ONLINE_STATUS_TOPIC, 
                SYS_INFO_TOPIC, 
                MANAGE_STATUS_TOPIC, 
                COMMAND_ACK_TOPIC, 
                OTA_STATUS_TOPIC,
                OTA_SATELLITE_STATUS_TOPIC,
                MUSIC_STATUS_TOPIC // [MỚI] Đăng ký nhận topic trạng thái nhạc
            ];
            client.subscribe(topicsToSubscribe, {qos:1}, (err)=>{
                if(err) {
                    console.error("Lỗi khi đăng ký topic:", err);
                } else {
                    console.log("Đăng ký nhận các topic thành công!");
                    client.publish(GET_DATA_TOPIC, '1', { qos: 1 });
                }
            });
        });
        
        client.on("message",(topic, payload)=>{
            const payloadString = payload.toString();
            
            if (topic === ONLINE_STATUS_TOPIC) {
                const schoolNameStatus = document.getElementById("school-name-status");
                if (payloadString === 'online') {
                    schoolNameStatus.className = "status-color-connected";
                    document.getElementById('clock-wrapper').style.display = 'block';
                } else {
                    schoolNameStatus.className = "status-color-disconnected";
                    document.getElementById('clock-wrapper').style.display = 'none';
                    serverTime = null;
                }
            }
            
            if (topic === DATA_STATUS_TOPIC && payloadString) {
                _load(payloadString);
            }

            if (topic === SYS_INFO_TOPIC) {
                try {
                    const info = JSON.parse(payloadString);
                    renderSystemInfo(info);
                } catch(e) {
                    console.error("Lỗi parse JSON thông tin hệ thống:", e);
                }
            }
            
            if (topic === MANAGE_STATUS_TOPIC) {
                try {
                    const data = JSON.parse(payloadString);
                    renderDeviceLists(data.managed || [], data.discovered || []);
                } catch(e) {
                    console.error("Lỗi parse JSON quản lý vệ tinh:", e);
                }
            }

            if (topic === COMMAND_ACK_TOPIC) {
                try {
                    const ack = JSON.parse(payloadString);
                    const message = `[${ack.name}] ${ack.message}`;
                    showNotification(message, ack.status || 'success');
                } catch (e) {
                    console.error("Lỗi parse JSON phản hồi lệnh:", e);
                }
            }
            
            if (topic === OTA_STATUS_TOPIC || topic === OTA_SATELLITE_STATUS_TOPIC) {
                try {
                    const status = JSON.parse(payloadString);
                    const deviceName = status.device || (status.name || 'Unknown');
                    
                    let deviceStatusEl = document.getElementById(`ota-status-${deviceName}`);
                    const statusList = document.getElementById('ota-device-status-list');
                    if (!deviceStatusEl) {
                        deviceStatusEl = document.createElement('div');
                        deviceStatusEl.id = `ota-status-${deviceName}`;
                        statusList.appendChild(deviceStatusEl);
                    }
                    
                    let progressText = '';
                    if (status.progress !== undefined) {
                        progressText = `${status.progress}% - `;
                    }
                    deviceStatusEl.textContent = `[${deviceName}]: ${progressText}${status.details}`;

                    if (status.status === 'error') {
                        deviceStatusEl.style.color = '#e74c3c';
                    } else if (status.status === 'success') {
                        deviceStatusEl.style.color = '#2ecc71';
                    } else if (status.status === 'progress' || status.status === 'start') {
                        deviceStatusEl.style.color = '#3498db';
                    } else {
                        deviceStatusEl.style.color = '#bdc3c7';
                    }
                } catch (e) {
                    console.error("Lỗi parse JSON trạng thái OTA:", e);
                }
            }
            
            // [MỚI] XỬ LÝ DỮ LIỆU TỪ TOPIC TRẠNG THÁI NHẠC
            if (topic === MUSIC_STATUS_TOPIC) {
                try {
                    const musicStatus = JSON.parse(payloadString);
                    updateMusicPlayerUI(musicStatus);
                } catch (e) {
                    console.error("Lỗi parse JSON trạng thái nhạc:", e);
                }
            }
        });
        
        client.on("error", e => console.error("Lỗi kết nối MQTT:", e));
        
        client.on("close",()=>{
            console.log("Mất kết nối MQTT. Đang thử kết nối lại...");
            document.getElementById("school-name-status").className = "status-color-disconnected";
            document.getElementById('clock-wrapper').style.display = 'none';
            serverTime = null;
        });
    }

    // [THÊM MỚI] Hàm ẩn/hiện các tùy chọn phát nhạc
    function toggleActionOptions(bellType) {
        const action = document.getElementById(`sohoi_${bellType}_action`).value;
        const musicOptions = document.getElementById(`music_options_${bellType}`);
        const isMusic = action === 'music';
        
        if (isMusic) {
            musicOptions.classList.add('visible');
        } else {
            musicOptions.classList.remove('visible');
        }
    }
    function updateClockAndCountdown() {
    updateLocalClock(); // Gọi hàm cập nhật đồng hồ cũ
    updateCountdown();  // Gọi hàm cập nhật đếm ngược mới
}
    function calculateAndStoreTodaySchedule() {
        if (!window.allData || !window.allData.lich) {
            todaySchedule = [];
            return;
        }

        const dayMap = ['cn', 't2', 't3', 't4', 't5', 't6', 't7'];
        const currentDayKey = dayMap[new Date().getDay()];

        // Tính toán lịch cho cả buổi sáng và chiều
        const morningSchedule = calculateSchedule(`${currentDayKey}_sang`);
        const afternoonSchedule = calculateSchedule(`${currentDayKey}_chieu`);

        // Gộp lịch 2 buổi và sắp xếp lại theo thời gian
        todaySchedule = [...morningSchedule, ...afternoonSchedule].sort((a, b) => a.timeInMinutes - b.timeInMinutes);
        console.log("Đã tính toán lịch cho hôm nay:", todaySchedule);
    }
    function updateCountdown() {
    const countdownEl = document.getElementById('countdown-status');
    if (!serverTime || !countdownEl || todaySchedule.length === 0) {
        countdownEl.innerHTML = ''; // Xóa nội dung nếu không có dữ liệu
        return;
    }

    // Lấy thời gian hiện tại (tính bằng phút từ đầu ngày)
    const nowInMinutes = serverTime.getHours() * 60 + serverTime.getMinutes();

    // Tìm sự kiện tiếp theo trong lịch trình của ngày hôm nay
    const nextEvent = todaySchedule.find(event => event.timeInMinutes > nowInMinutes);

    if (!nextEvent) {
        countdownEl.innerHTML = "Đã hết lịch học hôm nay.";
        return;
    }

    // Tính toán thời gian còn lại (tính bằng giây)
    const nowInSeconds = serverTime.getHours() * 3600 + serverTime.getMinutes() * 60 + serverTime.getSeconds();
    const nextEventInSeconds = nextEvent.timeInMinutes * 60;
    const secondsRemaining = nextEventInSeconds - nowInSeconds;

    if (secondsRemaining < 0) return; // Bỏ qua nếu có lỗi tính toán

    // Định dạng thời gian còn lại thành MM:SS
    const minutes = Math.floor(secondsRemaining / 60);
    const seconds = secondsRemaining % 60;
    const countdownText = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

    // Tạo thông báo mô tả sự kiện
    let message = "";
    const description = nextEvent.description;

    if (description.includes("Vào tiết")) {
        message = `Còn ${countdownText} phút ${description.toLowerCase()}`;
    } else if (description.includes("Ra chơi")) {
        // "Ra chơi tiết 1" nghĩa là "Hết tiết 1"
        const tiet = description.match(/\d+/); // Lấy số từ chuỗi
        if (tiet) {
            message = `Còn ${countdownText} phút hết tiết ${tiet[0]}`;
        }
    } else if (description.includes("Ra về")) {
        message = `Còn ${countdownText} phút là tan học`;
    } else if (description.includes("Dự vào")) {
        message = `Còn ${countdownText} phút chuẩn bị vào lớp`;
    } else if (description.includes("Chào cờ") || description.includes("Sinh hoạt")) {
        message = `Còn ${countdownText} phút bắt đầu ${description.toLowerCase()}`;
    } else {
        // Trường hợp dự phòng
        message = `Sự kiện tiếp theo: ${description} sau ${countdownText}`;
    }

    // Cập nhật nội dung lên giao diện
    countdownEl.innerHTML = message;
}
    // [THÊM MỚI] Hàm cập nhật danh sách bài hát cho các dropdown trong cài đặt
    function updateTrackSelectors(playlist) {
        const bellTypes = ['batdau', 'vaotiet', 'rachoi', 'duvao'];
        bellTypes.forEach(type => {
            const select = document.getElementById(`sohoi_${type}_track`);
            if (select) {
                const currentVal = select.value;
                select.innerHTML = '<option value="">-- Chọn file nhạc --</option>';
                playlist.forEach(track => {
                    const option = document.createElement('option');
                    option.value = track;
                    option.textContent = track;
                    select.appendChild(option);
                });
                // Khôi phục giá trị đã chọn nếu còn tồn tại
                if (playlist.includes(currentVal)) {
                    select.value = currentVal;
                }
            }
        });
    }

    // [CẬP NHẬT] CÁC HÀM ĐIỀU KHIỂN VÀ CẬP NHẬT GIAO DIỆN NHẠC
    function updateMusicPlayerUI(status) {
        // Cập nhật danh sách phát (playlist)
        const playlistContainer = document.getElementById('music-playlist-container');
        const trackSelect = document.getElementById('schedule-music-track-select');
        if (status.playlist && Array.isArray(status.playlist)) {
            playlistContainer.innerHTML = '';
            trackSelect.innerHTML = '<option value="">-- Chọn bài hát --</option>';
            if(status.playlist.length === 0) {
                 playlistContainer.innerHTML = '<p class="list-placeholder">Không tìm thấy file nhạc nào trên thẻ nhớ.</p>';
            } else {
                status.playlist.forEach(track => {
                    const item = document.createElement('div');
                    item.className = 'playlist-item';
                    item.textContent = track;
                    item.onclick = () => handleMusicControl('play_track', track);
                    if (track === status.current_track) {
                        item.classList.add('playing');
                    }
                    playlistContainer.appendChild(item);

                    const option = document.createElement('option');
                    option.value = track;
                    option.textContent = track;
                    trackSelect.appendChild(option);
                });
            }

            // [THÊM MỚI] Gọi hàm cập nhật các dropdown trong cài đặt
            updateTrackSelectors(status.playlist);
        }

        // Cập nhật thông tin bài hát đang phát
        document.getElementById('now-playing-title').textContent = status.current_track || 'Chưa có bài hát nào được chọn';

        // Cập nhật nút Play/Pause
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        if (status.status === 'playing') {
            playIcon.style.display = 'none';
            pauseIcon.style.display = 'block';
        } else {
            playIcon.style.display = 'block';
            pauseIcon.style.display = 'none';
        }

        // Cập nhật thanh tiến trình và thời gian
        document.getElementById('music-progress-bar').value = status.progress || 0;
        document.getElementById('current-time').textContent = formatTime(status.current_time_s || 0);
        document.getElementById('total-time').textContent = formatTime(status.total_time_s || 0);

        // Cập nhật thanh âm lượng
        document.getElementById('volume-slider').value = status.volume === undefined ? 50 : Math.round(status.volume / 30 * 100);

        // Cập nhật các chế độ phát
        document.getElementById('shuffle-btn').classList.toggle('active', status.shuffle_mode || false);
        document.getElementById('repeat-btn').classList.toggle('active', status.repeat_mode || false);
        
        // Cập nhật bảng hẹn giờ
        const scheduleTableBody = document.querySelector('#music-schedule-table tbody');
        scheduleTableBody.innerHTML = '';
        if (status.schedules && Array.isArray(status.schedules)) {
            status.schedules.forEach((sch, index) => {
                const row = scheduleTableBody.insertRow();
                row.innerHTML = `
                    <td>${sch.time}</td>
                    <td>${sch.track_name}</td>
                    <td>${sch.days.join(', ')}</td>
                    <td><button class="delete-schedule-btn" onclick="deleteMusicSchedule(${index})">Xóa</button></td>
                `;
            });
        }
    }

    function handleMusicControl(command, value = null) {
        if (!client || !client.connected) return showNotification("Chưa kết nối máy chủ!", 'error');
        const payload = { command: command };
        if (value !== null) {
             if (command === 'set_volume') {
                payload.value = Math.round(parseInt(value) / 100 * 30);
            } else {
                payload.value = value;
            }
        }
        client.publish(MUSIC_CONTROL_TOPIC, JSON.stringify(payload), { qos: 1 });
    }
    
    function togglePlayMode(mode) {
        handleMusicControl(`toggle_${mode}`);
    }

    function addMusicSchedule() {
        const time = document.getElementById('schedule-music-time').value;
        const track = document.getElementById('schedule-music-track-select').value;
        const selectedDays = Array.from(document.querySelectorAll('input[name="music-day"]:checked')).map(cb => cb.value);

        if (!time || !track || selectedDays.length === 0) {
            return showNotification("Vui lòng điền đầy đủ thông tin hẹn giờ!", "error");
        }

        const schedule = { time: time, track_name: track, days: selectedDays };
        handleMusicControl('schedule_add', schedule);
    }

    function deleteMusicSchedule(index) {
        if (confirm(`Bạn có chắc muốn xóa lịch phát này không?`)) {
            handleMusicControl('schedule_remove', index);
        }
    }

    function formatTime(seconds) {
        if (isNaN(seconds) || seconds < 0) return "00:00";
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
    }

    // =======================================================

    function showNotification(message, type = 'success') {
        const area = document.getElementById('notification-area');
        const notif = document.createElement('div');
        notif.className = `notification ${type}`;
        notif.textContent = message;
        area.appendChild(notif);
        
        setTimeout(() => { notif.classList.add('show'); }, 10);

        setTimeout(() => {
            notif.classList.remove('show');
            setTimeout(() => {
                if(area.contains(notif)) {
                    area.removeChild(notif);
                }
            }, 300);
        }, 4000);
    }
    
    function openAdvancedSettingsModal() {
        document.getElementById('advanced-settings-modal').classList.add('visible');
        if (document.getElementById('adv-tab-system').classList.contains('active')) {
            requestSystemInfo();
        }
    }
    function closeAdvancedSettingsModal() {
        document.getElementById('advanced-settings-modal').classList.remove('visible');
    }
    function switchAdvTab(evt, tabName) {
        document.querySelectorAll('.adv-modal-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.adv-modal-tab-content').forEach(content => content.classList.remove('active'));
        evt.currentTarget.classList.add('active');
        document.getElementById(tabName).classList.add('active');
        
        if (tabName === 'adv-tab-system' || tabName === 'adv-tab-reset-esp') {
            requestSystemInfo(); // Gửi lệnh lấy dữ liệu từ ESP
        }
    }
    function saveAutoRestartConfig() {
    const days = document.getElementById('auto-restart-days-input').value;
    const timeVal = document.getElementById('auto-restart-time-input').value;

    if (days < 0 || days > 30) {
        showNotification("Số ngày không hợp lệ (0-30)", "error");
        return;
    }
    
    // Nếu nhập ngày > 0 mà không chọn giờ, báo lỗi
    if (days > 0 && !timeVal) {
        showNotification("Vui lòng chọn giờ thực hiện!", "error");
        return;
    }

    let hour = 0, minute = 0;
    if (timeVal) {
        const parts = timeVal.split(':');
        hour = parseInt(parts[0]);
        minute = parseInt(parts[1]);
    }
    
    if (client && client.connected) {
        const payload = {
            command: "SET_AUTO_RESTART",
            days: parseInt(days),
            hour: hour,
            minute: minute
        };
        client.publish(CONTROL_TOPIC, JSON.stringify(payload), { qos: 1 });
        showNotification("Đã gửi cài đặt tự động khởi động lại.", "success");
    } else {
        showNotification("Chưa kết nối máy chủ!", "error");
    }
}
    function renderSystemInfo(info) {
        
        
        // 1. CẬP NHẬT CÁC Ô NHẬP LIỆU AUTO RESET (Phần Mới)
        // Cập nhật số ngày
        if (info.restart_days !== undefined) {
            const dayInput = document.getElementById('auto-restart-days-input');
            if (dayInput) {
                dayInput.value = info.restart_days;
            }
        }
        
        // Cập nhật giờ thực hiện (Định dạng HH:MM)
        if (info.restart_hour !== undefined && info.restart_minute !== undefined) {
            const timeInput = document.getElementById('auto-restart-time-input');
            if (timeInput) {
                // Chuyển đổi số thành chuỗi 2 ký tự (ví dụ: 1 -> "01")
                const h = String(info.restart_hour).padStart(2, '0');
                const m = String(info.restart_minute).padStart(2, '0');
                timeInput.value = `${h}:${m}`;
            }
        }

        // 2. VẼ DANH SÁCH THÔNG TIN HỆ THỐNG (Phần Cũ)
        const listDiv = document.getElementById('system-info-actions-list');
        if (!listDiv) return;
        listDiv.innerHTML = ''; 

        const createItem = (icon, title, value, valueClass = '') => {
            return `
                <div class="action-item">
                    <div class="action-icon">${icon}</div>
                    <div class="action-text">
                        <div class="title">${title}</div>
                        <div class="description ${valueClass}">${value}</div>
                    </div>
                </div>
            `;
        };

        // Định nghĩa các Icon (SVG)
        const wifiIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C7.486 2 3.407 3.585 0 6l1.414 1.414C4.195 5.53 7.855 4 12 4s7.805 1.53 10.586 3.414L24 6C20.593 3.585 16.514 2 12 2zm0 4c-3.145 0-6.195 1.229-8.485 3.414L5.414 11.31C7.21 9.898 9.51 9 12 9s4.79 0.898 6.586 2.31l1.899-1.898C18.195 7.229 15.145 6 12 6zm0 5c-1.854 0-3.58.718-4.828 1.968L9.07 14.864C9.945 14.18 10.94 13.8 12 13.8s2.055 0.38 2.93 1.064l1.898-1.898C15.58 11.718 13.854 11 12 11zm0 4.2c-0.828 0-1.5 0.672-1.5 1.5s0.672 1.5 1.5 1.5 1.5-0.672 1.5-1.5-0.672-1.5-1.5-1.5z"></path></svg>';
        const ipIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm-1.999 14.413-3.713-3.713 1.414-1.414 2.299 2.299 4.949-4.95 1.414 1.414-6.363 6.364z"></path></svg>';
        const rtcIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v5.414l3.293 3.293 1.414-1.414L13 11.586z"></path></svg>';
        const lcdIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 3H4c-1.103 0-2 .897-2 2v11c0 1.103.897 2 2 2h3l-1 2v1h12v-1l-1-2h3c1.103 0 2-.897 2-2V5c0-1.103-.897-2-2-2zM4 14V5h16l.002 9H4z"></path></svg>';
        const flashIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"></path></svg>';
        const ramIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 5h16v2H4zm0 4h16v2H4zm0 4h16v2H4zm0 4h16v2H4z"></path></svg>';
        const mp3Icon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"></path></svg>';
        
        // Thêm các dòng thông tin vào danh sách
        listDiv.innerHTML += createItem(wifiIcon, 'Tên WiFi (SSID)', info.ssid || 'N/A');
        listDiv.innerHTML += createItem(ipIcon, 'Địa chỉ IP', info.ip || 'N/A');
        
        // Module RTC
        listDiv.innerHTML += createItem(
            rtcIcon, 
            'Module RTC', 
            info.rtc ? 'Đã kết nối' : 'Không tìm thấy', 
            info.rtc ? 'description connected' : 'description disconnected'
        );
        
        // Module LCD
        listDiv.innerHTML += createItem(
            lcdIcon, 
            'Màn hình LCD', 
            info.lcd ? 'Đã kết nối' : 'Không tìm thấy', 
            info.lcd ? 'description connected' : 'description disconnected'
        );
        
        // Module MP3
        listDiv.innerHTML += createItem(
            mp3Icon, 
            'Module MP3', 
            info.mp3 ? 'Đã kết nối' : 'Không tìm thấy', 
            info.mp3 ? 'description connected' : 'description disconnected'
        );

        // Flash & RAM
        listDiv.innerHTML += createItem(flashIcon, 'Bộ nhớ Flash', `${info.flash_usage || 'N/A'} % (${info.running_partition || ''})`);
        listDiv.innerHTML += createItem(ramIcon, 'RAM trong (SRAM)', `${info.sram_usage_percent || 'N/A'} % (Còn trống ${info.sram_free_kb || 'N/A'} KB)`);
        listDiv.innerHTML += createItem(ramIcon, 'RAM ngoài (PSRAM)', `${info.psram_usage_percent || 'N/A'} % (Còn trống ${info.psram_free_mb || 'N/A'} MB)`);
    }

    function requestSystemInfo() {
        if (client && client.connected) {
            client.publish(CONTROL_TOPIC, "GET_SYS_INFO", {qos: 1});
        } else {
            showNotification("Chưa kết nối đến máy chủ!", 'error');
        }
    }

    function openPasswordModal(deviceName, action) {
        targetDevice = deviceName;
        targetAction = action;
        const titleEl = document.getElementById('password-modal-title');
        const descEl = document.getElementById('password-modal-description');

        if (action === 'wifi') {
            titleEl.textContent = `Reset WiFi cho ${deviceName}`;
            descEl.textContent = `Hành động này sẽ xóa cấu hình WiFi đã lưu trên ${deviceName}.`;
        } else if (action === 'restart') {
            titleEl.textContent = `Khởi động lại ${deviceName}`;
            descEl.textContent = `Hành động này sẽ khởi động lại thiết bị ${deviceName}.`;
        }

        document.getElementById('password-modal-overlay').classList.add('visible');
        document.getElementById('admin-password-input').focus();
    }

    function closePasswordModal() {
        document.getElementById('password-modal-overlay').classList.remove('visible');
        document.getElementById('admin-password-input').value = '';
        targetDevice = null;
        targetAction = null;
    }
    
    function confirmAction() {
        const password = document.getElementById('admin-password-input').value;
        if (!password) {
            showNotification('Vui lòng nhập mật khẩu!', 'error');
            return;
        }
        if (!targetDevice || !targetAction) {
            console.error("Lỗi: Không có thiết bị hoặc hành động nào được chọn.");
            closePasswordModal();
            return;
        }

        let payload = {
            target: targetDevice,
            admin_pass: password
        };
        let notificationText = '';

        if (targetAction === 'wifi') {
            payload.command = "RESET_WIFI";
            notificationText = `Đã gửi lệnh Reset WiFi đến ${targetDevice}...`;
        } else if (targetAction === 'restart') {
            payload.command = "RESTART_ESP";
            notificationText = `Đã gửi lệnh khởi động lại đến ${targetDevice}...`;
        } else {
            console.error("Hành động không xác định:", targetAction);
            closePasswordModal();
            return;
        }

        if (client && client.connected) {
            client.publish(CONTROL_TOPIC, JSON.stringify(payload), { qos: 1 });
            showNotification(notificationText);
        } else {
            showNotification("Chưa kết nối đến máy chủ!", 'error');
        }
        closePasswordModal();
    }

    function handleChangePassword() {
        const oldPass = document.getElementById('old-admin-password').value;
        const newPass = document.getElementById('new-admin-password').value;
        const confirmPass = document.getElementById('confirm-admin-password').value;

        if (!oldPass || !newPass || !confirmPass) {
            showNotification('Vui lòng điền đầy đủ thông tin!', 'error');
            return;
        }
        if (newPass !== confirmPass) {
            showNotification('Mật khẩu mới không khớp!', 'error');
            return;
        }
        if (newPass.length < 8) {
            showNotification('Mật khẩu mới phải có ít nhất 8 ký tự!', 'error');
            return;
        }

        if (client && client.connected) {
            const payload = {
                command: "CHANGE_PASSWORD",
                old_pass: oldPass,
                new_pass: newPass
            };
            client.publish(CONTROL_TOPIC, JSON.stringify(payload), { qos: 1 });
            showNotification("Đã gửi yêu cầu thay đổi mật khẩu...");
            document.getElementById('old-admin-password').value = '';
            document.getElementById('new-admin-password').value = '';
            document.getElementById('confirm-admin-password').value = '';
        } else {
            showNotification("Chưa kết nối đến máy chủ!", 'error');
        }
    }

    function addSatellite(deviceName) {
        if (client && client.connected) {
            client.publish(MANAGE_ADD_TOPIC, deviceName, { qos: 1 });
        } else {
            showNotification("Chưa kết nối đến máy chủ!", 'error');
        }
    }
    function removeSatellite(deviceName) {
        if (confirm(`Bạn có chắc muốn ngừng quản lý thiết bị "${deviceName}" không?`)) {
            if (client && client.connected) {
                client.publish(MANAGE_REMOVE_TOPIC, deviceName, { qos: 1 });
            } else {
                showNotification("Chưa kết nối đến máy chủ!", 'error');
            }
        }
    }
    
    function renderDeviceLists(managed, discovered) {
        const managedListDiv = document.getElementById('managed-devices-list');
        const discoveredListDiv = document.getElementById('discovered-devices-list');
        const resetWifiListDiv = document.getElementById('reset-wifi-actions-list');
        const resetEspListDiv = document.getElementById('reset-esp-actions-list');
        const otaDeviceListDiv = document.getElementById('ota-device-selection-list');

        managedListDiv.innerHTML = '';
        discoveredListDiv.innerHTML = '';
        resetWifiListDiv.innerHTML = '';
        resetEspListDiv.innerHTML = '';
        otaDeviceListDiv.innerHTML = '';

        if (managed.length === 0) {
            managedListDiv.innerHTML = '<p class="list-placeholder">Chưa có thiết bị nào được quản lý.</p>';
        } else {
            managed.forEach(dev => {
                const item = document.createElement('div');
                item.className = 'device-item';
                const statusClass = dev.online ? 'connected' : 'disconnected';
                const statusText = dev.online ? 'Online' : 'Offline';
                const rssiText = dev.rssi ? `${dev.rssi} dBm` : 'N/A';
                const uptimeText = dev.uptime || 'N/A';
                const ipText = dev.ip || 'N/A';
                item.innerHTML = `
                    <div class="device-item-header">
                        <span class="device-name">${dev.name}</span>
                        <span class="device-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="device-info-grid">
                        <span><span class="label">IP:</span> ${ipText}</span>
                        <span><span class="label">Sóng WiFi:</span> ${rssiText}</span>
                        <span style="grid-column: 1 / -1;"><span class="label">Uptime:</span> ${uptimeText}</span>
                    </div>
                    <div class="device-actions">
                        <button class="device-action-btn cancel-btn" onclick="removeSatellite('${dev.name}')">Hủy</button>
                    </div>
                `;
                managedListDiv.appendChild(item);
            });
        }

        if (discovered.length === 0) {
            discoveredListDiv.innerHTML = '<p class="list-placeholder">Không phát hiện thiết bị mới nào.</p>';
        } else {
            discovered.forEach(dev => {
                const item = document.createElement('div');
                item.className = 'device-item';
                item.style.flexDirection = 'row';
                item.style.justifyContent = 'space-between';
                item.innerHTML = `
                    <div class="device-info">
                        <span class="device-name">${dev.name}</span>
                        <div class="device-info-grid" style="grid-template-columns: 1fr; font-size: 0.8em;">
                           <span><span class="label">IP:</span> ${dev.ip || 'N/A'}</span>
                        </div>
                    </div>
                    <button class="device-action-btn add-btn" onclick="addSatellite('${dev.name}')">Thêm</button>
                `;
                discoveredListDiv.appendChild(item);
            });
        }
        
        const allDevices = [{ name: 'ESP32-MayChu', type: 'Máy Chủ' }, ...managed.map(d => ({...d, type: 'Vệ tinh'}))];

        const createOtaDeviceCheckbox = (deviceName, deviceType) => {
            return `
                <label>
                    <input type="checkbox" class="ota-target-checkbox" value="${deviceName}">
                    <span>${deviceName} <em style="color:#bdc3c7; font-size: 0.9em;">(${deviceType})</em></span>
                </label>
            `;
        };

        if(allDevices.length > 0) {
            allDevices.forEach(dev => {
                otaDeviceListDiv.innerHTML += createOtaDeviceCheckbox(dev.name, dev.type);

                resetWifiListDiv.innerHTML += `
                    <div class="action-item">
                        <div class="action-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 13h-2v-2h2v2zm0-4h-2V7h2v2z"></path></svg>
                        </div>
                        <div class="action-text">
                            <div class="title">${dev.name}</div>
                            <div class="description">Xóa cấu hình WiFi của thiết bị ${dev.type} này.</div>
                        </div>
                        <button class="action-btn reset" onclick="openPasswordModal('${dev.name}', 'wifi')">Reset WiFi</button>
                    </div>
                `;
                
                resetEspListDiv.innerHTML += `
                    <div class="action-item">
                         <div class="action-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13.5 2.5a1 1 0 1 0-2 0v2.4a6.5 6.5 0 1 0 9.9 7.4 1 1 0 1 0-1.8-1a4.5 4.5 0 1 1-6.6-5.9V8a1 1 0 1 0 2 0V2.5z"></path></svg>
                        </div>
                        <div class="action-text">
                            <div class="title">${dev.name}</div>
                            <div class="description">Khởi động lại thiết bị ${dev.type} này.</div>
                        </div>
                        <button class="action-btn reset" style="background-color: #e67e22;" onclick="openPasswordModal('${dev.name}', 'restart')">Restart</button>
                    </div>
                `;
            });
        } else {
            otaDeviceListDiv.innerHTML = '<p class="list-placeholder">Không có thiết bị nào.</p>';
        }
    }

function _load(e) {
    try {
        const t = JSON.parse(e);
        window.allData = null; 

        if (t.data) { // Cấu trúc mới
            if (t.data.epoch) setTime(t.data.epoch);
            if (t.data.schedule) {
                window.allData = t.data.schedule;
                populateForm(t.data.schedule);
                calculateAndStoreTodaySchedule();
                
            }
            if (t.data.holidays) loadHolidayData(t.data.holidays);
            if (t.data.scenario) {
                console.log("Nhan du lieu scenario tu MQTT, dang cap nhat UI...");
                renderSavedScenario(t.data.scenario);
                
                // Đồng bộ lại localStorage với dữ liệu mới nhất từ thiết bị
                localStorage.setItem('savedScenario', JSON.stringify(t.data.scenario));
            }

        } else { // Cấu trúc cũ (dự phòng)
             if (t.epoch) setTime(t.epoch);
             if (t.schedule) {
                window.allData = t.schedule;
                populateForm(t.schedule);
                calculateAndStoreTodaySchedule();
                
             }
             if (t.holidays) loadHolidayData(t.holidays);
             // Cấu trúc cũ không có kịch bản nên không cần làm gì thêm.
        }

    } catch (error) {
        console.error("Lỗi parse JSON từ MQTT:", error);
    }
}
    // =======================================================
// === [THÊM MỚI] HÀM XỬ LÝ LỊCH NGHỈ LỄ KHI TẢI TRANG ===
// =======================================================
function loadHolidayData(holidays) {
    if (holidays) {
        console.log("Nhan du lieu lich nghi le tu ESP32:", holidays);
        // Lưu dữ liệu vào biến toàn cục để các hàm khác sử dụng
        holidayData = holidays;

        // Vẽ lại giao diện lịch với dữ liệu mới
        // Hàm này sẽ tự động đọc biến holidayData và tô màu đúng các ngày nghỉ
        generateCalendar(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth());
    }
}
    function publishUpdate() {
    if (!client || !client.connected) return showNotification("Chưa kết nối máy chủ!", 'error');
    try {
        const scheduleData = gatherDataFromForm();
        const payload = {
            schedule: scheduleData,
            holidays: holidayData
        };
        const payloadString = JSON.stringify(payload);
        client.publish(SET_DATA_TOPIC, payloadString, { qos: 1, retain: true });
        showNotification("Đã gửi lệnh cập nhật Lịch học & Lịch nghỉ...", 'success');
    } catch (e) {
        showNotification("Lỗi: " + e.message, 'error');
        console.error(e)
    }
}
    
    function publishTestBell(){
        if(client&&client.connected) {
            const payload = { command: "TEST_BELL" };
            client.publish(CONTROL_TOPIC, JSON.stringify(payload), {qos:1});
            showNotification("Đã gửi lệnh thử chuông chung...");
        } else {
            showNotification("Chưa kết nối máy chủ!", 'error');
        }
    }
    
    function manualSyncTime() {
    if (!client || !client.connected) {
        return showNotification("Chưa kết nối máy chủ!", 'error');
    }
    // Gửi một lệnh đơn giản đến ESP32 để yêu cầu nó tự đồng bộ NTP
    const payload = { command: "TRIGGER_NTP_SYNC" };
    client.publish(CONTROL_TOPIC, JSON.stringify(payload), { qos: 1 });
    showNotification("Đã gửi yêu cầu đồng bộ thời gian NTP...", 'info');
}
    function logout(){sessionStorage.removeItem("isLoggedIn"),window.location.href="login.html"}
    function setTime(e){isNaN(e)||e<1e5?(console.log("Invalid epoch received, clock not set:",e),serverTime=null):(serverTime=new Date(1e3*e),document.getElementById("date").innerHTML=serverTime.toLocaleDateString("vi-VN",{weekday:"long",year:"numeric",month:"long",day:"numeric",timeZone:"Asia/Ho_Chi_Minh"}),updateLocalClock())}
    function updateLocalClock(){serverTime&&(serverTime.setSeconds(serverTime.getSeconds()+1),document.getElementById("clock").innerHTML=serverTime.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:"Asia/Ho_Chi_Minh",hour12:!1}))}
    
    function toggleSettings(headerElement) {
        const content = headerElement.nextElementSibling;
        if (content && content.classList.contains('collapsible-settings')) {
            headerElement.classList.toggle('expanded');
            content.classList.toggle('expanded');
        }
    }

    function toggleScheduleActivation(dayId) {
        const isEnabled = document.getElementById(`enable_${dayId}`).checked;
        const enableItem = document.getElementById(`toggle_item_enable_${dayId}`);
        const specialItem = document.getElementById(`toggle_item_special_${dayId}`);
        const duvaoItem = document.getElementById(`toggle_item_duvao_${dayId}`);
        const settingsContainer = document.getElementById(`settings_container_${dayId}`);
        const isChieu = dayId.includes('_chieu');

        if (isEnabled) {
            if (enableItem) {
                enableItem.classList.add('active');
                if (isChieu) enableItem.classList.add('chieu-style');
            }
            if (specialItem) specialItem.classList.remove('disabled');
            if (duvaoItem) duvaoItem.classList.remove('disabled');
            if (settingsContainer) settingsContainer.classList.remove('hidden');
        } else {
            if (enableItem) {
                enableItem.classList.remove('active', 'chieu-style');
            }
            if (specialItem) specialItem.classList.add('disabled');
            if (duvaoItem) duvaoItem.classList.add('disabled');
            if (settingsContainer) settingsContainer.classList.add('hidden');
        }
    }

    function toggleSpecialEvent(dayId) {
        const checkbox = document.getElementById(`has_special_${dayId}`);
        const container = document.getElementById(`special_event_container_${dayId}`);
        if (container) {
            container.style.display = checkbox.checked ? 'grid' : 'none'; // Use grid for consistency
        }
    }

    function toggleDuVao(dayId) {
        const checkbox = document.getElementById(`has_duvao_${dayId}`);
        const inputWrapper = document.getElementById(`duvao_wrapper_${dayId}`);
        if (inputWrapper) {
            inputWrapper.style.display = checkbox.checked ? 'flex' : 'none';
        }
    }

    // =======================================================
    // === [NÂNG CẤP] CÁC HÀM TẠO GIAO DIỆN VÀ TÍNH TOÁN LỊCH HỌC ===
    // =======================================================

    const createDayContent = (e, t, o) => {
        const isMondayMorning = (e === 't2_sang');
        
        // Icons
        const d = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v5.414l3.293 3.293 1.414-1.414L13 11.586z"></path></svg></div>`;
        const r = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 4h-2V2h-2v2H9V2H7v2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2zm-1 15H6V7h12v12z"></path></svg></div>`;
        const l = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 2H6c-1.206 0-3 .799-3 3v14c0 2.201 1.794 3 3 3h15v-2H6.012C5.55 19.988 5 19.806 5 19s.55-.988 1.012-1H21V4c0-1.103-.897-2-2-2zm0 13H6V5h13v10z"></path></svg></div>`;
        const c = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18 5h-2V2H8v3H6c-1.654 0-3 1.346-3 3v6c0 1.654 1.346 3 3 3h1v1c0 .552.447 1 1 1h6c.553 0 1-.448 1-1v-1h1c1.654 0 3-1.346 3-3V8c0-1.654-1.346-3-3-3zm1 9c0 .552-.447 1-1 1H6c-.553 0-1-.448-1-1V8c0-.552.447-1 1-1h12c.553 0 1 .448 1 1v6z"></path></svg></div>`;
        const m = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M14 12V8h-4v4H8l4 4 4-4h-2z"></path></svg></div>`;
        const p = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h2v2H4zm0 5h2v2H4zm0 5h2v2H4zm16-8V6H8v2h12zm0 5H8v2h12zm0 5H8v2h12z"></path></svg></div>`;
        
        // [NÂNG CẤP] Tạo HTML cho khu vực sự kiện đặc biệt, bao gồm cả ô nhập thời gian chuẩn bị
        const specialEventInput = isMondayMorning 
            ? `<div class="setting-item full-width">${r}<div class="input-wrapper"><label for="chaoco_${e}">TG Chào cờ</label><div class="unit-input"><input id="chaoco_${e}" type="number" value="40"><span>phút</span></div></div></div>`
            : `<div class="setting-item full-width">${r}<div class="input-wrapper"><label for="chunhiem_${e}">TG Sinh hoạt</label><div class="unit-input"><input id="chunhiem_${e}" type="number" value="15"><span>phút</span></div></div></div>`;
        const prepareAfterSpecialInput = `<div class="setting-item full-width">${m}<div class="input-wrapper"><label for="prepare_after_special_${e}">TG chuẩn bị sau SH/CC</label><div class="unit-input"><input id="prepare_after_special_${e}" type="number" value="2"><span>phút</span></div></div></div>`;
        const u = specialEventInput + prepareAfterSpecialInput;

        let g = ""; // Copy button HTML
        if (!isMondayMorning) {
            if (o === 'sang') {
                g = `<div class="copy-button-container"><button class="copy-button sang" onclick="copyMorningSchedule('${e}')">Sao chép đến T3-CN (Sáng)</button></div>`;
            } else { // 'chieu'
                g = `<div class="copy-button-container"><button class="copy-button chieu" onclick="copyAfternoonSchedule('${e}')">Sao chép đến các ngày Chiều</button></div>`;
            }
        }
        
        return `
        <div id="${e}" class="tabcontent">
            <h3 onclick="toggleSettings(this)">Cài đặt Lịch ${t}<br><span class="session-subtitle">(Buổi ${"sang"===o?"Sáng":"Chiều"})</span></h3>
            
            <div class="collapsible-settings">
                <div class="toggle-actions-group">
                    <div id="toggle_item_enable_${e}" class="toggle-action-item">
                        <div class="toggle-action-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42A6.92 6.92 0 0 1 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-1.93.78-3.68 2-4.95L5.59 5.64A8.96 8.96 0 0 0 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.49-1-4.73-2.67-6.41z"/></svg></div>
                        <div class="toggle-action-text">Kích hoạt Lịch</div>
                        <label class="switch ${"chieu"===o?"chieu-toggle":""}">
                            <input type="checkbox" id="enable_${e}" onchange="toggleScheduleActivation('${e}')" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="toggle_item_special_${e}" class="toggle-action-item">
                        <div class="toggle-action-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></div>
                        <div class="toggle-action-text">${isMondayMorning ? 'Có Giờ Chào cờ' : 'Có Giờ Sinh hoạt'}</div>
                        <label class="switch ${"chieu"===o?"chieu-toggle":""}">
                            <input type="checkbox" id="has_special_${e}" onchange="toggleSpecialEvent('${e}')">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="toggle_item_duvao_${e}" class="toggle-action-item">
                        <div class="toggle-action-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M10 20h4c0 1.1-.9 2-2 2s-2-.9-2-2zm10-2.64V11c0-3.35-2.36-6.15-5.5-6.83V3.5c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5V4.17C8.36 4.85 6 7.65 6 11v6.36L4 19.72V20h16v-.28l-2-2.36zM15 11h2v2h-2v-2zm-4 0h2v2h-2v-2zm-4 0h2v2H7v-2z"/></svg></div>
                        <div class="toggle-action-text">Có Chuông Dự vào lớp</div>
                        <label class="switch ${"chieu"===o?"chieu-toggle":""}">
                            <input type="checkbox" id="has_duvao_${e}" onchange="toggleDuVao('${e}')" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div id="settings_container_${e}" class="settings-grid-container">
                    ${g}
                    <hr style="margin: 15px; background: #414345; height: 1px; opacity: 0.5;">

                    <div class="settings-grid">
                        <div class="setting-item full-width">${d}<div class="input-wrapper"><label for="gio_${e}">Giờ vào học</label><input id="gio_${e}" type="time"></div></div>
                        
                        <div id="special_event_container_${e}" class="settings-grid full-width" style="display: none; grid-template-columns: 1fr; gap: 8px; padding: 0;">${u}</div>
                        
                        <div class="setting-item">${l}<div class="input-wrapper"><label for="tiethoc_${e}">TG Tiết học</label><div class="unit-input"><input id="tiethoc_${e}" type="text" value="45"><span>phút</span></div><div class="input-helper-text">VD: 45,45,45,30</div></div></div>
                        <div class="setting-item">${c}<div class="input-wrapper"><label for="rachoi_${e}">TG Ra chơi</label><div class="unit-input"><input id="rachoi_${e}" type="text" value="5"><span>phút</span></div><div class="input-helper-text">VD: 5,15,5,5</div></div></div>
                        <div class="setting-item" id="duvao_wrapper_${e}">${m}<div class="input-wrapper"><label for="duvaotiet_${e}">TG Dự vào</label><div class="unit-input"><input id="duvaotiet_${e}" type="number" value="3"><span>phút</span></div></div></div>
                        <div class="setting-item">${p}<div class="input-wrapper"><label for="sotiet_${e}">Số tiết học</label><div class="unit-input"><input id="sotiet_${e}" type="number" value="5"><span>tiết</span></div></div></div>
                    </div>
                    
                    <button class="modern-btn preview-button" onclick="updatePreviewTable('${e}')" style="height: 40px; font-size: 0.85em; background: #34495e; color: #f1c40f; border: 1px solid #f1c40f; margin-top: 15px;">Cập nhật bảng chi tiết</button>

                </div>
            </div>

            <details style="margin-top: 15px;">
                <summary>Xem chi tiết lịch</summary>
                <div class="details-container" id="details-${e}"></div>
            </details>
        </div>`
    }
    
    const contentWrapper = document.getElementById("tab-content-wrapper");
    const days=[{id:"t2",name:"Thứ 2"},{id:"t3",name:"Thứ 3"},{id:"t4",name:"Thứ 4"},{id:"t5",name:"Thứ 5"},{id:"t6",name:"Thứ 6"},{id:"t7",name:"Thứ 7"},{id:"cn",name:"Chủ Nhật"}];
    
    function populateForm(e){
        const t = e;
        if(t&&t.sohoi&&t.lich){
            document.querySelectorAll('#tab-content-wrapper .tabcontent').forEach(el => el.remove());
            console.log("Bat dau cap nhat form voi du lieu:",t);

            const bellTypes = ["batdau","vaotiet","rachoi","duvao"];
            bellTypes.forEach(type => {
                const numInput = document.getElementById(`sohoi_${type}`);
                if(numInput) numInput.value = t.sohoi[type]?.num || "";

                const actionSelect = document.getElementById(`sohoi_${type}_action`);
                if(actionSelect) actionSelect.value = t.sohoi[type]?.action || "bell";

                const trackSelect = document.getElementById(`sohoi_${type}_track`);
                if(trackSelect) trackSelect.value = t.sohoi[type]?.track || "";

                const volumeSlider = document.getElementById(`sohoi_${type}_volume`);
                if(volumeSlider) volumeSlider.value = t.sohoi[type]?.volume || 25;
                
                if (type === 'rachoi') {
                    const randomCheckbox = document.getElementById('sohoi_rachoi_random');
                    if(randomCheckbox) randomCheckbox.checked = t.sohoi[type]?.random || false;
                }
                toggleActionOptions(type);
            });
            ["tg_reo", "tg_nghi"].forEach(e=>{
                const o=document.getElementById(`sohoi_${e}`);
                o&&(o.value=t.sohoi[e]||"")
            });
            
            days.forEach(day => {
                contentWrapper.innerHTML += createDayContent(`${day.id}_sang`, day.name, "sang");
                contentWrapper.innerHTML += createDayContent(`${day.id}_chieu`, day.name, "chieu");
            });

            ["sang","chieu"].forEach(e=>{
                days.forEach(o=>{
                    const n=t.lich?.[e]?.[o.id];
                    if(n){
                        const dayId = `${o.id}_${e}`;
                        document.getElementById(`enable_${dayId}`).checked=n.enabled;
                        document.getElementById(`gio_${dayId}`).value=n.gio||"";
                        document.getElementById(`tiethoc_${dayId}`).value=n.tiethoc||"";
                        document.getElementById(`rachoi_${dayId}`).value=n.rachoi||"5"; // [NÂNG CẤP]
                        document.getElementById(`duvaotiet_${dayId}`).value=n.duvaotiet||"";
                        document.getElementById(`sotiet_${dayId}`).value=n.sotiet||"";
                        
                        const chaocoInput = document.getElementById(`chaoco_${dayId}`);
                        if(chaocoInput) chaocoInput.value=n.chaoco||0;
                        
                        const chunhiemInput = document.getElementById(`chunhiem_${dayId}`);
                        if(chunhiemInput) chunhiemInput.value=n.chunhiem||0;
                        
                        // [NÂNG CẤP & SỬA LỖI] Tải dữ liệu cho trường mới và xử lý đúng giá trị 0
                        const prepareSpecialInput = document.getElementById(`prepare_after_special_${dayId}`);
                        if(prepareSpecialInput) prepareSpecialInput.value = n.prepare_after_special ?? 0;
                        
                        const hasSpecialCheckbox = document.getElementById(`has_special_${dayId}`);
                        if (hasSpecialCheckbox) {
                            hasSpecialCheckbox.checked = n.has_special_event || false;
                            toggleSpecialEvent(dayId);
                        }
                        
                        const hasDuVaoCheckbox = document.getElementById(`has_duvao_${dayId}`);
                        if (hasDuVaoCheckbox) {
                            hasDuVaoCheckbox.checked = n.has_duvao_bell === undefined ? true : n.has_duvao_bell;
                            toggleDuVao(dayId);
                        }
                        
                        toggleScheduleActivation(dayId);
                        updatePreviewTable(dayId);
                    }
                })
            });
             showActiveTab();
        } else {
            console.error("Dữ liệu lịch học nhận được không hợp lệ hoặc không đầy đủ:",e)
        }
    }

    function gatherDataFromForm(){
        const e={sohoi:{},lich:{sang:{},chieu:{}}};
        
        const bellTypes = ["batdau","vaotiet","rachoi","duvao"];
        bellTypes.forEach(type => {
            e.sohoi[type] = {
                num: parseInt(document.getElementById(`sohoi_${type}`).value) || 0,
                action: document.getElementById(`sohoi_${type}_action`).value,
                track: document.getElementById(`sohoi_${type}_track`).value,
                volume: parseInt(document.getElementById(`sohoi_${type}_volume`).value) || 0
            };
            if (type === 'rachoi') {
                e.sohoi[type].random = document.getElementById('sohoi_rachoi_random').checked;
            }
        });
        ["tg_reo", "tg_nghi"].forEach(t=>{
            e.sohoi[t]=parseInt(document.getElementById(`sohoi_${t}`).value)||0
        });

        ["sang","chieu"].forEach(t=>{
            days.forEach(o=>{
                const dayId = `${o.id}_${t}`;
                const n=e.lich[t][o.id]={};
                n.enabled=document.getElementById(`enable_${dayId}`).checked;
                n.gio=document.getElementById(`gio_${dayId}`).value;
                n.tiethoc=document.getElementById(`tiethoc_${dayId}`).value || "45";
                n.rachoi=document.getElementById(`rachoi_${dayId}`).value || "5"; // [NÂNG CẤP]
                n.duvaotiet=parseInt(document.getElementById(`duvaotiet_${dayId}`).value)||0;
                n.sotiet=parseInt(document.getElementById(`sotiet_${dayId}`).value)||0;
                
                const chaocoInput = document.getElementById(`chaoco_${dayId}`);
                if(chaocoInput) n.chaoco=parseInt(chaocoInput.value)||0;
                
                const chunhiemInput = document.getElementById(`chunhiem_${dayId}`);
                if(chunhiemInput) n.chunhiem=parseInt(chunhiemInput.value)||0;
                
                // [NÂNG CẤP & SỬA LỖI] Thu thập dữ liệu từ trường mới và xử lý đúng giá trị 0
                const prepareSpecialInput = document.getElementById(`prepare_after_special_${dayId}`);
                if(prepareSpecialInput) {
                    const val = parseInt(prepareSpecialInput.value);
                    n.prepare_after_special = isNaN(val) ? 0 : val;
                }

                const hasSpecialCheckbox = document.getElementById(`has_special_${dayId}`);
                if (hasSpecialCheckbox) n.has_special_event = hasSpecialCheckbox.checked;

                const hasDuVaoCheckbox = document.getElementById(`has_duvao_${dayId}`);
                if (hasDuVaoCheckbox) n.has_duvao_bell = hasDuVaoCheckbox.checked;
            })
        });
        return e;
    }

    function selectDay(evt, day) {
        selectedDay = day;
        document.querySelectorAll('.tablinks-day').forEach(btn => btn.classList.remove('active'));
        evt.currentTarget.classList.add('active');
        showActiveTab();
    }

    function selectSession(evt, session) {
        selectedSession = session;
        document.querySelectorAll('.tablinks-session').forEach(btn => btn.classList.remove('active'));
        evt.currentTarget.classList.add('active');
        showActiveTab();
    }

    function showActiveTab() {
        document.querySelectorAll('.tabcontent').forEach(content => {
            content.classList.remove('active');
        });
        const activeTabId = `${selectedDay}_${selectedSession}`;
        const activeContent = document.getElementById(activeTabId);
        if (activeContent) {
            activeContent.classList.add('active');
        }
    }

    function timeToMinute(e){if(!e)return 0;const[t,o]=e.split(":").map(Number);return 60*t+o}function minuteToTime(e){const t=Math.floor(e/60).toString().padStart(2,"0"),o=(e%60).toString().padStart(2,"0");return`${t}:${o}`}
    
    // [SỬA LỖI] Hàm getVal được viết lại để xử lý đúng giá trị 0
    const getVal = (id, defaultValue = 0) => {
        const el = document.getElementById(id);
        if (!el) return defaultValue;
        const parsedValue = parseInt(el.value);
        return isNaN(parsedValue) ? defaultValue : parsedValue;
    };

    // [NÂNG CẤP TOÀN BỘ] Hàm tính toán lịch học được viết lại để linh hoạt hơn
    function calculateSchedule(dayId) {
    const getVal = (id, defaultValue = 0) => {
        const el = document.getElementById(id);
        if (!el) return defaultValue;
        const parsedValue = parseInt(el.value);
        return isNaN(parsedValue) ? defaultValue : parsedValue;
    };

    const isEnabled = document.getElementById(`enable_${dayId}`)?.checked;
    if (!isEnabled) return [];

    const hasSpecial = document.getElementById(`has_special_${dayId}`)?.checked;
    const hasDuVao = document.getElementById(`has_duvao_${dayId}`)?.checked;

    const startTime = timeToMinute(document.getElementById(`gio_${dayId}`).value);

    // --- [THAY ĐỔI LỚN BẮT ĐẦU TỪ ĐÂY] ---
    const lessonTimeStr = document.getElementById(`tiethoc_${dayId}`).value || '45';
    const lessonTimes = lessonTimeStr.split(',').map(s => parseInt(s.trim()) || 45);
    // --- [KẾT THÚC THAY ĐỔI] ---

    const lessonCount = getVal(`sotiet_${dayId}`, 5);
    const prepareTime = hasDuVao ? getVal(`duvaotiet_${dayId}`, 3) : 0;

    const breakTimeStr = document.getElementById(`rachoi_${dayId}`).value || '5';
    const breakTimes = breakTimeStr.split(',').map(s => parseInt(s.trim()) || 0);

    const isMondayMorning = dayId.includes('t2_sang');
    const specialEventTime = hasSpecial ? getVal(isMondayMorning ? `chaoco_${dayId}` : `chunhiem_${dayId}`) : 0;
    const specialPrepareTime = hasSpecial ? getVal(`prepare_after_special_${dayId}`, 0) : 0;

    if (startTime === 0 || lessonCount === 0) return [];

    let schedule = [];
    let currentTime = startTime;

    if (hasSpecial && specialEventTime > 0) {
        schedule.push({ time: currentTime, description: isMondayMorning ? "Chào cờ" : "Sinh hoạt" });
        currentTime += specialEventTime;

        if (specialPrepareTime > 0) {
            schedule.push({ time: currentTime, description: "Nghỉ sau SH/CC" });
            currentTime += specialPrepareTime;
        }
    }

    for (let i = 1; i <= lessonCount; i++) {
        // Lấy thời gian cho tiết học hiện tại, nếu thiếu thì dùng giá trị cuối cùng
        const currentLessonTime = lessonTimes[i - 1] ?? lessonTimes[lessonTimes.length - 1];

        schedule.push({ time: currentTime, description: `Vào tiết ${i}` });
        currentTime += currentLessonTime; // Sử dụng thời gian tiết học tương ứng

        if (i < lessonCount) {
            const currentBreakTime = breakTimes[i - 1] ?? breakTimes[breakTimes.length - 1]; 

            if (currentBreakTime > 0) {
                schedule.push({ time: currentTime, description: `Ra chơi tiết ${i}` });
                currentTime += currentBreakTime;

                if (prepareTime > 0) {
                    schedule.push({ time: currentTime, description: `Dự vào tiết ${i + 1}` });
                    currentTime += prepareTime;
                }
            }
        }
    }

    schedule.push({ time: currentTime, description: "Ra về" });

    const uniqueSchedule = Array.from(new Map(schedule.map(item => [item.time, item])).values());
    return uniqueSchedule
        .map(item => ({ ...item, timeInMinutes: item.time, time: minuteToTime(item.time) }))
        .sort((a, b) => a.timeInMinutes - b.timeInMinutes);
}

    function updatePreviewTable(e){const t=document.getElementById(`enable_${e}`).checked,o=document.getElementById("details-"+e);if(!o)return;if(!t)return void(o.innerHTML="<p style='text-align:center; padding: 10px;'>Lịch này đang tắt.</p>");const n=calculateSchedule(e);let a="<table><thead><tr><th>STT</th><th>Thời gian</th><th>Nội dung</th></tr></thead><tbody>";n.forEach((e,t)=>{a+=`<tr><td>${t+1}</td><td>${e.time}</td><td>${e.description}</td></tr>`}),a+="</tbody></table>",o.innerHTML=a}
    
    // [NÂNG CẤP] Các hàm sao chép để bao gồm cả trường dữ liệu mới
    function copyAfternoonSchedule(sourceDayId) {
        const sourceDayName = sourceDayId.split('_')[0].toUpperCase();
        if (!confirm(`Bạn có chắc muốn sao chép lịch của ${sourceDayName} (chiều) đến TẤT CẢ các ngày còn lại của buổi chiều không?`)) return;

        const sourceData = {
            enabled: document.getElementById(`enable_${sourceDayId}`).checked,
            gio: document.getElementById(`gio_${sourceDayId}`).value,
            has_special_event: document.getElementById(`has_special_${sourceDayId}`).checked,
            chunhiem: document.getElementById(`chunhiem_${sourceDayId}`).value,
            prepare_after_special: document.getElementById(`prepare_after_special_${sourceDayId}`).value,
            has_duvao_bell: document.getElementById(`has_duvao_${sourceDayId}`).checked,
            tiethoc: document.getElementById(`tiethoc_${sourceDayId}`).value,
            rachoi: document.getElementById(`rachoi_${sourceDayId}`).value,
            duvaotiet: document.getElementById(`duvaotiet_${sourceDayId}`).value,
            sotiet: document.getElementById(`sotiet_${sourceDayId}`).value
        };

        const sourceId = sourceDayId.replace('_chieu', '');
        days.filter(d => d.id !== sourceId).forEach(day => {
            const targetDayId = `${day.id}_chieu`;
            document.getElementById(`enable_${targetDayId}`).checked = sourceData.enabled;
            document.getElementById(`gio_${targetDayId}`).value = sourceData.gio;
            document.getElementById(`has_special_${targetDayId}`).checked = sourceData.has_special_event;
            document.getElementById(`chunhiem_${targetDayId}`).value = sourceData.chunhiem;
            document.getElementById(`prepare_after_special_${targetDayId}`).value = sourceData.prepare_after_special;
            document.getElementById(`has_duvao_${targetDayId}`).checked = sourceData.has_duvao_bell;
            document.getElementById(`tiethoc_${targetDayId}`).value = sourceData.tiethoc;
            document.getElementById(`rachoi_${targetDayId}`).value = sourceData.rachoi;
            document.getElementById(`duvaotiet_${targetDayId}`).value = sourceData.duvaotiet;
            document.getElementById(`sotiet_${targetDayId}`).value = sourceData.sotiet;
            
            toggleSpecialEvent(targetDayId);
            toggleDuVao(targetDayId);
            toggleScheduleActivation(targetDayId);
            updatePreviewTable(targetDayId);
        });
        showNotification('Sao chép thành công! Hãy nhấn "Lưu và gửi cập nhật" để áp dụng.', "success");
    }

    function copyMorningSchedule(sourceDayId) {
        const sourceDayName = sourceDayId.split('_')[0].toUpperCase();
        if (!confirm(`Bạn có chắc muốn sao chép lịch của ${sourceDayName} (sáng) đến các ngày còn lại (T3-CN) không?`)) return;

        const sourceData = {
            enabled: document.getElementById(`enable_${sourceDayId}`).checked,
            gio: document.getElementById(`gio_${sourceDayId}`).value,
            has_special_event: document.getElementById(`has_special_${sourceDayId}`).checked,
            chunhiem: document.getElementById(`chunhiem_${sourceDayId}`).value,
            prepare_after_special: document.getElementById(`prepare_after_special_${sourceDayId}`).value,
            has_duvao_bell: document.getElementById(`has_duvao_${sourceDayId}`).checked,
            tiethoc: document.getElementById(`tiethoc_${sourceDayId}`).value,
            rachoi: document.getElementById(`rachoi_${sourceDayId}`).value,
            duvaotiet: document.getElementById(`duvaotiet_${sourceDayId}`).value,
            sotiet: document.getElementById(`sotiet_${sourceDayId}`).value
        };
        
        const sourceId = sourceDayId.replace('_sang', '');
        const targetDays = ["t3", "t4", "t5", "t6", "t7", "cn"].filter(id => id !== sourceId);
        
        targetDays.forEach(dayId => {
            const targetDayId = `${dayId}_sang`;
            document.getElementById(`enable_${targetDayId}`).checked = sourceData.enabled;
            document.getElementById(`gio_${targetDayId}`).value = sourceData.gio;
            document.getElementById(`has_special_${targetDayId}`).checked = sourceData.has_special_event;
            document.getElementById(`chunhiem_${targetDayId}`).value = sourceData.chunhiem;
            document.getElementById(`prepare_after_special_${targetDayId}`).value = sourceData.prepare_after_special;
            document.getElementById(`has_duvao_${targetDayId}`).checked = sourceData.has_duvao_bell;
            document.getElementById(`tiethoc_${targetDayId}`).value = sourceData.tiethoc;
            document.getElementById(`rachoi_${targetDayId}`).value = sourceData.rachoi;
            document.getElementById(`duvaotiet_${targetDayId}`).value = sourceData.duvaotiet;
            document.getElementById(`sotiet_${targetDayId}`).value = sourceData.sotiet;

            toggleSpecialEvent(targetDayId);
            toggleDuVao(targetDayId);
            toggleScheduleActivation(targetDayId);
            updatePreviewTable(targetDayId);
        });
        showNotification('Sao chép thành công! Hãy nhấn "Lưu và gửi cập nhật" để áp dụng.',"success");
    }
    // =======================================================
    // === KẾT THÚC PHẦN NÂNG CẤP ===
    // =======================================================

    function resetOtaUi(hideProgress = false) {
        otaInProgress = false;
        const uploadBtn = document.getElementById('ota-upload-btn');
        document.getElementById('ota-select-file-btn').disabled = false;
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Bắt đầu Cập nhật';
        uploadBtn.style.backgroundColor = '#27ae60';

        if (hideProgress) {
            document.getElementById('ota-progress-container').style.display = 'none';
        }
    }

    function handleOtaUpload() {
        if (otaInProgress) {
            showNotification("Quá trình cập nhật đang diễn ra!", 'info');
            return;
        }
        if (!client || !client.connected) return showNotification("Chưa kết nối máy chủ!", 'error');
        
        const fileInput = document.getElementById('ota-file-input');
        const file = fileInput.files[0];
        const selectedDevices = Array.from(document.querySelectorAll('.ota-target-checkbox:checked')).map(cb => cb.value);

        if (!file) {
            return showNotification("Vui lòng chọn một file firmware (.bin)!", 'error');
        }
        if (selectedDevices.length === 0) {
            return showNotification("Vui lòng chọn ít nhất một thiết bị để cập nhật!", 'error');
        }

        otaInProgress = true;
        const selectBtn = document.getElementById('ota-select-file-btn');
        const uploadBtn = document.getElementById('ota-upload-btn');
        const progressContainer = document.getElementById('ota-progress-container');
        const progressBar = document.getElementById('ota-progress-bar');
        const statusText = document.getElementById('ota-status-text');
        const progressDetails = document.getElementById('ota-progress-details');
        const deviceStatusList = document.getElementById('ota-device-status-list');

        selectBtn.disabled = true;
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Đang cập nhật...';
        uploadBtn.style.backgroundColor = '#7f8c8d';
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        statusText.textContent = 'Đang đọc file...';
        progressDetails.textContent = '';
        deviceStatusList.innerHTML = '';

        const reader = new FileReader();
        reader.onload = function(e) {
            const fileData = e.target.result;
            const fileSize = fileData.byteLength;
            const CHUNK_SIZE = 256;
            let offset = 0;
            
            showNotification(`Bắt đầu OTA cho ${selectedDevices.length} thiết bị...`, 'info');
            
            statusText.textContent = 'Gửi lệnh bắt đầu...';
            for (const deviceName of selectedDevices) {
                const isMaster = (deviceName === 'ESP32-MayChu');
                const commandTopic = isMaster ? OTA_COMMAND_TOPIC : OTA_SATELLITE_COMMAND_TOPIC_PREFIX + deviceName;
                client.publish(commandTopic, JSON.stringify({ action: "START", size: fileSize }), { qos: 1 });
            }

            function sendChunk() {
                if (!otaInProgress || offset >= fileSize) {
                    if(otaInProgress) {
                        statusText.textContent = 'Hoàn tất gửi file, đang chờ xác nhận...';
                        for (const deviceName of selectedDevices) {
                            const isMaster = (deviceName === 'ESP32-MayChu');
                            const commandTopic = isMaster ? OTA_COMMAND_TOPIC : OTA_SATELLITE_COMMAND_TOPIC_PREFIX + deviceName;
                            client.publish(commandTopic, JSON.stringify({ action: "END" }), { qos: 1 });
                        }
                        progressBar.style.width = '100%';
                    }
                    return;
                }

                const chunk = fileData.slice(offset, offset + CHUNK_SIZE);
                
                for (const deviceName of selectedDevices) {
                    const isMaster = (deviceName === 'ESP32-MayChu');
                    const dataTopic = isMaster ? OTA_DATA_TOPIC : OTA_SATELLITE_DATA_TOPIC_PREFIX + deviceName;
                    client.publish(dataTopic, new Uint8Array(chunk), { qos: 1 });
                }
                
                offset += chunk.byteLength;
                const progress = Math.min(100, Math.round((offset / fileSize) * 100));
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${progress}%`;
                statusText.textContent = `Đang gửi... ${Math.round(offset/1024)}/${Math.round(fileSize/1024)} KB`;
                
                setTimeout(sendChunk, 5);
            }
            
            setTimeout(sendChunk, 1000);
        };

        reader.onerror = function() {
            showNotification("Lỗi khi đọc file!", 'error');
            resetOtaUi(true);
        };

        reader.readAsArrayBuffer(file);
    }

    function initializeTabs() {
        const dayMap = ['cn', 't2', 't3', 't4', 't5', 't6', 't7'];
        const today = new Date();
        const currentDayId = dayMap[today.getDay()];

        selectedDay = currentDayId;

        const todayButton = document.querySelector(`.tablinks-day[onclick*="'${currentDayId}'"]`);
        if (todayButton) {
            document.querySelectorAll('.tablinks-day').forEach(btn => btn.classList.remove('active'));
            todayButton.classList.add('active');
        } else {
            document.querySelector('.tablinks-day').classList.add('active');
        }

        document.querySelector(`.tablinks-session[onclick*="'${selectedSession}'"]`).classList.add('active');
        
        days.forEach(day => {
            contentWrapper.innerHTML += createDayContent(`${day.id}_sang`, day.name, "sang");
            contentWrapper.innerHTML += createDayContent(`${day.id}_chieu`, day.name, "chieu");
        });

        showActiveTab();
    }
    
    // =======================================================
    // [MỚI] SCRIPT CHO CÀI ĐẶT GIAO DIỆN
    // =======================================================
    const customizableTexts = [
        { id: 'index-main-title', defaultText: 'CHUÔNG BÁO TỰ ĐỘNG', description: 'Tiêu đề chính' },
        { id: 'school-name-status', defaultText: 'THPT YÊN KHÁNH A', description: 'Tên trường' },
        { id: 'index-schedule-title', defaultText: 'CÀI ĐẶT LỊCH HỌC', description: 'Tiêu đề cài đặt Lịch' },
        { id: 'sohoi-title', defaultText: 'CÀI ĐẶT CHUÔNG BÁO & ÂM THANH', description: 'Tiêu đề Chuông & Âm thanh' }, // ĐÃ SỬA LẠI TEXT TRONG HÀM GATHER/POPULATE
        { id: 'sohoi-subtitle', defaultText: '(CHUNG CHO TẤT CẢ CÁC NGÀY)', description: 'Phụ đề Chuông & Âm thanh' }, // ĐÃ SỬA LẠI TEXT
        { id: 'label-sohoi-batdau', defaultText: 'Bắt đầu buổi học', description: 'Label: Bắt đầu buổi học' },
        { id: 'label-sohoi-vaotiet', defaultText: 'Vào tiết', description: 'Label: Vào tiết' },
        { id: 'label-sohoi-rachoi', defaultText: 'Ra chơi', description: 'Label: Ra chơi' },
        { id: 'label-sohoi-duvao', defaultText: 'Dự vào lớp', description: 'Label: Dự vào lớp' },
        { id: 'label-sohoi-tgreo', defaultText: 'Thời gian reo (ms)', description: 'Label: TG Reo' },
        { id: 'label-sohoi-tgnghi', defaultText: 'Thời gian nghỉ (ms)', description: 'Label: TG Nghỉ' },
        { id: 'btn-save-schedule', defaultText: 'Lưu và gửi cập nhật', description: 'Nút Lưu chính' },
        { id: 'btn-test-bell', defaultText: 'Thử Chuông Báo Chung', description: 'Nút Thử Chuông' },
        { id: 'btn-interface-settings', defaultText: 'Cài đặt giao diện', description: 'Nút Cài đặt giao diện' },
        { id: 'btn-advanced-settings', defaultText: 'Cài đặt nâng cao', description: 'Nút Cài đặt nâng cao' },
        { id: 'btn-logout', defaultText: 'Đăng xuất', description: 'Nút Đăng xuất' },
        { id: 'interface-modal-title', defaultText: 'Cài đặt Giao diện', description: 'Giao diện: Tiêu đề Modal' },
        { id: 'interface-label-content', defaultText: 'Nội dung', description: 'Giao diện: Label Nội dung' },
        { id: 'interface-label-color', defaultText: 'Màu chữ', description: 'Giao diện: Label Màu chữ' },
        { id: 'interface-label-fontsize', defaultText: 'Cỡ chữ (px)', description: 'Giao diện: Label Cỡ chữ' },
        { id: 'interface-label-fontfamily', defaultText: 'Font chữ', description: 'Giao diện: Label Font chữ' },
        { id: 'interface-btn-reset', defaultText: 'Reset về Mặc định', description: 'Giao diện: Nút Reset' },
        { id: 'interface-btn-close', defaultText: 'Đóng', description: 'Giao diện: Nút Đóng Modal' },
        { id: 'title-scenario-tab', defaultText: 'HẸN GIỜ THEO KỊCH BẢN', description: 'Tab: Hẹn giờ kịch bản' },
        { id: 'summary-new-scenario-text', defaultText: 'THIẾT LẬP KỊCH BẢN MỚI', description: 'Hẹn giờ: Tiêu đề thiết lập' },
        { id: 'title-saved-scenario', defaultText: 'KỊCH BẢN HIỆN TẠI ĐANG LƯU TRÊN THIẾT BỊ', description: 'Hẹn giờ: Tiêu đề Kịch bản đã lưu' },
        { id: 'btn-delete-scenario', defaultText: 'Xóa Kịch Bản Đã Lưu', description: 'Hẹn giờ: Nút Xóa Kịch bản' },
        { id: 'title-holiday-calendar', defaultText: 'LỊCH NGHỈ LỄ', description: 'Cài đặt: Tiêu đề Lịch nghỉ lễ' },
        { id: 'title-music-player', defaultText: 'ĐIỀU KHIỂN PHÁT NHẠC', description: 'Phát nhạc: Tiêu đề chính' },
        { id: 'title-music-playlist', defaultText: 'DANH SÁCH PHÁT', description: 'Phát nhạc: Tiêu đề Playlist' },
        { id: 'summary-music-schedule', defaultText: 'HẸN GIỜ PHÁT NHẠC', description: 'Phát nhạc: Tiêu đề Hẹn giờ nhạc' },
        { id: 'label-music-repeat-days', defaultText: 'Lặp lại vào các ngày', description: 'Phát nhạc: Label Lặp lại ngày' },
    ];
    let selectedElementId = null;

    function openInterfaceSettingsModal() {
        document.getElementById('interface-settings-modal').classList.add('visible');
        populateInterfaceTable();
    }

    function closeInterfaceSettingsModal() {
        document.getElementById('interface-settings-modal').classList.remove('visible');
        selectedElementId = null;
    }

    function populateInterfaceTable() {
        const tableBody = document.getElementById('text-elements-table-body');
        tableBody.innerHTML = '';
        const savedSettings = localStorage.getItem('interfaceSettings');
        const settings = savedSettings ? JSON.parse(savedSettings) : {};
        customizableTexts.forEach(item => {
            const element = document.getElementById(item.id);
            const currentText = settings[item.id]?.text || (element ? element.innerText : item.defaultText);
            const row = document.createElement('tr');
            row.setAttribute('data-element-id', item.id);
            row.onclick = () => selectTextElement(row, item.id);
            row.innerHTML = `<td>${item.description}</td><td id="table-cell-${item.id}">${currentText}</td>`;
            tableBody.appendChild(row);
        });
    }

    function selectTextElement(row, elementId) {
        selectedElementId = elementId;
        document.querySelectorAll('#text-elements-table-body tr').forEach(r => r.classList.remove('selected-row'));
        row.classList.add('selected-row');

        const savedSettings = localStorage.getItem('interfaceSettings');
        const settings = savedSettings ? JSON.parse(savedSettings) : {};
        const specificSettings = settings[elementId];
        const defaultConfig = customizableTexts.find(item => item.id === elementId);

        const textValue = specificSettings?.text ?? defaultConfig?.defaultText ?? '';
        document.getElementById('text-editor-input').value = textValue;
        
        const element = document.getElementById(elementId);
        const computedStyle = element ? window.getComputedStyle(element) : {};

        const colorValue = specificSettings?.color || computedStyle.color || '#f5f6fa';
        document.getElementById('color-picker-input').value = rgbToHex(colorValue);

        const fontSizeValue = specificSettings?.fontSize ? parseFloat(specificSettings.fontSize) : (computedStyle.fontSize ? parseFloat(computedStyle.fontSize) : 15);
        document.getElementById('font-size-input').value = fontSizeValue;

        const fontFamilyValue = specificSettings?.fontFamily || computedStyle.fontFamily || "'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif";
        document.getElementById('font-family-select').value = fontFamilyValue;
    }

    function applyInterfaceChanges(property, value) {
        if (!selectedElementId) {
            showNotification("Vui lòng chọn một mục từ bảng để chỉnh sửa!", "error");
            return;
        }

        const savedSettings = localStorage.getItem('interfaceSettings');
        let settings = savedSettings ? JSON.parse(savedSettings) : {};

        if (!settings[selectedElementId]) {
            settings[selectedElementId] = {};
        }

        switch (property) {
            case 'text': settings[selectedElementId].text = value; break;
            case 'color': settings[selectedElementId].color = value; break;
            case 'fontSize': settings[selectedElementId].fontSize = value ? value + 'px' : ''; break;
            case 'fontFamily': settings[selectedElementId].fontFamily = value; break;
        }

        localStorage.setItem('interfaceSettings', JSON.stringify(settings));

        const element = document.getElementById(selectedElementId);
        if (element) {
            if (property === 'text') element.innerText = value;
            if (property === 'color') element.style.color = value;
            if (property === 'fontSize') element.style.fontSize = settings[selectedElementId].fontSize;
            if (property === 'fontFamily') element.style.fontFamily = value;
        }
        
        if (property === 'text') {
            const tableCell = document.getElementById(`table-cell-${selectedElementId}`);
            if (tableCell) tableCell.innerText = value;
        }
    }

    function loadInterfaceSettings() {
        const savedSettings = localStorage.getItem('interfaceSettings');
        if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            for (const id in settings) {
                const element = document.getElementById(id);
                const itemSettings = settings[id];
                if (element && itemSettings) {
                    if (itemSettings.text) element.innerText = itemSettings.text;
                    if (itemSettings.color) element.style.color = itemSettings.color;
                    if (itemSettings.fontSize) element.style.fontSize = itemSettings.fontSize;
                    if (itemSettings.fontFamily) element.style.fontFamily = itemSettings.fontFamily;
                }
            }
        }
    }

    function resetInterfaceSettings() {
        if (confirm("Bạn có chắc muốn reset tất cả cài đặt giao diện về mặc định không?")) {
            localStorage.removeItem('interfaceSettings');
            window.location.reload();
        }
    }

    function rgbToHex(rgb) {
      if (!rgb || typeof rgb !== 'string') return '#ffffff';
      if (rgb.startsWith('#')) return rgb;
      let match = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
      if (!match) return '#ffffff';
      function toHex(c) {
        let hex = Number(c).toString(16);
        return hex.length == 1 ? "0" + hex : hex;
      }
      return "#" + toHex(match[1]) + toHex(match[2]) + toHex(match[3]);
    }
    // =======================================================
    // [MỚI] SCRIPT CHO LỊCH NGHỈ LỄ
    // =======================================================
    let holidayData = {}; 
    let currentDisplayDate = new Date();

    function generateCalendar(year, month) {
        const grid = document.getElementById('calendar-grid');
        const display = document.getElementById('month-year-display');
        grid.innerHTML = '';

        const today = new Date();
        const firstDayOfMonth = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        display.textContent = `Tháng ${month + 1} ${year}`;
        currentDisplayDate = new Date(year, month, 1);

        ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'].forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'calendar-day-header';
            dayHeader.textContent = day;
            grid.appendChild(dayHeader);
        });

        for (let i = 0; i < firstDayOfMonth.getDay(); i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'calendar-day empty';
            grid.appendChild(emptyCell);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';
            dayCell.textContent = day;
            
            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            dayCell.setAttribute('data-date', dateString);

            if (holidayData[dateString]) {
                dayCell.classList.add('holiday');
            }
            if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                dayCell.classList.add('today');
            }

            dayCell.onclick = () => toggleHoliday(dateString);
            grid.appendChild(dayCell);
        }
    }

    function changeMonth(offset) {
        currentDisplayDate.setMonth(currentDisplayDate.getMonth() + offset);
        generateCalendar(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth());
    }

    // File: index full.html

function toggleHoliday(dateString) {
    function loadHolidayData(data) {
    if (data) {
        holidayData = data; // Cập nhật biến toàn cục với dữ liệu từ thiết bị
        // Vẽ lại giao diện lịch với dữ liệu mới
        generateCalendar(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth());
    }
}
    const cell = document.querySelector(`.calendar-day[data-date="${dateString}"]`);
    if (holidayData[dateString]) {
        delete holidayData[dateString];
        if(cell) cell.classList.remove('holiday');
    } else {
        holidayData[dateString] = true; // Giá trị có thể là true hoặc một object rỗng
        if(cell) cell.classList.add('holiday');
    }

    // [THÊM MỚI] Gửi cập nhật lịch nghỉ lễ ngay lập tức
    if (!client || !client.connected) {
        return showNotification("Chưa kết nối máy chủ! Thay đổi chưa được lưu.", 'error');
    }

    // Tạo một payload chỉ chứa thông tin ngày nghỉ
    const payload = {
        holidays: holidayData 
    };

    // Gửi lên topic SET_DATA_TOPIC, ESP32 sẽ tự biết cách xử lý
    client.publish(SET_DATA_TOPIC, JSON.stringify(payload), { qos: 1, retain: true });
    showNotification(`Đã cập nhật ngày nghỉ ${dateString}`, 'success');
}
    // =======================================================

    window.onload = function() { 
        loadInterfaceSettings();
        connectToMqtt();
        setInterval(updateClockAndCountdown, 1000);

        // [SỬA LỖI] Tải kịch bản đã lưu từ bộ nhớ trình duyệt ngay khi vào trang
        try {
            const lastScenario = localStorage.getItem('savedScenario');
            if (lastScenario) {
                renderSavedScenario(JSON.parse(lastScenario));
            }
        } catch (e) {
            console.error("Không thể tải kịch bản từ localStorage:", e);
        }
        
        document.getElementById('admin-password-input').addEventListener('keyup', function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                document.querySelector('#password-modal-overlay .modal-confirm-btn').click();
            }
        });

        document.getElementById('ota-file-input').addEventListener('change', function(event) {
            const file = event.target.files[0];
            const uploadBtn = document.getElementById('ota-upload-btn');
            const fileNameDiv = document.getElementById('ota-file-name');
            if (file) {
                fileNameDiv.textContent = file.name;
                uploadBtn.style.display = 'block';
            } else {
                fileNameDiv.textContent = 'Chưa chọn tệp nào';
                uploadBtn.style.display = 'none';
            }
        });
        
        document.getElementById('text-editor-input').addEventListener('input', (e) => applyInterfaceChanges('text', e.target.value));
        document.getElementById('color-picker-input').addEventListener('input', (e) => applyInterfaceChanges('color', e.target.value));
        document.getElementById('font-size-input').addEventListener('input', (e) => applyInterfaceChanges('fontSize', e.target.value));
        document.getElementById('font-family-select').addEventListener('change', (e) => applyInterfaceChanges('fontFamily', e.target.value));

        document.getElementById('volume-slider').addEventListener('change', (e) => handleMusicControl('set_volume', e.target.value));
        document.getElementById('music-progress-bar').addEventListener('change', (e) => handleMusicControl('seek', e.target.value));

        initializeTabs();
        generateCalendar(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth());
        document.querySelector('.sticky-action-bar').style.display = 'flex';
    };

function renderSavedScenario(savedData) {
    const wrapper = document.getElementById('saved-scenario-table-wrapper');
    const priorityDiv = document.getElementById('saved-scenario-priority');
    const placeholder = document.getElementById('saved-scenario-placeholder');
    const daysDisplayContainer = document.getElementById('saved-scenario-days-display');

    // Xóa nội dung cũ
    wrapper.innerHTML = '';
    priorityDiv.innerHTML = '';
    daysDisplayContainer.innerHTML = '';

    // 1. Kiểm tra xem dữ liệu có phải là một mảng HỢP LỆ không
    if (!savedData || !Array.isArray(savedData)) {
        wrapper.style.display = 'none';
        placeholder.style.display = 'block';
        return; 
    }
    
    // 2. Nếu là mảng HỢP LỆ (kể cả rỗng), ẩn placeholder
    wrapper.style.display = 'block';
    placeholder.style.display = 'none';

    // 3. Bây giờ mới kiểm tra xem mảng có rỗng không
    if (savedData.length === 0) {
        wrapper.innerHTML = '<p class="list-placeholder" style="display: block; padding: 10px;">Không có kịch bản nào được lưu.</p>';
        return;
    }
    
    // 4. Nếu mảng không rỗng, lặp và hiển thị
    let listHTML = '';
    const dayNameMap = {t2: 'T2', t3: 'T3', t4: 'T4', t5: 'T5', t6: 'T6', t7: 'T7', cn: 'CN'};

    savedData.forEach((scenarioDoc, index) => {
        const events = scenarioDoc.scenario || [];
        const days = scenarioDoc.days || [];
        const priority = scenarioDoc.priority || 'none';
        
        // [SỬA ĐỔI 1] Lấy danh sách giờ hẹn
        const eventTimes = events.map(e => e.time).join(', ');
        
        let priorityText = 'Không ưu tiên';
        if (priority === 'scenario') priorityText = '<span style="color: #2ecc71;">Ưu tiên Kịch Bản</span>';
        if (priority === 'schedule') priorityText = '<span style="color: #3498db;">Ưu tiên Lịch Học</span>';

        listHTML += `
            <div class="scenario-item" style="border: 1px solid #414345; border-radius: 8px; margin-bottom: 10px; background: #232526;">
                <div class="scenario-item-header" style="background: #34495e; padding: 8px 12px; border-radius: 8px 8px 0 0; font-weight: bold; color: #f1c40f;">
                    KỊCH BẢN #${index + 1} (${events.length} sự kiện)
                </div>
                <div class="scenario-item-body" style="padding: 12px; font-size: 0.9em; line-height: 1.6;">
                    <div style="margin-bottom: 5px;"><strong>Áp dụng:</strong> ${days.map(d => dayNameMap[d] || d).join(', ') || 'Không có'}</div>
                    
                    <div style="margin-bottom: 5px; color: #f1c40f;"><strong>Giờ hẹn:</strong> ${eventTimes}</div>
                    
                    <div style="margin-bottom: 10px;"><strong>Ưu tiên:</strong> ${priorityText}</div>
                    
                    <button class="device-action-btn remove-btn" style="width: 100%; font-size: 0.8em;" onclick="deleteSingleScenario(${index})">
                        Xóa Kịch bản này
                    </button>
                </div>
            </div>
        `;
    });
    
    wrapper.innerHTML = listHTML;
}

  </script>
  
<script>
// This is a remnant script block from the original file. It is being kept for 100% file integrity,
// but the main logic is handled by the larger script block above. The functions here are overridden.
function addScenario() {
  const startTime = document.getElementById("scenario-start-time").value;
  const intervals = document.getElementById("scenario-intervals").value;
  const bells = document.getElementById("scenario-bells").value;

  if (!startTime || !bells) {
    showNotification("Vui lòng nhập đủ thông tin!", "error");
    return;
  }

  const scenario = { startTime, intervals, bells };

  if (typeof client !== 'undefined' && client && client.connected) {
    client.publish("device/command/saveScenario", JSON.stringify(scenario));
    showNotification("Đã gửi kịch bản lên thiết bị", "success");
  } else {
    showNotification("Mất kết nối MQTT", "error");
  }

  const tableHtml = `
    <table class="scenario-table">
      <thead>
        <tr><th>STT</th><th>Thời gian</th><th>Số hồi</th></tr>
      </thead>
      <tbody>
        <tr>
          <td>1</td>
          <td>${startTime}${intervals ? " +" + intervals : ""}</td>
          <td>${bells} hồi</td>
        </tr>
      </tbody>
    </table>
  `;
  document.getElementById("saved-scenario-table-wrapper").innerHTML = tableHtml;
}

function showNotification(msg, type="info") {
  const area = document.getElementById("notification-area");
  if (!area) return;
  const div = document.createElement("div");
  div.className = `notification ${type}`;
  div.textContent = msg;
  area.appendChild(div);
  setTimeout(() => div.classList.add("show"), 50);
  setTimeout(() => {
    div.classList.remove("show");
    if (div.parentNode) div.parentNode.removeChild(div);
  }, 3000);
}

</script>

</body>
</html>
