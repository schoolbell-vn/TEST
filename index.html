<!DOCTYPE html>
<html lang="vi">
<head>
  <title>H·∫πn Gi·ªù Chu√¥ng B√°o - ƒêi·ªÅu khi·ªÉn Internet</title>
  <meta name="viewport" content="width=device-width,user-scalable=0" charset="utf-8">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js" type="text/javascript"></script>
  
  <style type="text/css">
    /* --- C√ÄI ƒê·∫∂T CHUNG & S·ª¨A L·ªñI TR√ÄN KHUNG --- */
    * {
        box-sizing: border-box;
    }
    body {
        background: linear-gradient(135deg, #3a4750 0%, #4a627a 100%);
        font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        color: #f5f6fa;
        min-height: 100vh;
        margin: 0;
        /* [M·ªöI] Th√™m padding-bottom ƒë·ªÉ kh√¥ng b·ªã thanh h√†nh ƒë·ªông che m·∫•t n·ªôi dung */
        padding-bottom: 80px; 
        font-size: 15px;
    }

/* === [B∆Ø·ªöC 2] CSS CHO GIAO DI·ªÜN G√ìI/M·ªû C·ª¶A TAB H·∫∏N GI·ªú === */
.scenario-setup-details {
    border: none;
    background: transparent;
    box-shadow: none;
    margin: 0 15px 15px 15px; /* CƒÉn l·ªÅ cho ƒë·ªìng b·ªô */
}
.scenario-setup-details > summary {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 12px 15px;
    font-size: 1.1em;
    font-weight: 700;
    letter-spacing: 1px;
    border-radius: 10px;
    background: linear-gradient(90deg, #2c3e50, #34495e);
    color: #3498db;
    border: 2px solid #3498db;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.2);
    transition: all 0.2s ease-in-out;
}
.scenario-setup-details > summary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
}
.scenario-setup-details[open] > summary {
    background: #3498db;
    color: #fff;
}
.scenario-setup-details > summary svg {
    width: 20px;
    height: 20px;
    margin-right: 10px;
}
.scenario-setup-details .details-content {
    border: 1px solid #414345;
    border-top: none;
    border-radius: 0 0 10px 10px;
    margin-top: -5px;
    padding: 10px;
    background: #232526;
}
/* ======================================================= */
    #main {
        margin: 24px auto;
        width: 380px;
        max-width: 98vw;
    }

    /* --- KHUNG N·ªòI DUNG CH√çNH --- */
    #content {
        background: #2c3e50;
        border: none;
        width: 100%;
        /*float: left;*/
        border-radius: 18px;
        padding-bottom: 24px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
    }

/* === [PH∆Ø∆†NG √ÅN M·ªöI] CSS CHO HI·ªÇN TH·ªä NG√ÄY ƒê√É L∆ØU === */
.saved-days-container {
    text-align: center;
    margin-top: 12px;
    padding: 5px;
}
.day-badge {
    display: inline-block;
    padding: 6px 12px;
    background-color: #f1c40f; /* M√†u v√†ng ƒë·∫∑c tr∆∞ng */
    color: #232526; /* M√†u ch·ªØ t·ªëi cho d·ªÖ ƒë·ªçc */
    font-weight: 700;
    border-radius: 8px;
    margin: 3px;
    font-size: 0.95em;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.day-badge-label {
    color: #bdc3c7;
    font-weight: bold;
    margin-right: 8px;
}
/* =================================================== */

    /* === [M·ªöI] THANH H√ÄNH ƒê·ªòNG C·ªê ƒê·ªäNH (STICKY ACTION BAR) === */
    .sticky-action-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(35, 37, 38, 0.85);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 10px;
        display: flex;
        justify-content: center;
        gap: 15px;
        z-index: 100;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        border-top: 1px solid #414345;
    }
    .sticky-action-bar .modern-btn {
    flex: 1;
    max-width: 350px; /* TƒÉng chi·ªÅu r·ªông t·ªëi ƒëa */
    margin: 0;
}
    /* L√†m cho n√∫t L∆∞u n·ªïi b·∫≠t h∆°n */
    .sticky-action-bar .save-button {
        transform: scale(1.05);
        box-shadow: 0 8px 24px #00e6ff55;
    }

    /* === [M·ªöI] H·ªÜ TH·ªêNG TAB CH√çNH === */
    .main-tabs {
        display: flex;
        background-color: #232526;
        border-radius: 16px 16px 0 0;
        padding: 5px;
        margin-bottom: 15px;
        border-bottom: 2px solid #414345;
    }
    .main-tab-button {
        flex: 1;
        padding: 10px 5px;
        cursor: pointer;
        background: transparent;
        border: none;
        color: #bdc3c7;
        font-weight: 700;
        font-size: 0.8em;
        transition: all 0.2s ease-out;
        border-radius: 12px;
        text-transform: uppercase;
    }
    .main-tab-button:hover {
        background-color: #414345;
        color: #fff;
    }
    .main-tab-button.active {
        background: #f1c40f;
        color: #232526;
        box-shadow: 0 2px 10px #f1c40f55;
    }
    .main-tab-content {
        display: none; /* M·∫∑c ƒë·ªãnh ·∫©n t·∫•t c·∫£ n·ªôi dung tab */
    }
    .main-tab-content.active {
        display: block; /* Ch·ªâ hi·ªán n·ªôi dung c·ªßa tab ƒëang active */
    }
    
    /* === KHU V·ª∞C TH√îNG B√ÅO PH·∫¢N H·ªíI === */
    #notification-area {
        position: fixed;
        top: 15px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1010;
        width: 90%;
        max-width: 360px;
    }
    .notification {
        padding: 10px 15px;
        border-radius: 8px;
        color: #fff;
        font-weight: bold;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        opacity: 0;
        transform: translateY(-20px);
        transition: opacity 0.3s, transform 0.3s;
        margin-bottom: 10px;
        font-size: 0.9em;
    }
    .notification.show {
        opacity: 1;
        transform: translateY(0);
    }
    .notification.success {
        background: linear-gradient(90deg, #27ae60, #2ecc71);
    }
    .notification.error {
        background: linear-gradient(90deg, #c0392b, #e74c3c);
    }
    .notification.info {
        background: linear-gradient(90deg, #2980b9, #3498db);
    }

    /* --- TI√äU ƒê·ªÄ & M√ÄU S·∫ÆC N·ªîI B·∫¨T --- */
    h2 {
        font-size: 1.6em;
        margin-top: 20px;
        margin-bottom: 10px;
        text-align: center;
        color: #f39c12;
        text-shadow: 0 4px 12px rgba(243, 156, 18, 0.18), 0 2px 4px rgba(0,0,0,0.08);
        letter-spacing: 1px;
        font-weight: 800;
    }
    h3 {
        margin-top: 28px;
        margin-bottom: 18px; 
        text-align: center;
        font-size: 1.15em;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        padding: 12px 18px;
        background: linear-gradient(90deg, #232526 60%, #414345 100%);
        border-radius: 12px;
        margin-left: 15px;
        margin-right: 15px;
        border-left: 5px solid;
        border-right: 5px solid;
        position: relative;
        z-index: 2;
        box-shadow: 0 4px 24px 0 #00000044, 0 2px 8px rgba(0,0,0,0.08);
    }
    #header-sang { 
        color: #2ecc71 !important;
        text-shadow: 0 0 12px #2ecc71, 0 2px 8px #000;
        border-color: #2ecc71;
        box-shadow: 0 4px 24px 0 #00000044, 0 2px 8px rgba(0,0,0,0.08),
                    inset 5px 0 10px -5px #2ecc71,
                    inset -5px 0 10px -5px #2ecc71;
    }
    #header-chieu { 
        color: #3498db !important;
        text-shadow: 0 0 12px #3498db, 0 2px 8px #000;
        border-color: #3498db;
        box-shadow: 0 4px 24px 0 #00000044, 0 2px 8px rgba(0,0,0,0.08),
                    inset 5px 0 10px -5px #3498db,
                    inset -5px 0 10px -5px #3498db;
    }
    hr { border: none; height: 1px; background: linear-gradient(90deg, #f1c40f 0%, #e0eafc 100%); margin: 28px 15px; border-radius: 2px; opacity: 0.5; }

    /* --- [M·ªöI] THANH TR·∫†NG TH√ÅI & ƒê·ªíNG H·ªí --- */
    #school-name-status {
        transition: color 0.5s ease; /* Hi·ªáu ·ª©ng chuy·ªÉn m√†u m∆∞·ª£t m√† */
    }
    .status-color-connected { 
        color: #43e97b !important; /* Xanh l√° c√¢y */
    }
    .status-color-disconnected { 
        color: #ff5858 !important; /* ƒê·ªè */
    }
    .status-color-connecting { 
        color: #00e6ff !important; /* Xanh d∆∞∆°ng (m√†u g·ªëc) */
    }

    .clock-container { 
        text-align: center; 
        margin: 15px auto; 
        background: linear-gradient(120deg, #232526 60%, #414345 100%); 
        border: 2px solid #f1c40f; 
        border-radius: 14px; 
        padding: 8px 10px;
        box-shadow: 0 2px 12px rgba(241, 196, 15, 0.10), 0 2px 5px rgba(0,0,0,0.08);
        width: 90%;
    }
    .clock {
        font-size: 2.5em;
        color: #f1c40f;
        text-shadow: 0 0 10px #f1c40f88;
        letter-spacing: 2px;
        font-family: 'Courier New', Courier, monospace;
    }
    .date-display { font-size: 0.9em; color: #ecf0f1; margin-top: 5px; font-weight: 500; }

    /* --- KHU V·ª∞C N√öT ƒêI·ªÄU KHI·ªÇN --- */
    .modern-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 45px;
        padding: 0 15px;
        border: none;
        border-radius: 10px;
        font-size: 0.9em;
        font-weight: 700;
        letter-spacing: 1px;
        transition: all 0.2s ease-out;
        cursor: pointer;
        outline: none;
        position: relative;
        overflow: hidden;
        z-index: 1;
        text-transform: uppercase;
        width: 100%;
        text-decoration: none;
    }
    .modern-btn:hover {
        transform: translateY(-2px);
        filter: brightness(1.1);
    }
    .modern-btn svg {
        width: 1.1em;
        height: 1.1em;
        margin-right: 10px;
    }
    .modern-btn:active {
        transform: scale(0.97);
        filter: brightness(0.97);
        box-shadow: 0 2px 8px 0 #0004;
    }
    .save-button {
        background: linear-gradient(90deg, #232526 60%, #414345 100%);
        color: #00e6ff;
        border-left: 4px solid #00e6ff;
        border-right: 4px solid #00e6ff;
        text-shadow: 0 0 12px #00e6ff, 0 2px 8px #000;
        box-shadow: 0 4px 18px 0 #00000044;
    }
    .save-button:hover {
        box-shadow: 0 8px 24px #00e6ff55;
    }
    .test-button {
        background: linear-gradient(90deg, #232526 60%, #414345 100%);
        color: #f1c40f;
        border-left: 4px solid #f1c40f;
        border-right: 4px solid #f1c40f;
        text-shadow: 0 0 12px #f1c40f, 0 2px 8px #000;
        box-shadow: 0 4px 18px 0 #00000044;
    }
    .test-button:hover {
        box-shadow: 0 8px 24px #f1c40f55;
    }
    
.tab { display: flex; justify-content: space-around; border-bottom: 2px solid #414345; margin: 0 15px 0 15px; position: relative; z-index: 1; }
    .tab button {
        flex-grow: 1; border: none; outline: none; cursor: pointer; padding: 10px 5px 8px 5px;
        transition: all 0.2s ease-out;
        font-size: 0.9em; font-weight: 700; border-radius: 8px 8px 0 0; margin: 0 2px;
        position: relative; top: 2px; border-bottom: 3px solid transparent;
        background: transparent; color: #bdc3c7;
    }
    .tab button:hover {
        background: #414345; color: #fff;
        transform: translateY(-2px);
    }
    .tablinks-sang.active { 
        background: linear-gradient(90deg, #2ecc71 60%, #27ae60 100%);
        color: #fff; 
        border-bottom-color: #2ecc71;
        z-index: 2;
    }
     .tablinks-chieu.active { 
        background: linear-gradient(90deg, #3498db 60%, #2980b9 100%);
        color: #fff; 
        border-bottom-color: #3498db;
        z-index: 2;
    }
    .tabcontent { 
        display: none; 
        padding: 10px; 
        background: #232526;
        border-radius: 0 0 12px 12px;
        margin: 0 15px 8px 15px;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height 0.5s ease-in-out, opacity 0.4s ease-in-out, padding 0.5s ease-in-out;
    }
    .tabcontent.active {
        display: block;
        max-height: 1000px;
        opacity: 1;
        padding: 15px 10px 10px 10px;
    }
    .tabcontent h3 {
        font-size: 1em; 
        margin: 0; 
        margin-bottom: 10px;
        padding: 10px 15px;
        color: #f1c40f; 
        font-weight: 700;
        cursor: pointer;
        position: relative;
        border-bottom: 1px solid #414345;
        background: rgba(44, 62, 80, 0.5);
        border-radius: 8px;
        text-align: center;
    }
    .tabcontent h3::after {
        content: '‚ñº';
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%) scale(0.9);
        font-size: 0.8em;
        transition: transform 0.3s ease-in-out;
    }
    .tabcontent h3.expanded::after {
        transform: translateY(-50%) scale(0.9) rotate(180deg);
    }
    .session-subtitle {
        font-size: 0.8em;
        font-weight: normal;
        text-transform: none;
        color: #bdc3c7;
    }
    .collapsible-settings {
        overflow: hidden;
        max-height: 0;
        opacity: 0;
        transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out, margin-top 0.4s ease-in-out;
        margin-top: 0;
    }
    .collapsible-settings.expanded {
        max-height: 500px;
        opacity: 1;
        margin-top: 10px;
    }
/* === [TH√äM M·ªöI] CSS CHO B·∫¢NG K·ªäCH B·∫¢N H·∫∏N GI·ªú === */
    .scenario-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    .scenario-table th, .scenario-table td {
        border: 1px solid #414345;
        padding: 9px 5px;
        text-align: center; /* CƒÉn gi·ªØa n·ªôi dung trong √¥ */
        font-size: 0.9em;
    }
    .scenario-table th {
        background-color: #3498db;
        color: #fff;
        font-weight: bold;
    }
    .scenario-table tbody tr:nth-child(odd) {
        background-color: #2c3e50;
    }
    .scenario-table tbody tr:nth-child(even) {
        background-color: #34495e;
    }
    /* Ph√¢n chia ƒë·ªô r·ªông c√°c c·ªôt cho ƒë·ªÅu */
    .scenario-table th:nth-child(1), .scenario-table td:nth-child(1) { width: 15%; } /* C·ªôt STT */
    .scenario-table th:nth-child(2), .scenario-table td:nth-child(2) { width: 42.5%; } /* C·ªôt Th·ªùi gian */
    .scenario-table th:nth-child(3), .scenario-table td:nth-child(3) { width: 42.5%; } /* C·ªôt S·ªë h·ªìi */
    /* === C√ÄI ƒê·∫∂T N√öT G·∫†T (TOGGLE SWITCH) D·∫†NG BOX === */
    .toggle-actions-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 0 5px 10px 5px;
    }
    .toggle-action-item {
        display: flex;
        align-items: center;
        background-color: #2c3e50;
        border-radius: 8px;
        padding: 8px 12px;
        border-left: 4px solid #4a4e54;
        transition: all 0.3s ease;
    }
    .toggle-action-icon {
        flex-shrink: 0;
        margin-right: 12px;
        color: #bdc3c7;
    }
    .toggle-action-icon svg {
        width: 24px;
        height: 24px;
        display: block;
    }
    .toggle-action-text {
        flex-grow: 1;
        font-weight: bold;
        font-size: 0.9em;
    }
    .toggle-action-item .switch {
        margin-left: auto;
    }
    .toggle-action-item.disabled {
        opacity: 0.5;
        pointer-events: none;
        background-color: #232526;
    }
    .toggle-action-item.active {
        border-left-color: #2ecc71;
    }
    .toggle-action-item.active.chieu-style {
        border-left-color: #3498db;
    }
    .toggle-action-item.active .toggle-action-icon {
        color: #f1c40f;
    }
    .switch {
        position: relative;
        display: inline-block;
        width: 46px; height: 24px;
        flex-shrink: 0;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
        position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
        background-color: #4a4e54;
        transition: .3s;
        border-radius: 24px;
    }
    .slider:before {
        position: absolute; content: "";
        height: 18px; width: 18px;
        left: 3px; bottom: 3px;
        background-color: #bdc3c7;
        transition: .3s cubic-bezier(.4,0,.2,1);
        border-radius: 50%;
    }
    input:checked + .slider { background: linear-gradient(90deg, #27ae60, #2ecc71); }
    .chieu-toggle input:checked + .slider { background: linear-gradient(90deg, #2980b9, #3498db); }
    input:checked + .slider:before { transform: translateX(22px); background-color: white; }

    /* --- KHU V·ª∞C C√ÄI ƒê·∫∂T (DETAILS) --- */
    details {
        border: 1px solid #414345; border-radius: 10px; margin-bottom: 12px;
        background: #232526; box-shadow: 0 2px 8px rgba(0,0,0, 0.1);
        overflow: hidden; transition: box-shadow 0.2s;
    }
    summary {
        font-weight: bold; padding: 12px 15px; cursor: pointer; outline: none;
        transition: background 0.2s, color 0.2s; list-style: none;
        font-size: 0.9em;
    }
    summary::-webkit-details-marker, summary::marker { display: none; }
    
    .sohoi-container {
        padding: 0 15px;
    }
    summary#header-sohoi {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 50px;
        border-radius: 10px;
        background: linear-gradient(90deg, #232526 60%, #414345 100%);
        color: #f1c40f;
        border-left: 4px solid #f1c40f;
        border-right: 4px solid #f1c40f;
        text-shadow: 0 0 12px #f1c40f, 0 2px 8px #000, 0 0 24px #fff;
        box-shadow: 0 4px 18px 0 #f1c40f33, 0 2px 8px #fff2;
    }
    summary#header-sohoi div:first-child {
        font-size: 1em;
        font-weight: 700;
        letter-spacing: 1.5px;
    }
    .details-content { padding: 12px 15px 16px 15px; border-top: 1px solid #414345; }
    
    .tabcontent details summary {
        text-align: center;
        font-size: 1em;
        border-radius: 8px 8px 0 0;
        background: #2c3e50;
        color: #f1c40f;
    }
    details[open] > .tabcontent details summary { 
        background: #f1c40f;
        color: #232526; 
    }
    
    /* --- B·∫¢NG L·ªäCH CHI TI·∫æT --- */
    .details-container {max-height: 250px;overflow-y: auto;}
    .details-container::-webkit-scrollbar {width: 8px;}
    .details-container::-webkit-scrollbar-track {background: #2c3e50;border-radius: 4px;}
    .details-container::-webkit-scrollbar-thumb {background-color: #f1c40f;border-radius: 4px;border: 2px solid #2c3e50;}
    .details-container table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #232526; border-radius: 8px; overflow: hidden; }
    .details-container th, .details-container td { border: 1px solid #414345; padding: 8px 5px; text-align: center; font-size: 0.9em; }
    .details-container th { background: #f1c40f; color: #232526; font-weight: bold; }
    .details-container tbody tr { transition: background-color 0.2s; }
    .details-container tbody tr:hover { background-color: #f1c40f22; }
    .details-container tbody tr:nth-child(odd) { background: #232526; color: #ecf0f1; }
    .details-container tbody tr:nth-child(even) { background: #414345; color: #ecf0f1; }
    .divider-yellow {width: 90%; height: 2px; background: linear-gradient(90deg, #f1c40f 0%, #fff200 100%);border-radius: 2px; margin: 24px auto 18px auto; box-shadow: 0 2px 8px #f1c40f55;}

    /* --- GIAO DI·ªÜN L∆Ø·ªöI "TH√îNG MINH" CHO C√ÄI ƒê·∫∂T --- */
.settings-grid-container {
    /* [S·ª¨A ƒê·ªîI] Gi·ªõi h·∫°n chi·ªÅu cao v√† th√™m thanh cu·ªôn t·ª± ƒë·ªông */
    max-height: 380px; 
    overflow-y: auto;
    padding-right: 5px; /* Th√™m kho·∫£ng ƒë·ªám nh·ªè ƒë·ªÉ thanh cu·ªôn kh√¥ng qu√° s√°t */
    padding-bottom: 30px; /* TH√äM D√íNG N√ÄY: T·∫°o kho·∫£ng ƒë·ªám ·ªü cu·ªëi v√πng cu·ªôn */
    
    /* Gi·ªØ nguy√™n c√°c thu·ªôc t√≠nh c≈© */
    opacity: 1;
    transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out;
}
/* [TH√äM M·ªöI] T√πy ch·ªânh giao di·ªán thanh cu·ªôn cho ƒë·ªìng b·ªô */
.settings-grid-container::-webkit-scrollbar {
    width: 8px;
}
.settings-grid-container::-webkit-scrollbar-track {
    background: #2c3e50;
    border-radius: 4px;
}
.settings-grid-container::-webkit-scrollbar-thumb {
    background-color: #f1c40f;
    border-radius: 4px;
    border: 2px solid #2c3e50;
}
    .settings-grid-container.hidden {
        max-height: 0;
        opacity: 0;
    }
    .settings-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        padding: 8px 0;
    }
    .setting-item {
        background: #232526;
        border: 1px solid #414345;
        border-radius: 8px;
        padding: 8px;
        display: flex;
        align-items: center;
        transition: all 0.2s ease-in-out;
    }
    .setting-item:hover {
        border-color: #f1c40f;
        transform: translateY(-1px);
    }
    .setting-item.full-width {
        grid-column: 1 / -1;
    }
    .setting-item-icon {
        flex-shrink: 0;
        margin-right: 10px;
        color: #f1c40f;
    }
    .setting-item-icon svg {
        width: 22px;
        height: 22px;
    }
    .input-wrapper {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    .input-wrapper label {
        font-size: 0.8em;
        font-weight: 600;
        color: #bdc3c7;
        margin-bottom: 4px;
    }
    .unit-input {
        display: flex;
        align-items: center;
    }
    .unit-input input {
        width: 100%;
        margin-right: 8px;
    }
    .unit-input span {
        font-size: 0.9em;
        color: #bdc3c7;
    }
    .setting-item input[type="time"] {
        width: 100%;
        padding: 8px;
        font-size: 0.9em;
    }
    /* [M·ªöI] CSS cho H∆∞·ªõng d·∫´n nh·ªè */
    .input-helper-text {
        font-size: 0.75em;
        color: #7f8c8d;
        font-style: italic;
        margin-top: 4px;
        text-align: right;
    }
    .copy-button-container {
        padding: 5px 5px 15px 5px;
    }
    .copy-button {
        padding: 8px 12px;
        font-size: 0.8em;
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.18s;
        font-weight: 700;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        text-shadow: 0 1px 2px #00000044;
        width: 100%;
    }
    .copy-button:active {
        transform: scale(0.96);
        filter: brightness(0.95);
    }
    .copy-button.sang {
        background: linear-gradient(90deg, #16a085 0%, #43e97b 100%);
    }
    .copy-button.chieu {
        background: linear-gradient(90deg, #2980b9 0%, #6dd5fa 100%);
    }

    /* === Giao di·ªán cho Modal Chung === */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
    }
    .modal-overlay.visible {
        opacity: 1;
        visibility: visible;
    }
    .modal-content {
        background: #2c3e50;
        padding: 20px;
        border-radius: 15px;
        border-top: 5px solid #f1c40f;
        width: 95%;
        max-width: 400px;
        box-shadow: 0 5px 25px rgba(0,0,0,0.4);
        transform: scale(0.9);
        transition: transform 0.3s;
    }
    .modal-overlay.visible .modal-content {
        transform: scale(1);
    }
    .modal-content h4 {
        margin-top: 0;
        margin-bottom: 20px;
        color: #f1c40f;
        text-align: center;
        font-size: 1.2em;
        text-transform: uppercase;
    }
    .modal-buttons {
        display: flex;
        gap: 15px;
        margin-top: 20px;
    }
    .modal-buttons button {
        flex-grow: 1;
        padding: 10px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.2s;
    }
    .modal-confirm-btn {
        background: #f1c40f;
        color: #232526;
    }
    /* [M·ªöI] CSS cho c√°c n√∫t ∆∞u ti√™n trong modal c·∫£nh b√°o */
    .modal-confirm-btn.priority-scenario {
        background: #27ae60;
        color: #fff;
    }
    .modal-confirm-btn.priority-schedule {
        background: #2980b9;
        color: #fff;
    }
    .modal-cancel-btn {
        background: #7f8c8d;
        color: #fff;
    }
    
    .modal-input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 2px solid #7f8c8d;
        background-color: #2c3e50;
        color: #ecf0f1;
        font-size: 1em;
        margin-bottom: 15px;
    }
    .modal-input:focus {
        outline: none;
        border-color: #f1c40f;
    }
    /* [M·ªöI] CSS cho ph·∫ßn m√¥ t·∫£ trong modal */
    #conflict-modal-description {
        text-align: center; 
        margin-top: -10px; 
        margin-bottom: 20px; 
        color: #bdc3c7; 
        font-size: 0.9em; 
        line-height: 1.5;
    }
    #conflict-modal-description strong {
        color: #e74c3c;
    }

    /* === CSS CHO C·∫§U TR√öC TAB G·ªòP === */
    .tablinks-day {
        background: #414345;
        color: #bdc3c7;
        flex-grow: 1;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 10px 5px 8px 5px;
        transition: all 0.2s ease-out;
        font-size: 0.9em;
        font-weight: 700;
        border-radius: 8px;
        margin: 0 2px;
        border-bottom: 3px solid transparent;
    }
    .tablinks-day:hover {
        background: #2c3e50;
        color: #fff;
    }
    .tablinks-day.active {
        background: #f1c40f;
        color: #232526;
        border-bottom-color: #f39c12;
    }
    .tab-session {
        display: flex;
        padding: 0 15px;
        gap: 10px;
        margin-top: 15px;
        margin-bottom: 15px;
    }
    .tablinks-session {
        flex-grow: 1;
        padding: 12px 10px;
        border: 2px solid #414345;
        background: #232526;
        color: #bdc3c7;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
        font-size: 1em;
        text-transform: uppercase;
        transition: all 0.3s;
    }
    .tablinks-session.active[onclick*="'sang'"] {
        background: linear-gradient(90deg, #2ecc71 60%, #27ae60 100%);
        color: #fff;
        border-color: #2ecc71;
        box-shadow: 0 0 15px #2ecc7188;
    }
    .tablinks-session.active[onclick*="'chieu'"] {
        background: linear-gradient(90deg, #3498db 60%, #2980b9 100%);
        color: #fff;
        border-color: #3498db;
        box-shadow: 0 0 15px #3498db88;
    }

    /* === [M·ªöI] GIAO DI·ªÜN L·ªäCH NGH·ªà L·ªÑ === */
    .holiday-calendar-container {
        padding: 0 15px;
        margin-top: 25px;
    }
    .holiday-calendar-container details summary {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 50px;
        border-radius: 10px;
        background: linear-gradient(90deg, #485563 0%, #29323c 100%);
        color: #e74c3c;
        border-left: 4px solid #e74c3c;
        border-right: 4px solid #e74c3c;
        text-shadow: 0 0 12px #e74c3c, 0 2px 8px #000;
        box-shadow: 0 4px 18px 0 #00000044;
    }
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background-color: #34495e;
        border-radius: 8px 8px 0 0;
    }
    .calendar-header button {
        background: none;
        border: none;
        color: #f1c40f;
        font-size: 1.5em;
        cursor: pointer;
    }
    #month-year-display {
        color: #f1c40f;
        font-weight: bold;
        font-size: 1.1em;
    }
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        padding: 10px;
        background-color: #2c3e50;
        border-radius: 0 0 8px 8px;
    }
    .calendar-day, .calendar-day-header {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 35px;
        border-radius: 6px;
        font-weight: bold;
    }
    .calendar-day-header {
        color: #bdc3c7;
        font-size: 0.8em;
    }
    .calendar-day {
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
    }
    .calendar-day:not(.empty):hover {
        background-color: #34495e;
        transform: scale(1.05);
    }
    .calendar-day.holiday {
        background-color: #c0392b;
        color: #fff;
        box-shadow: 0 0 10px #e74c3c88;
    }
    .calendar-day.today {
        border: 2px solid #f1c40f;
    }
    .calendar-day.empty {
        cursor: default;
        opacity: 0.3;
    }

    /* === [TH√äM M·ªöI] CSS CHO T√çNH NƒÇNG H·∫∏N GI·ªú THEO K·ªäCH B·∫¢N === */
    .scenario-timer-container {
        padding: 0 15px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .scenario-input-group {
        background: #232526;
        border: 1px solid #414345;
        border-radius: 8px;
        padding: 12px;
    }
    .scenario-input-group label {
        display: flex;
        align-items: center;
        font-size: 1em;
        font-weight: 600;
        color: #bdc3c7;
        margin-bottom: 8px;
    }
    .scenario-input-group label svg {
        width: 20px;
        height: 20px;
        margin-right: 8px;
        color: #f1c40f;
    }
    .scenario-input-group input {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #7f8c8d;
        background-color: #2c3e50;
        color: #ecf0f1;
        font-size: 1.1em;
    }
    .scenario-helper-text {
        font-size: 0.8em;
        color: #7f8c8d;
        font-style: italic;
        margin-top: 5px;
    }
    .scenario-actions {
    display: flex;
    flex-direction: column; /* <-- D√íNG M·ªöI TH√äM V√ÄO */
    gap: 10px;
    margin-top: 10px;
}
    #scenario-preview-table-container {
        max-height: 250px;
        overflow-y: auto;
    }
    #scenario-preview-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 0.9em;
    }
    #scenario-preview-table th, #scenario-preview-table td {
        border: 1px solid #414345;
        padding: 8px;
        text-align: center;
    }
    #scenario-preview-table th {
        background: #f1c40f;
        color: #232526;
    }
    /* === [CH·ªàNH S·ª¨A THEO Y√äU C·∫¶U] === */
    /* Bi·∫øn #scenario-day-selector th√†nh thanh tab */
    #scenario-day-selector {
        display: flex;
        justify-content: space-around;
        border-bottom: 2px solid #414345;
        position: relative;
        z-index: 1;
        background: transparent; /* B·ªè background c≈© */
        padding: 0; /* B·ªè padding c≈© */
        border-radius: 0; /* B·ªè border-radius c≈© */
    }
    #scenario-day-selector label {
        flex-grow: 1;
        margin: 0 2px;
        padding: 0; /* B·ªè padding c≈© */
        border-radius: 0; /* B·ªè border-radius c≈© */
    }
    #scenario-day-selector span {
        display: block; /* L√†m cho span chi·∫øm to√†n b·ªô kh√¥ng gian c·ªßa label */
        border: none;
        outline: none;
        cursor: pointer;
        padding: 10px 5px 8px 5px;
        transition: all 0.2s ease-out;
        font-size: 0.9em;
        font-weight: 700;
        border-radius: 8px 8px 0 0;
        position: relative;
        top: 2px;
        border-bottom: 3px solid transparent;
        background: transparent;
        color: #bdc3c7;
        text-align: center;
    }
    #scenario-day-selector label:hover span {
        background: #414345;
        color: #fff;
        transform: translateY(-2px);
    }
    #scenario-day-selector input:checked + span {
        background: #f1c40f; /* M√†u v√†ng nh∆∞ y√™u c·∫ßu */
        color: #232526;
        border-bottom-color: #f39c12;
        /* X√≥a c√°c thu·ªôc t√≠nh c≈© kh√¥ng c·∫ßn thi·∫øt */
        box-shadow: none;
        transform: none;
    }
    
  </style>
</head>
<body>
    <div id="notification-area"></div>

  <div id="main">
    <div id="content">
      <div style="text-align: center; padding: 15px 0 5px 0;">
        <h2 id="index-main-title" style="margin: 0; padding: 0;">CHU√îNG B√ÅO T·ª∞ ƒê·ªòNG</h2>
        <p id="school-name-status" style="margin: 5px 0 0 0; padding: 0; font-size: 1.1em; font-weight: bold; text-shadow: 0 2px 8px #000; letter-spacing: 1.2px;">THPT Y√äN KH√ÅNH A</p>
      </div>
      <div class="clock-container" id="clock-wrapper" style="display: none;">
        <div id="clock" class="clock">--:--:--</div>
        <div id="date" class="date-display">ƒêang ch·ªù ƒë·ªìng b·ªô...</div>
      </div>
      
      <div class="main-tabs">
        <button class="main-tab-button active" onclick="openMainTab(event, 'tab-lich-hoc')">üóìÔ∏è L·ªãch H·ªçc</button>
        <button class="main-tab-button" onclick="openMainTab(event, 'tab-hen-gio')">‚è±Ô∏è H·∫πn Gi·ªù</button>
        <button class="main-tab-button" onclick="openMainTab(event, 'tab-cai-dat')">‚öôÔ∏è C√†i ƒê·∫∑t</button>
      </div>

      <div class="main-tab-content-container">
        <div id="tab-lich-hoc" class="main-tab-content active">
          <h3 id="index-schedule-title" style="text-align: center; font-size: 1.15em; font-weight: 900; text-transform: uppercase; letter-spacing: 1.5px; color: #ecf0f1; background: none; border: none; box-shadow: none; margin-bottom: 10px; margin-top: 5px;">
            C√ÄI ƒê·∫∂T L·ªäCH H·ªåC
          </h3>
          
          <div class="tab" id="tab_day">
            <button class="tablinks-day" onclick="selectDay(event, 't2')">T2</button>
            <button class="tablinks-day" onclick="selectDay(event, 't3')">T3</button>
            <button class="tablinks-day" onclick="selectDay(event, 't4')">T4</button>
            <button class="tablinks-day" onclick="selectDay(event, 't5')">T5</button>
            <button class="tablinks-day" onclick="selectDay(event, 't6')">T6</button>
            <button class="tablinks-day" onclick="selectDay(event, 't7')">T7</button>
            <button class="tablinks-day" onclick="selectDay(event, 'cn')">CN</button>
          </div>

          <div class="tab-session" id="tab_session">
            <button class="tablinks-session" onclick="selectSession(event, 'sang')">S√°ng</button>
            <button class="tablinks-session" onclick="selectSession(event, 'chieu')">Chi·ªÅu</button>
          </div>
          
          <div id="tab-content-wrapper"></div>
        </div>

        <div id="tab-hen-gio" class="main-tab-content">
            <h3 style="text-align: center; font-size: 1.15em; font-weight: 900; text-transform: uppercase; letter-spacing: 1.5px; color: #ecf0f1; background: none; border: none; box-shadow: none; margin-bottom: 15px; margin-top: 5px;">
                H·∫∏N GI·ªú THEO K·ªäCH B·∫¢N
            </h3>

           <div class="scenario-timer-container">
    
    <details class="scenario-setup-details">
        <summary>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v5.414l3.293 3.293 1.414-1.414L13 11.586z"></path></svg>
            THI·∫æT L·∫¨P K·ªäCH B·∫¢N M·ªöI
        </summary>
        
        <div class="details-content" style="padding-top: 20px; display: flex; flex-direction: column; gap: 15px;">
            <div class="scenario-input-group">
                <label for="scenario-start-time">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v5.414l3.293 3.293 1.414-1.414L13 11.586z"></path></svg>
                    Th·ªùi gian b·∫Øt ƒë·∫ßu
                </label>
                <input type="time" id="scenario-start-time">
            </div>

            <div class="scenario-input-group">
                <label for="scenario-intervals">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 9a3 3 0 0 0-3 3h6a3 3 0 0 0-3-3z"></path><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path></svg>
                    L·∫∑p l·∫°i sau (ph√∫t)
                </label>
                <input type="text" id="scenario-intervals" placeholder="V√≠ d·ª•: 45,7,4,10">
                <p class="scenario-helper-text">Nh·∫≠p c√°c kho·∫£ng th·ªùi gian ch·ªù, c√°ch nhau b·∫±ng d·∫•u ph·∫©y (,)</p>
            </div>

            <div class="scenario-input-group">
                <label for="scenario-bells">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13.586V10c0-3.217-2.185-5.927-5-6.758V2h-4v1.242C7.185 4.073 5 6.783 5 10v3.586l-1.707 1.707A.996.996 0 0 0 3 16v2a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1v-2a.996.996 0 0 0-.293-.707L19 13.586zM19 17H5v-.586l1.707-1.707A.996.996 0 0 0 7 14v-4c0-2.757 2.243-5 5-5s5 2.243 5 5v4c0 .266.105.52.293.707L19 16.414V17zM12 22a2.98 2.98 0 0 0 2.818-2H9.182A2.98 2.98 0 0 0 12 22z"></path></svg>
                    S·ªë h·ªìi chu√¥ng t∆∞∆°ng ·ª©ng
                </label>
                <input type="text" id="scenario-bells" placeholder="V√≠ d·ª•: 6,3,2,6,3">
                <p class="scenario-helper-text">Nh·∫≠p s·ªë h·ªìi chu√¥ng cho gi·ªù b·∫Øt ƒë·∫ßu v√† c√°c l·∫ßn l·∫∑p l·∫°i</p>
            </div>

            <div class="scenario-input-group">
                <label>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 4h-2V2h-2v2H9V2H7v2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2zm-1 15H6V7h12v12z"></path></svg>
                    √Åp d·ª•ng cho c√°c ng√†y
                </label>
                <div class="day-selector" id="scenario-day-selector">
                    <label><input type="checkbox" name="scenario-day" value="t2"><span>T2</span></label>
                    <label><input type="checkbox" name="scenario-day" value="t3"><span>T3</span></label>
                    <label><input type="checkbox" name="scenario-day" value="t4"><span>T4</span></label>
                    <label><input type="checkbox" name="scenario-day" value="t5"><span>T5</span></label>
                    <label><input type="checkbox" name="scenario-day" value="t6"><span>T6</span></label>
                    <label><input type="checkbox" name="scenario-day" value="t7"><span>T7</span></label>
                    <label><input type="checkbox" name="scenario-day" value="cn"><span>CN</span></label>
                </div>
            </div>
            <div class="scenario-actions">
                <button class="modern-btn test-button" onclick="previewScenario()">Xem Tr∆∞·ªõc K·ªãch B·∫£n</button>
                <button class="modern-btn save-button" onclick="sendScenario()" style="background: linear-gradient(90deg, #27ae60, #2ecc71); border-color: #2ecc71; color: white;">G·ª≠i L·ªánh L√™n Thi·∫øt B·ªã</button>
            </div>
        </div>
    </details>
    <div id="scenario-preview-table-container" style="margin-top: 20px;">
    </div>

    <div id="saved-scenario-container" style="padding: 0; margin-top: 20px;">
        <h5 style="text-align: center; color: #3498db; text-transform: uppercase; margin: 10px 0 15px 0;">
            K·ªäCH B·∫¢N HI·ªÜN T·∫†I ƒêANG L∆ØU TR√äN THI·∫æT B·ªä
        </h5>
        <div id="saved-scenario-table-wrapper" style="max-height: 250px; overflow-y: auto; display: none;">
        </div>
        <p id="saved-scenario-placeholder" class="list-placeholder" style="padding: 10px; display: block;">
            ƒêang ch·ªù d·ªØ li·ªáu t·ª´ thi·∫øt b·ªã...
        </p>
        <div id="saved-scenario-priority" style="text-align: center; font-size: 0.9em; color: #bdc3c7; margin-top: 10px; font-style: italic;">
        </div>
        <div id="saved-scenario-days-display" class="saved-days-container">
        </div>
    </div>
   </div>
  </div>
        <div id="tab-cai-dat" class="main-tab-content">
            <div class="sohoi-container" style="margin-top: 5px;">
              <details> <summary id="header-sohoi">
                      <div id="sohoi-title">C√ÄI ƒê·∫∂T CHU√îNG B√ÅO & √ÇM THANH</div>
                      <span id="sohoi-subtitle" style="font-size: 0.8em; font-weight: normal; color: #ccc; margin-top: 2px;">(CHUNG CHO T·∫§T C·∫¢ C√ÅC NG√ÄY)</span>
                  </summary>
                  <div class="details-content">
                      <div class="settings-grid" style="grid-template-columns: 1fr; gap: 12px;"> 
                          <div class="setting-item">
                              <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13.586V10c0-3.217-2.185-5.927-5-6.758V2h-4v1.242C7.185 4.073 5 6.783 5 10v3.586l-1.707 1.707A.996.996 0 0 0 3 16v2a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1v-2a.996.996 0 0 0-.293-.707L19 13.586zM19 17H5v-.586l1.707-1.707A.996.996 0 0 0 7 14v-4c0-2.757 2.243-5 5-5s5 2.243 5 5v4c0 .266.105.52.293.707L19 16.414V17zM12 22a2.98 2.98 0 0 0 2.818-2H9.182A2.98 2.98 0 0 0 12 22z"></path></svg></div>
                              <div class="input-wrapper">
                                  <label for="sohoi_batdau" id="label-sohoi-batdau">B·∫Øt ƒë·∫ßu bu·ªïi h·ªçc</label>
                                  <div class="unit-input"><input id="sohoi_batdau" type="number" value="6"><span>h·ªìi</span></div>
                              </div>
                          </div>
                          <div class="setting-item">
                               <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13 16.438V7.562a1 1 0 0 0-1.555-.832L8 9.562v4.876l3.445 2.832A1 1 0 0 0 13 16.438zM12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path></svg></div>
                              <div class="input-wrapper">
                                  <label for="sohoi_vaotiet" id="label-sohoi-vaotiet">V√†o ti·∫øt</label>
                                  <div class="unit-input"><input id="sohoi_vaotiet" type="number" value="5"><span>h·ªìi</span></div>
                              </div>
                          </div>
                          <div class="setting-item">
                               <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18 5h-2V2H8v3H6c-1.654 0-3 1.346-3 3v6c0 1.654 1.346 3 3 3h1v1c0 .552.447 1 1 1h6c.553 0 1-.448 1-1v-1h1c1.654 0 3-1.346 3-3V8c0-1.654-1.346-3-3-3zm1 9c0 .552-.447 1-1 1H6c-.553 0-1-.448-1-1V8c0-.552.447-1 1-1h12c.553 0 1 .448 1 1v6z"></path></svg></div>
                              <div class="input-wrapper">
                                  <label for="sohoi_rachoi" id="label-sohoi-rachoi">Ra ch∆°i</label>
                                  <div class="unit-input"><input id="sohoi_rachoi" type="number" value="3"><span>h·ªìi</span></div>
                              </div>
                          </div>
                          <div class="setting-item">
                               <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M14 12V8h-4v4H8l4 4 4-4h-2z"></path></svg></div>
                              <div class="input-wrapper">
                                  <label for="sohoi_duvao" id="label-sohoi-duvao">D·ª± v√†o l·ªõp</label>
                                  <div class="unit-input"><input id="sohoi_duvao" type="number" value="2"><span>h·ªìi</span></div>
                              </div>
                          </div>
                          <hr style="margin: 10px 0; background: #414345; height: 1px; opacity: 0.8;">

                          <h5 style="text-align: center; color: #f1c40f; margin: 10px 0;">C√ÄI ƒê·∫∂T CHUNG CHO CHU√îNG REO</h5>
                          <div class="settings-grid" style="grid-template-columns: 1fr 1fr; padding: 0;">
                              <div class="setting-item">
                                  <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v5.414l3.293 3.293 1.414-1.414L13 11.586z"></path></svg></div>
                                  <div class="input-wrapper">
                                      <label for="sohoi_tg_reo" id="label-sohoi-tgreo">Th·ªùi gian reo (ms)</label>
                                      <div class="unit-input"><input id="sohoi_tg_reo" type="number" value="1000"><span>ms</span></div>
                                  </div>
                              </div>
                              <div class="setting-item">
                                  <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M12 12.586-8.707 9.293l-1.414 1.414L12 15.414l7.121-7.121-1.414-1.414z"></path></svg></div>
                                  <div class="input-wrapper">
                                      <label for="sohoi_tg_nghi" id="label-sohoi-tgnghi">Th·ªùi gian ngh·ªâ (ms)</label>
                                      <div class="unit-input"><input id="sohoi_tg_nghi" type="number" value="1000"><span>ms</span></div>
                                  </div>
                              </div>
                          </div>
                          <div style="padding: 15px 0 0 0;">
                          <button class="modern-btn test-button" onclick="publishTestBell()">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                              <span id="btn-test-bell">Th·ª≠ Chu√¥ng B√°o Chung</span>
                          </button>
                      </div>
                  </div>
              </details>
            </div>
            <div class="holiday-calendar-container">
                <details>
                    <summary>
                        <div>L·ªäCH NGH·ªà L·ªÑ</div>
                    </summary>
                    <div class="details-content">
                        <div class="calendar-header">
                            <button onclick="changeMonth(-1)">&#8249;</button>
                            <div id="month-year-display">Th√°ng 9 2024</div>
                            <button onclick="changeMonth(1)">&#8250;</button>
                        </div>
                        <div class="calendar-grid" id="calendar-grid">
                            </div>
                    </div>
                </details>
            </div>
        </div>

      </div>
      </div>
  </div>
<div class="sticky-action-bar">
  <button class="modern-btn save-button" onclick="publishUpdate()">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
      <span id="btn-save-schedule">L∆∞u v√† g·ª≠i c·∫≠p nh·∫≠t</span>
  </button>
</div>

  <div class="modal-overlay" id="conflict-modal-overlay">
      <div class="modal-content" style="border-top-color: #e74c3c;">
          <h4 style="color: #e74c3c;">C·∫£nh b√°o: Ph√°t hi·ªán xung ƒë·ªôt!</h4>
          <div id="conflict-modal-description">N·ªôi dung xung ƒë·ªôt s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y.</div>
          <p style="text-align: center; font-size: 0.9em; color: #f1c40f; font-weight: bold;">√îng mu·ªën ∆∞u ti√™n th·ª±c hi·ªán l·ªánh n√†o?</p>
          <div class="modal-buttons" style="flex-direction: column; gap: 10px;">
              <button class="modal-confirm-btn priority-scenario" onclick="handleConflictChoice('scenario')">∆Øu ti√™n K·ªãch B·∫£n H·∫πn Gi·ªù</button>
              <button class="modal-confirm-btn priority-schedule" onclick="handleConflictChoice('schedule')">∆Øu ti√™n L·ªãch H·ªçc H√¥m Nay</button>
              <button class="modal-cancel-btn" onclick="handleConflictChoice('cancel')">H·ªßy b·ªè</button>
          </div>
      </div>
  </div>

  <script>
   // [M·ªöI] H√ÄM ƒêI·ªÄU KHI·ªÇN C√ÅC TAB CH√çNH
    function openMainTab(evt, tabName) {
        // L·∫•y t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ c√≥ class="main-tab-content" v√† ·∫©n ch√∫ng ƒëi
        const tabcontent = document.getElementsByClassName("main-tab-content");
        for (let i = 0; i < tabcontent.length; i++) {
            tabcontent[i].classList.remove("active");
        }

        // L·∫•y t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ c√≥ class="main-tab-button" v√† x√≥a class "active"
        const tablinks = document.getElementsByClassName("main-tab-button");
        for (let i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
        }

        // Hi·ªÉn th·ªã tab hi·ªán t·∫°i v√† th√™m m·ªôt class "active" v√†o n√∫t ƒë√£ m·ªü tab
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");

        // [S·ª¨A ƒê·ªîI] ·∫®n/hi·ªán thanh h√†nh ƒë·ªông t√πy theo tab
        const actionBar = document.querySelector('.sticky-action-bar');
        if (tabName === 'tab-lich-hoc' || tabName === 'tab-cai-dat') {
            actionBar.style.display = 'flex';
        } else {
            actionBar.style.display = 'none';
        }
    }
    
    // =======================================================
    // === [B·∫ÆT ƒê·∫¶U] JS M·ªöI CHO H·∫∏N GI·ªú & C·∫¢NH B√ÅO XUNG ƒê·ªòT ===
    // =======================================================

    // Bi·∫øn to√†n c·ª•c ƒë·ªÉ x·ª≠ l√Ω Promise c·ªßa modal
    let resolveConflictPromise = null;
    // [CH·ªàNH S·ª¨A THEO Y√äU C·∫¶U] Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u k·ªãch b·∫£n xem tr∆∞·ªõc
    let previewedScenarioData = null;


    /**
     * M·ªü modal c·∫£nh b√°o xung ƒë·ªôt v√† tr·∫£ v·ªÅ m·ªôt Promise
     * @param {string} message - N·ªôi dung HTML c·ªßa c·∫£nh b√°o
     * @returns {Promise<string>} - Promise s·∫Ω resolve v·ªõi l·ª±a ch·ªçn c·ªßa ng∆∞·ªùi d√πng ('scenario', 'schedule', 'cancel')
     */
    function openConflictModal(message) {
        const modal = document.getElementById('conflict-modal-overlay');
        const description = document.getElementById('conflict-modal-description');
        
        description.innerHTML = message;
        modal.classList.add('visible');

        return new Promise(resolve => {
            resolveConflictPromise = resolve;
        });
    }

    /**
     * ƒê√≥ng modal c·∫£nh b√°o xung ƒë·ªôt
     */
    function closeConflictModal() {
        const modal = document.getElementById('conflict-modal-overlay');
        modal.classList.remove('visible');
    }

    /**
     * X·ª≠ l√Ω l·ª±a ch·ªçn c·ªßa ng∆∞·ªùi d√πng t·ª´ modal c·∫£nh b√°o
     * @param {string} choice - L·ª±a ch·ªçn ('scenario', 'schedule', 'cancel')
     */
    function handleConflictChoice(choice) {
        if (resolveConflictPromise) {
            resolveConflictPromise(choice);
            resolveConflictPromise = null;
        }
        closeConflictModal();
    }
    
    /**
     * [N√ÇNG C·∫§P] H√†m h·ªó tr·ª£ t√≠nh to√°n kho·∫£ng th·ªùi gian ho·∫°t ƒë·ªông c·ªßa m·ªôt bu·ªïi h·ªçc.
     * Tr·∫£ v·ªÅ object ch·ª©a th·ªùi gian b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c (t√≠nh b·∫±ng ph√∫t).
     */
    function getSessionTimeRange(scheduleObject) {
        if (!scheduleObject || !scheduleObject.enabled) return null;

        const hasSpecial = scheduleObject.has_special_event || false;
        const hasDuVao = scheduleObject.has_duvao_bell === undefined ? true : scheduleObject.has_duvao_bell;

        const startTime = timeToMinute(scheduleObject.gio);
        const lessonTime = scheduleObject.tiethoc || 45;
        const lessonCount = scheduleObject.sotiet || 0;
        const prepareTime = hasDuVao ? (scheduleObject.duvaotiet || 3) : 0;

        const breakTimeStr = scheduleObject.rachoi || '5';
        const breakTimes = breakTimeStr.split(',').map(s => parseInt(s.trim()) || 0);

        const specialEventTime = hasSpecial ? (scheduleObject.chaoco || scheduleObject.chunhiem || 0) : 0;
        const specialPrepareTime = hasSpecial ? (scheduleObject.prepare_after_special || 2) : 0;

        if (startTime === 0 || lessonTime === 0 || lessonCount === 0) return null;

        let totalDuration = 0;
        if (hasSpecial && specialEventTime > 0) {
            totalDuration += specialEventTime;
            if (specialPrepareTime > 0) {
                totalDuration += specialPrepareTime;
            }
        }
        
        totalDuration += lessonTime * lessonCount;

        for (let i = 0; i < lessonCount - 1; i++) {
            const currentBreakTime = breakTimes[i] ?? breakTimes[breakTimes.length - 1];
            if (currentBreakTime > 0) {
                totalDuration += currentBreakTime;
                if (prepareTime > 0) {
                    totalDuration += prepareTime;
                }
            }
        }

        const endTime = startTime + totalDuration;
        return { start: startTime, end: endTime };
    }


    /**
     * [N√ÇNG C·∫§P] Ki·ªÉm tra xung ƒë·ªôt gi·ªØa k·ªãch b·∫£n v√† l·ªãch h·ªçc c·ªßa nh·ªØng ng√†y ƒë√£ ch·ªçn.
     * Logic m·ªõi s·∫Ω ki·ªÉm tra xem th·ªùi gian k·ªãch b·∫£n c√≥ n·∫±m TRONG KHO·∫¢NG th·ªùi gian b·∫≠n r·ªôn kh√¥ng.
     */
    async function checkForConflicts(scenario, selectedDays) {
        if (!scenario || scenario.length === 0 || !window.allData || !selectedDays || selectedDays.length === 0) {
            return { conflicting: false };
        }

        for (const dayId of selectedDays) {
            const morningScheduleData = window.allData.lich.sang[dayId];
            const afternoonScheduleData = window.allData.lich.chieu[dayId];

            const morningRange = getSessionTimeRange(morningScheduleData);
            const afternoonRange = getSessionTimeRange(afternoonScheduleData);

            for (const scenarioEvent of scenario) {
                const scenarioTimeInMinutes = timeToMinute(scenarioEvent.time);
                
                let conflictFound = false;
                let conflictSession = '';

                if (morningRange && scenarioTimeInMinutes >= morningRange.start && scenarioTimeInMinutes <= morningRange.end) {
                    conflictFound = true;
                    conflictSession = 'bu·ªïi s√°ng';
                } else if (afternoonRange && scenarioTimeInMinutes >= afternoonRange.start && scenarioTimeInMinutes <= afternoonRange.end) {
                    conflictFound = true;
                    conflictSession = 'bu·ªïi chi·ªÅu';
                }

                if (conflictFound) {
                    const dayNameMap = {t2: 'Th·ª© Hai', t3: 'Th·ª© Ba', t4: 'Th·ª© T∆∞', t5: 'Th·ª© NƒÉm', t6: 'Th·ª© S√°u', t7: 'Th·ª© B·∫£y', cn: 'Ch·ªß Nh·∫≠t'};
                    const dayName = dayNameMap[dayId] || dayId;
                    const message = `C·∫£nh b√°o: Th·ªùi gian <strong>${scenarioEvent.time}</strong> trong k·ªãch b·∫£n c·ªßa √¥ng tr√πng v·ªõi l·ªãch h·ªçc <strong>${conflictSession}</strong> c·ªßa ng√†y <strong>${dayName}</strong>.`;
                    return { conflicting: true, message: message };
                }
            }
        }

        return { conflicting: false };
    }

    function calculateScenario() {
        const startTimeEl = document.getElementById('scenario-start-time');
        const intervalsEl = document.getElementById('scenario-intervals');
        const bellsEl = document.getElementById('scenario-bells');

        if (!startTimeEl.value) {
            showNotification("Vui l√≤ng nh·∫≠p th·ªùi gian b·∫Øt ƒë·∫ßu!", "error");
            return null;
        }

        const intervalsStr = intervalsEl.value.trim();
        const bellsStr = bellsEl.value.trim();

        if (!bellsStr) {
            showNotification("Vui l√≤ng nh·∫≠p chu·ªói s·ªë h·ªìi chu√¥ng!", "error");
            return null;
        }
        
        const intervals = intervalsStr === '' ? [] : intervalsStr.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
        const bells = bellsStr.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
        
        let currentTimeInMinutes = timeToMinute(startTimeEl.value);
        let scenario = [];

        if (bells.length === 0) {
            showNotification("Chu·ªói s·ªë h·ªìi chu√¥ng kh√¥ng h·ª£p l·ªá!", "error");
            return null;
        }

        scenario.push({
            time: minuteToTime(currentTimeInMinutes),
            bell: bells[0]
        });

        const loopCount = Math.min(intervals.length, bells.length - 1);
        for (let i = 0; i < loopCount; i++) {
            currentTimeInMinutes += intervals[i];
            scenario.push({
                time: minuteToTime(currentTimeInMinutes),
                bell: bells[i + 1]
            });
        }

        return scenario;
    }
    
    // [CH·ªàNH S·ª¨A THEO Y√äU C·∫¶U] H√†m m·ªõi ch·ªâ ƒë·ªÉ xem tr∆∞·ªõc
    function previewScenario() {
        const scenario = calculateScenario();
        // S·ª¨A L·ªñI: Hi·ªÉn th·ªã b·∫£ng xem tr∆∞·ªõc
        const previewContainer = document.getElementById('scenario-preview-table-container');

        if (!scenario || scenario.length === 0) {
            previewContainer.innerHTML = ''; // X√≥a xem tr∆∞·ªõc c≈© n·∫øu c√≥ l·ªói
            // H√†m calculateScenario ƒë√£ t·ª± th√¥ng b√°o l·ªói
            return;
        }
        const selectedDays = Array.from(document.querySelectorAll('input[name="scenario-day"]:checked')).map(cb => cb.value);

        // L∆∞u d·ªØ li·ªáu ƒë√£ t√≠nh to√°n v√†o bi·∫øn to√†n c·ª•c ƒë·ªÉ h√†m "sendScenario" s·ª≠ d·ª•ng
        previewedScenarioData = {
            scenario: scenario,
            days: selectedDays
        };

        // T·∫°o HTML cho b·∫£ng xem tr∆∞·ªõc
        let tableHTML = `<h5 style="text-align: center; color: #f1c40f; text-transform: uppercase; margin: 10px 0 15px 0;">B·∫¢NG XEM TR∆Ø·ªöC</h5>
                         <table class="scenario-table">
                            <thead>
                                <tr><th>STT</th><th>Th·ªùi gian</th><th>S·ªë h·ªìi</th></tr>
                            </thead>
                            <tbody>`;
        scenario.forEach((event, index) => {
            tableHTML += `<tr>
                            <td>${index + 1}</td>
                            <td>${event.time}</td>
                            <td>${event.bell} h·ªìi</td>
                        </tr>`;
        });
        tableHTML += `</tbody></table>`;
        
        previewContainer.innerHTML = tableHTML;
        showNotification("ƒê√£ t·∫°o k·ªãch b·∫£n xem tr∆∞·ªõc. Nh·∫•n 'G·ª≠i L·ªánh' ƒë·ªÉ l∆∞u.", "info");
    }

    // [CH·ªàNH S·ª¨A THEO Y√äU C·∫¶U] H√†m m·ªõi d√πng ƒë·ªÉ g·ª≠i l·ªánh (tr∆∞·ªõc ƒë√¢y l√† addScenario)
    async function sendScenario() {
    if (!client || !client.connected) {
        return showNotification("Ch∆∞a k·∫øt n·ªëi m√°y ch·ªß!", 'error');
    }

    if (!previewedScenarioData) {
        showNotification("Vui l√≤ng nh·∫•n 'Xem Tr∆∞·ªõc K·ªãch B·∫£n' tr∆∞·ªõc khi g·ª≠i l·ªánh.", "error");
        return;
    }

    const { scenario, days } = previewedScenarioData;

    if (days.length === 0) {
        return showNotification("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ng√†y ƒë·ªÉ √°p d·ª•ng k·ªãch b·∫£n!", "error");
    }
    if (!scenario || scenario.length === 0) {
        return;
    }

    let userPriority = 'none'; 
    const conflict = await checkForConflicts(scenario, days);

    if (conflict.conflicting) {
        const userChoice = await openConflictModal(conflict.message);
        if (userChoice === 'cancel') {
            showNotification("ƒê√£ h·ªßy g·ª≠i l·ªánh do c√≥ xung ƒë·ªôt.", "info");
            return;
        }
        userPriority = userChoice;
    }

    const payload = {
        scenario: scenario,
        priority: userPriority,
        days: days
    };

    const SCENARIO_SET_TOPIC = "esp32/bell/scenario/set"; 
    client.publish(SCENARIO_SET_TOPIC, JSON.stringify(payload), { qos: 1 });
    
    // [S·ª¨A L·ªñI] C·∫≠p nh·∫≠t giao di·ªán v√† L∆ØU V√ÄO B·ªò NH·ªö TR√åNH DUY·ªÜT NGAY L·∫¨P T·ª®C
    renderSavedScenario(payload);
    try {
        localStorage.setItem('savedScenario', JSON.stringify(payload));
    } catch (e) {
        console.error("L·ªói khi l∆∞u k·ªãch b·∫£n v√†o localStorage:", e);
    }

    document.getElementById('scenario-preview-table-container').innerHTML = '';
    previewedScenarioData = null;
}
    // =======================================================
    // PH·∫¶N M√É G·ªêC (ƒê√É TINH GI·∫¢N CHO ESP8266)
    // =======================================================
    if("true"!==sessionStorage.getItem("isLoggedIn"))window.location.href="login.html";
    
    let client, serverTime = null;
    let selectedDay = 't2', selectedSession = 'sang';
    
    const brokerUrl="wss://8bdef73996bb4030affe9483eecde31b.s1.eu.hivemq.cloud:8884/mqtt";
    const options={username:"ngoctuyka",password:"Tu12345678@",clientId:"WebAppClient_"+parseInt(1e3*Math.random()),reconnectPeriod:2e3,protocolVersion: 4};
    
    // [ƒê√É TINH GI·∫¢N] TOPICS MQTT
    const ONLINE_STATUS_TOPIC = "esp32/bell/status/online";
    const DATA_STATUS_TOPIC = "esp32/bell/data/status";
    const SET_DATA_TOPIC = "esp32/bell/data/set";
    const GET_DATA_TOPIC = "esp32/bell/data/get";
    const CONTROL_TOPIC = "esp32/bell/control";
    const COMMAND_ACK_TOPIC = "esp32/bell/command/ack"; 
    const TIME_DATA_TOPIC = "esp32/bell/data/time"; // <-- Th√™m d√≤ng ƒë·ªãnh nghƒ©a n√†y

    function connectToMqtt(){
        console.log("ƒêang k·∫øt n·ªëi ƒë·∫øn MQTT broker...");
        const schoolNameStatus = document.getElementById("school-name-status");
        schoolNameStatus.className = 'status-color-connecting';
        
        client=mqtt.connect(brokerUrl,options);
        
        client.on("connect",()=>{
            console.log("ƒê√£ k·∫øt n·ªëi th√†nh c√¥ng ƒë·∫øn MQTT broker!");
            // [ƒê√É TINH GI·∫¢N] Ch·ªâ subscribe c√°c topic c·∫ßn thi·∫øt
            

            const topicsToSubscribe = [
                DATA_STATUS_TOPIC, 
                ONLINE_STATUS_TOPIC,
                COMMAND_ACK_TOPIC,
                TIME_DATA_TOPIC // <-- Th√™m topic m·ªõi v√†o danh s√°ch
            ];
            client.subscribe(topicsToSubscribe, {qos:1}, (err)=>{
                if(err) {
                    console.error("L·ªói khi ƒëƒÉng k√Ω topic:", err);
                } else {
                    console.log("ƒêƒÉng k√Ω nh·∫≠n c√°c topic th√†nh c√¥ng!");
                    client.publish(GET_DATA_TOPIC, '1', { qos: 1 });
                }
            });
        });
        
        client.on("message",(topic, payload)=>{
            const payloadString = payload.toString();
            if (topic === COMMAND_ACK_TOPIC) {
    try {
        const ack = JSON.parse(payloadString);
        // D·ª±a tr√™n h√†m publishAck [cite: 59, 60] c·ªßa ESP, ack.status l√† 'success', 'error', 'info'
        // v√† ack.message l√† n·ªôi dung tin nh·∫Øn.
        showNotification(ack.message, ack.status);
    } catch (e) {
        console.error("Loi parse ACK JSON:", e);
    }
}
 else if (topic === "esp32/bell/data/time") {
                try {
                    const data = JSON.parse(payloadString);
                    if (data.time) {
                        const parts = data.time.split(" "); // T√°ch chu·ªói th√†nh ["HH:MM:SS", "DD-MM-YYYY"]
                        
                        // K√≠ch ho·∫°t ƒë·ªìng h·ªì (quan tr·ªçng nh·∫•t)
                        document.getElementById("clock-wrapper").style.display = "block"; 
                        
                        // C·∫≠p nh·∫≠t n·ªôi dung
                        document.getElementById("clock").innerText = parts[0]; // ƒê·∫∑t Gi·ªù
                        document.getElementById("date").innerText = parts[1]; // ƒê·∫∑t Ng√†y
                        
                        // H·ªßy b·ªè bi·∫øn serverTime c≈© ƒë·ªÉ n√≥ kh√¥ng ghi ƒë√®
                        serverTime = null; 
                    }
                } catch (e) {
                    console.error("Loi parse JSON thoi gian:", e);
                }
            }      
                if (topic === ONLINE_STATUS_TOPIC) {
                const schoolNameStatus = document.getElementById("school-name-status");
                if (payloadString === 'online') {
                    schoolNameStatus.className = "status-color-connected";
                    document.getElementById('clock-wrapper').style.display = 'block';
                } else {
                    schoolNameStatus.className = "status-color-disconnected";
                    document.getElementById('clock-wrapper').style.display = 'none';
                    serverTime = null;
                }
            }
            
            if (topic === DATA_STATUS_TOPIC && payloadString) {
                _load(payloadString);
            }

            // [ƒê√É X√ìA] C√°c handler cho topic h·ªá th·ªëng, OTA, nh·∫°c...
        });
        
        client.on("error", e => console.error("L·ªói k·∫øt n·ªëi MQTT:", e));
        
        client.on("close",()=>{
            console.log("M·∫•t k·∫øt n·ªëi MQTT. ƒêang th·ª≠ k·∫øt n·ªëi l·∫°i...");
            document.getElementById("school-name-status").className = "status-color-disconnected";
            document.getElementById('clock-wrapper').style.display = 'none';
            serverTime = null;
        });
    }

    // [ƒê√É X√ìA] C√°c h√†m li√™n quan ƒë·∫øn Ph√°t Nh·∫°c, C√†i ƒë·∫∑t n√¢ng cao, Giao di·ªán...

    function showNotification(message, type = 'success') {
        const area = document.getElementById('notification-area');
        const notif = document.createElement('div');
        notif.className = `notification ${type}`;
        notif.textContent = message;
        area.appendChild(notif);
        
        setTimeout(() => { notif.classList.add('show'); }, 10);

        setTimeout(() => {
            notif.classList.remove('show');
            setTimeout(() => {
                if(area.contains(notif)) {
                    area.removeChild(notif);
                }
            }, 300);
        }, 4000);
    }

function _load(e) {
    try {
        const t = JSON.parse(e);
        window.allData = null; 

        if (t.data) { // C·∫•u tr√∫c m·ªõi
            if (t.data.epoch) setTime(t.data.epoch);
            if (t.data.schedule) {
                window.allData = t.data.schedule;
                populateForm(t.data.schedule);
            }
            if (t.data.holidays) loadHolidayData(t.data.holidays);
            if (t.data.scenario) {
                console.log("Nhan du lieu scenario tu MQTT, dang cap nhat UI...");
                renderSavedScenario(t.data.scenario);
                
                // ƒê·ªìng b·ªô l·∫°i localStorage v·ªõi d·ªØ li·ªáu m·ªõi nh·∫•t t·ª´ thi·∫øt b·ªã
                localStorage.setItem('savedScenario', JSON.stringify(t.data.scenario));
            }

        } else { // C·∫•u tr√∫c c≈© (d·ª± ph√≤ng)
             if (t.epoch) setTime(t.epoch);
             if (t.schedule) {
                window.allData = t.schedule;
                populateForm(t.schedule);
             }
             if (t.holidays) loadHolidayData(t.holidays);
             // C·∫•u tr√∫c c≈© kh√¥ng c√≥ k·ªãch b·∫£n n√™n kh√¥ng c·∫ßn l√†m g√¨ th√™m.
        }

    } catch (error) {
        console.error("L·ªói parse JSON t·ª´ MQTT:", error);
    }
}
    // =======================================================
// === [TH√äM M·ªöI] H√ÄM X·ª¨ L√ù L·ªäCH NGH·ªà L·ªÑ KHI T·∫¢I TRANG ===
// =======================================================
function loadHolidayData(holidays) {
    if (holidays) {
        console.log("Nhan du lieu lich nghi le tu ESP32:", holidays);
        // L∆∞u d·ªØ li·ªáu v√†o bi·∫øn to√†n c·ª•c ƒë·ªÉ c√°c h√†m kh√°c s·ª≠ d·ª•ng
        holidayData = holidays;

        // V·∫Ω l·∫°i giao di·ªán l·ªãch v·ªõi d·ªØ li·ªáu m·ªõi
        // H√†m n√†y s·∫Ω t·ª± ƒë·ªông ƒë·ªçc bi·∫øn holidayData v√† t√¥ m√†u ƒë√∫ng c√°c ng√†y ngh·ªâ
        generateCalendar(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth());
    }
}
    function publishUpdate() {
    if (!client || !client.connected) return showNotification("Ch∆∞a k·∫øt n·ªëi m√°y ch·ªß!", 'error');
    try {
        const scheduleData = gatherDataFromForm();
        const payload = {
            schedule: scheduleData,
            holidays: holidayData
        };
        const payloadString = JSON.stringify(payload);
        client.publish(SET_DATA_TOPIC, payloadString, { qos: 1, retain: true });
        } catch (e) {
        showNotification("L·ªói: " + e.message, 'error');
        console.error(e)
    }
}
    
    function publishTestBell(){
        if(client&&client.connected) {
            const payload = { command: "TEST_BELL" };
            client.publish(CONTROL_TOPIC, JSON.stringify(payload), {qos:1});
            showNotification("ƒê√£ g·ª≠i l·ªánh th·ª≠ chu√¥ng chung...");
        } else {
            showNotification("Ch∆∞a k·∫øt n·ªëi m√°y ch·ªß!", 'error');
        }
    }

    function logout(){sessionStorage.removeItem("isLoggedIn"),window.location.href="login.html"}
    function setTime(e){isNaN(e)||e<1e5?(console.log("Invalid epoch received, clock not set:",e),serverTime=null):(serverTime=new Date(1e3*e),document.getElementById("date").innerHTML=serverTime.toLocaleDateString("vi-VN",{weekday:"long",year:"numeric",month:"long",day:"numeric",timeZone:"Asia/Ho_Chi_Minh"}),updateLocalClock())}
    function updateLocalClock(){serverTime&&(serverTime.setSeconds(serverTime.getSeconds()+1),document.getElementById("clock").innerHTML=serverTime.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:"Asia/Ho_Chi_Minh",hour12:!1}))}
    
    function toggleSettings(headerElement) {
        const content = headerElement.nextElementSibling;
        if (content && content.classList.contains('collapsible-settings')) {
            headerElement.classList.toggle('expanded');
            content.classList.toggle('expanded');
        }
    }

    function toggleScheduleActivation(dayId) {
        const isEnabled = document.getElementById(`enable_${dayId}`).checked;
        const enableItem = document.getElementById(`toggle_item_enable_${dayId}`);
        const specialItem = document.getElementById(`toggle_item_special_${dayId}`);
        const duvaoItem = document.getElementById(`toggle_item_duvao_${dayId}`);
        const settingsContainer = document.getElementById(`settings_container_${dayId}`);
        const isChieu = dayId.includes('_chieu');

        if (isEnabled) {
            if (enableItem) {
                enableItem.classList.add('active');
                if (isChieu) enableItem.classList.add('chieu-style');
            }
            if (specialItem) specialItem.classList.remove('disabled');
            if (duvaoItem) duvaoItem.classList.remove('disabled');
            if (settingsContainer) settingsContainer.classList.remove('hidden');
        } else {
            if (enableItem) {
                enableItem.classList.remove('active', 'chieu-style');
            }
            if (specialItem) specialItem.classList.add('disabled');
            if (duvaoItem) duvaoItem.classList.add('disabled');
            if (settingsContainer) settingsContainer.classList.add('hidden');
        }
    }

    function toggleSpecialEvent(dayId) {
        const checkbox = document.getElementById(`has_special_${dayId}`);
        const container = document.getElementById(`special_event_container_${dayId}`);
        if (container) {
            container.style.display = checkbox.checked ? 'grid' : 'none'; // Use grid for consistency
        }
    }

    function toggleDuVao(dayId) {
        const checkbox = document.getElementById(`has_duvao_${dayId}`);
        const inputWrapper = document.getElementById(`duvao_wrapper_${dayId}`);
        if (inputWrapper) {
            inputWrapper.style.display = checkbox.checked ? 'flex' : 'none';
        }
    }

    // =======================================================
    // === [N√ÇNG C·∫§P] C√ÅC H√ÄM T·∫†O GIAO DI·ªÜN V√Ä T√çNH TO√ÅN L·ªäCH H·ªåC ===
    // =======================================================

    const createDayContent = (e, t, o) => {
        const isMondayMorning = (e === 't2_sang');
        
        // Icons
        const d = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v5.414l3.293 3.293 1.414-1.414L13 11.586z"></path></svg></div>`;
        const r = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 4h-2V2h-2v2H9V2H7v2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2zm-1 15H6V7h12v12z"></path></svg></div>`;
        const l = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 2H6c-1.206 0-3 .799-3 3v14c0 2.201 1.794 3 3 3h15v-2H6.012C5.55 19.988 5 19.806 5 19s.55-.988 1.012-1H21V4c0-1.103-.897-2-2-2zm0 13H6V5h13v10z"></path></svg></div>`;
        const c = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18 5h-2V2H8v3H6c-1.654 0-3 1.346-3 3v6c0 1.654 1.346 3 3 3h1v1c0 .552.447 1 1 1h6c.553 0 1-.448 1-1v-1h1c1.654 0 3-1.346 3-3V8c0-1.654-1.346-3-3-3zm1 9c0 .552-.447 1-1 1H6c-.553 0-1-.448-1-1V8c0-.552.447-1 1-1h12c.553 0 1 .448 1 1v6z"></path></svg></div>`;
        const m = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M14 12V8h-4v4H8l4 4 4-4h-2z"></path></svg></div>`;
        const p = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h2v2H4zm0 5h2v2H4zm0 5h2v2H4zm16-8V6H8v2h12zm0 5H8v2h12zm0 5H8v2h12z"></path></svg></div>`;
        
        // [N√ÇNG C·∫§P] T·∫°o HTML cho khu v·ª±c s·ª± ki·ªán ƒë·∫∑c bi·ªát, bao g·ªìm c·∫£ √¥ nh·∫≠p th·ªùi gian chu·∫©n b·ªã
        const specialEventInput = isMondayMorning 
            ? `<div class="setting-item full-width">${r}<div class="input-wrapper"><label for="chaoco_${e}">TG Ch√†o c·ªù</label><div class="unit-input"><input id="chaoco_${e}" type="number" value="40"><span>ph√∫t</span></div></div></div>`
            : `<div class="setting-item full-width">${r}<div class="input-wrapper"><label for="chunhiem_${e}">TG Sinh ho·∫°t</label><div class="unit-input"><input id="chunhiem_${e}" type="number" value="15"><span>ph√∫t</span></div></div></div>`;
        const prepareAfterSpecialInput = `<div class="setting-item full-width">${m}<div class="input-wrapper"><label for="prepare_after_special_${e}">TG chu·∫©n b·ªã sau SH/CC</label><div class="unit-input"><input id="prepare_after_special_${e}" type="number" value="2"><span>ph√∫t</span></div></div></div>`;
        const u = specialEventInput + prepareAfterSpecialInput;

        let g = ""; // Copy button HTML
        if (!isMondayMorning) {
            if (o === 'sang') {
                g = `<div class="copy-button-container"><button class="copy-button sang" onclick="copyMorningSchedule('${e}')">Sao ch√©p ƒë·∫øn T3-CN (S√°ng)</button></div>`;
            } else { // 'chieu'
                g = `<div class="copy-button-container"><button class="copy-button chieu" onclick="copyAfternoonSchedule('${e}')">Sao ch√©p ƒë·∫øn c√°c ng√†y Chi·ªÅu</button></div>`;
            }
        }
        
        return `
        <div id="${e}" class="tabcontent">
            <h3 onclick="toggleSettings(this)">C√†i ƒë·∫∑t L·ªãch ${t}<br><span class="session-subtitle">(Bu·ªïi ${"sang"===o?"S√°ng":"Chi·ªÅu"})</span></h3>
            
            <div class="collapsible-settings">
                <div class="toggle-actions-group">
                    <div id="toggle_item_enable_${e}" class="toggle-action-item">
                        <div class="toggle-action-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42A6.92 6.92 0 0 1 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-1.93.78-3.68 2-4.95L5.59 5.64A8.96 8.96 0 0 0 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.49-1-4.73-2.67-6.41z"/></svg></div>
                        <div class="toggle-action-text">K√≠ch ho·∫°t L·ªãch</div>
                        <label class="switch ${"chieu"===o?"chieu-toggle":""}">
                            <input type="checkbox" id="enable_${e}" onchange="toggleScheduleActivation('${e}')" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="toggle_item_special_${e}" class="toggle-action-item">
                        <div class="toggle-action-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></div>
                        <div class="toggle-action-text">${isMondayMorning ? 'C√≥ Gi·ªù Ch√†o c·ªù' : 'C√≥ Gi·ªù Sinh ho·∫°t'}</div>
                        <label class="switch ${"chieu"===o?"chieu-toggle":""}">
                            <input type="checkbox" id="has_special_${e}" onchange="toggleSpecialEvent('${e}')">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="toggle_item_duvao_${e}" class="toggle-action-item">
                        <div class="toggle-action-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M10 20h4c0 1.1-.9 2-2 2s-2-.9-2-2zm10-2.64V11c0-3.35-2.36-6.15-5.5-6.83V3.5c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5V4.17C8.36 4.85 6 7.65 6 11v6.36L4 19.72V20h16v-.28l-2-2.36zM15 11h2v2h-2v-2zm-4 0h2v2h-2v-2zm-4 0h2v2H7v-2z"/></svg></div>
                        <div class="toggle-action-text">C√≥ Chu√¥ng D·ª± v√†o l·ªõp</div>
                        <label class="switch ${"chieu"===o?"chieu-toggle":""}">
                            <input type="checkbox" id="has_duvao_${e}" onchange="toggleDuVao('${e}')" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div id="settings_container_${e}" class="settings-grid-container">
                    ${g}
                    <hr style="margin: 15px; background: #414345; height: 1px; opacity: 0.5;">

                    <div class="settings-grid">
                        <div class="setting-item full-width">${d}<div class="input-wrapper"><label for="gio_${e}">Gi·ªù v√†o h·ªçc</label><input id="gio_${e}" type="time"></div></div>
                        
                        <div id="special_event_container_${e}" class="settings-grid full-width" style="display: none; grid-template-columns: 1fr; gap: 8px; padding: 0;">${u}</div>
                        
                        <div class="setting-item">${l}<div class="input-wrapper"><label for="tiethoc_${e}">TG Ti·∫øt h·ªçc</label><div class="unit-input"><input id="tiethoc_${e}" type="number" value="45"><span>ph√∫t</span></div></div></div>
                        <div class="setting-item">${c}<div class="input-wrapper"><label for="rachoi_${e}">TG Ra ch∆°i</label><div class="unit-input"><input id="rachoi_${e}" type="text" value="5"><span>ph√∫t</span></div><div class="input-helper-text">VD: 5,15,5,5</div></div></div>
                        <div class="setting-item" id="duvao_wrapper_${e}">${m}<div class="input-wrapper"><label for="duvaotiet_${e}">TG D·ª± v√†o</label><div class="unit-input"><input id="duvaotiet_${e}" type="number" value="3"><span>ph√∫t</span></div></div></div>
                        <div class="setting-item">${p}<div class="input-wrapper"><label for="sotiet_${e}">S·ªë ti·∫øt h·ªçc</label><div class="unit-input"><input id="sotiet_${e}" type="number" value="5"><span>ti·∫øt</span></div></div></div>
                    </div>
                    
                    <button class="modern-btn preview-button" onclick="updatePreviewTable('${e}')" style="height: 40px; font-size: 0.85em; background: #34495e; color: #f1c40f; border: 1px solid #f1c40f; margin-top: 15px;">C·∫≠p nh·∫≠t b·∫£ng chi ti·∫øt</button>

                </div>
            </div>

            <details style="margin-top: 15px;">
                <summary>Xem chi ti·∫øt l·ªãch</summary>
                <div class="details-container" id="details-${e}"></div>
            </details>
        </div>`
    }
    
    const contentWrapper = document.getElementById("tab-content-wrapper");
    const days=[{id:"t2",name:"Th·ª© 2"},{id:"t3",name:"Th·ª© 3"},{id:"t4",name:"Th·ª© 4"},{id:"t5",name:"Th·ª© 5"},{id:"t6",name:"Th·ª© 6"},{id:"t7",name:"Th·ª© 7"},{id:"cn",name:"Ch·ªß Nh·∫≠t"}];
    
    function populateForm(e){
        const t = e;
        if(t&&t.sohoi&&t.lich){
            document.querySelectorAll('#tab-content-wrapper .tabcontent').forEach(el => el.remove());
            console.log("Bat dau cap nhat form voi du lieu:",t);

            // [ƒê√É ƒê∆†N GI·∫¢N H√ìA CHO ESP8266]
            const bellTypes = ["batdau","vaotiet","rachoi","duvao"];
            bellTypes.forEach(type => {
                const numInput = document.getElementById(`sohoi_${type}`);
                // H·ªó tr·ª£ c·∫£ c·∫•u tr√∫c c≈© (ch·ªâ c√≥ s·ªë) v√† c·∫•u tr√∫c m·ªõi (object .num)
                if(numInput) numInput.value = t.sohoi[type]?.num || (t.sohoi[type] || "");
            });
            // [K·∫æT TH√öC ƒê∆†N GI·∫¢N H√ìA]
            
            ["tg_reo", "tg_nghi"].forEach(e=>{
                const o=document.getElementById(`sohoi_${e}`);
                o&&(o.value=t.sohoi[e]||"")
            });
            
            days.forEach(day => {
                contentWrapper.innerHTML += createDayContent(`${day.id}_sang`, day.name, "sang");
                contentWrapper.innerHTML += createDayContent(`${day.id}_chieu`, day.name, "chieu");
            });

            ["sang","chieu"].forEach(e=>{
                days.forEach(o=>{
                    const n=t.lich?.[e]?.[o.id];
                    if(n){
                        const dayId = `${o.id}_${e}`;
                        document.getElementById(`enable_${dayId}`).checked=n.enabled;
                        document.getElementById(`gio_${dayId}`).value=n.gio||"";
                        document.getElementById(`tiethoc_${dayId}`).value=n.tiethoc||"";
                        document.getElementById(`rachoi_${dayId}`).value=n.rachoi||"5"; // [N√ÇNG C·∫§P]
                        document.getElementById(`duvaotiet_${dayId}`).value=n.duvaotiet||"";
                        document.getElementById(`sotiet_${dayId}`).value=n.sotiet||"";
                        
                        const chaocoInput = document.getElementById(`chaoco_${dayId}`);
                        if(chaocoInput) chaocoInput.value=n.chaoco||0;
                        
                        const chunhiemInput = document.getElementById(`chunhiem_${dayId}`);
                        if(chunhiemInput) chunhiemInput.value=n.chunhiem||0;
                        
                        // [N√ÇNG C·∫§P & S·ª¨A L·ªñI] T·∫£i d·ªØ li·ªáu cho tr∆∞·ªùng m·ªõi v√† x·ª≠ l√Ω ƒë√∫ng gi√° tr·ªã 0
                        const prepareSpecialInput = document.getElementById(`prepare_after_special_${dayId}`);
                        if(prepareSpecialInput) prepareSpecialInput.value = n.prepare_after_special ?? 0;
                        
                        const hasSpecialCheckbox = document.getElementById(`has_special_${dayId}`);
                        if (hasSpecialCheckbox) {
                            hasSpecialCheckbox.checked = n.has_special_event || false;
                            toggleSpecialEvent(dayId);
                        }
                        
                        const hasDuVaoCheckbox = document.getElementById(`has_duvao_${dayId}`);
                        if (hasDuVaoCheckbox) {
                            hasDuVaoCheckbox.checked = n.has_duvao_bell === undefined ? true : n.has_duvao_bell;
                            toggleDuVao(dayId);
                        }
                        
                        toggleScheduleActivation(dayId);
                        updatePreviewTable(dayId);
                    }
                })
            });
             showActiveTab();
        } else {
            console.error("D·ªØ li·ªáu l·ªãch h·ªçc nh·∫≠n ƒë∆∞·ª£c kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng ƒë·∫ßy ƒë·ªß:",e)
        }
    }

    function gatherDataFromForm(){
        const e={sohoi:{},lich:{sang:{},chieu:{}}};
        
        // [ƒê√É ƒê∆†N GI·∫¢N H√ìA CHO ESP8266]
        const bellTypes = ["batdau","vaotiet","rachoi","duvao"];
        bellTypes.forEach(type => {
            // G·ª≠i ƒëi object v·ªõi action 'bell' m·∫∑c ƒë·ªãnh ƒë·ªÉ t∆∞∆°ng th√≠ch
            // v·ªõi firmware c√≥ th·ªÉ v·∫´n mong ƒë·ª£i object, nh∆∞ng kh√¥ng c√≥ t√πy ch·ªçn nh·∫°c
            e.sohoi[type] = {
                num: parseInt(document.getElementById(`sohoi_${type}`).value) || 0,
                action: "bell",
                track: "",
                volume: 0,
                random: false
            };
        });
        // [K·∫æT TH√öC ƒê∆†N GI·∫¢N H√ìA]
        
        ["tg_reo", "tg_nghi"].forEach(t=>{
            e.sohoi[t]=parseInt(document.getElementById(`sohoi_${t}`).value)||0
        });

        ["sang","chieu"].forEach(t=>{
            days.forEach(o=>{
                const dayId = `${o.id}_${t}`;
                const n=e.lich[t][o.id]={};
                n.enabled=document.getElementById(`enable_${dayId}`).checked;
                n.gio=document.getElementById(`gio_${dayId}`).value;
                n.tiethoc=parseInt(document.getElementById(`tiethoc_${dayId}`).value)||0;
                n.rachoi=document.getElementById(`rachoi_${dayId}`).value || "5"; // [N√ÇNG C·∫§P]
                n.duvaotiet=parseInt(document.getElementById(`duvaotiet_${dayId}`).value)||0;
                n.sotiet=parseInt(document.getElementById(`sotiet_${dayId}`).value)||0;
                
                const chaocoInput = document.getElementById(`chaoco_${dayId}`);
                if(chaocoInput) n.chaoco=parseInt(chaocoInput.value)||0;
                
                const chunhiemInput = document.getElementById(`chunhiem_${dayId}`);
                if(chunhiemInput) n.chunhiem=parseInt(chunhiemInput.value)||0;
                
                // [N√ÇNG C·∫§P & S·ª¨A L·ªñI] Thu th·∫≠p d·ªØ li·ªáu t·ª´ tr∆∞·ªùng m·ªõi v√† x·ª≠ l√Ω ƒë√∫ng gi√° tr·ªã 0
                const prepareSpecialInput = document.getElementById(`prepare_after_special_${dayId}`);
                if(prepareSpecialInput) {
                    const val = parseInt(prepareSpecialInput.value);
                    n.prepare_after_special = isNaN(val) ? 0 : val;
                }

                const hasSpecialCheckbox = document.getElementById(`has_special_${dayId}`);
                if (hasSpecialCheckbox) n.has_special_event = hasSpecialCheckbox.checked;

                const hasDuVaoCheckbox = document.getElementById(`has_duvao_${dayId}`);
                if (hasDuVaoCheckbox) n.has_duvao_bell = hasDuVaoCheckbox.checked;
            })
        });
        return e;
    }

    function selectDay(evt, day) {
        selectedDay = day;
        document.querySelectorAll('.tablinks-day').forEach(btn => btn.classList.remove('active'));
        evt.currentTarget.classList.add('active');
        showActiveTab();
    }

    function selectSession(evt, session) {
        selectedSession = session;
        document.querySelectorAll('.tablinks-session').forEach(btn => btn.classList.remove('active'));
        evt.currentTarget.classList.add('active');
        showActiveTab();
    }

    function showActiveTab() {
        document.querySelectorAll('.tabcontent').forEach(content => {
            content.classList.remove('active');
        });
        const activeTabId = `${selectedDay}_${selectedSession}`;
        const activeContent = document.getElementById(activeTabId);
        if (activeContent) {
            activeContent.classList.add('active');
        }
    }

    function timeToMinute(e){if(!e)return 0;const[t,o]=e.split(":").map(Number);return 60*t+o}function minuteToTime(e){const t=Math.floor(e/60).toString().padStart(2,"0"),o=(e%60).toString().padStart(2,"0");return`${t}:${o}`}
    
    // [S·ª¨A L·ªñI] H√†m getVal ƒë∆∞·ª£c vi·∫øt l·∫°i ƒë·ªÉ x·ª≠ l√Ω ƒë√∫ng gi√° tr·ªã 0
    const getVal = (id, defaultValue = 0) => {
        const el = document.getElementById(id);
        if (!el) return defaultValue;
        const parsedValue = parseInt(el.value);
        return isNaN(parsedValue) ? defaultValue : parsedValue;
    };

    // [N√ÇNG C·∫§P TO√ÄN B·ªò] H√†m t√≠nh to√°n l·ªãch h·ªçc ƒë∆∞·ª£c vi·∫øt l·∫°i ƒë·ªÉ linh ho·∫°t h∆°n
    function calculateSchedule(dayId) {
        const isEnabled = document.getElementById(`enable_${dayId}`)?.checked;
        if (!isEnabled) return []; // [M·ªöI] Tr·∫£ v·ªÅ m·∫£ng r·ªóng n·∫øu l·ªãch b·ªã t·∫Øt

        const hasSpecial = document.getElementById(`has_special_${dayId}`)?.checked;
        const hasDuVao = document.getElementById(`has_duvao_${dayId}`)?.checked;
        
        const startTime = timeToMinute(document.getElementById(`gio_${dayId}`).value);
        const lessonTime = getVal(`tiethoc_${dayId}`, 45);
        const lessonCount = getVal(`sotiet_${dayId}`, 5);
        const prepareTime = hasDuVao ? getVal(`duvaotiet_${dayId}`, 3) : 0;
        
        const breakTimeStr = document.getElementById(`rachoi_${dayId}`).value || '5';
        const breakTimes = breakTimeStr.split(',').map(s => parseInt(s.trim()) || 0);

        const isMondayMorning = dayId.includes('t2_sang');
        const specialEventTime = hasSpecial ? getVal(isMondayMorning ? `chaoco_${dayId}` : `chunhiem_${dayId}`) : 0;
        
        // [S·ª¨A L·ªñI] M·∫∑c ƒë·ªãnh th·ªùi gian chu·∫©n b·ªã l√† 0 n·∫øu ƒë·ªÉ tr·ªëng, theo y√™u c·∫ßu
        const specialPrepareTime = hasSpecial ? getVal(`prepare_after_special_${dayId}`, 0) : 0;
        
        if (startTime === 0 || lessonTime === 0 || lessonCount === 0) return [];

        let schedule = [];
        let currentTime = startTime;

        // 1. X·ª≠ l√Ω s·ª± ki·ªán ƒë·∫∑c bi·ªát (Ch√†o c·ªù/Sinh ho·∫°t) n·∫øu c√≥
        if (hasSpecial && specialEventTime > 0) {
            schedule.push({ time: currentTime, description: isMondayMorning ? "Ch√†o c·ªù" : "Sinh ho·∫°t" });
            currentTime += specialEventTime;
            
            if (specialPrepareTime > 0) {
                schedule.push({ time: currentTime, description: "Ngh·ªâ sau SH/CC" });
                currentTime += specialPrepareTime;
            }
        }

        // 2. V√≤ng l·∫∑p qua c√°c ti·∫øt h·ªçc v√† gi·ªù ra ch∆°i
        for (let i = 1; i <= lessonCount; i++) {
            schedule.push({ time: currentTime, description: `V√†o ti·∫øt ${i}` });
            currentTime += lessonTime;

            if (i < lessonCount) {
                const currentBreakTime = breakTimes[i - 1] ?? breakTimes[breakTimes.length - 1]; 
                
                if (currentBreakTime > 0) {
                    schedule.push({ time: currentTime, description: `Ra ch∆°i ti·∫øt ${i}` });
                    currentTime += currentBreakTime;

                    if (prepareTime > 0) {
                        schedule.push({ time: currentTime, description: `D·ª± v√†o ti·∫øt ${i + 1}` });
                        currentTime += prepareTime;
                    }
                }
            }
        }

        // 3. Th√™m s·ª± ki·ªán "Ra v·ªÅ"
        schedule.push({ time: currentTime, description: "Ra v·ªÅ" });
        
        const uniqueSchedule = Array.from(new Map(schedule.map(item => [item.time, item])).values());
        return uniqueSchedule
            .map(item => ({ ...item, timeInMinutes: item.time, time: minuteToTime(item.time) }))
            .sort((a, b) => a.timeInMinutes - b.timeInMinutes);
    }

    function updatePreviewTable(e){const t=document.getElementById(`enable_${e}`).checked,o=document.getElementById("details-"+e);if(!o)return;if(!t)return void(o.innerHTML="<p style='text-align:center; padding: 10px;'>L·ªãch n√†y ƒëang t·∫Øt.</p>");const n=calculateSchedule(e);let a="<table><thead><tr><th>STT</th><th>Th·ªùi gian</th><th>N·ªôi dung</th></tr></thead><tbody>";n.forEach((e,t)=>{a+=`<tr><td>${t+1}</td><td>${e.time}</td><td>${e.description}</td></tr>`}),a+="</tbody></table>",o.innerHTML=a}
    
    // [N√ÇNG C·∫§P] C√°c h√†m sao ch√©p ƒë·ªÉ bao g·ªìm c·∫£ tr∆∞·ªùng d·ªØ li·ªáu m·ªõi
    function copyAfternoonSchedule(sourceDayId) {
        const sourceDayName = sourceDayId.split('_')[0].toUpperCase();
        if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën sao ch√©p l·ªãch c·ªßa ${sourceDayName} (chi·ªÅu) ƒë·∫øn T·∫§T C·∫¢ c√°c ng√†y c√≤n l·∫°i c·ªßa bu·ªïi chi·ªÅu kh√¥ng?`)) return;

        const sourceData = {
            enabled: document.getElementById(`enable_${sourceDayId}`).checked,
            gio: document.getElementById(`gio_${sourceDayId}`).value,
            has_special_event: document.getElementById(`has_special_${sourceDayId}`).checked,
            chunhiem: document.getElementById(`chunhiem_${sourceDayId}`).value,
            prepare_after_special: document.getElementById(`prepare_after_special_${sourceDayId}`).value,
            has_duvao_bell: document.getElementById(`has_duvao_${sourceDayId}`).checked,
            tiethoc: document.getElementById(`tiethoc_${sourceDayId}`).value,
            rachoi: document.getElementById(`rachoi_${sourceDayId}`).value,
            duvaotiet: document.getElementById(`duvaotiet_${sourceDayId}`).value,
            sotiet: document.getElementById(`sotiet_${sourceDayId}`).value
        };

        const sourceId = sourceDayId.replace('_chieu', '');
        days.filter(d => d.id !== sourceId).forEach(day => {
            const targetDayId = `${day.id}_chieu`;
            document.getElementById(`enable_${targetDayId}`).checked = sourceData.enabled;
            document.getElementById(`gio_${targetDayId}`).value = sourceData.gio;
            document.getElementById(`has_special_${targetDayId}`).checked = sourceData.has_special_event;
            document.getElementById(`chunhiem_${targetDayId}`).value = sourceData.chunhiem;
            document.getElementById(`prepare_after_special_${targetDayId}`).value = sourceData.prepare_after_special;
            document.getElementById(`has_duvao_${targetDayId}`).checked = sourceData.has_duvao_bell;
            document.getElementById(`tiethoc_${targetDayId}`).value = sourceData.tiethoc;
            document.getElementById(`rachoi_${targetDayId}`).value = sourceData.rachoi;
            document.getElementById(`duvaotiet_${targetDayId}`).value = sourceData.duvaotiet;
            document.getElementById(`sotiet_${targetDayId}`).value = sourceData.sotiet;
            
            toggleSpecialEvent(targetDayId);
            toggleDuVao(targetDayId);
            toggleScheduleActivation(targetDayId);
            updatePreviewTable(targetDayId);
        });
        showNotification('Sao ch√©p th√†nh c√¥ng! H√£y nh·∫•n "L∆∞u v√† g·ª≠i c·∫≠p nh·∫≠t" ƒë·ªÉ √°p d·ª•ng.', "success");
    }

    function copyMorningSchedule(sourceDayId) {
        const sourceDayName = sourceDayId.split('_')[0].toUpperCase();
        if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën sao ch√©p l·ªãch c·ªßa ${sourceDayName} (s√°ng) ƒë·∫øn c√°c ng√†y c√≤n l·∫°i (T3-CN) kh√¥ng?`)) return;

        const sourceData = {
            enabled: document.getElementById(`enable_${sourceDayId}`).checked,
            gio: document.getElementById(`gio_${sourceDayId}`).value,
            has_special_event: document.getElementById(`has_special_${sourceDayId}`).checked,
            chunhiem: document.getElementById(`chunhiem_${sourceDayId}`).value,
            prepare_after_special: document.getElementById(`prepare_after_special_${sourceDayId}`).value,
            has_duvao_bell: document.getElementById(`has_duvao_${sourceDayId}`).checked,
            tiethoc: document.getElementById(`tiethoc_${sourceDayId}`).value,
            rachoi: document.getElementById(`rachoi_${sourceDayId}`).value,
            duvaotiet: document.getElementById(`duvaotiet_${sourceDayId}`).value,
            sotiet: document.getElementById(`sotiet_${sourceDayId}`).value
        };
        
        const sourceId = sourceDayId.replace('_sang', '');
        const targetDays = ["t3", "t4", "t5", "t6", "t7", "cn"].filter(id => id !== sourceId);
        
        targetDays.forEach(dayId => {
            const targetDayId = `${dayId}_sang`;
            document.getElementById(`enable_${targetDayId}`).checked = sourceData.enabled;
            document.getElementById(`gio_${targetDayId}`).value = sourceData.gio;
            document.getElementById(`has_special_${targetDayId}`).checked = sourceData.has_special_event;
            document.getElementById(`chunhiem_${targetDayId}`).value = sourceData.chunhiem;
            document.getElementById(`prepare_after_special_${targetDayId}`).value = sourceData.prepare_after_special;
            document.getElementById(`has_duvao_${targetDayId}`).checked = sourceData.has_duvao_bell;
            document.getElementById(`tiethoc_${targetDayId}`).value = sourceData.tiethoc;
            document.getElementById(`rachoi_${targetDayId}`).value = sourceData.rachoi;
            document.getElementById(`duvaotiet_${targetDayId}`).value = sourceData.duvaotiet;
            document.getElementById(`sotiet_${targetDayId}`).value = sourceData.sotiet;

            toggleSpecialEvent(targetDayId);
            toggleDuVao(targetDayId);
            toggleScheduleActivation(targetDayId);
            updatePreviewTable(targetDayId);
        });
        showNotification('Sao ch√©p th√†nh c√¥ng! H√£y nh·∫•n "L∆∞u v√† g·ª≠i c·∫≠p nh·∫≠t" ƒë·ªÉ √°p d·ª•ng.',"success");
    }
    // =======================================================
    // === K·∫æT TH√öC PH·∫¶N N√ÇNG C·∫§P ===
    // =======================================================
    
    function initializeTabs() {
        const dayMap = ['cn', 't2', 't3', 't4', 't5', 't6', 't7'];
        const today = new Date();
        const currentDayId = dayMap[today.getDay()];

        selectedDay = currentDayId;

        const todayButton = document.querySelector(`.tablinks-day[onclick*="'${currentDayId}'"]`);
        if (todayButton) {
            document.querySelectorAll('.tablinks-day').forEach(btn => btn.classList.remove('active'));
            todayButton.classList.add('active');
        } else {
            document.querySelector('.tablinks-day').classList.add('active');
        }

        document.querySelector(`.tablinks-session[onclick*="'${selectedSession}'"]`).classList.add('active');
        
        days.forEach(day => {
            contentWrapper.innerHTML += createDayContent(`${day.id}_sang`, day.name, "sang");
            contentWrapper.innerHTML += createDayContent(`${day.id}_chieu`, day.name, "chieu");
        });

        showActiveTab();
    }
    
    // =======================================================
    // [M·ªöI] SCRIPT CHO L·ªäCH NGH·ªà L·ªÑ
    // =======================================================
    let holidayData = {}; 
    let currentDisplayDate = new Date();

    function generateCalendar(year, month) {
        const grid = document.getElementById('calendar-grid');
        const display = document.getElementById('month-year-display');
        grid.innerHTML = '';

        const today = new Date();
        const firstDayOfMonth = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        display.textContent = `Th√°ng ${month + 1} ${year}`;
        currentDisplayDate = new Date(year, month, 1);

        ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'].forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'calendar-day-header';
            dayHeader.textContent = day;
            grid.appendChild(dayHeader);
        });

        for (let i = 0; i < firstDayOfMonth.getDay(); i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'calendar-day empty';
            grid.appendChild(emptyCell);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';
            dayCell.textContent = day;
            
            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            dayCell.setAttribute('data-date', dateString);

            if (holidayData[dateString]) {
                dayCell.classList.add('holiday');
            }
            if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                dayCell.classList.add('today');
            }

            dayCell.onclick = () => toggleHoliday(dateString);
            grid.appendChild(dayCell);
        }
    }

    function changeMonth(offset) {
        currentDisplayDate.setMonth(currentDisplayDate.getMonth() + offset);
        generateCalendar(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth());
    }

    // File: index full.html

function toggleHoliday(dateString) {
    function loadHolidayData(data) {
    if (data) {
        holidayData = data; // C·∫≠p nh·∫≠t bi·∫øn to√†n c·ª•c v·ªõi d·ªØ li·ªáu t·ª´ thi·∫øt b·ªã
        // V·∫Ω l·∫°i giao di·ªán l·ªãch v·ªõi d·ªØ li·ªáu m·ªõi
        generateCalendar(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth());
    }
}
    const cell = document.querySelector(`.calendar-day[data-date="${dateString}"]`);
    if (holidayData[dateString]) {
        delete holidayData[dateString];
        if(cell) cell.classList.remove('holiday');
    } else {
        holidayData[dateString] = true; // Gi√° tr·ªã c√≥ th·ªÉ l√† true ho·∫∑c m·ªôt object r·ªóng
        if(cell) cell.classList.add('holiday');
    }

    // [TH√äM M·ªöI] G·ª≠i c·∫≠p nh·∫≠t l·ªãch ngh·ªâ l·ªÖ ngay l·∫≠p t·ª©c
    if (!client || !client.connected) {
        return showNotification("Ch∆∞a k·∫øt n·ªëi m√°y ch·ªß! Thay ƒë·ªïi ch∆∞a ƒë∆∞·ª£c l∆∞u.", 'error');
    }

    // T·∫°o m·ªôt payload ch·ªâ ch·ª©a th√¥ng tin ng√†y ngh·ªâ
    const payload = {
        holidays: holidayData 
    };

    // G·ª≠i l√™n topic SET_DATA_TOPIC, ESP32 s·∫Ω t·ª± bi·∫øt c√°ch x·ª≠ l√Ω
    client.publish(SET_DATA_TOPIC, JSON.stringify(payload), { qos: 1, retain: true });
}
    // =======================================================

    window.onload = function() { 
        // [ƒê√É X√ìA] loadInterfaceSettings();
        connectToMqtt();
        setInterval(updateLocalClock, 1000);

        // [S·ª¨A L·ªñI] T·∫£i k·ªãch b·∫£n ƒë√£ l∆∞u t·ª´ b·ªô nh·ªõ tr√¨nh duy·ªát ngay khi v√†o trang
        try {
            const lastScenario = localStorage.getItem('savedScenario');
            if (lastScenario) {
                renderSavedScenario(JSON.parse(lastScenario));
            }
        } catch (e) {
            console.error("Kh√¥ng th·ªÉ t·∫£i k·ªãch b·∫£n t·ª´ localStorage:", e);
        }
        
        // [ƒê√É X√ìA] C√°c event listener cho OTA, Giao di·ªán, Ph√°t nh·∫°c...

        initializeTabs();
        generateCalendar(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth());
        document.querySelector('.sticky-action-bar').style.display = 'flex';
    };

// === [PH∆Ø∆†NG √ÅN M·ªöI] THAY TH·∫æ TO√ÄN B·ªò H√ÄM renderSavedScenario ===
// File: index 4.html (b√™n trong th·∫ª <script>)

// === [GI·∫¢I PH√ÅP D·ª®T ƒêI·ªÇM] THAY TH·∫æ TO√ÄN B·ªò H√ÄM N√ÄY ===
function renderSavedScenario(savedData) {
    const wrapper = document.getElementById('saved-scenario-table-wrapper');
    const priorityDiv = document.getElementById('saved-scenario-priority');
    const placeholder = document.getElementById('saved-scenario-placeholder');
    const daysDisplayContainer = document.getElementById('saved-scenario-days-display');

    // Lu√¥n x√≥a n·ªôi dung c≈© c·ªßa c√°c ph·∫ßn t·ª≠ c√≥ th·ªÉ thay ƒë·ªïi
    priorityDiv.innerHTML = '';
    daysDisplayContainer.innerHTML = '';

    // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu, ho·∫∑c d·ªØ li·ªáu r·ªóng:
    if (!savedData || !savedData.scenario || savedData.scenario.length === 0) {
        // ·∫®n b·∫£ng v√† hi·ªán placeholder.
        wrapper.style.display = 'none';
        placeholder.style.display = 'block';
        return; // D·ª´ng h√†m t·∫°i ƒë√¢y
    }

    // N·∫øu c√≥ d·ªØ li·ªáu h·ª£p l·ªá:
    // Hi·ªán b·∫£ng v√† ·∫©n placeholder.
    wrapper.style.display = 'block';
    placeholder.style.display = 'none';

    // 1. Hi·ªÉn th·ªã b·∫£ng k·ªãch b·∫£n
    let tableHTML = `<table class="scenario-table"><thead><tr><th>STT</th><th>Th·ªùi gian</th><th>S·ªë h·ªìi</th></tr></thead><tbody>`;
    savedData.scenario.forEach((event, index) => {
        tableHTML += `<tr><td>${index + 1}</td><td>${event.time}</td><td>${event.bell} h·ªìi</td></tr>`;
    });
    tableHTML += `</tbody></table>`;
    wrapper.innerHTML = tableHTML; // ƒê·∫∑t n·ªôi dung cho b·∫£ng

    // 2. Hi·ªÉn th·ªã tr·∫°ng th√°i ∆∞u ti√™n
    if (savedData.priority === 'scenario') {
        priorityDiv.textContent = '∆Øu ti√™n hi·ªán t·∫°i: K·ªãch B·∫£n';
        priorityDiv.style.color = '#2ecc71';
    } else if (savedData.priority === 'schedule') {
        priorityDiv.textContent = '∆Øu ti√™n hi·ªán t·∫°i: L·ªãch H·ªçc';
        priorityDiv.style.color = '#3498db';
    }

    // 3. Hi·ªÉn th·ªã c√°c huy hi·ªáu ng√†y ƒë√£ l∆∞u
    if (savedData.days && savedData.days.length > 0) {
        const label = document.createElement('span');
        label.className = 'day-badge-label';
        label.textContent = 'ƒêang √°p d·ª•ng cho:';
        daysDisplayContainer.appendChild(label);
        
        const dayNameMap = {t2: 'T2', t3: 'T3', t4: 'T4', t5: 'T5', t6: 'T6', t7: 'T7', cn: 'CN'};
        
        savedData.days.forEach(dayId => {
            const badge = document.createElement('span');
            badge.className = 'day-badge';
            badge.textContent = dayNameMap[dayId] || dayId.toUpperCase();
            daysDisplayContainer.appendChild(badge);
        });
    }
}
  </script>
  
<script>
// This is a remnant script block from the original file. It is being kept for 100% file integrity,
// but the main logic is handled by the larger script block above. The functions here are overridden.
function addScenario() {
  const startTime = document.getElementById("scenario-start-time").value;
  const intervals = document.getElementById("scenario-intervals").value;
  const bells = document.getElementById("scenario-bells").value;

  if (!startTime || !bells) {
    showNotification("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!", "error");
    return;
  }

  const scenario = { startTime, intervals, bells };

  if (typeof client !== 'undefined' && client && client.connected) {
    client.publish("device/command/saveScenario", JSON.stringify(scenario));
    showNotification("ƒê√£ g·ª≠i k·ªãch b·∫£n l√™n thi·∫øt b·ªã", "success");
  } else {
    showNotification("M·∫•t k·∫øt n·ªëi MQTT", "error");
  }

  const tableHtml = `
    <table class="scenario-table">
      <thead>
        <tr><th>STT</th><th>Th·ªùi gian</th><th>S·ªë h·ªìi</th></tr>
      </thead>
      <tbody>
        <tr>
          <td>1</td>
          <td>${startTime}${intervals ? " +" + intervals : ""}</td>
          <td>${bells} h·ªìi</td>
        </tr>
      </tbody>
    </table>
  `;
  document.getElementById("saved-scenario-table-wrapper").innerHTML = tableHtml;
}

function showNotification(msg, type="info") {
  const area = document.getElementById("notification-area");
  if (!area) return;
  const div = document.createElement("div");
  div.className = `notification ${type}`;
  div.textContent = msg;
  area.appendChild(div);
  setTimeout(() => div.classList.add("show"), 50);
  setTimeout(() => {
    div.classList.remove("show");
    if (div.parentNode) div.parentNode.removeChild(div);
  }, 3000);
}
</script>

</body>
</html>
