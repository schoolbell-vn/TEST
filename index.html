<!DOCTYPE html>
<html lang="vi">
<head>
  <title>Hẹn Giờ Chuông Báo - Điều khiển Internet</title>
  <meta name="viewport" content="width=device-width,user-scalable=0" charset="utf-8">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js" type="text/javascript"></script>
  
  <style type="text/css">
    body{ background: #1e1e1e; font-family: Verdana, sans-serif; color: #f0f0f0; }
    #main{ margin: 10px auto; width: 360px; }
    #content{ background-color: #2a2a2a; border: 1px solid #444; width: 360px; float: left; border-radius: 8px; padding-bottom: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); }
    h2 { font-size: 1.4em; margin-top: 20px; margin-bottom: 10px; text-align: center; color: #ffa500; text-shadow: 0 0 5px rgba(255, 165, 0, 0.5); }
    h3{ margin-top: 25px; margin-bottom: 20px; text-align: center; font-size: 1.2em; font-weight: bold; }
    #header-sang { color: #66ff99; }
    #header-chieu { color: #66ccff; }
    h4 { text-align: center; color: yellow; border-top: 1px solid #444; padding-top: 15px; margin-top: 15px; }
    hr { border: 1px solid #444; margin: 25px 15px; }
    .div1{ padding: 0 15px; float: left; margin-bottom: 10px; width: 100%; box-sizing: border-box; }
    .tab1{ width: 150px; float: left; line-height: 25px; }
    .tab2{ width: 120px; float: left; display: flex; align-items: center; }
    /* [SỬA ĐỔI] Thêm input[type="text"] để định dạng ô Ra chơi */
    input[type="number"], input[type="time"], input[type="text"] { width: 80px; float: left; margin-right: 10px; background-color: #333; border: 1px solid #555; color: white; border-radius: 4px; padding: 5px; }
    input[type="checkbox"].enable-checkbox { width: 18px; height: 18px; transform: scale(1.1); margin-top: 1px; }
    .row{ margin-bottom: 8px; float: left; width: 100%; min-height: 35px; display: flex; align-items: center; }
    .activation-row .tab1 b { font-size: 0.95em; font-weight: normal; }
    .status-bar { padding: 8px 15px; margin-bottom: 10px; text-align: center; font-weight: bold; border-radius: 4px; transition: background-color 0.5s; }
    .status-connected { background-color: #28a745; color: white; }
    .status-disconnected { background-color: #dc3545; color: white; }
    .button-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; padding: 0 15px; }
    input[type="button"] { padding: 12px; font-size: 1em; font-weight: bold; border-radius: 6px; border: 1px solid rgba(0,0,0,0.2); cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .preview-button { background-image: linear-gradient(to top, #4CAF50, #5cdb61); color: white; margin-top: 10px; width: calc(100% - 30px); margin-left: 15px; margin-right: 15px;}
    .save-button { background-image: linear-gradient(to top, #008CBA, #00a8e0); color: white; }
    .test-button { background-image: linear-gradient(to top, #f44336, #f65a4c); color: white; }
    .tab { display: flex; justify-content: space-around; border-bottom: 1px solid #444; margin: 0 15px 15px 15px;}
    .tab button { flex-grow: 1; border: 1px solid #444; border-bottom: none; outline: none; cursor: pointer; padding: 10px 5px; transition: all 0.3s; font-size: 0.85em; color: #ccc; font-weight: bold; background-color: #333; margin: 0 2px -1px 2px; border-radius: 6px 6px 0 0; }
    #tab_sang button.active { background-color: #66ff99; color: #111; border-color: #66ff99; }
    #tab_chieu button.active { background-color: #66ccff; color: #111; border-color: #66ccff; }
    .tabcontent { display: none; padding: 0 15px;}
    .details-container table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .details-container th, .details-container td { border: 1px solid #444; padding: 8px; text-align: center; font-size:13px; }
    .details-container th { background-color: #3a3a3a; }
    /* --- [THÊM MỚI] CSS CHO ĐỒNG HỒ --- */
.clock-container { 
    text-align: center; 
    margin: 15px auto 10px auto; 
    background: #3a3a3a;
    border: 1px solid #555; 
    border-radius: 8px; 
    padding: 8px 10px;
    width: 90%;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.clock {
    font-size: 2.2em;
    color: #ffa500;
    text-shadow: 0 0 5px rgba(255, 165, 0, 0.5);
    letter-spacing: 2px;
    font-family: 'Courier New', Courier, monospace;
    font-weight: bold;
}
.date-display { 
    font-size: 0.9em; 
    color: #f0f0f0; 
    margin-top: 5px; 
    font-weight: 500; 
}
  </style>
</head>
<body>
  <div id="main">
    <div id="content">
      <div style="text-align: center;">
        <h2>CHUÔNG BÁO TỰ ĐỘNG</h2>
        <div class="clock-container" id="clock-wrapper" style="display: none;">
  <div id="clock" class="clock">--:--:--</div>
  <div id="date" class="date-display">Đang chờ đồng bộ...</div>
</div>
      </div>
      
      <div id="status" class="status-bar status-disconnected">Đang kết nối...</div>
      
      <h3 id="header-sang">LỊCH BUỔI SÁNG</h3>
      <div class="tab" id="tab_sang">
        <button class="tablinks-sang" onclick="openDay(event, 't2_sang', 'sang')">Thứ 2</button>
        <button class="tablinks-sang" onclick="openDay(event, 't3_sang', 'sang')">Thứ 3</button>
        <button class="tablinks-sang" onclick="openDay(event, 't4_sang', 'sang')">Thứ 4</button>
        <button class="tablinks-sang" onclick="openDay(event, 't5_sang', 'sang')">Thứ 5</button>
        <button class="tablinks-sang" onclick="openDay(event, 't6_sang', 'sang')">Thứ 6</button>
        <button class="tablinks-sang" onclick="openDay(event, 't7_sang', 'sang')">Thứ 7</button>
        <button class="tablinks-sang" onclick="openDay(event, 'cn_sang', 'sang')">CN</button>
      </div>
      <div id="tab-container-sang"></div>
      
      <hr>

      <h3 id="header-chieu">LỊCH BUỔI CHIỀU</h3>
      <div class="tab" id="tab_chieu">
        <button class="tablinks-chieu" onclick="openDay(event, 't2_chieu', 'chieu')">Thứ 2</button>
        <button class="tablinks-chieu" onclick="openDay(event, 't3_chieu', 'chieu')">Thứ 3</button>
        <button class="tablinks-chieu" onclick="openDay(event, 't4_chieu', 'chieu')">Thứ 4</button>
        <button class="tablinks-chieu" onclick="openDay(event, 't5_chieu', 'chieu')">Thứ 5</button>
        <button class="tablinks-chieu" onclick="openDay(event, 't6_chieu', 'chieu')">Thứ 6</button>
        <button class="tablinks-chieu" onclick="openDay(event, 't7_chieu', 'chieu')">Thứ 7</button>
        <button class="tablinks-chieu" onclick="openDay(event, 'cn_chieu', 'chieu')">CN</button>
      </div>
      <div id="tab-container-chieu"></div>
      
      <div class="settings-section div1">
        <h3>Cài đặt số hồi chuông (Chung)</h3>
        <div class="row"><div class="tab1">Bắt đầu buổi học:</div><div class="tab2"><input id="sohoi_batdau" type="number" value="6"><span>hồi</span></div></div>
        <div class="row"><div class="tab1">Vào tiết:</div><div class="tab2"><input id="sohoi_vaotiet" type="number" value="5"><span>hồi</span></div></div>
        <div class="row"><div class="tab1">Ra chơi:</div><div class="tab2"><input id="sohoi_rachoi" type="number" value="3"><span>hồi</span></div></div>
        <div class="row"><div class="tab1">Dự vào lớp:</div><div class="tab2"><input id="sohoi_duvao" type="number" value="2"><span>hồi</span></div></div>
      </div>

      <div class="button-container">
        <input type="button" class="save-button" onclick="updateAllData()" value="Lưu tất cả vào thiết bị">
        <input type="button" class="test-button" onclick="sendControl()" value="Thử Chuông">
      </div>
    </div>
  </div>

  <script>
    let client; // Khai báo biến client ở phạm vi toàn cục
    let serverTime = null; // <-- THÊM BIẾN NÀY
    // Cấu hình kết nối
    const brokerUrl = 'wss://8bdef73996bb4030affe9483eecde31b.s1.eu.hivemq.cloud:8884/mqtt';
    const options = {
      username: 'ngoctuyka',
      password: 'Tu12345678@',
      clientId: 'WebAppClient_' + new Date().getTime(), // SỬA LỖI: Dùng timestamp để ClientID luôn duy nhất
      reconnectPeriod: 1000, // Tự động kết nối lại sau mỗi giây nếu mất kết nối
    };

    function connectToMqtt() {
      console.log('Đang kết nối đến MQTT broker với thư viện MQTT.js...');
      document.getElementById('status').textContent = 'Đang kết nối...';
      document.getElementById('status').className = 'status-bar status-disconnected';

      // Khởi tạo kết nối
      client = mqtt.connect(brokerUrl, options);

      // Xử lý sự kiện khi kết nối thành công
      client.on('connect', () => {
        console.log('Đã kết nối thành công đến MQTT broker!');
        document.getElementById('status').textContent = 'Đã kết nối';
        document.getElementById('status').className = 'status-bar status-connected';
        
        // Đăng ký nhận dữ liệu từ thiết bị
        client.subscribe('esp8266/bell/data/status', (err) => {
          if (err) {
            console.error('Lỗi khi đăng ký topic:', err);
          } else {
            console.log('Đăng ký nhận topic esp8266/bell/data/status thành công!');
            
            // Chủ động yêu cầu thiết bị gửi lại dữ liệu hiện tại
            client.publish('esp8266/bell/data/get', 'GET_DATA');
            console.log('Đã gửi yêu cầu lấy dữ liệu đến thiết bị.');
          }
        });
      });

      // Xử lý khi nhận được tin nhắn từ các topic đã đăng ký
      // Xử lý khi nhận được tin nhắn từ các topic đã đăng ký
  client.on('message', (topic, payload) => {
    const payloadString = payload.toString();
    console.log(`Nhận được tin nhắn từ topic: ${topic}`);

    if (topic === 'esp8266/bell/data/status') { // Khớp với topic ông đã sửa ở Giải pháp 1
       try {
            const data = JSON.parse(payloadString);

            // [THÊM MỚI] Trích xuất dữ liệu epoch để chạy đồng hồ
            if (data.epoch && data.epoch > 100000) {
                setTime(data.epoch);
                document.getElementById('clock-wrapper').style.display = 'block'; // Hiển thị đồng hồ
            }

            // Trích xuất dữ liệu lịch (kiểm tra cả cấu trúc cũ và mới)
            const allData = data.schedule ? data.schedule : data;
            populateForm(allData);

        } catch (e) {
            console.error("Lỗi parse JSON:", e, payloadString);
        }
    }
  });

      // Xử lý khi có lỗi kết nối
      client.on('error', (err) => {
        console.error('Lỗi kết nối MQTT:', err);
      });

      // Xử lý khi mất kết nối
      client.on('close', () => {
        console.log('Mất kết nối MQTT. Thư viện sẽ tự động kết nối lại.');
        document.getElementById('status').textContent = 'Mất kết nối. Đang thử lại...';
        document.getElementById('status').className = 'status-bar status-disconnected';
      });
    }

    function updateAllData() {
      if (!client || !client.connected) {
        alert('Chưa kết nối đến thiết bị. Vui lòng kiểm tra lại.');
        return;
      }
      const allData = gatherDataFromForm();
      // [SỬA] Gửi đi theo cấu trúc mới { "schedule": { ... } }
      const message = JSON.stringify({ schedule: allData });
      client.publish('esp8266/bell/data/set', message, { retain: true });
      alert('Đã gửi lệnh cập nhật thành công!');
    }
    
    function sendControl() {
      if (!client || !client.connected) {
        alert('Chưa kết nối đến thiết bị. Vui lòng kiểm tra lại.');
        return;
      }
       // [SỬA] Gửi đi theo cấu trúc JSON
      client.publish('esp8266/bell/control', JSON.stringify({ command: "TEST_BELL" }));
    }
    
    // =========================================================================
    // CÁC HÀM GIAO DIỆN (ĐÃ CẬP NHẬT)
    // =========================================================================
    
    // [HÀM ĐÃ CẬP NHẬT]
    const createDayContent = (dayId, dayName, session, hasChaoCo, hasChuNhiem) => {
        let specialPeriod = '';
        // [THÊM] Trường "TG nghỉ sau SH/CC" (prepare_after_special)
        const prepareAfterSpecialInput = `<div class="row"><div class="tab1" style="font-size: 0.9em;">TG nghỉ sau SH/CC:</div><div class="tab2"><input id="prepare_after_special_${dayId}" type="number" value="2"><span>phút</span></div></div>`;

        if (hasChaoCo) {
            specialPeriod = `<div class="row"><div class="tab1">TG Chào cờ:</div><div class="tab2"><input id="chaoco_${dayId}" type="number" value="40"><span>phút</span></div></div>` + prepareAfterSpecialInput;
        } else if (hasChuNhiem) {
            specialPeriod = `<div class="row"><div class="tab1">TG Chủ nhiệm:</div><div class="tab2"><input id="chunhiem_${dayId}" type="number" value="15"><span>phút</span></div></div>` + prepareAfterSpecialInput;
        }
        
        // [THAY ĐỔI] Trường "TG Ra chơi" từ number thành text và thêm helper text
        const breakTimeInput = `
            <div class="row">
                <div class="tab1">TG Ra chơi:</div>
                <div class="tab2"><input id="rachoi_${dayId}" type="text" value="5" style="width: 100px;"><span>phút</span></div>
            </div>
            <div class="row" style="margin-top: -8px; margin-bottom: 0; min-height: 15px;">
                <div class="tab1"></div>
                <div class="tab2" style="font-size: 0.75em; color: #ccc; width: 100%;"><i>(VD: 5,15,5)</i></div>
            </div>`;

        return `
        <div id="${dayId}" class="tabcontent">
          <h3>Cài đặt Lịch ${dayName} (Buổi ${session === 'sang' ? 'Sáng' : 'Chiều'})</h3>
          <div class="row activation-row"><div class="tab1"><b>Kích hoạt lịch:</b></div><div class="tab2"><input type="checkbox" id="enable_${dayId}" class="enable-checkbox" checked></div></div>
          <div class="row"><div class="tab1">Giờ bắt đầu:</div><div class="tab2"><input id="gio_${dayId}" type="time"></div></div>
          ${specialPeriod}
          <div class="row"><div class="tab1">TG Tiết học:</div><div class="tab2"><input id="tiethoc_${dayId}" type="number" value="45"><span>phút</span></div></div>
          ${breakTimeInput}
          <div class="row"><div class="tab1">TG Dự vào:</div><div class="tab2"><input id="duvaotiet_${dayId}" type="number" value="3"><span>phút</span></div></div>
          <div class="row"><div class="tab1">Số tiết học:</div><div class="tab2"><input id="sotiet_${dayId}" type="number" value="5"><span>tiết</span></div></div>
          <input type="button" class="preview-button" onclick="updatePreviewTable('${dayId}')" value="Cập nhật bảng chi tiết">
          <h4>Chi tiết lịch chuông</h4>
          <div class="details-container" id="details-${dayId}"></div>
        </div>`;
    };

    const containerSang = document.getElementById('tab-container-sang');
    const containerChieu = document.getElementById('tab-container-chieu');
    const days = [
        { id: 't2', name: 'Thứ 2', chaoCo: true, chuNhiem: false },
        { id: 't3', name: 'Thứ 3', chaoCo: false, chuNhiem: true },
        { id: 't4', name: 'Thứ 4', chaoCo: false, chuNhiem: true },
        { id: 't5', name: 'Thứ 5', chaoCo: false, chuNhiem: true },
        { id: 't6', name: 'Thứ 6', chaoCo: false, chuNhiem: true },
        { id: 't7', name: 'Thứ 7', chaoCo: false, chuNhiem: true },
        { id: 'cn', name: 'Chủ Nhật', chaoCo: false, chuNhiem: false }
    ];

    days.forEach(day => {
        containerSang.innerHTML += createDayContent(`${day.id}_sang`, day.name, 'sang', day.chaoCo, day.chuNhiem);
        containerChieu.innerHTML += createDayContent(`${day.id}_chieu`, day.name, 'chieu', false, false);
    });
    
    // [HÀM ĐÃ CẬP NHẬT]
    function populateForm(allData) {
        if (!allData || !allData.sohoi || !allData.lich) {
            console.warn("Dữ liệu nhận được không đầy đủ, sử dụng giá trị mặc định.");
            return;
        }

        ['batdau', 'vaotiet', 'rachoi', 'duvao'].forEach(key => {
            if(document.getElementById(`sohoi_${key}`)) {
                // [SỬA] Đọc từ allData.sohoi[key].num nếu là cấu trúc mới, hoặc allData.sohoi[key] nếu là cấu trúc cũ
                const value = (typeof allData.sohoi[key] === 'object') ? allData.sohoi[key].num : allData.sohoi[key];
                document.getElementById(`sohoi_${key}`).value = value || '';
            }
        });

        ['sang', 'chieu'].forEach(session => {
            days.forEach(day => {
                const dayId = `${day.id}_${session}`;
                if(document.getElementById(dayId)) {
                    const dayData = allData.lich[session] ? allData.lich[session][day.id] : null;
                    if (dayData) {
                        document.getElementById(`enable_${dayId}`).checked = dayData.enabled;
                        document.getElementById(`gio_${dayId}`).value = dayData.gio || '';
                        document.getElementById(`tiethoc_${dayId}`).value = dayData.tiethoc || '';
                        // [SỬA] rachoi giờ là string, mặc định là '5'
                        document.getElementById(`rachoi_${dayId}`).value = dayData.rachoi || '5'; 
                        document.getElementById(`duvaotiet_${dayId}`).value = dayData.duvaotiet || '';
                        document.getElementById(`sotiet_${dayId}`).value = dayData.sotiet || '';
                        if (document.getElementById(`chaoco_${dayId}`)) {
                            document.getElementById(`chaoco_${dayId}`).value = dayData.chaoco || '';
                        }
                        if (document.getElementById(`chunhiem_${dayId}`)) {
                            document.getElementById(`chunhiem_${dayId}`).value = dayData.chunhiem || '';
                        }
                        // [THÊM] Đọc giá trị 'prepare_after_special'
                        if (document.getElementById(`prepare_after_special_${dayId}`)) {
                            // Xử lý cả trường hợp giá trị là 0 hoặc không tồn tại (undefined)
                            document.getElementById(`prepare_after_special_${dayId}`).value = dayData.prepare_after_special ?? 2;
                        }
                        updatePreviewTable(dayId);
                    }
                }
            });
        });
    }

    // [HÀM ĐÃ CẬP NHẬT]
    function gatherDataFromForm() {
        const allData = { sohoi: {}, lich: { sang: {}, chieu: {} } };
        ['batdau', 'vaotiet', 'rachoi', 'duvao'].forEach(key => {
            // [SỬA] Ghi dữ liệu theo cấu trúc mới { num: ... } để đồng bộ
            allData.sohoi[key] = {
                num: parseInt(document.getElementById(`sohoi_${key}`).value) || 0
            };
        });
        
        ['sang', 'chieu'].forEach(session => {
            days.forEach(day => {
                const dayId = `${day.id}_${session}`;
                if(document.getElementById(dayId)) {
                    const dayData = {};
                    dayData.enabled = document.getElementById(`enable_${dayId}`).checked;
                    dayData.gio = document.getElementById(`gio_${dayId}`).value;
                    dayData.tiethoc = parseInt(document.getElementById(`tiethoc_${dayId}`).value) || 0;
                    // [SỬA] Giữ nguyên là chuỗi
                    dayData.rachoi = document.getElementById(`rachoi_${dayId}`).value || '5'; 
                    dayData.duvaotiet = parseInt(document.getElementById(`duvaotiet_${dayId}`).value) || 0;
                    dayData.sotiet = parseInt(document.getElementById(`sotiet_${dayId}`).value) || 0;
                    
                    if (document.getElementById(`chaoco_${dayId}`)) {
                        dayData.chaoco = parseInt(document.getElementById(`chaoco_${dayId}`).value) || 0;
                    }
                    if (document.getElementById(`chunhiem_${dayId}`)) {
                        dayData.chunhiem = parseInt(document.getElementById(`chunhiem_${dayId}`).value) || 0;
                    }
                    // [THÊM] Lấy giá trị 'prepare_after_special'
                    if (document.getElementById(`prepare_after_special_${dayId}`)) {
                        dayData.prepare_after_special = parseInt(document.getElementById(`prepare_after_special_${dayId}`).value) || 0;
                    }
                    
                    // [THÊM] Suy luận các giá trị boolean để đồng bộ
                    dayData.has_special_event = (dayData.chaoco > 0) || (dayData.chunhiem > 0);
                    dayData.has_duvao_bell = (dayData.duvaotiet > 0);

                    allData.lich[session][day.id] = dayData;
                }
            });
        });
        return allData;
    }
    
    function openDay(evt, dayId, session) {
      let i;
      const tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) { tabcontent[i].style.display = "none"; }
      const tablinksSang = document.getElementsByClassName("tablinks-sang");
      for (i = 0; i < tablinksSang.length; i++) { tablinksSang[i].className = tablinksSang[i].className.replace(" active", ""); }
      const tablinksChieu = document.getElementsByClassName("tablinks-chieu");
      for (i = 0; i < tablinksChieu.length; i++) { tablinksChieu[i].className = tablinksChieu[i].className.replace(" active", ""); }
      document.getElementById(dayId).style.display = "block";
      evt.currentTarget.className += " active";
    }

    function timeToMinute(timeString) {
      if (!timeString) return 0;
      const [hours, minutes] = timeString.split(':').map(Number);
      return (hours * 60) + minutes;
    }

    function minuteToTime(totalMinutes) {
      const hours = Math.floor(totalMinutes / 60).toString().padStart(2, '0');
      const minutes = (totalMinutes % 60).toString().padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    // [HÀM ĐÃ THAY THẾ HOÀN TOÀN]
    function calculateSchedule(dayId) {
        // Hàm tiện ích getVal, xử lý cả giá trị 0
        const getVal = (id, defaultValue = 0) => {
            const el = document.getElementById(id);
            if (!el) return defaultValue;
            const parsedValue = parseInt(el.value);
            return isNaN(parsedValue) ? defaultValue : parsedValue;
        };
        
        // Hàm tiện ích getStartTime
        const getStartTime = (id) => timeToMinute(document.getElementById(id).value);

        // 1. Thu thập dữ liệu
        const isEnabled = document.getElementById(`enable_${dayId}`)?.checked;
        if (!isEnabled) return []; // Trả về mảng rỗng nếu lịch bị tắt

        // Kiểm tra xem có sự kiện đặc biệt không (Chào cờ hoặc Chủ nhiệm)
        const hasChaoCo = document.getElementById(`chaoco_${dayId}`) !== null;
        const hasChuNhiem = document.getElementById(`chunhiem_${dayId}`) !== null;
        const hasSpecial = hasChaoCo || hasChuNhiem;
        
        const startTime = getStartTime(`gio_${dayId}`);
        const lessonTime = getVal(`tiethoc_${dayId}`, 45);
        const lessonCount = getVal(`sotiet_${dayId}`, 5);
        
        const prepareTimeValue = getVal(`duvaotiet_${dayId}`, 3);
        const hasDuVao = prepareTimeValue > 0;
        const prepareTime = hasDuVao ? prepareTimeValue : 0;
        
        // [THAY ĐỔI LỚN] Đọc chuỗi thời gian ra chơi
        const breakTimeStr = document.getElementById(`rachoi_${dayId}`).value || '5';
        const breakTimes = breakTimeStr.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
        if (breakTimes.length === 0) breakTimes.push(5); // Đảm bảo luôn có ít nhất 1 giá trị

        let specialEventTime = 0;
        if (hasSpecial) {
            if (hasChaoCo) {
                specialEventTime = getVal(`chaoco_${dayId}`, 0);
            } else if (hasChuNhiem) {
                specialEventTime = getVal(`chunhiem_${dayId}`, 0);
            }
        }
        
        // [THÊM] Đọc thời gian chuẩn bị sau sự kiện đặc biệt
        const specialPrepareTime = hasSpecial ? getVal(`prepare_after_special_${dayId}`, 0) : 0;
        
        if (startTime === 0 || lessonTime === 0 || lessonCount === 0) return [];

        let schedule = [];
        let currentTime = startTime;

        // 2. Xử lý sự kiện đặc biệt (Chào cờ/Sinh hoạt) nếu có
        if (hasSpecial && specialEventTime > 0) {
            schedule.push({ time: currentTime, description: hasChaoCo ? "Chào cờ" : "Sinh hoạt" });
            currentTime += specialEventTime;
            
            if (specialPrepareTime > 0) {
                schedule.push({ time: currentTime, description: "Nghỉ sau SH/CC" });
                currentTime += specialPrepareTime;
            }
        }

        // 3. Vòng lặp qua các tiết học và giờ ra chơi
        for (let i = 1; i <= lessonCount; i++) {
            schedule.push({ time: currentTime, description: `Vào tiết ${i}` });
            currentTime += lessonTime;

            if (i < lessonCount) {
                // Lấy thời gian ra chơi cho tiết hiện tại
                const currentBreakTime = breakTimes[i - 1] ?? breakTimes[breakTimes.length - 1]; 
                
                if (currentBreakTime > 0) {
                    schedule.push({ time: currentTime, description: `Ra chơi tiết ${i}` });
                    currentTime += currentBreakTime;

                    if (prepareTime > 0) {
                        schedule.push({ time: currentTime, description: `Dự vào tiết ${i + 1}` });
                        currentTime += prepareTime;
                    }
                }
            }
        }

        // 4. Thêm sự kiện "Ra về"
        schedule.push({ time: currentTime, description: "Ra về" });
        
        // 5. Lọc các mốc thời gian trùng lặp và sắp xếp
        const uniqueSchedule = Array.from(new Map(schedule.map(item => [item.time, item])).values());
        return uniqueSchedule
            .map(item => ({ ...item, timeInMinutes: item.time, time: minuteToTime(item.time) }))
            .sort((a, b) => a.timeInMinutes - b.timeInMinutes);
    }

    function updatePreviewTable(dayId) {
      const isEnabled = document.getElementById(`enable_${dayId}`).checked;
      const container = document.getElementById('details-' + dayId);
      if (!container) return;

      if (!isEnabled) {
          container.innerHTML = "<p>Lịch này đang tắt.</p>";
          return;
      }
      
      const scheduleArray = calculateSchedule(dayId);
      
      let table = "<table><thead><tr><th>STT</th><th>Thời gian</th><th>Nội dung</th></tr></thead><tbody>";
      scheduleArray.forEach((event, index) => {
        table += `<tr><td>${index + 1}</td><td>${event.time}</td><td>${event.description}</td></tr>`;
      });
      table += "</tbody></table>";
      container.innerHTML = table;
    }
// [THÊM 2 HÀM MỚI NÀY]
function setTime(e){
    if(isNaN(e)||e<1e5) {
        console.log("Invalid epoch received:",e);
        serverTime=null;
    } else {
        serverTime=new Date(1e3*e); // Chuyển epoch giây sang mili giây
        document.getElementById("date").innerHTML=serverTime.toLocaleDateString("vi-VN",{weekday:"long",year:"numeric",month:"long",day:"numeric",timeZone:"Asia/Ho_Chi_Minh"});
        updateLocalClock(); // Cập nhật lần đầu
    }
}

function updateLocalClock(){
    if(serverTime){ // Chỉ chạy nếu serverTime đã được thiết lập
        serverTime.setSeconds(serverTime.getSeconds()+1); // Tăng 1 giây
        document.getElementById("clock").innerHTML=serverTime.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:"Asia/Ho_Chi_Minh",hour12:false});
    }
}
    // Hàm này sẽ được gọi khi trang được tải xong
    window.onload = function() { 
        connectToMqtt(); // Gọi hàm kết nối MQTT mới
        setInterval(updateLocalClock, 1000); // <-- THÊM DÒNG NÀY ĐỂ ĐỒNG HỒ TỰ ĐẾM
        document.querySelector('.tablinks-sang').click();
    };
  </script>
</body>
</html>
