<!DOCTYPE html>
<html lang="vi">
<head>
  <title>H·∫πn Gi·ªù Chu√¥ng B√°o - ƒêi·ªÅu khi·ªÉn Internet</title>
  <meta name="viewport" content="width=device-width,user-scalable=0" charset="utf-8">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js" type="text/javascript"></script>
  
  <style type="text/css">
    /* --- C√ÄI ƒê·∫∂T CHUNG & S·ª¨A L·ªñI TR√ÄN KHUNG --- */
    * {
        box-sizing: border-box;
    }
    body {
        background: linear-gradient(135deg, #3a4750 0%, #4a627a 100%);
        font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        color: #f5f6fa;
        min-height: 100vh;
        margin: 0;
        /* [M·ªöI] Th√™m padding-bottom ƒë·ªÉ kh√¥ng b·ªã thanh h√†nh ƒë·ªông che m·∫•t n·ªôi dung */
        padding-bottom: 80px; 
        font-size: 15px;
    }
    /* File: index 4.html (b√™n trong th·∫ª <style>) */

/* === [B∆Ø·ªöC 2] CSS CHO GIAO DI·ªÜN G√ìI/M·ªû C·ª¶A TAB H·∫∏N GI·ªú === */
.scenario-setup-details {
    border: none;
    background: transparent;
    box-shadow: none;
    margin: 0 15px 15px 15px; /* CƒÉn l·ªÅ cho ƒë·ªìng b·ªô */
}
.scenario-setup-details > summary {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 12px 15px;
    font-size: 1.1em;
    font-weight: 700;
    letter-spacing: 1px;
    border-radius: 10px;
    background: linear-gradient(90deg, #2c3e50, #34495e);
    color: #3498db;
    border: 2px solid #3498db;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.2);
    transition: all 0.2s ease-in-out;
}
.scenario-setup-details > summary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
}
.scenario-setup-details[open] > summary {
    background: #3498db;
    color: #fff;
}
.scenario-setup-details > summary svg {
    width: 20px;
    height: 20px;
    margin-right: 10px;
}
.scenario-setup-details .details-content {
    border: 1px solid #414345;
    border-top: none;
    border-radius: 0 0 10px 10px;
    margin-top: -5px;
    padding: 10px;
    background: #232526;
}
/* ======================================================= */
    #main {
        margin: 24px auto;
        width: 380px;
        max-width: 98vw;
    }

    /* --- KHUNG N·ªòI DUNG CH√çNH --- */
    #content {
        background: #2c3e50;
        border: none;
        width: 100%;
        /*float: left;*/
        border-radius: 18px;
        padding-bottom: 24px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
    }
    /* File: index 1.html (b√™n trong th·∫ª <style>) */

/* === [PH∆Ø∆†NG √ÅN M·ªöI] CSS CHO HI·ªÇN TH·ªä NG√ÄY ƒê√É L∆ØU === */
.saved-days-container {
    text-align: center;
    margin-top: 12px;
    padding: 5px;
}
.day-badge {
    display: inline-block;
    padding: 6px 12px;
    background-color: #f1c40f; /* M√†u v√†ng ƒë·∫∑c tr∆∞ng */
    color: #232526; /* M√†u ch·ªØ t·ªëi cho d·ªÖ ƒë·ªçc */
    font-weight: 700;
    border-radius: 8px;
    margin: 3px;
    font-size: 0.95em;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.day-badge-label {
    color: #bdc3c7;
    font-weight: bold;
    margin-right: 8px;
}
/* =================================================== */

    /* === [M·ªöI] THANH H√ÄNH ƒê·ªòNG C·ªê ƒê·ªäNH (STICKY ACTION BAR) === */
    .sticky-action-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(35, 37, 38, 0.85);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 10px;
        display: flex;
        justify-content: center;
        gap: 15px;
        z-index: 100;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        border-top: 1px solid #414345;
    }
    .sticky-action-bar .modern-btn {
    flex: 1;
    max-width: 350px; /* TƒÉng chi·ªÅu r·ªông t·ªëi ƒëa */
    margin: 0;
}
    /* L√†m cho n√∫t L∆∞u n·ªïi b·∫≠t h∆°n */
    .sticky-action-bar .save-button {
        transform: scale(1.05);
        box-shadow: 0 8px 24px #00e6ff55;
    }

    /* === [M·ªöI] H·ªÜ TH·ªêNG TAB CH√çNH === */
    .main-tabs {
        display: flex;
        background-color: #232526;
        border-radius: 16px 16px 0 0;
        padding: 5px;
        margin-bottom: 15px;
        border-bottom: 2px solid #414345;
    }
    .main-tab-button {
        flex: 1;
        padding: 10px 5px;
        cursor: pointer;
        background: transparent;
        border: none;
        color: #bdc3c7;
        font-weight: 700;
        font-size: 0.8em;
        transition: all 0.2s ease-out;
        border-radius: 12px;
        text-transform: uppercase;
    }
    .main-tab-button:hover {
        background-color: #414345;
        color: #fff;
    }
    .main-tab-button.active {
        background: #f1c40f;
        color: #232526;
        box-shadow: 0 2px 10px #f1c40f55;
    }
    .main-tab-content {
        display: none; /* M·∫∑c ƒë·ªãnh ·∫©n t·∫•t c·∫£ n·ªôi dung tab */
    }
    .main-tab-content.active {
        display: block; /* Ch·ªâ hi·ªán n·ªôi dung c·ªßa tab ƒëang active */
    }
    
    /* === KHU V·ª∞C TH√îNG B√ÅO PH·∫¢N H·ªíI === */
    #notification-area {
        position: fixed;
        top: 15px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1010;
        width: 90%;
        max-width: 360px;
    }
    .notification {
        padding: 10px 15px;
        border-radius: 8px;
        color: #fff;
        font-weight: bold;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        opacity: 0;
        transform: translateY(-20px);
        transition: opacity 0.3s, transform 0.3s;
        margin-bottom: 10px;
        font-size: 0.9em;
    }
    .notification.show {
        opacity: 1;
        transform: translateY(0);
    }
    .notification.success {
        background: linear-gradient(90deg, #27ae60, #2ecc71);
    }
    .notification.error {
        background: linear-gradient(90deg, #c0392b, #e74c3c);
    }
    .notification.info {
        background: linear-gradient(90deg, #2980b9, #3498db);
    }

    /* --- TI√äU ƒê·ªÄ & M√ÄU S·∫ÆC N·ªîI B·∫¨T --- */
    h2 {
        font-size: 1.6em;
        margin-top: 20px;
        margin-bottom: 10px;
        text-align: center;
        color: #f39c12;
        text-shadow: 0 4px 12px rgba(243, 156, 18, 0.18), 0 2px 4px rgba(0,0,0,0.08);
        letter-spacing: 1px;
        font-weight: 800;
    }
    h3 {
        margin-top: 28px;
        margin-bottom: 18px; 
        text-align: center;
        font-size: 1.15em;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        padding: 12px 18px;
        background: linear-gradient(90deg, #232526 60%, #414345 100%);
        border-radius: 12px;
        margin-left: 15px;
        margin-right: 15px;
        border-left: 5px solid;
        border-right: 5px solid;
        position: relative;
        z-index: 2;
        box-shadow: 0 4px 24px 0 #00000044, 0 2px 8px rgba(0,0,0,0.08);
    }
    #header-sang { 
        color: #2ecc71 !important;
        text-shadow: 0 0 12px #2ecc71, 0 2px 8px #000;
        border-color: #2ecc71;
        box-shadow: 0 4px 24px 0 #00000044, 0 2px 8px rgba(0,0,0,0.08),
                    inset 5px 0 10px -5px #2ecc71,
                    inset -5px 0 10px -5px #2ecc71;
    }
    #header-chieu { 
        color: #3498db !important;
        text-shadow: 0 0 12px #3498db, 0 2px 8px #000;
        border-color: #3498db;
        box-shadow: 0 4px 24px 0 #00000044, 0 2px 8px rgba(0,0,0,0.08),
                    inset 5px 0 10px -5px #3498db,
                    inset -5px 0 10px -5px #3498db;
    }
    hr { border: none; height: 1px; background: linear-gradient(90deg, #f1c40f 0%, #e0eafc 100%); margin: 28px 15px; border-radius: 2px; opacity: 0.5; }

    /* --- [M·ªöI] THANH TR·∫†NG TH√ÅI & ƒê·ªíNG H·ªí --- */
    #school-name-status {
        transition: color 0.5s ease; /* Hi·ªáu ·ª©ng chuy·ªÉn m√†u m∆∞·ª£t m√† */
    }
    .status-color-connected { 
        color: #43e97b !important; /* Xanh l√° c√¢y */
    }
    .status-color-disconnected { 
        color: #ff5858 !important; /* ƒê·ªè */
    }
    .status-color-connecting { 
        color: #00e6ff !important; /* Xanh d∆∞∆°ng (m√†u g·ªëc) */
    }

    .clock-container { 
        text-align: center; 
        margin: 15px auto; 
        background: linear-gradient(120deg, #232526 60%, #414345 100%); 
        border: 2px solid #f1c40f; 
        border-radius: 14px; 
        padding: 8px 10px;
        box-shadow: 0 2px 12px rgba(241, 196, 15, 0.10), 0 2px 5px rgba(0,0,0,0.08);
        width: 90%;
        cursor: pointer; /* << TH√äM D√íNG N√ÄY */
    }
    .clock {
        font-size: 2.5em;
        color: #f1c40f;
        text-shadow: 0 0 10px #f1c40f88;
        letter-spacing: 2px;
        font-family: 'Courier New', Courier, monospace;
    }
    .date-display { font-size: 0.9em; color: #ecf0f1; margin-top: 5px; font-weight: 500; }

    /* --- KHU V·ª∞C N√öT ƒêI·ªÄU KHI·ªÇN --- */
    /* [S·ª¨A ƒê·ªîI] Gi·ªØ l·∫°i .button-section cho c√°c n√∫t trong tab H·ªá th·ªëng */
    .button-section {
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 0 15px;
        margin-top: 24px;
    }
    .modern-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 45px;
        padding: 0 15px;
        border: none;
        border-radius: 10px;
        font-size: 0.9em;
        font-weight: 700;
        letter-spacing: 1px;
        transition: all 0.2s ease-out;
        cursor: pointer;
        outline: none;
        position: relative;
        overflow: hidden;
        z-index: 1;
        text-transform: uppercase;
        width: 100%;
        text-decoration: none;
    }
    .modern-btn:hover {
        transform: translateY(-2px);
        filter: brightness(1.1);
    }
    .modern-btn svg {
        width: 1.1em;
        height: 1.1em;
        margin-right: 10px;
    }
    .modern-btn:active {
        transform: scale(0.97);
        filter: brightness(0.97);
        box-shadow: 0 2px 8px 0 #0004;
    }
    .save-button {
        background: linear-gradient(90deg, #232526 60%, #414345 100%);
        color: #00e6ff;
        border-left: 4px solid #00e6ff;
        border-right: 4px solid #00e6ff;
        text-shadow: 0 0 12px #00e6ff, 0 2px 8px #000;
        box-shadow: 0 4px 18px 0 #00000044;
    }
    .save-button:hover {
        box-shadow: 0 8px 24px #00e6ff55;
    }
    .test-button {
        background: linear-gradient(90deg, #232526 60%, #414345 100%);
        color: #f1c40f;
        border-left: 4px solid #f1c40f;
        border-right: 4px solid #f1c40f;
        text-shadow: 0 0 12px #f1c40f, 0 2px 8px #000;
        box-shadow: 0 4px 18px 0 #00000044;
    }
    .test-button:hover {
        box-shadow: 0 8px 24px #f1c40f55;
    }
    .interface-button {
        background: linear-gradient(90deg, #232526 60%, #414345 100%);
        color: #ab47bc;
        border-left: 4px solid #ab47bc;
        border-right: 4px solid #ab47bc;
        text-shadow: 0 0 12px #ab47bc, 0 2px 8px #000;
        box-shadow: 0 4px 18px 0 #00000044;
    }
    .interface-button:hover {
        box-shadow: 0 8px 24px #ab47bc55;
    }
    .advanced-button {
        background: linear-gradient(90deg, #485563 0%, #29323c 100%);
        color: #bdc3c7;
        border-left: 4px solid #bdc3c7;
        border-right: 4px solid #bdc3c7;
        text-shadow: 0 0 12px #bdc3c7, 0 2px 8px #000;
        box-shadow: 0 4px 18px 0 #00000044;
    }
    .advanced-button:hover {
        box-shadow: 0 8px 24px #bdc3c755;
    }
    .logout-button {
        background: linear-gradient(90deg, #232526 60%, #414345 100%);
        color: #e74c3c;
        border-left: 4px solid #e74c3c;
        border-right: 4px solid #e74c3c;
        text-shadow: 0 0 12px #e74c3c, 0 2px 8px #000;
        box-shadow: 0 4px 18px 0 #00000044;
    }
    .logout-button:hover {
        box-shadow: 0 8px 24px #e74c3c55;
    }
    
.tab { display: flex; justify-content: space-around; border-bottom: 2px solid #414345; margin: 0 15px 0 15px; position: relative; z-index: 1; }
    .tab button {
        flex-grow: 1; border: none; outline: none; cursor: pointer; padding: 10px 5px 8px 5px;
        transition: all 0.2s ease-out;
        font-size: 0.9em; font-weight: 700; border-radius: 8px 8px 0 0; margin: 0 2px;
        position: relative; top: 2px; border-bottom: 3px solid transparent;
        background: transparent; color: #bdc3c7;
    }
    .tab button:hover {
        background: #414345; color: #fff;
        transform: translateY(-2px);
    }
    .tablinks-sang.active { 
        background: linear-gradient(90deg, #2ecc71 60%, #27ae60 100%);
        color: #fff; 
        border-bottom-color: #2ecc71;
        z-index: 2;
    }
     .tablinks-chieu.active { 
        background: linear-gradient(90deg, #3498db 60%, #2980b9 100%);
        color: #fff; 
        border-bottom-color: #3498db;
        z-index: 2;
    }
    .tabcontent { 
        display: none; 
        padding: 10px; 
        background: #232526;
        border-radius: 0 0 12px 12px;
        margin: 0 15px 8px 15px;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height 0.5s ease-in-out, opacity 0.4s ease-in-out, padding 0.5s ease-in-out;
    }
    .tabcontent.active {
        display: block;
        max-height: 1000px;
        opacity: 1;
        padding: 15px 10px 10px 10px;
    }
    .tabcontent h3 {
        font-size: 1em; 
        margin: 0; 
        margin-bottom: 10px;
        padding: 10px 15px;
        color: #f1c40f; 
        font-weight: 700;
        cursor: pointer;
        position: relative;
        border-bottom: 1px solid #414345;
        background: rgba(44, 62, 80, 0.5);
        border-radius: 8px;
        text-align: center;
    }
    .tabcontent h3::after {
        content: '‚ñº';
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%) scale(0.9);
        font-size: 0.8em;
        transition: transform 0.3s ease-in-out;
    }
    .tabcontent h3.expanded::after {
        transform: translateY(-50%) scale(0.9) rotate(180deg);
    }
    .session-subtitle {
        font-size: 0.8em;
        font-weight: normal;
        text-transform: none;
        color: #bdc3c7;
    }
    .collapsible-settings {
        overflow: hidden;
        max-height: 0;
        opacity: 0;
        transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out, margin-top 0.4s ease-in-out;
        margin-top: 0;
    }
    .collapsible-settings.expanded {
        max-height: 500px;
        opacity: 1;
        margin-top: 10px;
    }
/* === [TH√äM M·ªöI] CSS CHO B·∫¢NG K·ªäCH B·∫¢N H·∫∏N GI·ªú === */
    .scenario-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    .scenario-table th, .scenario-table td {
        border: 1px solid #414345;
        padding: 9px 5px;
        text-align: center; /* CƒÉn gi·ªØa n·ªôi dung trong √¥ */
        font-size: 0.9em;
    }
    .scenario-table th {
        background-color: #3498db;
        color: #fff;
        font-weight: bold;
    }
    .scenario-table tbody tr:nth-child(odd) {
        background-color: #2c3e50;
    }
    .scenario-table tbody tr:nth-child(even) {
        background-color: #34495e;
    }
    /* Ph√¢n chia ƒë·ªô r·ªông c√°c c·ªôt cho ƒë·ªÅu */
    .scenario-table th:nth-child(1), .scenario-table td:nth-child(1) { width: 15%; } /* C·ªôt STT */
    .scenario-table th:nth-child(2), .scenario-table td:nth-child(2) { width: 42.5%; } /* C·ªôt Th·ªùi gian */
    .scenario-table th:nth-child(3), .scenario-table td:nth-child(3) { width: 42.5%; } /* C·ªôt S·ªë h·ªìi */
    
    /* [TH√äM M·ªöI] CSS cho B·∫£ng K·ªãch B·∫£n ƒê√£ L∆∞u (Y√™u c·∫ßu n·ªÅn ƒëen ch·ªØ v√†ng) */
    #saved-scenario-table-wrapper .scenario-table {
        background: #232526; /* N·ªÅn ƒëen */
        border-radius: 8px; /* Bo g√≥c cho ƒë·ªìng b·ªô */
        overflow: hidden; /* ·∫®n tr√†n vi·ªÅn khi bo g√≥c */
    }
    #saved-scenario-table-wrapper .scenario-table th {
        background: #f1c40f; /* N·ªÅn v√†ng (nh∆∞ b·∫£ng chi ti·∫øt) */
        color: #232526; /* Ch·ªØ ƒëen (nh∆∞ b·∫£ng chi ti·∫øt) */
    }
    #saved-scenario-table-wrapper .scenario-table tbody tr:nth-child(odd) {
        background: #232526; /* N·ªÅn ƒëen */
        color: #ecf0f1;
    }
    #saved-scenario-table-wrapper .scenario-table tbody tr:nth-child(even) {
        background: #414345; /* N·ªÅn x√°m t·ªëi (nh∆∞ b·∫£ng chi ti·∫øt) */
        color: #ecf0f1;
    }
    /* [TH√äM M·ªöI] CSS cho N√∫t X√≥a K·ªãch B·∫£n */
    .delete-scenario-button-container {
        padding: 15px 0 5px 0; /* CƒÉn l·ªÅ cho n√∫t x√≥a */
    }
            
    /* === C√ÄI ƒê·∫∂T N√öT G·∫†T (TOGGLE SWITCH) D·∫†NG BOX === */
    .toggle-actions-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 0 5px 10px 5px;
    }
    .toggle-action-item {
        display: flex;
        align-items: center;
        background-color: #2c3e50;
        border-radius: 8px;
        padding: 8px 12px;
        border-left: 4px solid #4a4e54;
        transition: all 0.3s ease;
    }
    .toggle-action-icon {
        flex-shrink: 0;
        margin-right: 12px;
        color: #bdc3c7;
    }
    .toggle-action-icon svg {
        width: 24px;
        height: 24px;
        display: block;
    }
    .toggle-action-text {
        flex-grow: 1;
        font-weight: bold;
        font-size: 0.9em;
    }
    .toggle-action-item .switch {
        margin-left: auto;
    }
    .toggle-action-item.disabled {
        opacity: 0.5;
        pointer-events: none;
        background-color: #232526;
    }
    .toggle-action-item.active {
        border-left-color: #2ecc71;
    }
    .toggle-action-item.active.chieu-style {
        border-left-color: #3498db;
    }
    .toggle-action-item.active .toggle-action-icon {
        color: #f1c40f;
    }
    .switch {
        position: relative;
        display: inline-block;
        width: 46px; height: 24px;
        flex-shrink: 0;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
        position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
        background-color: #4a4e54;
        transition: .3s;
        border-radius: 24px;
    }
    .slider:before {
        position: absolute; content: "";
        height: 18px; width: 18px;
        left: 3px; bottom: 3px;
        background-color: #bdc3c7;
        transition: .3s cubic-bezier(.4,0,.2,1);
        border-radius: 50%;
    }
    input:checked + .slider { background: linear-gradient(90deg, #27ae60, #2ecc71); }
    .chieu-toggle input:checked + .slider { background: linear-gradient(90deg, #2980b9, #3498db); }
    input:checked + .slider:before { transform: translateX(22px); background-color: white; }

    /* --- KHU V·ª∞C C√ÄI ƒê·∫∂T (DETAILS) --- */
    details {
        border: 1px solid #414345; border-radius: 10px; margin-bottom: 12px;
        background: #232526; box-shadow: 0 2px 8px rgba(0,0,0, 0.1);
        overflow: hidden; transition: box-shadow 0.2s;
    }
    summary {
        font-weight: bold; padding: 12px 15px; cursor: pointer; outline: none;
        transition: background 0.2s, color 0.2s; list-style: none;
        font-size: 0.9em;
    }
    summary::-webkit-details-marker, summary::marker { display: none; }
    
    .sohoi-container {
        padding: 0 15px;
    }
    summary#header-sohoi {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        height: 50px;
        border-radius: 10px;
        background: linear-gradient(90deg, #232526 60%, #414345 100%);
        color: #f1c40f;
        border-left: 4px solid #f1c40f;
        border-right: 4px solid #f1c40f;
        text-shadow: 0 0 12px #f1c40f, 0 2px 8px #000, 0 0 24px #fff;
        box-shadow: 0 4px 18px 0 #f1c40f33, 0 2px 8px #fff2;
    }
    summary#header-sohoi div:first-child {
        font-size: 1em;
        font-weight: 700;
        letter-spacing: 1.5px;
    }
    .details-content { padding: 12px 15px 16px 15px; border-top: 1px solid #414345; }
    
    .tabcontent details summary {
        text-align: center;
        font-size: 1em;
        border-radius: 8px 8px 0 0;
        background: #2c3e50;
        color: #f1c40f;
    }
    details[open] > .tabcontent details summary { 
        background: #f1c40f;
        color: #232526; 
    }
    
    /* --- B·∫¢NG L·ªäCH CHI TI·∫æT --- */
    .details-container {max-height: 250px;overflow-y: auto;}
    .details-container::-webkit-scrollbar {width: 8px;}
    .details-container::-webkit-scrollbar-track {background: #2c3e50;border-radius: 4px;}
    .details-container::-webkit-scrollbar-thumb {background-color: #f1c40f;border-radius: 4px;border: 2px solid #2c3e50;}
    .details-container table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #232526; border-radius: 8px; overflow: hidden; }
    .details-container th, .details-container td { border: 1px solid #414345; padding: 8px 5px; text-align: center; font-size: 0.9em; }
    .details-container th { background: #f1c40f; color: #232526; font-weight: bold; }
    .details-container tbody tr { transition: background-color 0.2s; }
    .details-container tbody tr:hover { background-color: #f1c40f22; }
    .details-container tbody tr:nth-child(odd) { background: #232526; color: #ecf0f1; }
    .details-container tbody tr:nth-child(even) { background: #414345; color: #ecf0f1; }
    .divider-yellow {width: 90%; height: 2px; background: linear-gradient(90deg, #f1c40f 0%, #fff200 100%);border-radius: 2px; margin: 24px auto 18px auto; box-shadow: 0 2px 8px #f1c40f55;}

    /* --- GIAO DI·ªÜN L∆Ø·ªöI "TH√îNG MINH" CHO C√ÄI ƒê·∫∂T --- */
/* --- GIAO DI·ªÜN L∆Ø·ªöI "TH√îNG MINH" CHO C√ÄI ƒê·∫∂T --- */
.settings-grid-container {
    /* [S·ª¨A ƒê·ªîI] Gi·ªõi h·∫°n chi·ªÅu cao v√† th√™m thanh cu·ªôn t·ª± ƒë·ªông */
    max-height: 380px; 
    overflow-y: auto;
    padding-right: 5px; /* Th√™m kho·∫£ng ƒë·ªám nh·ªè ƒë·ªÉ thanh cu·ªôn kh√¥ng qu√° s√°t */
    padding-bottom: 30px; /* TH√äM D√íNG N√ÄY: T·∫°o kho·∫£ng ƒë·ªám ·ªü cu·ªëi v√πng cu·ªôn */
    
    /* Gi·ªØ nguy√™n c√°c thu·ªôc t√≠nh c≈© */
    opacity: 1;
    transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out;
}
/* [TH√äM M·ªöI] T√πy ch·ªânh giao di·ªán thanh cu·ªôn cho ƒë·ªìng b·ªô */
.settings-grid-container::-webkit-scrollbar {
    width: 8px;
}
.settings-grid-container::-webkit-scrollbar-track {
    background: #2c3e50;
    border-radius: 4px;
}
.settings-grid-container::-webkit-scrollbar-thumb {
    background-color: #f1c40f;
    border-radius: 4px;
    border: 2px solid #2c3e50;
}
    .settings-grid-container.hidden {
        max-height: 0;
        opacity: 0;
    }
    .settings-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        padding: 8px 0;
    }
    .setting-item {
        background: #232526;
        border: 1px solid #414345;
        border-radius: 8px;
        padding: 8px;
        display: flex;
        align-items: center;
        transition: all 0.2s ease-in-out;
    }
    .setting-item:hover {
        border-color: #f1c40f;
        transform: translateY(-1px);
    }
    .setting-item.full-width {
        grid-column: 1 / -1;
    }
    .setting-item-icon {
        flex-shrink: 0;
        margin-right: 10px;
        color: #f1c40f;
    }
    .setting-item-icon svg {
        width: 22px;
        height: 22px;
    }
    .input-wrapper {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    .input-wrapper label {
        font-size: 0.8em;
        font-weight: 600;
        color: #bdc3c7;
        margin-bottom: 4px;
    }
    .unit-input {
        display: flex;
        align-items: center;
    }
    .unit-input input {
        width: 100%;
        margin-right: 8px;
    }
    .unit-input span {
        font-size: 0.9em;
        color: #bdc3c7;
    }
    .setting-item input[type="time"] {
        width: 100%;
        padding: 8px;
        font-size: 0.9em;
    }
    /* [M·ªöI] CSS cho H∆∞·ªõng d·∫´n nh·ªè */
    .input-helper-text {
        font-size: 0.75em;
        color: #7f8c8d;
        font-style: italic;
        margin-top: 4px;
        text-align: right;
    }
    .copy-button-container {
        padding: 5px 5px 15px 5px;
    }
    .copy-button {
        padding: 8px 12px;
        font-size: 0.8em;
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.18s;
        font-weight: 700;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        text-shadow: 0 1px 2px #00000044;
        width: 100%;
    }
    .copy-button:active {
        transform: scale(0.96);
        filter: brightness(0.95);
    }
    .copy-button.sang {
        background: linear-gradient(90deg, #16a085 0%, #43e97b 100%);
    }
    .copy-button.chieu {
        background: linear-gradient(90deg, #2980b9 0%, #6dd5fa 100%);
    }

    /* === Giao di·ªán cho Modal Chung === */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
    }
    .modal-overlay.visible {
        opacity: 1;
        visibility: visible;
    }
    .modal-content {
        background: #2c3e50;
        padding: 20px;
        border-radius: 15px;
        border-top: 5px solid #f1c40f;
        width: 95%;
        max-width: 400px;
        box-shadow: 0 5px 25px rgba(0,0,0,0.4);
        transform: scale(0.9);
        transition: transform 0.3s;
    }
    .modal-overlay.visible .modal-content {
        transform: scale(1);
    }
    .modal-content h4 {
        margin-top: 0;
        margin-bottom: 20px;
        color: #f1c40f;
        text-align: center;
        font-size: 1.2em;
        text-transform: uppercase;
    }
    .modal-buttons {
        display: flex;
        gap: 15px;
        margin-top: 20px;
    }
    .modal-buttons button {
        flex-grow: 1;
        padding: 10px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.2s;
    }
    .modal-confirm-btn {
        background: #f1c40f;
        color: #232526;
    }
    /* [M·ªöI] CSS cho c√°c n√∫t ∆∞u ti√™n trong modal c·∫£nh b√°o */
    .modal-confirm-btn.priority-scenario {
        background: #27ae60;
        color: #fff;
    }
    .modal-confirm-btn.priority-schedule {
        background: #2980b9;
        color: #fff;
    }
    .modal-cancel-btn {
        background: #7f8c8d;
        color: #fff;
    }
    
    .modal-input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 2px solid #7f8c8d;
        background-color: #2c3e50;
        color: #ecf0f1;
        font-size: 1em;
        margin-bottom: 15px;
    }
    .modal-input:focus {
        outline: none;
        border-color: #f1c40f;
    }
    /* [M·ªöI] CSS cho ph·∫ßn m√¥ t·∫£ trong modal */
    #conflict-modal-description {
        text-align: center; 
        margin-top: -10px; 
        margin-bottom: 20px; 
        color: #bdc3c7; 
        font-size: 0.9em; 
        line-height: 1.5;
    }
    #conflict-modal-description strong {
        color: #e74c3c;
    }

    /* === Giao di·ªán cho Modal C√†i ƒë·∫∑t N√¢ng cao === */
    #advanced-settings-modal .modal-content {
        background: #232526;
        border-top-color: #f39c12;
        color: #f5f6fa;
    }
    #advanced-settings-modal h4 {
        color: #f39c12;
        text-shadow: 0 0 10px #f39c12;
    }
    .adv-modal-tabs {
        display: flex;
        border-bottom: 2px solid #414345;
        margin-bottom: 15px;
    }
    .adv-modal-tab {
        flex-grow: 1;
        padding: 10px 2px;
        text-align: center;
        cursor: pointer;
        font-weight: bold;
        color: #7f8c8d;
        border-bottom: 3px solid transparent;
        transition: all 0.2s;
        font-size: 0.75em;
    }
    .adv-modal-tab.active {
        color: #f39c12;
        border-bottom-color: #f39c12;
    }
    .adv-modal-tab-content {
        display: none;
    }
    .adv-modal-tab-content.active {
        display: block;
    }
    .adv-modal-tab-content h5 {
        text-align: center;
        color: #f39c12;
        text-transform: uppercase;
        margin: 10px 0 15px 0;
        letter-spacing: 1px;
        font-size: 0.9em;
    }
    
    /* === Giao di·ªán cho Tab H·ªá th·ªëng & Reset WiFi === */
    .actions-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .action-item {
        display: flex;
        align-items: center;
        background: #2c3e50;
        border-radius: 8px;
        padding: 12px;
        border-left: 4px solid #f39c12;
        transition: background-color 0.2s;
    }
    .action-item:hover {
        background-color: #34495e;
    }
    .action-icon {
        flex-shrink: 0;
        margin-right: 15px;
        color: #f39c12;
    }
    .action-icon svg {
        width: 28px;
        height: 28px;
    }
    .action-text {
        flex-grow: 1;
    }
    .action-text .title {
        font-weight: bold;
        font-size: 1em;
        color: #f5f6fa;
    }
    .action-text .description {
        font-size: 0.8em;
        color: #bdc3c7;
    }
    .action-text .description.connected { color: #2ecc71; }
    .action-text .description.disconnected { color: #e74c3c; }

    .action-btn {
        padding: 7px 15px;
        font-size: 0.8em;
        font-weight: bold;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        background-color: #f39c12;
        color: #232526;
    }
    .action-btn:disabled {
        background-color: #7f8c8d;
        cursor: not-allowed;
    }
    .action-btn.reset {
        background-color: #c0392b;
        color: #fff;
    }
    
    /* === Giao di·ªán cho Qu·∫£n l√Ω V·ªá tinh === */
    .device-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 280px;
        overflow-y: auto;
        padding: 5px;
        background: #2c3e50;
        border-radius: 8px;
    }
    .device-item {
        display: flex;
        flex-direction: column;
        padding: 10px;
        background: #34495e;
        border-radius: 8px;
        border-left: 4px solid #f1c40f;
        gap: 8px;
    }
    .device-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .device-name {
        font-weight: bold;
        font-size: 1em;
        color: #ecf0f1;
    }
    .device-status {
        font-size: 0.85em;
        font-weight: bold;
    }
    .device-status.connected { color: #2ecc71; }
    .device-status.disconnected { color: #e74c3c; }
    
    .device-info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
        font-size: 0.8em;
        color: #bdc3c7;
    }
    .device-info-grid span {
        background-color: #2c3e50;
        padding: 4px 6px;
        border-radius: 4px;
    }
    .device-info-grid .label {
        font-weight: bold;
        color: #ecf0f1;
    }
    
    .device-actions {
        display: flex;
        gap: 8px;
    }
    .device-action-btn {
        padding: 5px 10px;
        border: none;
        border-radius: 5px;
        color: #fff;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
        font-size: 0.75em;
        flex-grow: 1;
    }
    .device-action-btn:hover {
        filter: brightness(1.1);
        transform: scale(1.05);
    }
    .add-btn { background-color: #27ae60; }
    .remove-btn { background-color: #c0392b; }
    .cancel-btn { background-color: #7f8c8d; }

    .list-placeholder {
        text-align: center;
        padding: 20px;
        color: #7f8c8d;
        font-size: 0.9em;
    }

    /* === Giao di·ªán cho Tab OTA === */
    .ota-device-selection {
        background-color: #2c3e50;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 15px;
    }
    .ota-device-selection label {
        display: flex;
        align-items: center;
        padding: 8px;
        cursor: pointer;
        border-radius: 6px;
        transition: background-color 0.2s;
    }
    .ota-device-selection label:hover {
        background-color: #34495e;
    }
    .ota-device-selection input[type="checkbox"] {
        margin-right: 10px;
        width: 18px;
        height: 18px;
    }
    #ota-progress-container {
        display: none;
        width: 100%;
        background-color: #2c3e50;
        border-radius: 8px;
        padding: 3px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        margin-bottom: 10px;
    }
    #ota-progress-bar {
        width: 0%;
        height: 20px;
        background: linear-gradient(90deg, #f1c40f, #f39c12);
        border-radius: 5px;
        text-align: center;
        line-height: 20px;
        color: #232526;
        font-weight: bold;
        transition: width 0.3s ease-in-out;
    }
    #ota-status-text, #ota-progress-details {
        text-align: center;
        color: #bdc3c7;
        min-height: 18px;
        font-size: 0.9em;
        font-style: italic;
    }
    #ota-device-status-list {
        display: flex;
        flex-direction: column;
        gap: 5px;
        margin-top: 10px;
        font-size: 0.85em;
    }

    /* === CSS CHO C·∫§U TR√öC TAB G·ªòP === */
    .tablinks-day {
        background: #414345;
        color: #bdc3c7;
        flex-grow: 1;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 10px 5px 8px 5px;
        transition: all 0.2s ease-out;
        font-size: 0.9em;
        font-weight: 700;
        border-radius: 8px;
        margin: 0 2px;
        border-bottom: 3px solid transparent;
    }
    .tablinks-day:hover {
        background: #2c3e50;
        color: #fff;
    }
    .tablinks-day.active {
        background: #f1c40f;
        color: #232526;
        border-bottom-color: #f39c12;
    }
    .tab-session {
        display: flex;
        padding: 0 15px;
        gap: 10px;
        margin-top: 15px;
        margin-bottom: 15px;
    }
    .tablinks-session {
        flex-grow: 1;
        padding: 12px 10px;
        border: 2px solid #414345;
        background: #232526;
        color: #bdc3c7;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
        font-size: 1em;
        text-transform: uppercase;
        transition: all 0.3s;
    }
    .tablinks-session.active[onclick*="'sang'"] {
        background: linear-gradient(90deg, #2ecc71 60%, #27ae60 100%);
        color: #fff;
        border-color: #2ecc71;
        box-shadow: 0 0 15px #2ecc7188;
    }
    .tablinks-session.active[onclick*="'chieu'"] {
        background: linear-gradient(90deg, #3498db 60%, #2980b9 100%);
        color: #fff;
        border-color: #3498db;
        box-shadow: 0 0 15px #3498db88;
    }

    /* === [M·ªöI] Giao di·ªán cho Modal C√†i ƒë·∫∑t Giao di·ªán === */
    #interface-settings-modal .modal-content {
        max-width: 500px;
    }
    #interface-settings-modal h4 {
        color: #ab47bc;
    }
    .interface-table-container {
        max-height: 250px;
        overflow-y: auto;
        border: 1px solid #414345;
        border-radius: 8px;
    }
    .interface-table-container table {
        width: 100%;
        border-collapse: collapse;
    }
    .interface-table-container th, .interface-table-container td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #414345;
        font-size: 0.9em;
    }
    .interface-table-container th {
        background-color: #232526;
        color: #ab47bc;
        position: sticky;
        top: 0;
    }
    .interface-table-container tbody tr {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .interface-table-container tbody tr:hover {
        background-color: #34495e;
    }
    .interface-table-container tbody tr.selected-row {
        background-color: #ab47bc;
        color: #fff;
    }
    .interface-controls {
        margin-top: 20px;
        padding: 15px;
        background-color: #232526;
        border-radius: 8px;
    }
    .control-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }
    .control-grid .full-width {
        grid-column: 1 / -1;
    }
    .control-group {
        display: flex;
        flex-direction: column;
    }
    .control-group label {
        margin-bottom: 5px;
        font-size: 0.8em;
        color: #bdc3c7;
        font-weight: bold;
    }
    .control-group input, .control-group select {
        width: 100%;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #7f8c8d;
        background-color: #2c3e50;
        color: #ecf0f1;
        font-size: 0.9em;
    }
    .control-group input[type="color"] {
        padding: 2px;
        height: 38px;
    }
    .interface-action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    /* === [PH·∫¶N ƒê√É X√ìA THEO Y√äU C·∫¶U] === */
    /* .interface-action-buttons button { ... } ƒê√É X√ìA */
    /* .reset-btn { ... } ƒê√É X√ìA */
    /* .save-btn { ... } ƒê√É X√ìA */
    
    /* === [M·ªöI] GIAO DI·ªÜN L·ªäCH NGH·ªà L·ªÑ === */
    .holiday-calendar-container {
        padding: 0 15px;
        margin-top: 25px;
    }
    .holiday-calendar-container details summary {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        height: 50px;
        border-radius: 10px;
        background: linear-gradient(90deg, #485563 0%, #29323c 100%);
        color: #e74c3c;
        border-left: 4px solid #e74c3c;
        border-right: 4px solid #e74c3c;
        text-shadow: 0 0 12px #e74c3c, 0 2px 8px #000;
        box-shadow: 0 4px 18px 0 #00000044;
    }
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background-color: #34495e;
        border-radius: 8px 8px 0 0;
    }
    .calendar-header button {
        background: none;
        border: none;
        color: #f1c40f;
        font-size: 1.5em;
        cursor: pointer;
    }
    #month-year-display {
        color: #f1c40f;
        font-weight: bold;
        font-size: 1.1em;
    }
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        padding: 10px;
        background-color: #2c3e50;
        border-radius: 0 0 8px 8px;
    }
    .calendar-day, .calendar-day-header {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 35px;
        border-radius: 6px;
        font-weight: bold;
    }
    .calendar-day-header {
        color: #bdc3c7;
        font-size: 0.8em;
    }
    .calendar-day {
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
    }
    .calendar-day:not(.empty):hover {
        background-color: #34495e;
        transform: scale(1.05);
    }
    .calendar-day.holiday {
        background-color: #c0392b;
        color: #fff;
        box-shadow: 0 0 10px #e74c3c88;
    }
    .calendar-day.today {
        border: 2px solid #f1c40f;
    }
    .calendar-day.empty {
        cursor: default;
        opacity: 0.3;
    }

    .progress-container {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.8em;
    }
   

    /* === [TH√äM M·ªöI] CSS CHO T√çNH NƒÇNG H·∫∏N GI·ªú THEO K·ªäCH B·∫¢N === */
    .scenario-timer-container {
        padding: 0 15px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .scenario-input-group {
        background: #232526;
        border: 1px solid #414345;
        border-radius: 8px;
        padding: 12px;
    }
    .scenario-input-group label {
        display: flex;
        align-items: center;
        font-size: 1em;
        font-weight: 600;
        color: #bdc3c7;
        margin-bottom: 8px;
    }
    .scenario-input-group label svg {
        width: 20px;
        height: 20px;
        margin-right: 8px;
        color: #f1c40f;
    }
    .scenario-input-group input {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #7f8c8d;
        background-color: #2c3e50;
        color: #ecf0f1;
        font-size: 1.1em;
    }
    .scenario-helper-text {
        font-size: 0.8em;
        color: #7f8c8d;
        font-style: italic;
        margin-top: 5px;
    }
    .scenario-actions {
    display: flex;
    flex-direction: column; /* <-- D√íNG M·ªöI TH√äM V√ÄO */
    gap: 10px;
    margin-top: 10px;
}
    #scenario-preview-table-container {
        max-height: 250px;
        overflow-y: auto;
    }
    #scenario-preview-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 0.9em;
    }
    #scenario-preview-table th, #scenario-preview-table td {
        border: 1px solid #414345;
        padding: 8px;
        text-align: center;
    }
    #scenario-preview-table th {
        background: #f1c40f;
        color: #232526;
    }
    /* === [CH·ªàNH S·ª¨A THEO Y√äU C·∫¶U] === */
    /* Bi·∫øn #scenario-day-selector th√†nh thanh tab */
    /* === CSS KH√îI PH·ª§C GIAO DI·ªÜN N√öT B·∫§M CHO CH·ªåN NG√ÄY K·ªäCH B·∫¢N === */
#scenario-day-selector {
    display: flex;
    justify-content: space-around;
    gap: 5px; /* T·∫°o kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
    background: #2c3e50; /* N·ªÅn t·ªëi cho container */
    padding: 8px;
    border-radius: 8px; /* Bo tr√≤n container */
}
#scenario-day-selector label {
    flex: 1; /* Cho c√°c n√∫t c√≥ chi·ªÅu r·ªông b·∫±ng nhau */
    display: block;
}
#scenario-day-selector input {
    display: none; /* ·∫®n checkbox m·∫∑c ƒë·ªãnh */
}
#scenario-day-selector span {
    display: block;
    text-align: center;
    padding: 8px 5px;
    background-color: #414345; /* M√†u n·ªÅn m·∫∑c ƒë·ªãnh c·ªßa n√∫t */
    color: #bdc3c7; /* M√†u ch·ªØ m·∫∑c ƒë·ªãnh */
    font-weight: 700;
    font-size: 0.9em;
    border-radius: 6px; /* Bo tr√≤n c√°c n√∫t */
    cursor: pointer;
    transition: all 0.2s ease-out;
}
#scenario-day-selector label:hover span {
    background-color: #34495e; /* M√†u khi di chu·ªôt qua */
    color: #fff;
}
#scenario-day-selector input:checked + span {
    background-color: #f1c40f; /* M√†u v√†ng khi ƒë∆∞·ª£c ch·ªçn */
    color: #232526; /* M√†u ch·ªØ ƒëen khi ƒë∆∞·ª£c ch·ªçn */
    box-shadow: 0 2px 10px rgba(241, 196, 15, 0.5);
    transform: translateY(-2px);
}
    
  </style>
</head>
<body>
    <div id="notification-area"></div>

  <div id="main">
    <div id="content">
      <div style="text-align: center; padding: 15px 0 5px 0;">
        <h2 id="index-main-title" style="margin: 0; padding: 0;">CHU√îNG B√ÅO T·ª∞ ƒê·ªòNG</h2>
        <p id="school-name-status" style="margin: 5px 0 0 0; padding: 0; font-size: 1.1em; font-weight: bold; text-shadow: 0 2px 8px #000; letter-spacing: 1.2px;">THPT Y√äN KH√ÅNH A</p>
      </div>
     <div class="clock-container" id="clock-wrapper" style="display: none;" onclick="manualSyncTime()">
        <div id="clock" class="clock">--:--:--</div>
        <div id="date" class="date-display">ƒêang ch·ªù ƒë·ªìng b·ªô...</div>
      </div>
      <div id="countdown-status" style="text-align: center; color: #00e6ff; font-weight: bold; font-size: 1.1em; margin-top: -5px; margin-bottom: 10px; height: 25px; text-shadow: 0 0 8px #00e6ff88;">
    </div>
      <div class="main-tabs">
        <button class="main-tab-button active" onclick="openMainTab(event, 'tab-lich-hoc')">üóìÔ∏è L·ªãch H·ªçc</button>
        <button class="main-tab-button" onclick="openMainTab(event, 'tab-hen-gio')">‚è±Ô∏è H·∫πn Gi·ªù</button>
        <button class="main-tab-button" onclick="openMainTab(event, 'tab-cai-dat')">‚öôÔ∏è C√†i ƒê·∫∑t</button>
        
        <button class="main-tab-button" onclick="openMainTab(event, 'tab-he-thong')">üõ†Ô∏è H·ªá Th·ªëng</button>
      </div>

      <div class="main-tab-content-container">
        <div id="tab-lich-hoc" class="main-tab-content active">
          <h3 id="index-schedule-title" style="text-align: center; font-size: 1.15em; font-weight: 900; text-transform: uppercase; letter-spacing: 1.5px; color: #ecf0f1; background: none; border: none; box-shadow: none; margin-bottom: 10px; margin-top: 5px;">
            C√ÄI ƒê·∫∂T L·ªäCH H·ªåC
          </h3>
          <div class="tab" id="tab_day">
            <button class="tablinks-day" onclick="selectDay(event, 't2')">T2</button>
            <button class="tablinks-day" onclick="selectDay(event, 't3')">T3</button>
            <button class="tablinks-day" onclick="selectDay(event, 't4')">T4</button>
            <button class="tablinks-day" onclick="selectDay(event, 't5')">T5</button>
            <button class="tablinks-day" onclick="selectDay(event, 't6')">T6</button>
            <button class="tablinks-day" onclick="selectDay(event, 't7')">T7</button>
            <button class="tablinks-day" onclick="selectDay(event, 'cn')">CN</button>
          </div>

          <div class="tab-session" id="tab_session">
            <button class="tablinks-session" onclick="selectSession(event, 'sang')">S√°ng</button>
            <button class="tablinks-session" onclick="selectSession(event, 'chieu')">Chi·ªÅu</button>
          </div>
          
          <div id="tab-content-wrapper"></div>
        </div>

        <div id="tab-hen-gio" class="main-tab-content" >
            <h3 id="title-scenario-tab" style="text-align: center ; font-size: 1.15em; font-weight: 900; text-transform: uppercase; letter-spacing: 1.5px; color: #ecf0f1; background: none; border: none; box-shadow: none; margin-bottom: 15px; margin-top: 5px;">
                H·∫∏N GI·ªú THEO K·ªäCH B·∫¢N
            </h3>

           <div class="scenario-timer-container">
    
    <details class="scenario-setup-details">
        <summary>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v5.414l3.293 3.293 1.414-1.414L13 11.586z"></path></svg>
            <span id="summary-new-scenario-text">THI·∫æT L·∫¨P K·ªäCH B·∫¢N M·ªöI</span>
        </summary>
        
        <div class="details-content" style="padding-top: 20px; display: flex; flex-direction: column; gap: 15px;">
            <div class="scenario-input-group">
                <label for="scenario-start-time">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v5.414l3.293 3.293 1.414-1.414L13 11.586z"></path></svg>
                    Th·ªùi gian b·∫Øt ƒë·∫ßu
                </label>
                <input type="time" id="scenario-start-time">
            </div>

            <div class="scenario-input-group">
                <label for="scenario-intervals">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 9a3 3 0 0 0-3 3h6a3 3 0 0 0-3-3z"></path><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path></svg>
                    L·∫∑p l·∫°i sau (ph√∫t)
                </label>
                <input type="text" id="scenario-intervals" placeholder="V√≠ d·ª•: 45,7,4,10">
                <p class="scenario-helper-text">Nh·∫≠p c√°c kho·∫£ng th·ªùi gian ch·ªù, c√°ch nhau b·∫±ng d·∫•u ph·∫©y (,)</p>
            </div>

            <div class="scenario-input-group">
                <label for="scenario-bells">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13.586V10c0-3.217-2.185-5.927-5-6.758V2h-4v1.242C7.185 4.073 5 6.783 5 10v3.586l-1.707 1.707A.996.996 0 0 0 3 16v2a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1v-2a.996.996 0 0 0-.293-.707L19 13.586zM19 17H5v-.586l1.707-1.707A.996.996 0 0 0 7 14v-4c0-2.757 2.243-5 5-5s5 2.243 5 5v4c0 .266.105.52.293.707L19 16.414V17zM12 22a2.98 2.98 0 0 0 2.818-2H9.182A2.98 2.98 0 0 0 12 22z"></path></svg>
                    S·ªë h·ªìi chu√¥ng t∆∞∆°ng ·ª©ng
                </label>
                <input type="text" id="scenario-bells" placeholder="V√≠ d·ª•: 6,3,2,6,3">
                <p class="scenario-helper-text">Nh·∫≠p s·ªë h·ªìi chu√¥ng cho gi·ªù b·∫Øt ƒë·∫ßu v√† c√°c l·∫ßn l·∫∑p l·∫°i</p>
            </div>

            <div class="scenario-input-group">
                <label>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 4h-2V2h-2v2H9V2H7v2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2zm-1 15H6V7h12v12z"></path></svg>
                    √Åp d·ª•ng cho c√°c ng√†y
                </label>
                <div class="day-selector" id="scenario-day-selector">
                    <label><input type="checkbox" name="scenario-day" value="t2"><span>T2</span></label>
                    <label><input type="checkbox" name="scenario-day" value="t3"><span>T3</span></label>
                    <label><input type="checkbox" name="scenario-day" value="t4"><span>T4</span></label>
                    <label><input type="checkbox" name="scenario-day" value="t5"><span>T5</span></label>
                    <label><input type="checkbox" name="scenario-day" value="t6"><span>T6</span></label>
                    <label><input type="checkbox" name="scenario-day" value="t7"><span>T7</span></label>
                    <label><input type="checkbox" name="scenario-day" value="cn"><span>CN</span></label>
                </div>
            </div>
            <div class="scenario-actions">
                <button class="modern-btn test-button" onclick="previewScenario()">Xem Tr∆∞·ªõc K·ªãch B·∫£n</button>
                <button class="modern-btn save-button" onclick="sendScenario()" style="background: linear-gradient(90deg, #27ae60, #2ecc71); border-color: #2ecc71; color: white;">G·ª≠i L·ªánh L√™n Thi·∫øt B·ªã</button>
            </div>
        </div>
    </details>

    <div id="saved-scenario-container" style="padding: 0; margin-top: 20px;">
        <h5 id="title-saved-scenario" style="text-align: center; color: #3498db; text-transform: uppercase; margin: 10px 0 15px 0;">
            K·ªäCH B·∫¢N HI·ªÜN T·∫†I ƒêANG L∆ØU TR√äN THI·∫æT B·ªä
        </h5>
        <div id="saved-scenario-table-wrapper" style="max-height: 250px; overflow-y: auto; display: none;">
        </div>
        <p id="saved-scenario-placeholder" class="list-placeholder" style="padding: 10px; display: block;">
            ƒêang ch·ªù d·ªØ li·ªáu t·ª´ thi·∫øt b·ªã...
        </p>
        <div id="saved-scenario-priority" style="text-align: center; font-size: 0.9em; color: #bdc3c7; margin-top: 10px; font-style: italic;">
        </div>
        <div id="saved-scenario-days-display" class="saved-days-container">
        </div>
        <div class="delete-scenario-button-container">
            <button class="modern-btn logout-button" onclick="deleteSavedScenario()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
                 <span id="btn-delete-scenario">X√≥a K·ªãch B·∫£n ƒê√£ L∆∞u</span>
            </button>
        </div>
    </div>
    
    <div id="scenario-preview-table-container" style="margin-top: 20px;">
    </div>
    </div>
  </div>
        <div id="tab-cai-dat" class="main-tab-content">
            <div class="sohoi-container" style="margin-top: 5px;">
              <details> <summary id="header-sohoi">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24px" height="24px" style="margin-right: 10px; flex-shrink: 0;">
                                <path d="M19 13.586V10c0-3.217-2.185-5.927-5-6.758V2h-4v1.242C7.185 4.073 5 6.783 5 10v3.586l-1.707 1.707A.996.996 0 0 0 3 16v2a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1v-2a.996.996 0 0 0-.293-.707L19 13.586zM19 17H5v-.586l1.707-1.707A.996.996 0 0 0 7 14v-4c0-2.757 2.243-5 5-5s5 2.243 5 5v4c0 .266.105.52.293.707L19 16.414V17zM12 22a2.98 2.98 0 0 0 2.818-2H9.182A2.98 2.98 0 0 0 12 22z"></path>
                            </svg>
                            <div>
                                <div id="sohoi-title">C√ÄI ƒê·∫∂T CHU√îNG B√ÅO</div>
                            </div>
                        </summary>
                  <div class="details-content">
                      <div class="settings-grid" style="grid-template-columns: 1fr 1fr; padding: 0; gap: 8px;">
    <div class="setting-item">
        <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13.586V10c0-3.217-2.185-5.927-5-6.758V2h-4v1.242C7.185 4.073 5 6.783 5 10v3.586l-1.707 1.707A.996.996 0 0 0 3 16v2a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1v-2a.996.996 0 0 0-.293-.707L19 13.586zM19 17H5v-.586l1.707-1.707A.996.996 0 0 0 7 14v-4c0-2.757 2.243-5 5-5s5 2.243 5 5v4c0 .266.105.52.293.707L19 16.414V17zM12 22a2.98 2.98 0 0 0 2.818-2H9.182A2.98 2.98 0 0 0 12 22z"></path></svg></div>
        <div class="input-wrapper">
            <label for="sohoi_batdau" id="label-sohoi-batdau">B·∫Øt ƒë·∫ßu bu·ªïi h·ªçc</label>
            <div class="unit-input"><input id="sohoi_batdau" type="number" value="9"><span>h·ªìi</span></div>
        </div>
    </div>
    <div class="setting-item">
        <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13 16.438V7.562a1 1 0 0 0-1.555-.832L8 9.562v4.876l3.445 2.832A1 1 0 0 0 13 16.438zM12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path></svg></div>
        <div class="input-wrapper">
            <label for="sohoi_vaotiet" id="label-sohoi-vaotiet">V√†o ti·∫øt</label>
            <div class="unit-input"><input id="sohoi_vaotiet" type="number" value="6"><span>h·ªìi</span></div>
        </div>
    </div>
    <div class="setting-item">
        <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18 5h-2V2H8v3H6c-1.654 0-3 1.346-3 3v6c0 1.654 1.346 3 3 3h1v1c0 .552.447 1 1 1h6c.553 0 1-.448 1-1v-1h1c1.654 0 3-1.346 3-3V8c0-1.654-1.346-3-3-3zm1 9c0 .552-.447 1-1 1H6c-.553 0-1-.448-1-1V8c0-.552.447-1 1-1h12c.553 0 1 .448 1 1v6z"></path></svg></div>
        <div class="input-wrapper">
            <label for="sohoi_rachoi" id="label-sohoi-rachoi">Ra ch∆°i</label>
            <div class="unit-input"><input id="sohoi_rachoi" type="number" value="4"><span>h·ªìi</span></div>
        </div>
    </div>
    <div class="setting-item">
        <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M14 12V8h-4v4H8l4 4 4-4h-2z"></path></svg></div>
        <div class="input-wrapper">
            <label for="sohoi_duvao" id="label-sohoi-duvao">D·ª± v√†o l·ªõp</label>
            <div class="unit-input"><input id="sohoi_duvao" type="number" value="3"><span>h·ªìi</span></div>
        </div>
    </div>
</div> <hr style="margin: 10px 0; background: #414345; height: 1px; opacity: 0.8;">

<h5 style="text-align: center; color: #f1c40f; margin: 10px 0;">C√ÄI ƒê·∫∂T CHUNG CHO CHU√îNG REO</h5>
<div class="settings-grid" style="grid-template-columns: 1fr 1fr; padding: 0;">
    <div class="setting-item">
        <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v5.414l3.293 3.293 1.414-1.414L13 11.586z"></path></svg></div>
        <div class="input-wrapper">
            <label for="sohoi_tg_reo" id="label-sohoi-tgreo">Th·ªùi gian reo (ms)</label>
            <div class="unit-input"><input id="sohoi_tg_reo" type="number" value="1000"><span>ms</span></div>
        </div>
    </div>
    <div class="setting-item">
        <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M12 12.586-8.707 9.293l-1.414 1.414L12 15.414l7.121-7.121-1.414-1.414z"></path></svg></div>
        <div class="input-wrapper">
            <label for="sohoi_tg_nghi" id="label-sohoi-tgnghi">Th·ªùi gian ngh·ªâ (ms)</label>
            <div class="unit-input"><input id="sohoi_tg_nghi" type="number" value="1000"><span>ms</span></div>
        </div>
    </div>
</div>
<div style="padding: 15px 0 0 0;">
    <button class="modern-btn test-button" onclick="publishTestBell()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
        <span id="btn-test-bell">Th·ª≠ Chu√¥ng B√°o Chung</span>
    </button>
</div>
                </div>
              </details>
            </div>
            <div class="holiday-calendar-container">
                <details>
                    <summary>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24px" height="24px" style="margin-right: 10px; flex-shrink: 0;">
                            <path d="M19 4h-2V2h-2v2H9V2H7v2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2zm-1 15H6V7h12v12z"></path>
                        </svg>
                        <div id="title-holiday-calendar">L·ªäCH NGH·ªà L·ªÑ</div>
                    </summary>
                    <div class="details-content">
                        <div class="calendar-header">
                            <button onclick="changeMonth(-1)">&#8249;</button>
                            <div id="month-year-display">Th√°ng 9 2024</div>
                            <button onclick="changeMonth(1)">&#8250;</button>
                        </div>
                        <div class="calendar-grid" id="calendar-grid">
                            </div>
                    </div>
                </details>
            </div>
        </div>
             
        <div id="tab-he-thong" class="main-tab-content">
  <div class="button-section">
    
    <button class="modern-btn interface-button" onclick="openInterfaceSettingsModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path><path d="M12 22.31V12h10.31"></path><path d="M12 12H1.69"></path><path d="m12 12 5.66-5.66"></path></svg>
        <span id="btn-interface-settings">C√†i ƒë·∫∑t giao di·ªán</span>
    </button>
    <button class="modern-btn advanced-button" onclick="openAdvancedSettingsModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
        <span id="btn-advanced-settings">C√†i ƒë·∫∑t n√¢ng cao</span>
    </button>
    <div class="divider-yellow" style="margin: 10px auto;"></div>
    <button class="modern-btn logout-button" onclick="logout()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
        <span id="btn-logout">ƒêƒÉng xu·∫•t</span>
    </button>
  </div>
</div>

      </div>
      </div>
  </div>
<div class="sticky-action-bar">
  <button class="modern-btn save-button" onclick="publishUpdate()">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
      <span id="btn-save-schedule">L∆∞u v√† g·ª≠i c·∫≠p nh·∫≠t</span>
  </button>
</div>
<div class="modal-overlay" id="advanced-settings-modal">
    <div class="modal-content">
        <h4>C√†i ƒë·∫∑t n√¢ng cao</h4>
        <div class="adv-modal-tabs">
            <div class="adv-modal-tab active" onclick="switchAdvTab(event, 'adv-tab-satellites')">V·ªá tinh</div>
            <div class="adv-modal-tab" onclick="switchAdvTab(event, 'adv-tab-system')">H·ªá th·ªëng</div>
            <div class="adv-modal-tab" onclick="switchAdvTab(event, 'adv-tab-reset-wifi')">Reset WiFi</div>
            <div class="adv-modal-tab" onclick="switchAdvTab(event, 'adv-tab-reset-esp')">Reset ESP</div>
            <div class="adv-modal-tab" onclick="switchAdvTab(event, 'adv-tab-change-pass')">M·∫≠t kh·∫©u</div>
            <div class="adv-modal-tab" onclick="switchAdvTab(event, 'adv-tab-ota')">C·∫≠p nh·∫≠t OTA</div>
        </div>
        
        <div id="adv-tab-satellites" class="adv-modal-tab-content active">
            <h5>C√ÅC THI·∫æT B·ªä ƒêANG QU·∫¢N L√ù</h5>
            <div id="managed-devices-list" class="device-list">
                <p class="list-placeholder">Ch∆∞a c√≥ thi·∫øt b·ªã n√†o ƒë∆∞·ª£c qu·∫£n l√Ω.</p>
            </div>
            <hr style="margin: 20px 0; background: #414345; height: 1px; opacity: 0.5;">
            <h5>C√ÅC THI·∫æT B·ªä ƒê√É PH√ÅT HI·ªÜN</h5>
            <div id="discovered-devices-list" class="device-list">
                <p class="list-placeholder">ƒêang ch·ªù t√≠n hi·ªáu t·ª´ c√°c thi·∫øt b·ªã...</p>
            </div>
        </div>

        <div id="adv-tab-system" class="adv-modal-tab-content">
            <div id="system-info-actions-list" class="actions-list">
                </div>
        </div>

        <div id="adv-tab-reset-wifi" class="adv-modal-tab-content">
            <div id="reset-wifi-actions-list" class="actions-list">
                </div>
        </div>

        <div id="adv-tab-reset-esp" class="adv-modal-tab-content">
            <div id="reset-esp-actions-list" class="actions-list">
                </div>
        </div>

        <div id="adv-tab-change-pass" class="adv-modal-tab-content">
            <h5>THAY ƒê·ªîI M·∫¨T KH·∫®U QU·∫¢N TR·ªä</h5>
            <div class="actions-list" style="gap: 15px; padding-top: 10px;">
                <input type="password" id="old-admin-password" class="modal-input" placeholder="M·∫≠t kh·∫©u c≈©..." autocomplete="current-password">
                <input type="password" id="new-admin-password" class="modal-input" placeholder="M·∫≠t kh·∫©u m·ªõi..." autocomplete="new-password">
                <input type="password" id="confirm-admin-password" class="modal-input" placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi..." autocomplete="new-password">
                <button class="action-btn" style="width: 100%; height: 40px; font-size: 0.9em;" onclick="handleChangePassword()">L∆∞u Thay ƒê·ªïi</button>
            </div>
        </div>
        
        <div id="adv-tab-ota" class="adv-modal-tab-content">
            <h5>C·∫¨P NH·∫¨T FIRMWARE (OTA)</h5>
            <div class="actions-list" style="gap: 15px; padding-top: 10px;">
                
                <h5>1. CH·ªåN THI·∫æT B·ªä C·∫¶N C·∫¨P NH·∫¨T</h5>
                <div id="ota-device-selection-list" class="ota-device-selection">
                    <p class="list-placeholder">ƒêang ch·ªù danh s√°ch thi·∫øt b·ªã...</p>
                </div>
                
                <h5>2. CH·ªåN FILE FIRMWARE (.bin)</h5>
                <input type="file" id="ota-file-input" accept=".bin" style="display: none;">
                <button class="action-btn" id="ota-select-file-btn" onclick="document.getElementById('ota-file-input').click();" style="display: flex; align-items: center; justify-content: center; width: 100%; height: 40px; font-size: 0.9em;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    Ch·ªçn File (.bin)
                </button>
                <div id="ota-file-name" style="text-align: center; color: #f1c40f; font-weight: bold; min-height: 20px; font-size: 0.9em;">Ch∆∞a ch·ªçn t·ªáp n√†o</div>

                <h5>3. B·∫ÆT ƒê·∫¶U C·∫¨P NH·∫¨T</h5>
                <div id="ota-progress-container">
                    <div id="ota-progress-bar">0%</div>
                </div>
                <div id="ota-status-text"></div>
                <div id="ota-progress-details"></div>
                
                <div id="ota-device-status-list"></div>

                <button class="action-btn" id="ota-upload-btn" style="width: 100%; height: 40px; font-size: 0.9em; background-color: #27ae60; color: #fff; display: none;" onclick="handleOtaUpload()">B·∫Øt ƒë·∫ßu C·∫≠p nh·∫≠t</button>
            </div>
        </div>

        <div class="modal-buttons">
            <button class="modal-cancel-btn" onclick="closeAdvancedSettingsModal()">ƒê√≥ng</button>
        </div>
    </div>
  </div>

  <div class="modal-overlay" id="password-modal-overlay">
      <div class="modal-content">
          <h4 id="password-modal-title">X√°c th·ª±c quy·ªÅn Qu·∫£n tr·ªã</h4>
          <p id="password-modal-description" style="text-align: center; margin-top: -10px; margin-bottom: 20px; color: #bdc3c7; font-size: 0.9em;">Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ ti·∫øp t·ª•c.</p>
          <input type="password" id="admin-password-input" class="modal-input" placeholder="M·∫≠t kh·∫©u qu·∫£n tr·ªã..." autocomplete="current-password">
          <div class="modal-buttons">
              <button class="modal-cancel-btn" onclick="closePasswordModal()">H·ªßy</button>
              <button class="modal-confirm-btn" onclick="confirmAction()">X√°c nh·∫≠n</button>
          </div>
      </div>
  </div>

  <div class="modal-overlay" id="conflict-modal-overlay">
      <div class="modal-content" style="border-top-color: #e74c3c;">
          <h4 style="color: #e74c3c;">C·∫£nh b√°o: Ph√°t hi·ªán xung ƒë·ªôt!</h4>
          <div id="conflict-modal-description">N·ªôi dung xung ƒë·ªôt s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y.</div>
          <p style="text-align: center; font-size: 0.9em; color: #f1c40f; font-weight: bold;">√îng mu·ªën ∆∞u ti√™n th·ª±c hi·ªán l·ªánh n√†o?</p>
          <div class="modal-buttons" style="flex-direction: column; gap: 10px;">
              <button class="modal-confirm-btn priority-scenario" onclick="handleConflictChoice('scenario')">∆Øu ti√™n K·ªãch B·∫£n H·∫πn Gi·ªù</button>
              <button class="modal-confirm-btn priority-schedule" onclick="handleConflictChoice('schedule')">∆Øu ti√™n L·ªãch H·ªçc H√¥m Nay</button>
              <button class="modal-cancel-btn" onclick="handleConflictChoice('cancel')">H·ªßy b·ªè</button>
          </div>
      </div>
  </div>

  <div class="modal-overlay" id="interface-settings-modal">
    <div class="modal-content">
        <h4 id="interface-modal-title">C√†i ƒë·∫∑t Giao di·ªán</h4>
        <div class="interface-table-container">
            <table>
                <thead>
                    <tr>
                        <th>M√¥ t·∫£</th>
                        <th>N·ªôi dung hi·ªán t·∫°i</th>
                    </tr>
                </thead>
                <tbody id="text-elements-table-body">
                    </tbody>
            </table>
        </div>
        <div class="interface-controls">
            <div class="control-grid">
                <div class="control-group full-width">
                    <label for="text-editor-input" id="interface-label-content">N·ªôi dung</label>
                    <input type="text" id="text-editor-input" placeholder="Ch·ªçn m·ªôt d√≤ng trong b·∫£ng ƒë·ªÉ s·ª≠a...">
                </div>
                <div class="control-group">
                    <label for="color-picker-input" id="interface-label-color">M√†u ch·ªØ</label>
                    <input type="color" id="color-picker-input">
                </div>
                <div class="control-group">
                    <label for="font-size-input" id="interface-label-fontsize">C·ª° ch·ªØ (px)</label>
                    <input type="number" id="font-size-input" min="8" max="40">
                </div>
                <div class="control-group full-width">
                    <label for="font-family-select" id="interface-label-fontfamily">Font ch·ªØ</label>
                    <select id="font-family-select">
                        <option value="'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif">M·∫∑c ƒë·ªãnh (Segoe UI)</option>
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="Verdana, sans-serif">Verdana</option>
                        <option value="Tahoma, sans-serif">Tahoma</option>
                        <option value="'Courier New', Courier, monospace">Courier New</option>
                        <option value="'Times New Roman', Times, serif">Times New Roman</option>
                    </select>
                </div>
            </div>
            <div class="interface-action-buttons">
                <button class="modern-btn logout-button" onclick="resetInterfaceSettings()" style="width: 100%;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 10px;"><path d="M13.5 2.5a1 1 0 1 0-2 0v2.4a6.5 6.5 0 1 0 9.9 7.4 1 1 0 1 0-1.8-1a4.5 4.5 0 1 1-6.6-5.9V8a1 1 0 1 0 2 0V2.5z"></path></svg>
                    <span id="interface-btn-reset">Reset v·ªÅ M·∫∑c ƒë·ªãnh</span>
                 </button>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="modal-cancel-btn" onclick="closeInterfaceSettingsModal()"><span id="interface-btn-close">ƒê√≥ng</span></button>
        </div>
    </div>
  </div>
  <script>
   // [M·ªöI] H√ÄM ƒêI·ªÄU KHI·ªÇN C√ÅC TAB CH√çNH
    function openMainTab(evt, tabName) {
        // L·∫•y t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ c√≥ class="main-tab-content" v√† ·∫©n ch√∫ng ƒëi
        const tabcontent = document.getElementsByClassName("main-tab-content");
        for (let i = 0; i < tabcontent.length; i++) {
            tabcontent[i].classList.remove("active");
        }

        // L·∫•y t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ c√≥ class="main-tab-button" v√† x√≥a class "active"
        const tablinks = document.getElementsByClassName("main-tab-button");
        for (let i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
        }

        // Hi·ªÉn th·ªã tab hi·ªán t·∫°i v√† th√™m m·ªôt class "active" v√†o n√∫t ƒë√£ m·ªü tab
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");

        // [S·ª¨A ƒê·ªîI] ·∫®n/hi·ªán thanh h√†nh ƒë·ªông t√πy theo tab
        const actionBar = document.querySelector('.sticky-action-bar');
        if (tabName === 'tab-lich-hoc' || tabName === 'tab-cai-dat') {
            actionBar.style.display = 'flex';
        } else {
            actionBar.style.display = 'none';
        }
    }
    
    // =======================================================
    // === [B·∫ÆT ƒê·∫¶U] JS M·ªöI CHO H·∫∏N GI·ªú & C·∫¢NH B√ÅO XUNG ƒê·ªòT ===
    // =======================================================

    // Bi·∫øn to√†n c·ª•c ƒë·ªÉ x·ª≠ l√Ω Promise c·ªßa modal
    let resolveConflictPromise = null;
    // [CH·ªàNH S·ª¨A THEO Y√äU C·∫¶U] Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u k·ªãch b·∫£n xem tr∆∞·ªõc
    let previewedScenarioData = null;


    /**
     * M·ªü modal c·∫£nh b√°o xung ƒë·ªôt v√† tr·∫£ v·ªÅ m·ªôt Promise
     * @param {string} message - N·ªôi dung HTML c·ªßa c·∫£nh b√°o
     * @returns {Promise<string>} - Promise s·∫Ω resolve v·ªõi l·ª±a ch·ªçn c·ªßa ng∆∞·ªùi d√πng ('scenario', 'schedule', 'cancel')
     */
    function openConflictModal(message) {
        const modal = document.getElementById('conflict-modal-overlay');
        const description = document.getElementById('conflict-modal-description');
        
        description.innerHTML = message;
        modal.classList.add('visible');

        return new Promise(resolve => {
            resolveConflictPromise = resolve;
        });
    }

    /**
     * ƒê√≥ng modal c·∫£nh b√°o xung ƒë·ªôt
     */
    function closeConflictModal() {
        const modal = document.getElementById('conflict-modal-overlay');
        modal.classList.remove('visible');
    }

    /**
     * X·ª≠ l√Ω l·ª±a ch·ªçn c·ªßa ng∆∞·ªùi d√πng t·ª´ modal c·∫£nh b√°o
     * @param {string} choice - L·ª±a ch·ªçn ('scenario', 'schedule', 'cancel')
     */
    function handleConflictChoice(choice) {
        if (resolveConflictPromise) {
            resolveConflictPromise(choice);
            resolveConflictPromise = null;
        }
        closeConflictModal();
    }
    
    /**
     * [N√ÇNG C·∫§P] H√†m h·ªó tr·ª£ t√≠nh to√°n kho·∫£ng th·ªùi gian ho·∫°t ƒë·ªông c·ªßa m·ªôt bu·ªïi h·ªçc.
     * Tr·∫£ v·ªÅ object ch·ª©a th·ªùi gian b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c (t√≠nh b·∫±ng ph√∫t).
     */
    function getSessionTimeRange(scheduleObject) {
        if (!scheduleObject || !scheduleObject.enabled) return null;

        const hasSpecial = scheduleObject.has_special_event || false;
        const hasDuVao = scheduleObject.has_duvao_bell === undefined ? true : scheduleObject.has_duvao_bell;

        const startTime = timeToMinute(scheduleObject.gio);
        const lessonTime = scheduleObject.tiethoc || 45;
        const lessonCount = scheduleObject.sotiet || 0;
        const prepareTime = hasDuVao ? (scheduleObject.duvaotiet || 3) : 0;

        const breakTimeStr = scheduleObject.rachoi || '5';
        const breakTimes = breakTimeStr.split(',').map(s => parseInt(s.trim()) || 0);

        const specialEventTime = hasSpecial ? (scheduleObject.chaoco || scheduleObject.chunhiem || 0) : 0;
        const specialPrepareTime = hasSpecial ? (scheduleObject.prepare_after_special || 2) : 0;

        if (startTime === 0 || lessonTime === 0 || lessonCount === 0) return null;

        let totalDuration = 0;
        if (hasSpecial && specialEventTime > 0) {
            totalDuration += specialEventTime;
            if (specialPrepareTime > 0) {
                totalDuration += specialPrepareTime;
            }
        }
        
        totalDuration += lessonTime * lessonCount;

        for (let i = 0; i < lessonCount - 1; i++) {
            const currentBreakTime = breakTimes[i] ?? breakTimes[breakTimes.length - 1];
            if (currentBreakTime > 0) {
                totalDuration += currentBreakTime;
                if (prepareTime > 0) {
                    totalDuration += prepareTime;
                }
            }
        }

        const endTime = startTime + totalDuration;
        return { start: startTime, end: endTime };
    }


    /**
     * [N√ÇNG C·∫§P] Ki·ªÉm tra xung ƒë·ªôt gi·ªØa k·ªãch b·∫£n v√† l·ªãch h·ªçc c·ªßa nh·ªØng ng√†y ƒë√£ ch·ªçn.
     * Logic m·ªõi s·∫Ω ki·ªÉm tra xem th·ªùi gian k·ªãch b·∫£n c√≥ n·∫±m TRONG KHO·∫¢NG th·ªùi gian b·∫≠n r·ªôn kh√¥ng.
     */
    async function checkForConflicts(scenario, selectedDays) {
        if (!scenario || scenario.length === 0 || !window.allData || !selectedDays || selectedDays.length === 0) {
            return { conflicting: false };
        }

        for (const dayId of selectedDays) {
            const morningScheduleData = window.allData.lich.sang[dayId];
            const afternoonScheduleData = window.allData.lich.chieu[dayId];

            const morningRange = getSessionTimeRange(morningScheduleData);
            const afternoonRange = getSessionTimeRange(afternoonScheduleData);

            for (const scenarioEvent of scenario) {
                const scenarioTimeInMinutes = timeToMinute(scenarioEvent.time);
                
                let conflictFound = false;
                let conflictSession = '';

                if (morningRange && scenarioTimeInMinutes >= morningRange.start && scenarioTimeInMinutes <= morningRange.end) {
                    conflictFound = true;
                    conflictSession = 'bu·ªïi s√°ng';
                } else if (afternoonRange && scenarioTimeInMinutes >= afternoonRange.start && scenarioTimeInMinutes <= afternoonRange.end) {
                    conflictFound = true;
                    conflictSession = 'bu·ªïi chi·ªÅu';
                }

                if (conflictFound) {
                    const dayNameMap = {t2: 'Th·ª© Hai', t3: 'Th·ª© Ba', t4: 'Th·ª© T∆∞', t5: 'Th·ª© NƒÉm', t6: 'Th·ª© S√°u', t7: 'Th·ª© B·∫£y', cn: 'Ch·ªß Nh·∫≠t'};
                    const dayName = dayNameMap[dayId] || dayId;
                    const message = `C·∫£nh b√°o: Th·ªùi gian <strong>${scenarioEvent.time}</strong> trong k·ªãch b·∫£n c·ªßa √¥ng tr√πng v·ªõi l·ªãch h·ªçc <strong>${conflictSession}</strong> c·ªßa ng√†y <strong>${dayName}</strong>.`;
                    return { conflicting: true, message: message };
                }
            }
        }

        return { conflicting: false };
    }


    /**
     * [GI·ªÆ NGUY√äN & ƒê·∫¢M B·∫¢O] H√†m t√≠nh to√°n v√† tr·∫£ v·ªÅ m·ªôt danh s√°ch (m·∫£ng) c√°c s·ª± ki·ªán,
     * ƒë·∫£m b·∫£o m·ªói s·ª± ki·ªán s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã tr√™n m·ªôt d√≤ng ri√™ng.
     */
    function calculateScenario() {
        const startTimeEl = document.getElementById('scenario-start-time');
        const intervalsEl = document.getElementById('scenario-intervals');
        const bellsEl = document.getElementById('scenario-bells');

        if (!startTimeEl.value) {
            showNotification("Vui l√≤ng nh·∫≠p th·ªùi gian b·∫Øt ƒë·∫ßu!", "error");
            return null;
        }

        const intervalsStr = intervalsEl.value.trim();
        const bellsStr = bellsEl.value.trim();

        if (!bellsStr) {
            showNotification("Vui l√≤ng nh·∫≠p chu·ªói s·ªë h·ªìi chu√¥ng!", "error");
            return null;
        }
        
        const intervals = intervalsStr === '' ? [] : intervalsStr.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
        const bells = bellsStr.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
        
        let currentTimeInMinutes = timeToMinute(startTimeEl.value);
        let scenario = [];

        if (bells.length === 0) {
            showNotification("Chu·ªói s·ªë h·ªìi chu√¥ng kh√¥ng h·ª£p l·ªá!", "error");
            return null;
        }

        scenario.push({
            time: minuteToTime(currentTimeInMinutes),
            bell: bells[0]
        });

        const loopCount = Math.min(intervals.length, bells.length - 1);
        for (let i = 0; i < loopCount; i++) {
            currentTimeInMinutes += intervals[i];
            scenario.push({
                time: minuteToTime(currentTimeInMinutes),
                bell: bells[i + 1]
            });
        }

        return scenario;
    }
    
    // [CH·ªàNH S·ª¨A THEO Y√äU C·∫¶U] H√†m m·ªõi ch·ªâ ƒë·ªÉ xem tr∆∞·ªõc
    function previewScenario() {
        const scenario = calculateScenario();
        // S·ª¨A L·ªñI: Hi·ªÉn th·ªã b·∫£ng xem tr∆∞·ªõc
        const previewContainer = document.getElementById('scenario-preview-table-container');

        if (!scenario || scenario.length === 0) {
            previewContainer.innerHTML = ''; // X√≥a xem tr∆∞·ªõc c≈© n·∫øu c√≥ l·ªói
            // H√†m calculateScenario ƒë√£ t·ª± th√¥ng b√°o l·ªói
            return;
        }
        const selectedDays = Array.from(document.querySelectorAll('input[name="scenario-day"]:checked')).map(cb => cb.value);

        // L∆∞u d·ªØ li·ªáu ƒë√£ t√≠nh to√°n v√†o bi·∫øn to√†n c·ª•c ƒë·ªÉ h√†m "sendScenario" s·ª≠ d·ª•ng
        previewedScenarioData = {
            scenario: scenario,
            days: selectedDays
        };

        // T·∫°o HTML cho b·∫£ng xem tr∆∞·ªõc
        let tableHTML = `<h5 style="text-align: center; color: #f1c40f; text-transform: uppercase; margin: 10px 0 15px 0;">B·∫¢NG XEM TR∆Ø·ªöC</h5>
                         <table class="scenario-table">
                            <thead>
                                <tr><th>STT</th><th>Th·ªùi gian</th><th>S·ªë h·ªìi</th></tr>
                            </thead>
                            <tbody>`;
        scenario.forEach((event, index) => {
            tableHTML += `<tr>
                            <td>${index + 1}</td>
                            <td>${event.time}</td>
                            <td>${event.bell} h·ªìi</td>
                        </tr>`;
        });
        tableHTML += `</tbody></table>`;
        
        previewContainer.innerHTML = tableHTML;
        showNotification("ƒê√£ t·∫°o k·ªãch b·∫£n xem tr∆∞·ªõc. Nh·∫•n 'G·ª≠i L·ªánh' ƒë·ªÉ l∆∞u.", "info");
    }

    // [CH·ªàNH S·ª¨A THEO Y√äU C·∫¶U] H√†m m·ªõi d√πng ƒë·ªÉ g·ª≠i l·ªánh (tr∆∞·ªõc ƒë√¢y l√† addScenario)
    async function sendScenario() {
        if (!client || !client.connected) {
            return showNotification("Ch∆∞a k·∫øt n·ªëi m√°y ch·ªß!", 'error');
        }

        if (!previewedScenarioData) {
            showNotification("Vui l√≤ng nh·∫•n 'Xem Tr∆∞·ªõc K·ªãch B·∫£n' tr∆∞·ªõc khi g·ª≠i l·ªánh.", "error");
            return;
        }

        const { scenario, days } = previewedScenarioData;

        if (days.length === 0) {
            return showNotification("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ng√†y ƒë·ªÉ √°p d·ª•ng k·ªãch b·∫£n!", "error");
        }
        if (!scenario || scenario.length === 0) {
            return; 
        }

        let userPriority = 'none'; 
        const conflict = await checkForConflicts(scenario, days);

        if (conflict.conflicting) {
            const userChoice = await openConflictModal(conflict.message);
            if (userChoice === 'cancel') {
                showNotification("ƒê√£ h·ªßy g·ª≠i l·ªánh do c√≥ xung ƒë·ªôt.", "info");
                return;
            }
            userPriority = userChoice;
        }

        // ƒê√¢y l√† payload c·ªßa M·ªòT k·ªãch b·∫£n
        const payload = {
            scenario: scenario,
            priority: userPriority,
            days: days
        };

        // === [S·ª¨A L·ªñI QUAN TR·ªåNG] ===
        // Ch√∫ng ta g·ª≠i M·ªòT k·ªãch b·∫£n ƒë·∫øn topic "ADD" (TH√äM)
        const SCENARIO_ADD_TOPIC = "esp32/bell/scenario/add"; 
        client.publish(SCENARIO_ADD_TOPIC, JSON.stringify(payload), { qos: 1 });
        // ==============================

        showNotification("ƒê√£ g·ª≠i l·ªánh TH√äM k·ªãch b·∫£n m·ªõi!", "success");
        
        // Kh√¥ng c·∫ßn t·ª± c·∫≠p nh·∫≠t localStorage, v√¨ ESP32 s·∫Ω g·ª≠i l·∫°i danh s√°ch m·ªõi
        // v√† h√†m _load() s·∫Ω x·ª≠ l√Ω (X√ìA C√ÅC D√íNG LI√äN QUAN ƒê·∫æN localStorage T·ª™ H√ÄM C≈®)
        
        document.getElementById('scenario-preview-table-container').innerHTML = '';
        previewedScenarioData = null;
    }

    // [TH√äM M·ªöI] H√†m x√≥a k·ªãch b·∫£n ƒë√£ l∆∞u
    function deleteSavedScenario() {
        if (!client || !client.connected) {
            return showNotification("Ch∆∞a k·∫øt n·ªëi m√°y ch·ªß!", 'error');
        }
        
        if (!confirm("√îng c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA T·∫§T C·∫¢ k·ªãch b·∫£n ƒë√£ l∆∞u tr√™n thi·∫øt b·ªã kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.")) {
            return;
        }

        // === [S·ª¨A L·ªñI QUAN TR·ªåNG] ===
        // G·ª≠i m·ªôt chu·ªói m·∫£ng r·ªóng "[]"
        const payload = "[]"; 
        
        // G·ª≠i ƒë·∫øn topic "SET" (ƒë·ªÉ GHI ƒê√à/X√ìA)
        const SCENARIO_SET_TOPIC = "esp32/bell/scenario/set"; 
        client.publish(SCENARIO_SET_TOPIC, payload, { qos: 1 }); 
        // ==============================
        
        showNotification("ƒê√£ g·ª≠i l·ªánh X√ìA T·∫§T C·∫¢ k·ªãch b·∫£n!", "success");
        // Kh√¥ng c·∫ßn x√≥a localStorage, ESP32 s·∫Ω g·ª≠i l·∫°i danh s√°ch r·ªóng v√† h√†m _load() s·∫Ω c·∫≠p nh·∫≠t
    } // <--- [ƒê√É S·ª¨A] D·∫§U NGO·∫∂C NH·ªåN K·∫æT TH√öC H√ÄM deleteSavedScenario ƒê∆Ø·ª¢C DI CHUY·ªÇN L√äN ƒê√ÇY
    
        // === [TH√äM H√ÄM M·ªöI N√ÄY] ===
    function deleteSingleScenario(index) { // <-- [ƒê√É S·ª¨A] H√ÄM N√ÄY B√ÇY GI·ªú N·∫∞M NGO√ÄI, ·ªû PH·∫†M VI TO√ÄN C·ª§C
        if (!confirm(`√îng c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA K·ªäCH B·∫¢N #${index + 1} kh√¥ng?`)) {
            return;
        }
        if (!client || !client.connected) {
            return showNotification("Ch∆∞a k·∫øt n·ªëi m√°y ch·ªß!", 'error');
        }
        
        // 1. ƒê·ªãnh nghƒ©a topic m·ªõi
        const SCENARIO_DELETE_TOPIC = "esp32/bell/scenario/delete";
        
        // 2. G·ª≠i ƒëi V·ªä TR√ç (index) c·ªßa k·ªãch b·∫£n c·∫ßn x√≥a
        client.publish(SCENARIO_DELETE_TOPIC, String(index), { qos: 1 }); 
        
        showNotification(`ƒê√£ g·ª≠i l·ªánh x√≥a k·ªãch b·∫£n #${index + 1}...`, 'info');
    }
    // =======================================================
    // PH·∫¶N M√É G·ªêC (GI·ªÆ NGUY√äN)
    // =======================================================
    if("true"!==sessionStorage.getItem("isLoggedIn"))window.location.href="login.html";
    
    let client, serverTime = null, targetDevice = null, targetAction = null, otaInProgress = false;
    let selectedDay = 't2', selectedSession = 'sang';
    let todaySchedule = []; 
    const brokerUrl="wss://8bdef73996bb4030affe9483eecde31b.s1.eu.hivemq.cloud:8884/mqtt";
    const options={username:"ngoctuyka",password:"Tu12345678@",clientId:"WebAppClient_"+parseInt(1e3*Math.random()),reconnectPeriod:2e3,protocolVersion: 4};
    
    // TOPICS MQTT C≈®
    const ONLINE_STATUS_TOPIC = "esp32/bell/status/online";
    const DATA_STATUS_TOPIC = "esp32/bell/data/status";
    const SET_DATA_TOPIC = "esp32/bell/data/set";
    const GET_DATA_TOPIC = "esp32/bell/data/get";
    const CONTROL_TOPIC = "esp32/bell/control";
    const SYS_INFO_TOPIC = "esp32/bell/status/sysinfo";
    const MANAGE_ADD_TOPIC = "esp32/bell/manage/add";
    const MANAGE_REMOVE_TOPIC = "esp32/bell/manage/remove";
    const MANAGE_STATUS_TOPIC = "esp32/bell/manage/status";
    const COMMAND_ACK_TOPIC = "esp32/bell/command/ack";
    const OTA_COMMAND_TOPIC = "esp32/bell/ota/command";
    const OTA_DATA_TOPIC = "esp32/bell/ota/data";
    const OTA_STATUS_TOPIC = "esp32/bell/ota/status";
    const OTA_SATELLITE_COMMAND_TOPIC_PREFIX = "esp32/bell/ota/satellite/command/";
    const OTA_SATELLITE_DATA_TOPIC_PREFIX = "esp32/bell/ota/satellite/data/";
    const OTA_SATELLITE_STATUS_TOPIC = "esp32/bell/ota/satellite/status";
 
    function connectToMqtt(){
        console.log("ƒêang k·∫øt n·ªëi ƒë·∫øn MQTT broker...");
        const schoolNameStatus = document.getElementById("school-name-status");
        schoolNameStatus.className = 'status-color-connecting';
        
        client=mqtt.connect(brokerUrl,options);
        
        client.on("connect",()=>{
            console.log("ƒê√£ k·∫øt n·ªëi th√†nh c√¥ng ƒë·∫øn MQTT broker!");
            const topicsToSubscribe = [
                DATA_STATUS_TOPIC, 
                ONLINE_STATUS_TOPIC, 
                SYS_INFO_TOPIC, 
                MANAGE_STATUS_TOPIC, 
                COMMAND_ACK_TOPIC, 
                OTA_STATUS_TOPIC,
                OTA_SATELLITE_STATUS_TOPIC,
                ];
            client.subscribe(topicsToSubscribe, {qos:1}, (err)=>{
                if(err) {
                    console.error("L·ªói khi ƒëƒÉng k√Ω topic:", err);
                } else {
                    console.log("ƒêƒÉng k√Ω nh·∫≠n c√°c topic th√†nh c√¥ng!");
                    client.publish(GET_DATA_TOPIC, '1', { qos: 1 });
                }
            });
        });
        
        client.on("message",(topic, payload)=>{
            const payloadString = payload.toString();
            
            if (topic === ONLINE_STATUS_TOPIC) {
                const schoolNameStatus = document.getElementById("school-name-status");
                if (payloadString === 'online') {
                    schoolNameStatus.className = "status-color-connected";
                    document.getElementById('clock-wrapper').style.display = 'block';
                } else {
                    schoolNameStatus.className = "status-color-disconnected";
                    document.getElementById('clock-wrapper').style.display = 'none';
                    serverTime = null;
                }
            }
            
            if (topic === DATA_STATUS_TOPIC && payloadString) {
                _load(payloadString);
            }

            if (topic === SYS_INFO_TOPIC) {
                try {
                    const info = JSON.parse(payloadString);
                    renderSystemInfo(info);
                } catch(e) {
                    console.error("L·ªói parse JSON th√¥ng tin h·ªá th·ªëng:", e);
                }
            }
            
            if (topic === MANAGE_STATUS_TOPIC) {
                try {
                    const data = JSON.parse(payloadString);
                    renderDeviceLists(data.managed || [], data.discovered || []);
                } catch(e) {
                    console.error("L·ªói parse JSON qu·∫£n l√Ω v·ªá tinh:", e);
                }
            }

            if (topic === COMMAND_ACK_TOPIC) {
                try {
                    const ack = JSON.parse(payloadString);
                    const message = `[${ack.name}] ${ack.message}`;
                    showNotification(message, ack.status || 'success');
                } catch (e) {
                    console.error("L·ªói parse JSON ph·∫£n h·ªìi l·ªánh:", e);
                }
            }
            
            if (topic === OTA_STATUS_TOPIC || topic === OTA_SATELLITE_STATUS_TOPIC) {
                try {
                    const status = JSON.parse(payloadString);
                    const deviceName = status.device || (status.name || 'Unknown');
                    
                    let deviceStatusEl = document.getElementById(`ota-status-${deviceName}`);
                    const statusList = document.getElementById('ota-device-status-list');
                    if (!deviceStatusEl) {
                        deviceStatusEl = document.createElement('div');
                        deviceStatusEl.id = `ota-status-${deviceName}`;
                        statusList.appendChild(deviceStatusEl);
                    }
                    
                    let progressText = '';
                    if (status.progress !== undefined) {
                        progressText = `${status.progress}% - `;
                    }
                    deviceStatusEl.textContent = `[${deviceName}]: ${progressText}${status.details}`;

                    if (status.status === 'error') {
                        deviceStatusEl.style.color = '#e74c3c';
                    } else if (status.status === 'success') {
                        deviceStatusEl.style.color = '#2ecc71';
                    } else if (status.status === 'progress' || status.status === 'start') {
                        deviceStatusEl.style.color = '#3498db';
                    } else {
                        deviceStatusEl.style.color = '#bdc3c7';
                    }
                } catch (e) {
                    console.error("L·ªói parse JSON tr·∫°ng th√°i OTA:", e);
                }
            }
            
            // [M·ªöI] X·ª¨ L√ù D·ªÆ LI·ªÜU T·ª™ TOPIC TR·∫†NG TH√ÅI NH·∫†C
            
        });
        
        client.on("error", e => console.error("L·ªói k·∫øt n·ªëi MQTT:", e));
        
        client.on("close",()=>{
            console.log("M·∫•t k·∫øt n·ªëi MQTT. ƒêang th·ª≠ k·∫øt n·ªëi l·∫°i...");
            document.getElementById("school-name-status").className = "status-color-disconnected";
            document.getElementById('clock-wrapper').style.display = 'none';
            serverTime = null;
        });
    }

    // [TH√äM M·ªöI] H√†m ·∫©n/hi·ªán c√°c t√πy ch·ªçn ph√°t nh·∫°c
    function updateClockAndCountdown() {
    updateLocalClock(); // G·ªçi h√†m c·∫≠p nh·∫≠t ƒë·ªìng h·ªì c≈©
    updateCountdown();  // G·ªçi h√†m c·∫≠p nh·∫≠t ƒë·∫øm ng∆∞·ª£c m·ªõi
}
    function calculateAndStoreTodaySchedule() {
        if (!window.allData || !window.allData.lich) {
            todaySchedule = [];
            return;
        }

        const dayMap = ['cn', 't2', 't3', 't4', 't5', 't6', 't7'];
        const currentDayKey = dayMap[new Date().getDay()];

        // T√≠nh to√°n l·ªãch cho c·∫£ bu·ªïi s√°ng v√† chi·ªÅu
        const morningSchedule = calculateSchedule(`${currentDayKey}_sang`);
        const afternoonSchedule = calculateSchedule(`${currentDayKey}_chieu`);

        // G·ªôp l·ªãch 2 bu·ªïi v√† s·∫Øp x·∫øp l·∫°i theo th·ªùi gian
        todaySchedule = [...morningSchedule, ...afternoonSchedule].sort((a, b) => a.timeInMinutes - b.timeInMinutes);
        console.log("ƒê√£ t√≠nh to√°n l·ªãch cho h√¥m nay:", todaySchedule);
    }
    function updateCountdown() {
    const countdownEl = document.getElementById('countdown-status');
    if (!serverTime || !countdownEl || todaySchedule.length === 0) {
        countdownEl.innerHTML = ''; // X√≥a n·ªôi dung n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
        return;
    }

    // L·∫•y th·ªùi gian hi·ªán t·∫°i (t√≠nh b·∫±ng ph√∫t t·ª´ ƒë·∫ßu ng√†y)
    const nowInMinutes = serverTime.getHours() * 60 + serverTime.getMinutes();

    // T√¨m s·ª± ki·ªán ti·∫øp theo trong l·ªãch tr√¨nh c·ªßa ng√†y h√¥m nay
    const nextEvent = todaySchedule.find(event => event.timeInMinutes > nowInMinutes);

    if (!nextEvent) {
        countdownEl.innerHTML = "ƒê√£ h·∫øt l·ªãch h·ªçc h√¥m nay.";
        return;
    }

    // T√≠nh to√°n th·ªùi gian c√≤n l·∫°i (t√≠nh b·∫±ng gi√¢y)
    const nowInSeconds = serverTime.getHours() * 3600 + serverTime.getMinutes() * 60 + serverTime.getSeconds();
    const nextEventInSeconds = nextEvent.timeInMinutes * 60;
    const secondsRemaining = nextEventInSeconds - nowInSeconds;

    if (secondsRemaining < 0) return; // B·ªè qua n·∫øu c√≥ l·ªói t√≠nh to√°n

    // ƒê·ªãnh d·∫°ng th·ªùi gian c√≤n l·∫°i th√†nh MM:SS
    const minutes = Math.floor(secondsRemaining / 60);
    const seconds = secondsRemaining % 60;
    const countdownText = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

    // T·∫°o th√¥ng b√°o m√¥ t·∫£ s·ª± ki·ªán
    let message = "";
    const description = nextEvent.description;

    if (description.includes("V√†o ti·∫øt")) {
        message = `C√≤n ${countdownText} ph√∫t ${description.toLowerCase()}`;
    } else if (description.includes("Ra ch∆°i")) {
        // "Ra ch∆°i ti·∫øt 1" nghƒ©a l√† "H·∫øt ti·∫øt 1"
        const tiet = description.match(/\d+/); // L·∫•y s·ªë t·ª´ chu·ªói
        if (tiet) {
            message = `C√≤n ${countdownText} ph√∫t h·∫øt ti·∫øt ${tiet[0]}`;
        }
    } else if (description.includes("Ra v·ªÅ")) {
        message = `C√≤n ${countdownText} ph√∫t l√† tan h·ªçc`;
    } else if (description.includes("D·ª± v√†o")) {
        message = `C√≤n ${countdownText} ph√∫t chu·∫©n b·ªã v√†o l·ªõp`;
    } else if (description.includes("Ch√†o c·ªù") || description.includes("Sinh ho·∫°t")) {
        message = `C√≤n ${countdownText} ph√∫t b·∫Øt ƒë·∫ßu ${description.toLowerCase()}`;
    } else {
        // Tr∆∞·ªùng h·ª£p d·ª± ph√≤ng
        message = `S·ª± ki·ªán ti·∫øp theo: ${description} sau ${countdownText}`;
    }

    // C·∫≠p nh·∫≠t n·ªôi dung l√™n giao di·ªán
    countdownEl.innerHTML = message;
}
    
    function formatTime(seconds) {
        if (isNaN(seconds) || seconds < 0) return "00:00";
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
    }

    // =======================================================

    function showNotification(message, type = 'success') {
        const area = document.getElementById('notification-area');
        const notif = document.createElement('div');
        notif.className = `notification ${type}`;
        notif.textContent = message;
        area.appendChild(notif);
        
        setTimeout(() => { notif.classList.add('show'); }, 10);

        setTimeout(() => {
            notif.classList.remove('show');
            setTimeout(() => {
                if(area.contains(notif)) {
                    area.removeChild(notif);
                }
            }, 300);
        }, 4000);
    }
    
    function openAdvancedSettingsModal() {
        document.getElementById('advanced-settings-modal').classList.add('visible');
        if (document.getElementById('adv-tab-system').classList.contains('active')) {
            requestSystemInfo();
        }
    }
    function closeAdvancedSettingsModal() {
        document.getElementById('advanced-settings-modal').classList.remove('visible');
    }
    function switchAdvTab(evt, tabName) {
        document.querySelectorAll('.adv-modal-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.adv-modal-tab-content').forEach(content => content.classList.remove('active'));
        evt.currentTarget.classList.add('active');
        document.getElementById(tabName).classList.add('active');
        
        if (tabName === 'adv-tab-system') {
            requestSystemInfo();
        }
    }
    
    function renderSystemInfo(info) {
        const listDiv = document.getElementById('system-info-actions-list');
        if (!listDiv) return;

        listDiv.innerHTML = ''; 

        const createItem = (icon, title, value, valueClass = '') => {
            return `
                <div class="action-item">
                    <div class="action-icon">${icon}</div>
                    <div class="action-text">
                        <div class="title">${title}</div>
                        <div class="description ${valueClass}">${value}</div>
                    </div>
                </div>
            `;
        };

        const wifiIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C7.486 2 3.407 3.585 0 6l1.414 1.414C4.195 5.53 7.855 4 12 4s7.805 1.53 10.586 3.414L24 6C20.593 3.585 16.514 2 12 2zm0 4c-3.145 0-6.195 1.229-8.485 3.414L5.414 11.31C7.21 9.898 9.51 9 12 9s4.79 0.898 6.586 2.31l1.899-1.898C18.195 7.229 15.145 6 12 6zm0 5c-1.854 0-3.58.718-4.828 1.968L9.07 14.864C9.945 14.18 10.94 13.8 12 13.8s2.055 0.38 2.93 1.064l1.898-1.898C15.58 11.718 13.854 11 12 11zm0 4.2c-0.828 0-1.5 0.672-1.5 1.5s0.672 1.5 1.5 1.5 1.5-0.672 1.5-1.5-0.672-1.5-1.5-1.5z"></path></svg>';
        const ipIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm-1.999 14.413-3.713-3.713 1.414-1.414 2.299 2.299 4.949-4.95 1.414 1.414-6.363 6.364z"></path></svg>';
        const rtcIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v5.414l3.293 3.293 1.414-1.414L13 11.586z"></path></svg>';
        const lcdIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 3H4c-1.103 0-2 .897-2 2v11c0 1.103.897 2 2 2h3l-1 2v1h12v-1l-1-2h3c1.103 0 2-.897 2-2V5c0-1.103-.897-2-2-2zM4 14V5h16l.002 9H4z"></path></svg>';
        const flashIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"></path></svg>';
        const ramIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 5h16v2H4zm0 4h16v2H4zm0 4h16v2H4zm0 4h16v2H4z"></path></svg>';
              
        listDiv.innerHTML += createItem(wifiIcon, 'T√™n WiFi (SSID)', info.ssid || 'N/A');
        listDiv.innerHTML += createItem(ipIcon, 'ƒê·ªãa ch·ªâ IP', info.ip || 'N/A');
        listDiv.innerHTML += createItem(rtcIcon, 'Module RTC', info.rtc ? 'ƒê√£ k·∫øt n·ªëi' : 'Kh√¥ng t√¨m th·∫•y', info.rtc ? 'description connected' : 'description disconnected');
        listDiv.innerHTML += createItem(lcdIcon, 'M√†n h√¨nh LCD', info.lcd ? 'ƒê√£ k·∫øt n·ªëi' : 'Kh√¥ng t√¨m th·∫•y', info.lcd ? 'description connected' : 'description disconnected');
        listDiv.innerHTML += createItem(flashIcon, 'B·ªô nh·ªõ Flash', `${info.flash_usage || 'N/A'} % (${info.running_partition || ''})`);
        
        listDiv.innerHTML += createItem(ramIcon, 'RAM trong (SRAM)', `${info.sram_usage_percent || 'N/A'} % (C√≤n tr·ªëng ${info.sram_free_kb || 'N/A'} KB)`);
        listDiv.innerHTML += createItem(ramIcon, 'RAM ngo√†i (PSRAM)', `${info.psram_usage_percent || 'N/A'} % (C√≤n tr·ªëng ${info.psram_free_mb || 'N/A'} MB)`);
    }

    function requestSystemInfo() {
        if (client && client.connected) {
            client.publish(CONTROL_TOPIC, "GET_SYS_INFO", {qos: 1});
        } else {
            showNotification("Ch∆∞a k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß!", 'error');
        }
    }

    function openPasswordModal(deviceName, action) {
        targetDevice = deviceName;
        targetAction = action;
        const titleEl = document.getElementById('password-modal-title');
        const descEl = document.getElementById('password-modal-description');

        if (action === 'wifi') {
            titleEl.textContent = `Reset WiFi cho ${deviceName}`;
            descEl.textContent = `H√†nh ƒë·ªông n√†y s·∫Ω x√≥a c·∫•u h√¨nh WiFi ƒë√£ l∆∞u tr√™n ${deviceName}.`;
        } else if (action === 'restart') {
            titleEl.textContent = `Kh·ªüi ƒë·ªông l·∫°i ${deviceName}`;
            descEl.textContent = `H√†nh ƒë·ªông n√†y s·∫Ω kh·ªüi ƒë·ªông l·∫°i thi·∫øt b·ªã ${deviceName}.`;
        }

        document.getElementById('password-modal-overlay').classList.add('visible');
        document.getElementById('admin-password-input').focus();
    }

    function closePasswordModal() {
        document.getElementById('password-modal-overlay').classList.remove('visible');
        document.getElementById('admin-password-input').value = '';
        targetDevice = null;
        targetAction = null;
    }
    
    function confirmAction() {
        const password = document.getElementById('admin-password-input').value;
        if (!password) {
            showNotification('Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u!', 'error');
            return;
        }
        if (!targetDevice || !targetAction) {
            console.error("L·ªói: Kh√¥ng c√≥ thi·∫øt b·ªã ho·∫∑c h√†nh ƒë·ªông n√†o ƒë∆∞·ª£c ch·ªçn.");
            closePasswordModal();
            return;
        }

        let payload = {
            target: targetDevice,
            admin_pass: password
        };
        let notificationText = '';

        if (targetAction === 'wifi') {
            payload.command = "RESET_WIFI";
            notificationText = `ƒê√£ g·ª≠i l·ªánh Reset WiFi ƒë·∫øn ${targetDevice}...`;
        } else if (targetAction === 'restart') {
            payload.command = "RESTART_ESP";
            notificationText = `ƒê√£ g·ª≠i l·ªánh kh·ªüi ƒë·ªông l·∫°i ƒë·∫øn ${targetDevice}...`;
        } else {
            console.error("H√†nh ƒë·ªông kh√¥ng x√°c ƒë·ªãnh:", targetAction);
            closePasswordModal();
            return;
        }

        if (client && client.connected) {
            client.publish(CONTROL_TOPIC, JSON.stringify(payload), { qos: 1 });
            showNotification(notificationText);
        } else {
            showNotification("Ch∆∞a k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß!", 'error');
        }
        closePasswordModal();
    }

    function handleChangePassword() {
        const oldPass = document.getElementById('old-admin-password').value;
        const newPass = document.getElementById('new-admin-password').value;
        const confirmPass = document.getElementById('confirm-admin-password').value;

        if (!oldPass || !newPass || !confirmPass) {
            showNotification('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
            return;
        }
        if (newPass !== confirmPass) {
            showNotification('M·∫≠t kh·∫©u m·ªõi kh√¥ng kh·ªõp!', 'error');
            return;
        }
        if (newPass.length < 8) {
            showNotification('M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±!', 'error');
            return;
        }

        if (client && client.connected) {
            const payload = {
                command: "CHANGE_PASSWORD",
                old_pass: oldPass,
                new_pass: newPass
            };
            client.publish(CONTROL_TOPIC, JSON.stringify(payload), { qos: 1 });
            showNotification("ƒê√£ g·ª≠i y√™u c·∫ßu thay ƒë·ªïi m·∫≠t kh·∫©u...");
            document.getElementById('old-admin-password').value = '';
            document.getElementById('new-admin-password').value = '';
            document.getElementById('confirm-admin-password').value = '';
        } else {
            showNotification("Ch∆∞a k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß!", 'error');
        }
    }

    function addSatellite(deviceName) {
        if (client && client.connected) {
            client.publish(MANAGE_ADD_TOPIC, deviceName, { qos: 1 });
        } else {
            showNotification("Ch∆∞a k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß!", 'error');
        }
    }
    function removeSatellite(deviceName) {
        if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën ng·ª´ng qu·∫£n l√Ω thi·∫øt b·ªã "${deviceName}" kh√¥ng?`)) {
            if (client && client.connected) {
                client.publish(MANAGE_REMOVE_TOPIC, deviceName, { qos: 1 });
            } else {
                showNotification("Ch∆∞a k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß!", 'error');
            }
        }
    }
    
    function renderDeviceLists(managed, discovered) {
        const managedListDiv = document.getElementById('managed-devices-list');
        const discoveredListDiv = document.getElementById('discovered-devices-list');
        const resetWifiListDiv = document.getElementById('reset-wifi-actions-list');
        const resetEspListDiv = document.getElementById('reset-esp-actions-list');
        const otaDeviceListDiv = document.getElementById('ota-device-selection-list');

        managedListDiv.innerHTML = '';
        discoveredListDiv.innerHTML = '';
        resetWifiListDiv.innerHTML = '';
        resetEspListDiv.innerHTML = '';
        otaDeviceListDiv.innerHTML = '';

        if (managed.length === 0) {
            managedListDiv.innerHTML = '<p class="list-placeholder">Ch∆∞a c√≥ thi·∫øt b·ªã n√†o ƒë∆∞·ª£c qu·∫£n l√Ω.</p>';
        } else {
            managed.forEach(dev => {
                const item = document.createElement('div');
                item.className = 'device-item';
                const statusClass = dev.online ? 'connected' : 'disconnected';
                const statusText = dev.online ? 'Online' : 'Offline';
                const rssiText = dev.rssi ? `${dev.rssi} dBm` : 'N/A';
                const uptimeText = dev.uptime || 'N/A';
                const ipText = dev.ip || 'N/A';
                item.innerHTML = `
                    <div class="device-item-header">
                        <span class="device-name">${dev.name}</span>
                        <span class="device-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="device-info-grid">
                        <span><span class="label">IP:</span> ${ipText}</span>
                        <span><span class="label">S√≥ng WiFi:</span> ${rssiText}</span>
                        <span style="grid-column: 1 / -1;"><span class="label">Uptime:</span> ${uptimeText}</span>
                    </div>
                    <div class="device-actions">
                        <button class="device-action-btn cancel-btn" onclick="removeSatellite('${dev.name}')">H·ªßy</button>
                    </div>
                `;
                managedListDiv.appendChild(item);
            });
        }

        if (discovered.length === 0) {
            discoveredListDiv.innerHTML = '<p class="list-placeholder">Kh√¥ng ph√°t hi·ªán thi·∫øt b·ªã m·ªõi n√†o.</p>';
        } else {
            discovered.forEach(dev => {
                const item = document.createElement('div');
                item.className = 'device-item';
                item.style.flexDirection = 'row';
                item.style.justifyContent = 'space-between';
                item.innerHTML = `
                    <div class="device-info">
                        <span class="device-name">${dev.name}</span>
                        <div class="device-info-grid" style="grid-template-columns: 1fr; font-size: 0.8em;">
                           <span><span class="label">IP:</span> ${dev.ip || 'N/A'}</span>
                        </div>
                    </div>
                    <button class="device-action-btn add-btn" onclick="addSatellite('${dev.name}')">Th√™m</button>
                `;
                discoveredListDiv.appendChild(item);
            });
        }
        
        const allDevices = [{ name: 'ESP32-MayChu', type: 'M√°y Ch·ªß' }, ...managed.map(d => ({...d, type: 'V·ªá tinh'}))];

        const createOtaDeviceCheckbox = (deviceName, deviceType) => {
            return `
                <label>
                    <input type="checkbox" class="ota-target-checkbox" value="${deviceName}">
                    <span>${deviceName} <em style="color:#bdc3c7; font-size: 0.9em;">(${deviceType})</em></span>
                </label>
            `;
        };

        if(allDevices.length > 0) {
            allDevices.forEach(dev => {
                otaDeviceListDiv.innerHTML += createOtaDeviceCheckbox(dev.name, dev.type);

                resetWifiListDiv.innerHTML += `
                    <div class="action-item">
                        <div class="action-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 13h-2v-2h2v2zm0-4h-2V7h2v2z"></path></svg>
                        </div>
                        <div class="action-text">
                            <div class="title">${dev.name}</div>
                            <div class="description">X√≥a c·∫•u h√¨nh WiFi c·ªßa thi·∫øt b·ªã ${dev.type} n√†y.</div>
                        </div>
                        <button class="action-btn reset" onclick="openPasswordModal('${dev.name}', 'wifi')">Reset WiFi</button>
                    </div>
                `;
                
                resetEspListDiv.innerHTML += `
                    <div class="action-item">
                         <div class="action-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13.5 2.5a1 1 0 1 0-2 0v2.4a6.5 6.5 0 1 0 9.9 7.4 1 1 0 1 0-1.8-1a4.5 4.5 0 1 1-6.6-5.9V8a1 1 0 1 0 2 0V2.5z"></path></svg>
                        </div>
                        <div class="action-text">
                            <div class="title">${dev.name}</div>
                            <div class="description">Kh·ªüi ƒë·ªông l·∫°i thi·∫øt b·ªã ${dev.type} n√†y.</div>
                        </div>
                        <button class="action-btn reset" style="background-color: #e67e22;" onclick="openPasswordModal('${dev.name}', 'restart')">Restart</button>
                    </div>
                `;
            });
        } else {
            otaDeviceListDiv.innerHTML = '<p class="list-placeholder">Kh√¥ng c√≥ thi·∫øt b·ªã n√†o.</p>';
        }
    }

function _load(e) {
    try {
        const t = JSON.parse(e);
        window.allData = null; 

        if (t.data) { // C·∫•u tr√∫c m·ªõi
            if (t.data.epoch) setTime(t.data.epoch);
            if (t.data.schedule) {
                window.allData = t.data.schedule;
                populateForm(t.data.schedule);
                calculateAndStoreTodaySchedule();
                
            }
            if (t.data.holidays) loadHolidayData(t.data.holidays);
            if (t.data.scenario) {
                console.log("Nhan du lieu scenario tu MQTT, dang cap nhat UI...");
                renderSavedScenario(t.data.scenario);
                
                // ƒê·ªìng b·ªô l·∫°i localStorage v·ªõi d·ªØ li·ªáu m·ªõi nh·∫•t t·ª´ thi·∫øt b·ªã
                localStorage.setItem('savedScenario', JSON.stringify(t.data.scenario));
            }

        } else { // C·∫•u tr√∫c c≈© (d·ª± ph√≤ng)
             if (t.epoch) setTime(t.epoch);
             if (t.schedule) {
                window.allData = t.schedule;
                populateForm(t.schedule);
                calculateAndStoreTodaySchedule();
                
             }
             if (t.holidays) loadHolidayData(t.holidays);
             // C·∫•u tr√∫c c≈© kh√¥ng c√≥ k·ªãch b·∫£n n√™n kh√¥ng c·∫ßn l√†m g√¨ th√™m.
        }

    } catch (error) {
        console.error("L·ªói parse JSON t·ª´ MQTT:", error);
    }
}
    // =======================================================
// === [TH√äM M·ªöI] H√ÄM X·ª¨ L√ù L·ªäCH NGH·ªà L·ªÑ KHI T·∫¢I TRANG ===
// =======================================================
function loadHolidayData(holidays) {
    if (holidays) {
        console.log("Nhan du lieu lich nghi le tu ESP32:", holidays);
        // L∆∞u d·ªØ li·ªáu v√†o bi·∫øn to√†n c·ª•c ƒë·ªÉ c√°c h√†m kh√°c s·ª≠ d·ª•ng
        holidayData = holidays;

        // V·∫Ω l·∫°i giao di·ªán l·ªãch v·ªõi d·ªØ li·ªáu m·ªõi
        // H√†m n√†y s·∫Ω t·ª± ƒë·ªông ƒë·ªçc bi·∫øn holidayData v√† t√¥ m√†u ƒë√∫ng c√°c ng√†y ngh·ªâ
        generateCalendar(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth());
    }
}
    function publishUpdate() {
    if (!client || !client.connected) return showNotification("Ch∆∞a k·∫øt n·ªëi m√°y ch·ªß!", 'error');
    try {
        const scheduleData = gatherDataFromForm();
        const payload = {
            schedule: scheduleData,
            holidays: holidayData
        };
        const payloadString = JSON.stringify(payload);
        client.publish(SET_DATA_TOPIC, payloadString, { qos: 1, retain: true });
        showNotification("ƒê√£ g·ª≠i l·ªánh c·∫≠p nh·∫≠t L·ªãch h·ªçc & L·ªãch ngh·ªâ...", 'success');
    } catch (e) {
        showNotification("L·ªói: " + e.message, 'error');
        console.error(e)
    }
}
    
    function publishTestBell(){
        if(client&&client.connected) {
            const payload = { command: "TEST_BELL" };
            client.publish(CONTROL_TOPIC, JSON.stringify(payload), {qos:1});
            showNotification("ƒê√£ g·ª≠i l·ªánh th·ª≠ chu√¥ng chung...");
        } else {
            showNotification("Ch∆∞a k·∫øt n·ªëi m√°y ch·ªß!", 'error');
        }
    }
    
    function manualSyncTime() {
    if (!client || !client.connected) {
        return showNotification("Ch∆∞a k·∫øt n·ªëi m√°y ch·ªß!", 'error');
    }
    // G·ª≠i m·ªôt l·ªánh ƒë∆°n gi·∫£n ƒë·∫øn ESP32 ƒë·ªÉ y√™u c·∫ßu n√≥ t·ª± ƒë·ªìng b·ªô NTP
    const payload = { command: "TRIGGER_NTP_SYNC" };
    client.publish(CONTROL_TOPIC, JSON.stringify(payload), { qos: 1 });
    showNotification("ƒê√£ g·ª≠i y√™u c·∫ßu ƒë·ªìng b·ªô th·ªùi gian NTP...", 'info');
}
    function logout(){sessionStorage.removeItem("isLoggedIn"),window.location.href="login.html"}
    function setTime(e){isNaN(e)||e<1e5?(console.log("Invalid epoch received, clock not set:",e),serverTime=null):(serverTime=new Date(1e3*e),document.getElementById("date").innerHTML=serverTime.toLocaleDateString("vi-VN",{weekday:"long",year:"numeric",month:"long",day:"numeric",timeZone:"Asia/Ho_Chi_Minh"}),updateLocalClock())}
    function updateLocalClock(){serverTime&&(serverTime.setSeconds(serverTime.getSeconds()+1),document.getElementById("clock").innerHTML=serverTime.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:"Asia/Ho_Chi_Minh",hour12:!1}))}
    
    function toggleSettings(headerElement) {
        const content = headerElement.nextElementSibling;
        if (content && content.classList.contains('collapsible-settings')) {
            headerElement.classList.toggle('expanded');
            content.classList.toggle('expanded');
        }
    }

    function toggleScheduleActivation(dayId) {
        const isEnabled = document.getElementById(`enable_${dayId}`).checked;
        const enableItem = document.getElementById(`toggle_item_enable_${dayId}`);
        const specialItem = document.getElementById(`toggle_item_special_${dayId}`);
        const duvaoItem = document.getElementById(`toggle_item_duvao_${dayId}`);
        const settingsContainer = document.getElementById(`settings_container_${dayId}`);
        const isChieu = dayId.includes('_chieu');

        if (isEnabled) {
            if (enableItem) {
                enableItem.classList.add('active');
                if (isChieu) enableItem.classList.add('chieu-style');
            }
            if (specialItem) specialItem.classList.remove('disabled');
            if (duvaoItem) duvaoItem.classList.remove('disabled');
            if (settingsContainer) settingsContainer.classList.remove('hidden');
        } else {
            if (enableItem) {
                enableItem.classList.remove('active', 'chieu-style');
            }
            if (specialItem) specialItem.classList.add('disabled');
            if (duvaoItem) duvaoItem.classList.add('disabled');
            if (settingsContainer) settingsContainer.classList.add('hidden');
        }
    }

    function toggleSpecialEvent(dayId) {
        const checkbox = document.getElementById(`has_special_${dayId}`);
        const container = document.getElementById(`special_event_container_${dayId}`);
        if (container) {
            container.style.display = checkbox.checked ? 'grid' : 'none'; // Use grid for consistency
        }
    }

    function toggleDuVao(dayId) {
        const checkbox = document.getElementById(`has_duvao_${dayId}`);
        const inputWrapper = document.getElementById(`duvao_wrapper_${dayId}`);
        if (inputWrapper) {
            inputWrapper.style.display = checkbox.checked ? 'flex' : 'none';
        }
    }

    // =======================================================
    // === [N√ÇNG C·∫§P] C√ÅC H√ÄM T·∫†O GIAO DI·ªÜN V√Ä T√çNH TO√ÅN L·ªäCH H·ªåC ===
    // =======================================================

    const createDayContent = (e, t, o) => {
        const isMondayMorning = (e === 't2_sang');
        
        // Icons
        const d = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v5.414l3.293 3.293 1.414-1.414L13 11.586z"></path></svg></div>`;
        const r = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 4h-2V2h-2v2H9V2H7v2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2zm-1 15H6V7h12v12z"></path></svg></div>`;
        const l = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 2H6c-1.206 0-3 .799-3 3v14c0 2.201 1.794 3 3 3h15v-2H6.012C5.55 19.988 5 19.806 5 19s.55-.988 1.012-1H21V4c0-1.103-.897-2-2-2zm0 13H6V5h13v10z"></path></svg></div>`;
        const c = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18 5h-2V2H8v3H6c-1.654 0-3 1.346-3 3v6c0 1.654 1.346 3 3 3h1v1c0 .552.447 1 1 1h6c.553 0 1-.448 1-1v-1h1c1.654 0 3-1.346 3-3V8c0-1.654-1.346-3-3-3zm1 9c0 .552-.447 1-1 1H6c-.553 0-1-.448-1-1V8c0-.552.447-1 1-1h12c.553 0 1 .448 1 1v6z"></path></svg></div>`;
        const m = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M14 12V8h-4v4H8l4 4 4-4h-2z"></path></svg></div>`;
        const p = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h2v2H4zm0 5h2v2H4zm0 5h2v2H4zm16-8V6H8v2h12zm0 5H8v2h12zm0 5H8v2h12z"></path></svg></div>`;
        
        // [N√ÇNG C·∫§P] T·∫°o HTML cho khu v·ª±c s·ª± ki·ªán ƒë·∫∑c bi·ªát, bao g·ªìm c·∫£ √¥ nh·∫≠p th·ªùi gian chu·∫©n b·ªã
        const specialEventInput = isMondayMorning 
            ? `<div class="setting-item full-width">${r}<div class="input-wrapper"><label for="chaoco_${e}">TG Ch√†o c·ªù</label><div class="unit-input"><input id="chaoco_${e}" type="number" value="40"><span>ph√∫t</span></div></div></div>`
            : `<div class="setting-item full-width">${r}<div class="input-wrapper"><label for="chunhiem_${e}">TG Sinh ho·∫°t</label><div class="unit-input"><input id="chunhiem_${e}" type="number" value="15"><span>ph√∫t</span></div></div></div>`;
        const prepareAfterSpecialInput = `<div class="setting-item full-width">${m}<div class="input-wrapper"><label for="prepare_after_special_${e}">TG chu·∫©n b·ªã sau SH/CC</label><div class="unit-input"><input id="prepare_after_special_${e}" type="number" value="2"><span>ph√∫t</span></div></div></div>`;
        const u = specialEventInput + prepareAfterSpecialInput;

        let g = ""; // Copy button HTML
        if (!isMondayMorning) {
            if (o === 'sang') {
                g = `<div class="copy-button-container"><button class="copy-button sang" onclick="copyMorningSchedule('${e}')">Sao ch√©p ƒë·∫øn T3-CN (S√°ng)</button></div>`;
            } else { // 'chieu'
                g = `<div class="copy-button-container"><button class="copy-button chieu" onclick="copyAfternoonSchedule('${e}')">Sao ch√©p ƒë·∫øn c√°c ng√†y Chi·ªÅu</button></div>`;
            }
        }
        
        return `
        <div id="${e}" class="tabcontent">
            <h3 onclick="toggleSettings(this)">C√†i ƒë·∫∑t L·ªãch ${t}<br><span class="session-subtitle">(Bu·ªïi ${"sang"===o?"S√°ng":"Chi·ªÅu"})</span></h3>
            
            <div class="collapsible-settings">
                <div class="toggle-actions-group">
                    <div id="toggle_item_enable_${e}" class="toggle-action-item">
                        <div class="toggle-action-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42A6.92 6.92 0 0 1 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-1.93.78-3.68 2-4.95L5.59 5.64A8.96 8.96 0 0 0 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.49-1-4.73-2.67-6.41z"/></svg></div>
                        <div class="toggle-action-text">K√≠ch ho·∫°t L·ªãch</div>
                        <label class="switch ${"chieu"===o?"chieu-toggle":""}">
                            <input type="checkbox" id="enable_${e}" onchange="toggleScheduleActivation('${e}')" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="toggle_item_special_${e}" class="toggle-action-item">
                        <div class="toggle-action-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></div>
                        <div class="toggle-action-text">${isMondayMorning ? 'C√≥ Gi·ªù Ch√†o c·ªù' : 'C√≥ Gi·ªù Sinh ho·∫°t'}</div>
                        <label class="switch ${"chieu"===o?"chieu-toggle":""}">
                            <input type="checkbox" id="has_special_${e}" onchange="toggleSpecialEvent('${e}')">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="toggle_item_duvao_${e}" class="toggle-action-item">
                        <div class="toggle-action-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M10 20h4c0 1.1-.9 2-2 2s-2-.9-2-2zm10-2.64V11c0-3.35-2.36-6.15-5.5-6.83V3.5c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5V4.17C8.36 4.85 6 7.65 6 11v6.36L4 19.72V20h16v-.28l-2-2.36zM15 11h2v2h-2v-2zm-4 0h2v2h-2v-2zm-4 0h2v2H7v-2z"/></svg></div>
                        <div class="toggle-action-text">C√≥ Chu√¥ng D·ª± v√†o l·ªõp</div>
                        <label class="switch ${"chieu"===o?"chieu-toggle":""}">
                            <input type="checkbox" id="has_duvao_${e}" onchange="toggleDuVao('${e}')" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div id="settings_container_${e}" class="settings-grid-container">
                    ${g}
                    <hr style="margin: 15px; background: #414345; height: 1px; opacity: 0.5;">

                    <div class="settings-grid">
                        <div class="setting-item full-width">${d}<div class="input-wrapper"><label for="gio_${e}">Gi·ªù v√†o h·ªçc</label><input id="gio_${e}" type="time"></div></div>
                        
                        <div id="special_event_container_${e}" class="settings-grid full-width" style="display: none; grid-template-columns: 1fr; gap: 8px; padding: 0;">${u}</div>
                        
                        <div class="setting-item">${l}<div class="input-wrapper"><label for="tiethoc_${e}">TG Ti·∫øt h·ªçc</label><div class="unit-input"><input id="tiethoc_${e}" type="text" value="45"><span>ph√∫t</span></div><div class="input-helper-text">VD: 45,45,45,30</div></div></div>
                        <div class="setting-item">${c}<div class="input-wrapper"><label for="rachoi_${e}">TG Ra ch∆°i</label><div class="unit-input"><input id="rachoi_${e}" type="text" value="5"><span>ph√∫t</span></div><div class="input-helper-text">VD: 5,15,5,5</div></div></div>
                        <div class="setting-item" id="duvao_wrapper_${e}">${m}<div class="input-wrapper"><label for="duvaotiet_${e}">TG D·ª± v√†o</label><div class="unit-input"><input id="duvaotiet_${e}" type="number" value="3"><span>ph√∫t</span></div></div></div>
                        <div class="setting-item">${p}<div class="input-wrapper"><label for="sotiet_${e}">S·ªë ti·∫øt h·ªçc</label><div class="unit-input"><input id="sotiet_${e}" type="number" value="5"><span>ti·∫øt</span></div></div></div>
                    </div>
                    
                    <button class="modern-btn preview-button" onclick="updatePreviewTable('${e}')" style="height: 40px; font-size: 0.85em; background: #34495e; color: #f1c40f; border: 1px solid #f1c40f; margin-top: 15px;">C·∫≠p nh·∫≠t b·∫£ng chi ti·∫øt</button>

                </div>
            </div>

            <details style="margin-top: 15px;">
                <summary>Xem chi ti·∫øt l·ªãch</summary>
                <div class="details-container" id="details-${e}"></div>
            </details>
        </div>`
    }
    
    const contentWrapper = document.getElementById("tab-content-wrapper");
    const days=[{id:"t2",name:"Th·ª© 2"},{id:"t3",name:"Th·ª© 3"},{id:"t4",name:"Th·ª© 4"},{id:"t5",name:"Th·ª© 5"},{id:"t6",name:"Th·ª© 6"},{id:"t7",name:"Th·ª© 7"},{id:"cn",name:"Ch·ªß Nh·∫≠t"}];
    
    function populateForm(e){
        const t = e;
        if(t&&t.sohoi&&t.lich){
            document.querySelectorAll('#tab-content-wrapper .tabcontent').forEach(el => el.remove());
            console.log("Bat dau cap nhat form voi du lieu:",t);

            const bellTypes = ["batdau","vaotiet","rachoi","duvao"];
            bellTypes.forEach(type => {
                const numInput = document.getElementById(`sohoi_${type}`);
                if(numInput) numInput.value = t.sohoi[type]?.num || "";

                
            });
            ["tg_reo", "tg_nghi"].forEach(e=>{
                const o=document.getElementById(`sohoi_${e}`);
                o&&(o.value=t.sohoi[e]||"")
            });
            
            days.forEach(day => {
                contentWrapper.innerHTML += createDayContent(`${day.id}_sang`, day.name, "sang");
                contentWrapper.innerHTML += createDayContent(`${day.id}_chieu`, day.name, "chieu");
            });

            ["sang","chieu"].forEach(e=>{
                days.forEach(o=>{
                    const n=t.lich?.[e]?.[o.id];
                    if(n){
                        const dayId = `${o.id}_${e}`;
                        document.getElementById(`enable_${dayId}`).checked=n.enabled;
                        document.getElementById(`gio_${dayId}`).value=n.gio||"";
                        document.getElementById(`tiethoc_${dayId}`).value=n.tiethoc||"";
                        document.getElementById(`rachoi_${dayId}`).value=n.rachoi||"5"; // [N√ÇNG C·∫§P]
                        document.getElementById(`duvaotiet_${dayId}`).value=n.duvaotiet||"";
                        document.getElementById(`sotiet_${dayId}`).value=n.sotiet||"";
                        
                        const chaocoInput = document.getElementById(`chaoco_${dayId}`);
                        if(chaocoInput) chaocoInput.value=n.chaoco||0;
                        
                        const chunhiemInput = document.getElementById(`chunhiem_${dayId}`);
                        if(chunhiemInput) chunhiemInput.value=n.chunhiem||0;
                        
                        // [N√ÇNG C·∫§P & S·ª¨A L·ªñI] T·∫£i d·ªØ li·ªáu cho tr∆∞·ªùng m·ªõi v√† x·ª≠ l√Ω ƒë√∫ng gi√° tr·ªã 0
                        const prepareSpecialInput = document.getElementById(`prepare_after_special_${dayId}`);
                        if(prepareSpecialInput) prepareSpecialInput.value = n.prepare_after_special ?? 0;
                        
                        const hasSpecialCheckbox = document.getElementById(`has_special_${dayId}`);
                        if (hasSpecialCheckbox) {
                            hasSpecialCheckbox.checked = n.has_special_event || false;
                            toggleSpecialEvent(dayId);
                        }
                        
                        const hasDuVaoCheckbox = document.getElementById(`has_duvao_${dayId}`);
                        if (hasDuVaoCheckbox) {
                            hasDuVaoCheckbox.checked = n.has_duvao_bell === undefined ? true : n.has_duvao_bell;
                            toggleDuVao(dayId);
                        }
                        
                        toggleScheduleActivation(dayId);
                        updatePreviewTable(dayId);
                    }
                })
            });
             showActiveTab();
        } else {
            console.error("D·ªØ li·ªáu l·ªãch h·ªçc nh·∫≠n ƒë∆∞·ª£c kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng ƒë·∫ßy ƒë·ªß:",e)
        }
    }

    function gatherDataFromForm(){
        const e={sohoi:{},lich:{sang:{},chieu:{}}};
        
        const bellTypes = ["batdau","vaotiet","rachoi","duvao"];
        bellTypes.forEach(type => {
            e.sohoi[type] = {
    num: parseInt(document.getElementById(`sohoi_${type}`).value) || 0
};

        });
        ["tg_reo", "tg_nghi"].forEach(t=>{
            e.sohoi[t]=parseInt(document.getElementById(`sohoi_${t}`).value)||0
        });

        ["sang","chieu"].forEach(t=>{
            days.forEach(o=>{
                const dayId = `${o.id}_${t}`;
                const n=e.lich[t][o.id]={};
                n.enabled=document.getElementById(`enable_${dayId}`).checked;
                n.gio=document.getElementById(`gio_${dayId}`).value;
                n.tiethoc=document.getElementById(`tiethoc_${dayId}`).value || "45";
                n.rachoi=document.getElementById(`rachoi_${dayId}`).value || "5"; // [N√ÇNG C·∫§P]
                n.duvaotiet=parseInt(document.getElementById(`duvaotiet_${dayId}`).value)||0;
                n.sotiet=parseInt(document.getElementById(`sotiet_${dayId}`).value)||0;
                
                const chaocoInput = document.getElementById(`chaoco_${dayId}`);
                if(chaocoInput) n.chaoco=parseInt(chaocoInput.value)||0;
                
                const chunhiemInput = document.getElementById(`chunhiem_${dayId}`);
                if(chunhiemInput) n.chunhiem=parseInt(chunhiemInput.value)||0;
                
                // [N√ÇNG C·∫§P & S·ª¨A L·ªñI] Thu th·∫≠p d·ªØ li·ªáu t·ª´ tr∆∞·ªùng m·ªõi v√† x·ª≠ l√Ω ƒë√∫ng gi√° tr·ªã 0
                const prepareSpecialInput = document.getElementById(`prepare_after_special_${dayId}`);
                if(prepareSpecialInput) {
                    const val = parseInt(prepareSpecialInput.value);
                    n.prepare_after_special = isNaN(val) ? 0 : val;
                }

                const hasSpecialCheckbox = document.getElementById(`has_special_${dayId}`);
                if (hasSpecialCheckbox) n.has_special_event = hasSpecialCheckbox.checked;

                const hasDuVaoCheckbox = document.getElementById(`has_duvao_${dayId}`);
                if (hasDuVaoCheckbox) n.has_duvao_bell = hasDuVaoCheckbox.checked;
            })
        });
        return e;
    }

    function selectDay(evt, day) {
        selectedDay = day;
        document.querySelectorAll('.tablinks-day').forEach(btn => btn.classList.remove('active'));
        evt.currentTarget.classList.add('active');
        showActiveTab();
    }

    function selectSession(evt, session) {
        selectedSession = session;
        document.querySelectorAll('.tablinks-session').forEach(btn => btn.classList.remove('active'));
        evt.currentTarget.classList.add('active');
        showActiveTab();
    }

    function showActiveTab() {
        document.querySelectorAll('.tabcontent').forEach(content => {
            content.classList.remove('active');
        });
        const activeTabId = `${selectedDay}_${selectedSession}`;
        const activeContent = document.getElementById(activeTabId);
        if (activeContent) {
            activeContent.classList.add('active');
        }
    }

    function timeToMinute(e){if(!e)return 0;const[t,o]=e.split(":").map(Number);return 60*t+o}function minuteToTime(e){const t=Math.floor(e/60).toString().padStart(2,"0"),o=(e%60).toString().padStart(2,"0");return`${t}:${o}`}
    
    // [S·ª¨A L·ªñI] H√†m getVal ƒë∆∞·ª£c vi·∫øt l·∫°i ƒë·ªÉ x·ª≠ l√Ω ƒë√∫ng gi√° tr·ªã 0
    const getVal = (id, defaultValue = 0) => {
        const el = document.getElementById(id);
        if (!el) return defaultValue;
        const parsedValue = parseInt(el.value);
        return isNaN(parsedValue) ? defaultValue : parsedValue;
    };

    // [N√ÇNG C·∫§P TO√ÄN B·ªò] H√†m t√≠nh to√°n l·ªãch h·ªçc ƒë∆∞·ª£c vi·∫øt l·∫°i ƒë·ªÉ linh ho·∫°t h∆°n
    function calculateSchedule(dayId) {
    const getVal = (id, defaultValue = 0) => {
        const el = document.getElementById(id);
        if (!el) return defaultValue;
        const parsedValue = parseInt(el.value);
        return isNaN(parsedValue) ? defaultValue : parsedValue;
    };

    const isEnabled = document.getElementById(`enable_${dayId}`)?.checked;
    if (!isEnabled) return [];

    const hasSpecial = document.getElementById(`has_special_${dayId}`)?.checked;
    const hasDuVao = document.getElementById(`has_duvao_${dayId}`)?.checked;

    const startTime = timeToMinute(document.getElementById(`gio_${dayId}`).value);

    // --- [THAY ƒê·ªîI L·ªöN B·∫ÆT ƒê·∫¶U T·ª™ ƒê√ÇY] ---
    const lessonTimeStr = document.getElementById(`tiethoc_${dayId}`).value || '45';
    const lessonTimes = lessonTimeStr.split(',').map(s => parseInt(s.trim()) || 45);
    // --- [K·∫æT TH√öC THAY ƒê·ªîI] ---

    const lessonCount = getVal(`sotiet_${dayId}`, 5);
    const prepareTime = hasDuVao ? getVal(`duvaotiet_${dayId}`, 3) : 0;

    const breakTimeStr = document.getElementById(`rachoi_${dayId}`).value || '5';
    const breakTimes = breakTimeStr.split(',').map(s => parseInt(s.trim()) || 0);

    const isMondayMorning = dayId.includes('t2_sang');
    const specialEventTime = hasSpecial ? getVal(isMondayMorning ? `chaoco_${dayId}` : `chunhiem_${dayId}`) : 0;
    const specialPrepareTime = hasSpecial ? getVal(`prepare_after_special_${dayId}`, 0) : 0;

    if (startTime === 0 || lessonCount === 0) return [];

    let schedule = [];
    let currentTime = startTime;

    if (hasSpecial && specialEventTime > 0) {
        schedule.push({ time: currentTime, description: isMondayMorning ? "Ch√†o c·ªù" : "Sinh ho·∫°t" });
        currentTime += specialEventTime;

        if (specialPrepareTime > 0) {
            schedule.push({ time: currentTime, description: "Ngh·ªâ sau SH/CC" });
            currentTime += specialPrepareTime;
        }
    }

    for (let i = 1; i <= lessonCount; i++) {
        const currentLessonTime = lessonTimes[i - 1] ?? lessonTimes[lessonTimes.length - 1];

        schedule.push({ time: currentTime, description: `V√†o ti·∫øt ${i}` });
        currentTime += currentLessonTime; // S·ª≠ d·ª•ng th·ªùi gian ti·∫øt h·ªçc t∆∞∆°ng ·ª©ng

        if (i < lessonCount) {
            const currentBreakTime = breakTimes[i - 1] ?? breakTimes[breakTimes.length - 1]; 

            if (currentBreakTime > 0) {
                schedule.push({ time: currentTime, description: `Ra ch∆°i ti·∫øt ${i}` });
                currentTime += currentBreakTime;

                if (prepareTime > 0) {
                    schedule.push({ time: currentTime, description: `D·ª± v√†o ti·∫øt ${i + 1}` });
                    currentTime += prepareTime;
                }
            }
        }
    }

    schedule.push({ time: currentTime, description: "Ra v·ªÅ" });

    const uniqueSchedule = Array.from(new Map(schedule.map(item => [item.time, item])).values());
    return uniqueSchedule
        .map(item => ({ ...item, timeInMinutes: item.time, time: minuteToTime(item.time) }))
        .sort((a, b) => a.timeInMinutes - b.timeInMinutes);
}

    function updatePreviewTable(e){const t=document.getElementById(`enable_${e}`).checked,o=document.getElementById("details-"+e);if(!o)return;if(!t)return void(o.innerHTML="<p style='text-align:center; padding: 10px;'>L·ªãch n√†y ƒëang t·∫Øt.</p>");const n=calculateSchedule(e);let a="<table><thead><tr><th>STT</th><th>Th·ªùi gian</th><th>N·ªôi dung</th></tr></thead><tbody>";n.forEach((e,t)=>{a+=`<tr><td>${t+1}</td><td>${e.time}</td><td>${e.description}</td></tr>`}),a+="</tbody></table>",o.innerHTML=a}

    function copyAfternoonSchedule(sourceDayId) {
        const sourceDayName = sourceDayId.split('_')[0].toUpperCase();
        if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën sao ch√©p l·ªãch c·ªßa ${sourceDayName} (chi·ªÅu) ƒë·∫øn T·∫§T C·∫¢ c√°c ng√†y c√≤n l·∫°i c·ªßa bu·ªïi chi·ªÅu kh√¥ng?`)) return;

        const sourceData = {
            enabled: document.getElementById(`enable_${sourceDayId}`).checked,
            gio: document.getElementById(`gio_${sourceDayId}`).value,
            has_special_event: document.getElementById(`has_special_${sourceDayId}`).checked,
            chunhiem: document.getElementById(`chunhiem_${sourceDayId}`).value,
            prepare_after_special: document.getElementById(`prepare_after_special_${sourceDayId}`).value,
            has_duvao_bell: document.getElementById(`has_duvao_${sourceDayId}`).checked,
            tiethoc: document.getElementById(`tiethoc_${sourceDayId}`).value,
            rachoi: document.getElementById(`rachoi_${sourceDayId}`).value,
            duvaotiet: document.getElementById(`duvaotiet_${sourceDayId}`).value,
            sotiet: document.getElementById(`sotiet_${sourceDayId}`).value
        };

        const sourceId = sourceDayId.replace('_chieu', '');
        days.filter(d => d.id !== sourceId).forEach(day => {
            const targetDayId = `${day.id}_chieu`;
            document.getElementById(`enable_${targetDayId}`).checked = sourceData.enabled;
            document.getElementById(`gio_${targetDayId}`).value = sourceData.gio;
            document.getElementById(`has_special_${targetDayId}`).checked = sourceData.has_special_event;
            document.getElementById(`chunhiem_${targetDayId}`).value = sourceData.chunhiem;
            document.getElementById(`prepare_after_special_${targetDayId}`).value = sourceData.prepare_after_special;
            document.getElementById(`has_duvao_${targetDayId}`).checked = sourceData.has_duvao_bell;
            document.getElementById(`tiethoc_${targetDayId}`).value = sourceData.tiethoc;
            document.getElementById(`rachoi_${targetDayId}`).value = sourceData.rachoi;
            document.getElementById(`duvaotiet_${targetDayId}`).value = sourceData.duvaotiet;
            document.getElementById(`sotiet_${targetDayId}`).value = sourceData.sotiet;
            
            toggleSpecialEvent(targetDayId);
            toggleDuVao(targetDayId);
            toggleScheduleActivation(targetDayId);
            updatePreviewTable(targetDayId);
        });
        showNotification('Sao ch√©p th√†nh c√¥ng! H√£y nh·∫•n "L∆∞u v√† g·ª≠i c·∫≠p nh·∫≠t" ƒë·ªÉ √°p d·ª•ng.', "success");
    }

    function copyMorningSchedule(sourceDayId) {
        const sourceDayName = sourceDayId.split('_')[0].toUpperCase();
        if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën sao ch√©p l·ªãch c·ªßa ${sourceDayName} (s√°ng) ƒë·∫øn c√°c ng√†y c√≤n l·∫°i (T3-CN) kh√¥ng?`)) return;

        const sourceData = {
            enabled: document.getElementById(`enable_${sourceDayId}`).checked,
            gio: document.getElementById(`gio_${sourceDayId}`).value,
            has_special_event: document.getElementById(`has_special_${sourceDayId}`).checked,
            chunhiem: document.getElementById(`chunhiem_${sourceDayId}`).value,
            prepare_after_special: document.getElementById(`prepare_after_special_${sourceDayId}`).value,
            has_duvao_bell: document.getElementById(`has_duvao_${sourceDayId}`).checked,
            tiethoc: document.getElementById(`tiethoc_${sourceDayId}`).value,
            rachoi: document.getElementById(`rachoi_${sourceDayId}`).value,
            duvaotiet: document.getElementById(`duvaotiet_${sourceDayId}`).value,
            sotiet: document.getElementById(`sotiet_${sourceDayId}`).value
        };
        
        const sourceId = sourceDayId.replace('_sang', '');
        const targetDays = ["t3", "t4", "t5", "t6", "t7", "cn"].filter(id => id !== sourceId);
        
        targetDays.forEach(dayId => {
            const targetDayId = `${dayId}_sang`;
            document.getElementById(`enable_${targetDayId}`).checked = sourceData.enabled;
            document.getElementById(`gio_${targetDayId}`).value = sourceData.gio;
            document.getElementById(`has_special_${targetDayId}`).checked = sourceData.has_special_event;
            document.getElementById(`chunhiem_${targetDayId}`).value = sourceData.chunhiem;
            document.getElementById(`prepare_after_special_${targetDayId}`).value = sourceData.prepare_after_special;
            document.getElementById(`has_duvao_${targetDayId}`).checked = sourceData.has_duvao_bell;
            document.getElementById(`tiethoc_${targetDayId}`).value = sourceData.tiethoc;
            document.getElementById(`rachoi_${targetDayId}`).value = sourceData.rachoi;
            document.getElementById(`duvaotiet_${targetDayId}`).value = sourceData.duvaotiet;
            document.getElementById(`sotiet_${targetDayId}`).value = sourceData.sotiet;

            toggleSpecialEvent(targetDayId);
            toggleDuVao(targetDayId);
            toggleScheduleActivation(targetDayId);
            updatePreviewTable(targetDayId);
        });
        showNotification('Sao ch√©p th√†nh c√¥ng! H√£y nh·∫•n "L∆∞u v√† g·ª≠i c·∫≠p nh·∫≠t" ƒë·ªÉ √°p d·ª•ng.',"success");
    }

    function resetOtaUi(hideProgress = false) {
        otaInProgress = false;
        const uploadBtn = document.getElementById('ota-upload-btn');
        document.getElementById('ota-select-file-btn').disabled = false;
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'B·∫Øt ƒë·∫ßu C·∫≠p nh·∫≠t';
        uploadBtn.style.backgroundColor = '#27ae60';

        if (hideProgress) {
            document.getElementById('ota-progress-container').style.display = 'none';
        }
    }

    function handleOtaUpload() {
        if (otaInProgress) {
            showNotification("Qu√° tr√¨nh c·∫≠p nh·∫≠t ƒëang di·ªÖn ra!", 'info');
            return;
        }
        if (!client || !client.connected) return showNotification("Ch∆∞a k·∫øt n·ªëi m√°y ch·ªß!", 'error');
        
        const fileInput = document.getElementById('ota-file-input');
        const file = fileInput.files[0];
        const selectedDevices = Array.from(document.querySelectorAll('.ota-target-checkbox:checked')).map(cb => cb.value);

        if (!file) {
            return showNotification("Vui l√≤ng ch·ªçn m·ªôt file firmware (.bin)!", 'error');
        }
        if (selectedDevices.length === 0) {
            return showNotification("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt thi·∫øt b·ªã ƒë·ªÉ c·∫≠p nh·∫≠t!", 'error');
        }

        otaInProgress = true;
        const selectBtn = document.getElementById('ota-select-file-btn');
        const uploadBtn = document.getElementById('ota-upload-btn');
        const progressContainer = document.getElementById('ota-progress-container');
        const progressBar = document.getElementById('ota-progress-bar');
        const statusText = document.getElementById('ota-status-text');
        const progressDetails = document.getElementById('ota-progress-details');
        const deviceStatusList = document.getElementById('ota-device-status-list');

        selectBtn.disabled = true;
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'ƒêang c·∫≠p nh·∫≠t...';
        uploadBtn.style.backgroundColor = '#7f8c8d';
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        statusText.textContent = 'ƒêang ƒë·ªçc file...';
        progressDetails.textContent = '';
        deviceStatusList.innerHTML = '';

        const reader = new FileReader();
        reader.onload = function(e) {
            const fileData = e.target.result;
            const fileSize = fileData.byteLength;
            const CHUNK_SIZE = 256;
            let offset = 0;
            
            showNotification(`B·∫Øt ƒë·∫ßu OTA cho ${selectedDevices.length} thi·∫øt b·ªã...`, 'info');
            
            statusText.textContent = 'G·ª≠i l·ªánh b·∫Øt ƒë·∫ßu...';
            for (const deviceName of selectedDevices) {
                const isMaster = (deviceName === 'ESP32-MayChu');
                const commandTopic = isMaster ? OTA_COMMAND_TOPIC : OTA_SATELLITE_COMMAND_TOPIC_PREFIX + deviceName;
                client.publish(commandTopic, JSON.stringify({ action: "START", size: fileSize }), { qos: 1 });
            }

            function sendChunk() {
                if (!otaInProgress || offset >= fileSize) {
                    if(otaInProgress) {
                        statusText.textContent = 'Ho√†n t·∫•t g·ª≠i file, ƒëang ch·ªù x√°c nh·∫≠n...';
                        for (const deviceName of selectedDevices) {
                            const isMaster = (deviceName === 'ESP32-MayChu');
                            const commandTopic = isMaster ? OTA_COMMAND_TOPIC : OTA_SATELLITE_COMMAND_TOPIC_PREFIX + deviceName;
                            client.publish(commandTopic, JSON.stringify({ action: "END" }), { qos: 1 });
                        }
                        progressBar.style.width = '100%';
                    }
                    return;
                }

                const chunk = fileData.slice(offset, offset + CHUNK_SIZE);
                
                for (const deviceName of selectedDevices) {
                    const isMaster = (deviceName === 'ESP32-MayChu');
                    const dataTopic = isMaster ? OTA_DATA_TOPIC : OTA_SATELLITE_DATA_TOPIC_PREFIX + deviceName;
                    client.publish(dataTopic, new Uint8Array(chunk), { qos: 1 });
                }
                
                offset += chunk.byteLength;
                const progress = Math.min(100, Math.round((offset / fileSize) * 100));
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${progress}%`;
                statusText.textContent = `ƒêang g·ª≠i... ${Math.round(offset/1024)}/${Math.round(fileSize/1024)} KB`;
                
                setTimeout(sendChunk, 5);
            }
            
            setTimeout(sendChunk, 1000);
        };

        reader.onerror = function() {
            showNotification("L·ªói khi ƒë·ªçc file!", 'error');
            resetOtaUi(true);
        };

        reader.readAsArrayBuffer(file);
    }

    function initializeTabs() {
        const dayMap = ['cn', 't2', 't3', 't4', 't5', 't6', 't7'];
        const today = new Date();
        const currentDayId = dayMap[today.getDay()];

        selectedDay = currentDayId;

        const todayButton = document.querySelector(`.tablinks-day[onclick*="'${currentDayId}'"]`);
        if (todayButton) {
            document.querySelectorAll('.tablinks-day').forEach(btn => btn.classList.remove('active'));
            todayButton.classList.add('active');
        } else {
            document.querySelector('.tablinks-day').classList.add('active');
        }

        document.querySelector(`.tablinks-session[onclick*="'${selectedSession}'"]`).classList.add('active');
        
        days.forEach(day => {
            contentWrapper.innerHTML += createDayContent(`${day.id}_sang`, day.name, "sang");
            contentWrapper.innerHTML += createDayContent(`${day.id}_chieu`, day.name, "chieu");
        });

        showActiveTab();
    }

    const customizableTexts = [
        { id: 'index-main-title', defaultText: 'CHU√îNG B√ÅO T·ª∞ ƒê·ªòNG', description: 'Ti√™u ƒë·ªÅ ch√≠nh' },
        { id: 'school-name-status', defaultText: 'THPT Y√äN KH√ÅNH A', description: 'T√™n tr∆∞·ªùng' },
        { id: 'index-schedule-title', defaultText: 'C√ÄI ƒê·∫∂T L·ªäCH H·ªåC', description: 'Ti√™u ƒë·ªÅ c√†i ƒë·∫∑t L·ªãch' },
        { id: 'sohoi-title', defaultText: 'C√ÄI ƒê·∫∂T CHU√îNG B√ÅO', description: 'Ti√™u ƒë·ªÅ Chu√¥ng' }, // ƒê√É S·ª¨A L·∫†I TEXT TRONG H√ÄM GATHER/POPULATE
        { id: 'sohoi-subtitle', defaultText: '(CHUNG CHO T·∫§T C·∫¢ C√ÅC NG√ÄY)', description: 'Ph·ª• ƒë·ªÅ Chu√¥ng' }, // ƒê√É S·ª¨A L·∫†I TEXT
        { id: 'label-sohoi-batdau', defaultText: 'B·∫Øt ƒë·∫ßu bu·ªïi h·ªçc', description: 'Label: B·∫Øt ƒë·∫ßu bu·ªïi h·ªçc' },
        { id: 'label-sohoi-vaotiet', defaultText: 'V√†o ti·∫øt', description: 'Label: V√†o ti·∫øt' },
        { id: 'label-sohoi-rachoi', defaultText: 'Ra ch∆°i', description: 'Label: Ra ch∆°i' },
        { id: 'label-sohoi-duvao', defaultText: 'D·ª± v√†o l·ªõp', description: 'Label: D·ª± v√†o l·ªõp' },
        { id: 'label-sohoi-tgreo', defaultText: 'Th·ªùi gian reo (ms)', description: 'Label: TG Reo' },
        { id: 'label-sohoi-tgnghi', defaultText: 'Th·ªùi gian ngh·ªâ (ms)', description: 'Label: TG Ngh·ªâ' },
        { id: 'btn-save-schedule', defaultText: 'L∆∞u v√† g·ª≠i c·∫≠p nh·∫≠t', description: 'N√∫t L∆∞u ch√≠nh' },
        { id: 'btn-test-bell', defaultText: 'Th·ª≠ Chu√¥ng B√°o Chung', description: 'N√∫t Th·ª≠ Chu√¥ng' },
        { id: 'btn-interface-settings', defaultText: 'C√†i ƒë·∫∑t giao di·ªán', description: 'N√∫t C√†i ƒë·∫∑t giao di·ªán' },
        { id: 'btn-advanced-settings', defaultText: 'C√†i ƒë·∫∑t n√¢ng cao', description: 'N√∫t C√†i ƒë·∫∑t n√¢ng cao' },
        { id: 'btn-logout', defaultText: 'ƒêƒÉng xu·∫•t', description: 'N√∫t ƒêƒÉng xu·∫•t' },
        { id: 'interface-modal-title', defaultText: 'C√†i ƒë·∫∑t Giao di·ªán', description: 'Giao di·ªán: Ti√™u ƒë·ªÅ Modal' },
        { id: 'interface-label-content', defaultText: 'N·ªôi dung', description: 'Giao di·ªán: Label N·ªôi dung' },
        { id: 'interface-label-color', defaultText: 'M√†u ch·ªØ', description: 'Giao di·ªán: Label M√†u ch·ªØ' },
        { id: 'interface-label-fontsize', defaultText: 'C·ª° ch·ªØ (px)', description: 'Giao di·ªán: Label C·ª° ch·ªØ' },
        { id: 'interface-label-fontfamily', defaultText: 'Font ch·ªØ', description: 'Giao di·ªán: Label Font ch·ªØ' },
        { id: 'interface-btn-reset', defaultText: 'Reset v·ªÅ M·∫∑c ƒë·ªãnh', description: 'Giao di·ªán: N√∫t Reset' },
        { id: 'interface-btn-close', defaultText: 'ƒê√≥ng', description: 'Giao di·ªán: N√∫t ƒê√≥ng Modal' },
        { id: 'title-scenario-tab', defaultText: 'H·∫∏N GI·ªú THEO K·ªäCH B·∫¢N', description: 'Tab: H·∫πn gi·ªù k·ªãch b·∫£n' },
        { id: 'summary-new-scenario-text', defaultText: 'THI·∫æT L·∫¨P K·ªäCH B·∫¢N M·ªöI', description: 'H·∫πn gi·ªù: Ti√™u ƒë·ªÅ thi·∫øt l·∫≠p' },
        { id: 'title-saved-scenario', defaultText: 'K·ªäCH B·∫¢N HI·ªÜN T·∫†I ƒêANG L∆ØU TR√äN THI·∫æT B·ªä', description: 'H·∫πn gi·ªù: Ti√™u ƒë·ªÅ K·ªãch b·∫£n ƒë√£ l∆∞u' },
        { id: 'btn-delete-scenario', defaultText: 'X√≥a K·ªãch B·∫£n ƒê√£ L∆∞u', description: 'H·∫πn gi·ªù: N√∫t X√≥a K·ªãch b·∫£n' },
        { id: 'title-holiday-calendar', defaultText: 'L·ªäCH NGH·ªà L·ªÑ', description: 'C√†i ƒë·∫∑t: Ti√™u ƒë·ªÅ L·ªãch ngh·ªâ l·ªÖ' },
        { id: 'title-music-player', defaultText: 'ƒêI·ªÄU KHI·ªÇN PH√ÅT NH·∫†C', description: 'Ph√°t nh·∫°c: Ti√™u ƒë·ªÅ ch√≠nh' },
        { id: 'title-music-playlist', defaultText: 'DANH S√ÅCH PH√ÅT', description: 'Ph√°t nh·∫°c: Ti√™u ƒë·ªÅ Playlist' },
        { id: 'summary-music-schedule', defaultText: 'H·∫∏N GI·ªú PH√ÅT NH·∫†C', description: 'Ph√°t nh·∫°c: Ti√™u ƒë·ªÅ H·∫πn gi·ªù nh·∫°c' },
        { id: 'label-music-repeat-days', defaultText: 'L·∫∑p l·∫°i v√†o c√°c ng√†y', description: 'Ph√°t nh·∫°c: Label L·∫∑p l·∫°i ng√†y' },
    ];
    let selectedElementId = null;

    function openInterfaceSettingsModal() {
        document.getElementById('interface-settings-modal').classList.add('visible');
        populateInterfaceTable();
    }

    function closeInterfaceSettingsModal() {
        document.getElementById('interface-settings-modal').classList.remove('visible');
        selectedElementId = null;
    }

    function populateInterfaceTable() {
        const tableBody = document.getElementById('text-elements-table-body');
        tableBody.innerHTML = '';
        const savedSettings = localStorage.getItem('interfaceSettings');
        const settings = savedSettings ? JSON.parse(savedSettings) : {};
        customizableTexts.forEach(item => {
            const element = document.getElementById(item.id);
            const currentText = settings[item.id]?.text || (element ? element.innerText : item.defaultText);
            const row = document.createElement('tr');
            row.setAttribute('data-element-id', item.id);
            row.onclick = () => selectTextElement(row, item.id);
            row.innerHTML = `<td>${item.description}</td><td id="table-cell-${item.id}">${currentText}</td>`;
            tableBody.appendChild(row);
        });
    }

    function selectTextElement(row, elementId) {
        selectedElementId = elementId;
        document.querySelectorAll('#text-elements-table-body tr').forEach(r => r.classList.remove('selected-row'));
        row.classList.add('selected-row');

        const savedSettings = localStorage.getItem('interfaceSettings');
        const settings = savedSettings ? JSON.parse(savedSettings) : {};
        const specificSettings = settings[elementId];
        const defaultConfig = customizableTexts.find(item => item.id === elementId);

        const textValue = specificSettings?.text ?? defaultConfig?.defaultText ?? '';
        document.getElementById('text-editor-input').value = textValue;
        
        const element = document.getElementById(elementId);
        const computedStyle = element ? window.getComputedStyle(element) : {};

        const colorValue = specificSettings?.color || computedStyle.color || '#f5f6fa';
        document.getElementById('color-picker-input').value = rgbToHex(colorValue);

        const fontSizeValue = specificSettings?.fontSize ? parseFloat(specificSettings.fontSize) : (computedStyle.fontSize ? parseFloat(computedStyle.fontSize) : 15);
        document.getElementById('font-size-input').value = fontSizeValue;

        const fontFamilyValue = specificSettings?.fontFamily || computedStyle.fontFamily || "'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif";
        document.getElementById('font-family-select').value = fontFamilyValue;
    }

    function applyInterfaceChanges(property, value) {
        if (!selectedElementId) {
            showNotification("Vui l√≤ng ch·ªçn m·ªôt m·ª•c t·ª´ b·∫£ng ƒë·ªÉ ch·ªânh s·ª≠a!", "error");
            return;
        }

        const savedSettings = localStorage.getItem('interfaceSettings');
        let settings = savedSettings ? JSON.parse(savedSettings) : {};

        if (!settings[selectedElementId]) {
            settings[selectedElementId] = {};
        }

        switch (property) {
            case 'text': settings[selectedElementId].text = value; break;
            case 'color': settings[selectedElementId].color = value; break;
            case 'fontSize': settings[selectedElementId].fontSize = value ? value + 'px' : ''; break;
            case 'fontFamily': settings[selectedElementId].fontFamily = value; break;
        }

        localStorage.setItem('interfaceSettings', JSON.stringify(settings));

        const element = document.getElementById(selectedElementId);
        if (element) {
            if (property === 'text') element.innerText = value;
            if (property === 'color') element.style.color = value;
            if (property === 'fontSize') element.style.fontSize = settings[selectedElementId].fontSize;
            if (property === 'fontFamily') element.style.fontFamily = value;
        }
        
        if (property === 'text') {
            const tableCell = document.getElementById(`table-cell-${selectedElementId}`);
            if (tableCell) tableCell.innerText = value;
        }
    }

    function loadInterfaceSettings() {
        const savedSettings = localStorage.getItem('interfaceSettings');
        if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            for (const id in settings) {
                const element = document.getElementById(id);
                const itemSettings = settings[id];
                if (element && itemSettings) {
                    if (itemSettings.text) element.innerText = itemSettings.text;
                    if (itemSettings.color) element.style.color = itemSettings.color;
                    if (itemSettings.fontSize) element.style.fontSize = itemSettings.fontSize;
                    if (itemSettings.fontFamily) element.style.fontFamily = itemSettings.fontFamily;
                }
            }
        }
    }

    function resetInterfaceSettings() {
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën reset t·∫•t c·∫£ c√†i ƒë·∫∑t giao di·ªán v·ªÅ m·∫∑c ƒë·ªãnh kh√¥ng?")) {
            localStorage.removeItem('interfaceSettings');
            window.location.reload();
        }
    }

    function rgbToHex(rgb) {
      if (!rgb || typeof rgb !== 'string') return '#ffffff';
      if (rgb.startsWith('#')) return rgb;
      let match = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
      if (!match) return '#ffffff';
      function toHex(c) {
        let hex = Number(c).toString(16);
        return hex.length == 1 ? "0" + hex : hex;
      }
      return "#" + toHex(match[1]) + toHex(match[2]) + toHex(match[3]);
    }
    let holidayData = {}; 
    let currentDisplayDate = new Date();

    function generateCalendar(year, month) {
        const grid = document.getElementById('calendar-grid');
        const display = document.getElementById('month-year-display');
        grid.innerHTML = '';

        const today = new Date();
        const firstDayOfMonth = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        display.textContent = `Th√°ng ${month + 1} ${year}`;
        currentDisplayDate = new Date(year, month, 1);

        ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'].forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'calendar-day-header';
            dayHeader.textContent = day;
            grid.appendChild(dayHeader);
        });

        for (let i = 0; i < firstDayOfMonth.getDay(); i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'calendar-day empty';
            grid.appendChild(emptyCell);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';
            dayCell.textContent = day;
            
            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            dayCell.setAttribute('data-date', dateString);

            if (holidayData[dateString]) {
                dayCell.classList.add('holiday');
            }
            if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                dayCell.classList.add('today');
            }

            dayCell.onclick = () => toggleHoliday(dateString);
            grid.appendChild(dayCell);
        }
    }

    function changeMonth(offset) {
        currentDisplayDate.setMonth(currentDisplayDate.getMonth() + offset);
        generateCalendar(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth());
    }
function toggleHoliday(dateString) {
    function loadHolidayData(data) {
    if (data) {
        holidayData = data; // C·∫≠p nh·∫≠t bi·∫øn to√†n c·ª•c v·ªõi d·ªØ li·ªáu t·ª´ thi·∫øt b·ªã
        generateCalendar(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth());
    }
}
    const cell = document.querySelector(`.calendar-day[data-date="${dateString}"]`);
    if (holidayData[dateString]) {
        delete holidayData[dateString];
        if(cell) cell.classList.remove('holiday');
    } else {
        holidayData[dateString] = true; // Gi√° tr·ªã c√≥ th·ªÉ l√† true ho·∫∑c m·ªôt object r·ªóng
        if(cell) cell.classList.add('holiday');
    }
    if (!client || !client.connected) {
        return showNotification("Ch∆∞a k·∫øt n·ªëi m√°y ch·ªß! Thay ƒë·ªïi ch∆∞a ƒë∆∞·ª£c l∆∞u.", 'error');
    }
    const payload = {
        holidays: holidayData 
    };
    client.publish(SET_DATA_TOPIC, JSON.stringify(payload), { qos: 1, retain: true });
    showNotification(`ƒê√£ c·∫≠p nh·∫≠t ng√†y ngh·ªâ ${dateString}`, 'success');
}
    window.onload = function() { 
        loadInterfaceSettings();
        connectToMqtt();
        setInterval(updateClockAndCountdown, 1000);
        try {
            const lastScenario = localStorage.getItem('savedScenario');
            if (lastScenario) {
                renderSavedScenario(JSON.parse(lastScenario));
            }
        } catch (e) {
            console.error("Kh√¥ng th·ªÉ t·∫£i k·ªãch b·∫£n t·ª´ localStorage:", e);
        }
        
        document.getElementById('admin-password-input').addEventListener('keyup', function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                document.querySelector('#password-modal-overlay .modal-confirm-btn').click();
            }
        });

        document.getElementById('ota-file-input').addEventListener('change', function(event) {
            const file = event.target.files[0];
            const uploadBtn = document.getElementById('ota-upload-btn');
            const fileNameDiv = document.getElementById('ota-file-name');
            if (file) {
                fileNameDiv.textContent = file.name;
                uploadBtn.style.display = 'block';
            } else {
                fileNameDiv.textContent = 'Ch∆∞a ch·ªçn t·ªáp n√†o';
                uploadBtn.style.display = 'none';
            }
        });
        
        document.getElementById('text-editor-input').addEventListener('input', (e) => applyInterfaceChanges('text', e.target.value));
        document.getElementById('color-picker-input').addEventListener('input', (e) => applyInterfaceChanges('color', e.target.value));
        document.getElementById('font-size-input').addEventListener('input', (e) => applyInterfaceChanges('fontSize', e.target.value));
        document.getElementById('font-family-select').addEventListener('change', (e) => applyInterfaceChanges('fontFamily', e.target.value));

        initializeTabs();
        generateCalendar(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth());
        document.querySelector('.sticky-action-bar').style.display = 'flex';
    };

function renderSavedScenario(savedData) {
    const wrapper = document.getElementById('saved-scenario-table-wrapper');
    const priorityDiv = document.getElementById('saved-scenario-priority');
    const placeholder = document.getElementById('saved-scenario-placeholder');
    const daysDisplayContainer = document.getElementById('saved-scenario-days-display');

    // X√≥a n·ªôi dung c≈©
    wrapper.innerHTML = '';
    priorityDiv.innerHTML = '';
    daysDisplayContainer.innerHTML = '';

    // 1. Ki·ªÉm tra xem d·ªØ li·ªáu c√≥ ph·∫£i l√† m·ªôt m·∫£ng H·ª¢P L·ªÜ kh√¥ng
    if (!savedData || !Array.isArray(savedData)) {
        wrapper.style.display = 'none';
        placeholder.style.display = 'block';
        return; 
    }
    
    // 2. N·∫øu l√† m·∫£ng H·ª¢P L·ªÜ (k·ªÉ c·∫£ r·ªóng), ·∫©n placeholder
    wrapper.style.display = 'block';
    placeholder.style.display = 'none';

    // 3. B√¢y gi·ªù m·ªõi ki·ªÉm tra xem m·∫£ng c√≥ r·ªóng kh√¥ng
    if (savedData.length === 0) {
        wrapper.innerHTML = '<p class="list-placeholder" style="display: block; padding: 10px;">Kh√¥ng c√≥ k·ªãch b·∫£n n√†o ƒë∆∞·ª£c l∆∞u.</p>';
        return;
    }
    
    // 4. N·∫øu m·∫£ng kh√¥ng r·ªóng, l·∫∑p v√† hi·ªÉn th·ªã
    let listHTML = '';
    const dayNameMap = {t2: 'T2', t3: 'T3', t4: 'T4', t5: 'T5', t6: 'T6', t7: 'T7', cn: 'CN'};

    savedData.forEach((scenarioDoc, index) => {
        const events = scenarioDoc.scenario || [];
        const days = scenarioDoc.days || [];
        const priority = scenarioDoc.priority || 'none';
        
        // [S·ª¨A ƒê·ªîI 1] L·∫•y danh s√°ch gi·ªù h·∫πn
        const eventTimes = events.map(e => e.time).join(', ');
        
        let priorityText = 'Kh√¥ng ∆∞u ti√™n';
        if (priority === 'scenario') priorityText = '<span style="color: #2ecc71;">∆Øu ti√™n K·ªãch B·∫£n</span>';
        if (priority === 'schedule') priorityText = '<span style="color: #3498db;">∆Øu ti√™n L·ªãch H·ªçc</span>';

        listHTML += `
            <div class="scenario-item" style="border: 1px solid #414345; border-radius: 8px; margin-bottom: 10px; background: #232526;">
                <div class="scenario-item-header" style="background: #34495e; padding: 8px 12px; border-radius: 8px 8px 0 0; font-weight: bold; color: #f1c40f;">
                    K·ªäCH B·∫¢N #${index + 1} (${events.length} s·ª± ki·ªán)
                </div>
                <div class="scenario-item-body" style="padding: 12px; font-size: 0.9em; line-height: 1.6;">
                    <div style="margin-bottom: 5px;"><strong>√Åp d·ª•ng:</strong> ${days.map(d => dayNameMap[d] || d).join(', ') || 'Kh√¥ng c√≥'}</div>
                    
                    <div style="margin-bottom: 5px; color: #f1c40f;"><strong>Gi·ªù h·∫πn:</strong> ${eventTimes}</div>
                    
                    <div style="margin-bottom: 10px;"><strong>∆Øu ti√™n:</strong> ${priorityText}</div>
                    
                    <button class="device-action-btn remove-btn" style="width: 100%; font-size: 0.8em;" onclick="deleteSingleScenario(${index})">
                        X√≥a K·ªãch b·∫£n n√†y
                    </button>
                </div>
            </div>
        `;
    });
    wrapper.innerHTML = listHTML;
}
  </script>
 
<script>
function addScenario() {
  const startTime = document.getElementById("scenario-start-time").value;
  const intervals = document.getElementById("scenario-intervals").value;
  const bells = document.getElementById("scenario-bells").value;

  if (!startTime || !bells) {
    showNotification("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!", "error");
    return;
  }

  const scenario = { startTime, intervals, bells };

  if (typeof client !== 'undefined' && client && client.connected) {
    client.publish("device/command/saveScenario", JSON.stringify(scenario));
    showNotification("ƒê√£ g·ª≠i k·ªãch b·∫£n l√™n thi·∫øt b·ªã", "success");
  } else {
    showNotification("M·∫•t k·∫øt n·ªëi MQTT", "error");
  }

  const tableHtml = `
    <table class="scenario-table">
      <thead>
        <tr><th>STT</th><th>Th·ªùi gian</th><th>S·ªë h·ªìi</th></tr>
      </thead>
      <tbody>
        <tr>
          <td>1</td>
          <td>${startTime}${intervals ? " +" + intervals : ""}</td>
          <td>${bells} h·ªìi</td>
        </tr>
      </tbody>
    </table>
  `;
  document.getElementById("saved-scenario-table-wrapper").innerHTML = tableHtml;
}
function showNotification(msg, type="info") {
  const area = document.getElementById("notification-area");
  if (!area) return;
  const div = document.createElement("div");
  div.className = `notification ${type}`;
  div.textContent = msg;
  area.appendChild(div);
  setTimeout(() => div.classList.add("show"), 50);
  setTimeout(() => {
    div.classList.remove("show");
    if (div.parentNode) div.parentNode.removeChild(div);
  }, 3000);
}
</script>
</body>
</html>
