<!DOCTYPE html>
<html lang="vi">
<head>
  <title>Hẹn Giờ Chuông Báo - Điều khiển Internet</title>
  <meta name="viewport" content="width=device-width,user-scalable=0" charset="utf-8">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js" type="text/javascript"></script>
  
  <style type="text/css">
    /* --- CÀI ĐẶT CHUNG & SỬA LỖI TRÀN KHUNG --- */
    * {
        box-sizing: border-box;
    }
    body {
        background: linear-gradient(135deg, #3a4750 0%, #4a627a 100%);
        font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        color: #f5f6fa;
        min-height: 100vh;
        margin: 0;
        /* [MỚI] Thêm padding-bottom để không bị thanh hành động che mất nội dung */
        padding-bottom: 80px; 
        font-size: 15px;
    }

/* === [BƯỚC 2] CSS CHO GIAO DIỆN GÓI/MỞ CỦA TAB HẸN GIỜ === */
.scenario-setup-details {
    border: none;
    background: transparent;
    box-shadow: none;
    margin: 0 15px 15px 15px; /* Căn lề cho đồng bộ */
}
.scenario-setup-details > summary {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 12px 15px;
    font-size: 1.1em;
    font-weight: 700;
    letter-spacing: 1px;
    border-radius: 10px;
    background: linear-gradient(90deg, #2c3e50, #34495e);
    color: #3498db;
    border: 2px solid #3498db;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.2);
    transition: all 0.2s ease-in-out;
}
.scenario-setup-details > summary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
}
.scenario-setup-details[open] > summary {
    background: #3498db;
    color: #fff;
}
.scenario-setup-details > summary svg {
    width: 20px;
    height: 20px;
    margin-right: 10px;
}
.scenario-setup-details .details-content {
    border: 1px solid #414345;
    border-top: none;
    border-radius: 0 0 10px 10px;
    margin-top: -5px;
    padding: 10px;
    background: #232526;
}
/* ======================================================= */
    #main {
        margin: 24px auto;
        width: 380px;
        max-width: 98vw;
    }

    /* --- KHUNG NỘI DUNG CHÍNH --- */
    #content {
        background: #2c3e50;
        border: none;
        width: 100%;
        /*float: left;*/
        border-radius: 18px;
        padding-bottom: 24px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
    }

/* === [PHƯƠNG ÁN MỚI] CSS CHO HIỂN THỊ NGÀY ĐÃ LƯU === */
.saved-days-container {
    text-align: center;
    margin-top: 12px;
    padding: 5px;
}
.day-badge {
    display: inline-block;
    padding: 6px 12px;
    background-color: #f1c40f; /* Màu vàng đặc trưng */
    color: #232526; /* Màu chữ tối cho dễ đọc */
    font-weight: 700;
    border-radius: 8px;
    margin: 3px;
    font-size: 0.95em;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.day-badge-label {
    color: #bdc3c7;
    font-weight: bold;
    margin-right: 8px;
}
/* =================================================== */

    /* === [MỚI] THANH HÀNH ĐỘNG CỐ ĐỊNH (STICKY ACTION BAR) === */
    .sticky-action-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(35, 37, 38, 0.85);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 10px;
        display: flex;
        justify-content: center;
        gap: 15px;
        z-index: 100;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        border-top: 1px solid #414345;
    }
    .sticky-action-bar .modern-btn {
    flex: 1;
    max-width: 350px; /* Tăng chiều rộng tối đa */
    margin: 0;
}
    /* Làm cho nút Lưu nổi bật hơn */
    .sticky-action-bar .save-button {
        transform: scale(1.05);
        box-shadow: 0 8px 24px #00e6ff55;
    }

    /* === [MỚI] HỆ THỐNG TAB CHÍNH === */
    .main-tabs {
        display: flex;
        background-color: #232526;
        border-radius: 16px 16px 0 0;
        padding: 5px;
        margin-bottom: 15px;
        border-bottom: 2px solid #414345;
    }
    .main-tab-button {
        flex: 1;
        padding: 10px 5px;
        cursor: pointer;
        background: transparent;
        border: none;
        color: #bdc3c7;
        font-weight: 700;
        font-size: 0.8em;
        transition: all 0.2s ease-out;
        border-radius: 12px;
        text-transform: uppercase;
    }
    .main-tab-button:hover {
        background-color: #414345;
        color: #fff;
    }
    .main-tab-button.active {
        background: #f1c40f;
        color: #232526;
        box-shadow: 0 2px 10px #f1c40f55;
    }
    .main-tab-content {
        display: none; /* Mặc định ẩn tất cả nội dung tab */
    }
    .main-tab-content.active {
        display: block; /* Chỉ hiện nội dung của tab đang active */
    }
    
    /* === KHU VỰC THÔNG BÁO PHẢN HỒI === */
    #notification-area {
        position: fixed;
        top: 15px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1010;
        width: 90%;
        max-width: 360px;
    }
    .notification {
        padding: 10px 15px;
        border-radius: 8px;
        color: #fff;
        font-weight: bold;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        opacity: 0;
        transform: translateY(-20px);
        transition: opacity 0.3s, transform 0.3s;
        margin-bottom: 10px;
        font-size: 0.9em;
    }
    .notification.show {
        opacity: 1;
        transform: translateY(0);
    }
    .notification.success {
        background: linear-gradient(90deg, #27ae60, #2ecc71);
    }
    .notification.error {
        background: linear-gradient(90deg, #c0392b, #e74c3c);
    }
    .notification.info {
        background: linear-gradient(90deg, #2980b9, #3498db);
    }

    /* --- TIÊU ĐỀ & MÀU SẮC NỔI BẬT --- */
    h2 {
        font-size: 1.6em;
        margin-top: 20px;
        margin-bottom: 10px;
        text-align: center;
        color: #f39c12;
        text-shadow: 0 4px 12px rgba(243, 156, 18, 0.18), 0 2px 4px rgba(0,0,0,0.08);
        letter-spacing: 1px;
        font-weight: 800;
    }
    h3 {
        margin-top: 28px;
        margin-bottom: 18px; 
        text-align: center;
        font-size: 1.15em;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        padding: 12px 18px;
        background: linear-gradient(90deg, #232526 60%, #414345 100%);
        border-radius: 12px;
        margin-left: 15px;
        margin-right: 15px;
        border-left: 5px solid;
        border-right: 5px solid;
        position: relative;
        z-index: 2;
        box-shadow: 0 4px 24px 0 #00000044, 0 2px 8px rgba(0,0,0,0.08);
    }
    #header-sang { 
        color: #2ecc71 !important;
        text-shadow: 0 0 12px #2ecc71, 0 2px 8px #000;
        border-color: #2ecc71;
        box-shadow: 0 4px 24px 0 #00000044, 0 2px 8px rgba(0,0,0,0.08),
                    inset 5px 0 10px -5px #2ecc71,
                    inset -5px 0 10px -5px #2ecc71;
    }
    #header-chieu { 
        color: #3498db !important;
        text-shadow: 0 0 12px #3498db, 0 2px 8px #000;
        border-color: #3498db;
        box-shadow: 0 4px 24px 0 #00000044, 0 2px 8px rgba(0,0,0,0.08),
                    inset 5px 0 10px -5px #3498db,
                    inset -5px 0 10px -5px #3498db;
    }
    hr { border: none; height: 1px; background: linear-gradient(90deg, #f1c40f 0%, #e0eafc 100%); margin: 28px 15px; border-radius: 2px; opacity: 0.5; }

    /* --- [MỚI] THANH TRẠNG THÁI & ĐỒNG HỒ --- */
    #school-name-status {
        transition: color 0.5s ease; /* Hiệu ứng chuyển màu mượt mà */
    }
    .status-color-connected { 
        color: #43e97b !important; /* Xanh lá cây */
    }
    .status-color-disconnected { 
        color: #ff5858 !important; /* Đỏ */
    }
    .status-color-connecting { 
        color: #00e6ff !important; /* Xanh dương (màu gốc) */
    }

    .clock-container { 
        text-align: center; 
        margin: 15px auto; 
        background: linear-gradient(120deg, #232526 60%, #414345 100%); 
        border: 2px solid #f1c40f; 
        border-radius: 14px; 
        padding: 8px 10px;
        box-shadow: 0 2px 12px rgba(241, 196, 15, 0.10), 0 2px 5px rgba(0,0,0,0.08);
        width: 90%;
    }
    .clock {
        font-size: 2.5em;
        color: #f1c40f;
        text-shadow: 0 0 10px #f1c40f88;
        letter-spacing: 2px;
        font-family: 'Courier New', Courier, monospace;
    }
    .date-display { font-size: 0.9em; color: #ecf0f1; margin-top: 5px; font-weight: 500; }

    /* --- KHU VỰC NÚT ĐIỀU KHIỂN --- */
    .modern-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 45px;
        padding: 0 15px;
        border: none;
        border-radius: 10px;
        font-size: 0.9em;
        font-weight: 700;
        letter-spacing: 1px;
        transition: all 0.2s ease-out;
        cursor: pointer;
        outline: none;
        position: relative;
        overflow: hidden;
        z-index: 1;
        text-transform: uppercase;
        width: 100%;
        text-decoration: none;
    }
    .modern-btn:hover {
        transform: translateY(-2px);
        filter: brightness(1.1);
    }
    .modern-btn svg {
        width: 1.1em;
        height: 1.1em;
        margin-right: 10px;
    }
    .modern-btn:active {
        transform: scale(0.97);
        filter: brightness(0.97);
        box-shadow: 0 2px 8px 0 #0004;
    }
    .save-button {
        background: linear-gradient(90deg, #232526 60%, #414345 100%);
        color: #00e6ff;
        border-left: 4px solid #00e6ff;
        border-right: 4px solid #00e6ff;
        text-shadow: 0 0 12px #00e6ff, 0 2px 8px #000;
        box-shadow: 0 4px 18px 0 #00000044;
    }
    .save-button:hover {
        box-shadow: 0 8px 24px #00e6ff55;
    }
    .test-button {
        background: linear-gradient(90deg, #232526 60%, #414345 100%);
        color: #f1c40f;
        border-left: 4px solid #f1c40f;
        border-right: 4px solid #f1c40f;
        text-shadow: 0 0 12px #f1c40f, 0 2px 8px #000;
        box-shadow: 0 4px 18px 0 #00000044;
    }
    .test-button:hover {
        box-shadow: 0 8px 24px #f1c40f55;
    }
    
.tab { display: flex; justify-content: space-around; border-bottom: 2px solid #414345; margin: 0 15px 0 15px; position: relative; z-index: 1; }
    .tab button {
        flex-grow: 1; border: none; outline: none; cursor: pointer; padding: 10px 5px 8px 5px;
        transition: all 0.2s ease-out;
        font-size: 0.9em; font-weight: 700; border-radius: 8px 8px 0 0; margin: 0 2px;
        position: relative; top: 2px; border-bottom: 3px solid transparent;
        background: transparent; color: #bdc3c7;
    }
    .tab button:hover {
        background: #414345; color: #fff;
        transform: translateY(-2px);
    }
    .tablinks-sang.active { 
        background: linear-gradient(90deg, #2ecc71 60%, #27ae60 100%);
        color: #fff; 
        border-bottom-color: #2ecc71;
        z-index: 2;
    }
     .tablinks-chieu.active { 
        background: linear-gradient(90deg, #3498db 60%, #2980b9 100%);
        color: #fff; 
        border-bottom-color: #3498db;
        z-index: 2;
    }
    .tabcontent { 
        display: none; 
        padding: 10px; 
        background: #232526;
        border-radius: 0 0 12px 12px;
        margin: 0 15px 8px 15px;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height 0.5s ease-in-out, opacity 0.4s ease-in-out, padding 0.5s ease-in-out;
    }
    .tabcontent.active {
        display: block;
        max-height: 1000px;
        opacity: 1;
        padding: 15px 10px 10px 10px;
    }
    .tabcontent h3 {
        font-size: 1em; 
        margin: 0; 
        margin-bottom: 10px;
        padding: 10px 15px;
        color: #f1c40f; 
        font-weight: 700;
        cursor: pointer;
        position: relative;
        border-bottom: 1px solid #414345;
        background: rgba(44, 62, 80, 0.5);
        border-radius: 8px;
        text-align: center;
    }
    .tabcontent h3::after {
        content: '▼';
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%) scale(0.9);
        font-size: 0.8em;
        transition: transform 0.3s ease-in-out;
    }
    .tabcontent h3.expanded::after {
        transform: translateY(-50%) scale(0.9) rotate(180deg);
    }
    .session-subtitle {
        font-size: 0.8em;
        font-weight: normal;
        text-transform: none;
        color: #bdc3c7;
    }
    .collapsible-settings {
        overflow: hidden;
        max-height: 0;
        opacity: 0;
        transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out, margin-top 0.4s ease-in-out;
        margin-top: 0;
    }
    .collapsible-settings.expanded {
        max-height: 500px;
        opacity: 1;
        margin-top: 10px;
    }
/* === [THÊM MỚI] CSS CHO BẢNG KỊCH BẢN HẸN GIỜ === */
    .scenario-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    .scenario-table th, .scenario-table td {
        border: 1px solid #414345;
        padding: 9px 5px;
        text-align: center; /* Căn giữa nội dung trong ô */
        font-size: 0.9em;
    }
    .scenario-table th {
        background-color: #3498db;
        color: #fff;
        font-weight: bold;
    }
    .scenario-table tbody tr:nth-child(odd) {
        background-color: #2c3e50;
    }
    .scenario-table tbody tr:nth-child(even) {
        background-color: #34495e;
    }
    /* Phân chia độ rộng các cột cho đều */
    .scenario-table th:nth-child(1), .scenario-table td:nth-child(1) { width: 15%; } /* Cột STT */
    .scenario-table th:nth-child(2), .scenario-table td:nth-child(2) { width: 42.5%; } /* Cột Thời gian */
    .scenario-table th:nth-child(3), .scenario-table td:nth-child(3) { width: 42.5%; } /* Cột Số hồi */
    /* === CÀI ĐẶT NÚT GẠT (TOGGLE SWITCH) DẠNG BOX === */
    .toggle-actions-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 0 5px 10px 5px;
    }
    .toggle-action-item {
        display: flex;
        align-items: center;
        background-color: #2c3e50;
        border-radius: 8px;
        padding: 8px 12px;
        border-left: 4px solid #4a4e54;
        transition: all 0.3s ease;
    }
    .toggle-action-icon {
        flex-shrink: 0;
        margin-right: 12px;
        color: #bdc3c7;
    }
    .toggle-action-icon svg {
        width: 24px;
        height: 24px;
        display: block;
    }
    .toggle-action-text {
        flex-grow: 1;
        font-weight: bold;
        font-size: 0.9em;
    }
    .toggle-action-item .switch {
        margin-left: auto;
    }
    .toggle-action-item.disabled {
        opacity: 0.5;
        pointer-events: none;
        background-color: #232526;
    }
    .toggle-action-item.active {
        border-left-color: #2ecc71;
    }
    .toggle-action-item.active.chieu-style {
        border-left-color: #3498db;
    }
    .toggle-action-item.active .toggle-action-icon {
        color: #f1c40f;
    }
    .switch {
        position: relative;
        display: inline-block;
        width: 46px; height: 24px;
        flex-shrink: 0;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
        position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
        background-color: #4a4e54;
        transition: .3s;
        border-radius: 24px;
    }
    .slider:before {
        position: absolute; content: "";
        height: 18px; width: 18px;
        left: 3px; bottom: 3px;
        background-color: #bdc3c7;
        transition: .3s cubic-bezier(.4,0,.2,1);
        border-radius: 50%;
    }
    input:checked + .slider { background: linear-gradient(90deg, #27ae60, #2ecc71); }
    .chieu-toggle input:checked + .slider { background: linear-gradient(90deg, #2980b9, #3498db); }
    input:checked + .slider:before { transform: translateX(22px); background-color: white; }

    /* --- KHU VỰC CÀI ĐẶT (DETAILS) --- */
    details {
        border: 1px solid #414345; border-radius: 10px; margin-bottom: 12px;
        background: #232526; box-shadow: 0 2px 8px rgba(0,0,0, 0.1);
        overflow: hidden; transition: box-shadow 0.2s;
    }
    summary {
        font-weight: bold; padding: 12px 15px; cursor: pointer; outline: none;
        transition: background 0.2s, color 0.2s; list-style: none;
        font-size: 0.9em;
    }
    summary::-webkit-details-marker, summary::marker { display: none; }
    
    .sohoi-container {
        padding: 0 15px;
    }
    summary#header-sohoi {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 50px;
        border-radius: 10px;
        background: linear-gradient(90deg, #232526 60%, #414345 100%);
        color: #f1c40f;
        border-left: 4px solid #f1c40f;
        border-right: 4px solid #f1c40f;
        text-shadow: 0 0 12px #f1c40f, 0 2px 8px #000, 0 0 24px #fff;
        box-shadow: 0 4px 18px 0 #f1c40f33, 0 2px 8px #fff2;
    }
    summary#header-sohoi div:first-child {
        font-size: 1em;
        font-weight: 700;
        letter-spacing: 1.5px;
    }
    .details-content { padding: 12px 15px 16px 15px; border-top: 1px solid #414345; }
    
    .tabcontent details summary {
        text-align: center;
        font-size: 1em;
        border-radius: 8px 8px 0 0;
        background: #2c3e50;
        color: #f1c40f;
    }
    details[open] > .tabcontent details summary { 
        background: #f1c40f;
        color: #232526; 
    }
    
    /* --- BẢNG LỊCH CHI TIẾT --- */
    .details-container {max-height: 250px;overflow-y: auto;}
    .details-container::-webkit-scrollbar {width: 8px;}
    .details-container::-webkit-scrollbar-track {background: #2c3e50;border-radius: 4px;}
    .details-container::-webkit-scrollbar-thumb {background-color: #f1c40f;border-radius: 4px;border: 2px solid #2c3e50;}
    .details-container table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #232526; border-radius: 8px; overflow: hidden; }
    .details-container th, .details-container td { border: 1px solid #414345; padding: 8px 5px; text-align: center; font-size: 0.9em; }
    .details-container th { background: #f1c40f; color: #232526; font-weight: bold; }
    .details-container tbody tr { transition: background-color 0.2s; }
    .details-container tbody tr:hover { background-color: #f1c40f22; }
    .details-container tbody tr:nth-child(odd) { background: #232526; color: #ecf0f1; }
    .details-container tbody tr:nth-child(even) { background: #414345; color: #ecf0f1; }
    .divider-yellow {width: 90%; height: 2px; background: linear-gradient(90deg, #f1c40f 0%, #fff200 100%);border-radius: 2px; margin: 24px auto 18px auto; box-shadow: 0 2px 8px #f1c40f55;}

    /* --- GIAO DIỆN LƯỚI "THÔNG MINH" CHO CÀI ĐẶT --- */
.settings-grid-container {
    /* [SỬA ĐỔI] Giới hạn chiều cao và thêm thanh cuộn tự động */
    max-height: 380px; 
    overflow-y: auto;
    padding-right: 5px; /* Thêm khoảng đệm nhỏ để thanh cuộn không quá sát */
    padding-bottom: 30px; /* THÊM DÒNG NÀY: Tạo khoảng đệm ở cuối vùng cuộn */
    
    /* Giữ nguyên các thuộc tính cũ */
    opacity: 1;
    transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out;
}
/* [THÊM MỚI] Tùy chỉnh giao diện thanh cuộn cho đồng bộ */
.settings-grid-container::-webkit-scrollbar {
    width: 8px;
}
.settings-grid-container::-webkit-scrollbar-track {
    background: #2c3e50;
    border-radius: 4px;
}
.settings-grid-container::-webkit-scrollbar-thumb {
    background-color: #f1c40f;
    border-radius: 4px;
    border: 2px solid #2c3e50;
}
    .settings-grid-container.hidden {
        max-height: 0;
        opacity: 0;
    }
    .settings-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        padding: 8px 0;
    }
    .setting-item {
        background: #232526;
        border: 1px solid #414345;
        border-radius: 8px;
        padding: 8px;
        display: flex;
        align-items: center;
        transition: all 0.2s ease-in-out;
    }
    .setting-item:hover {
        border-color: #f1c40f;
        transform: translateY(-1px);
    }
    .setting-item.full-width {
        grid-column: 1 / -1;
    }
    .setting-item-icon {
        flex-shrink: 0;
        margin-right: 10px;
        color: #f1c40f;
    }
    .setting-item-icon svg {
        width: 22px;
        height: 22px;
    }
    .input-wrapper {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    .input-wrapper label {
        font-size: 0.8em;
        font-weight: 600;
        color: #bdc3c7;
        margin-bottom: 4px;
    }
    .unit-input {
        display: flex;
        align-items: center;
    }
    .unit-input input {
        width: 100%;
        margin-right: 8px;
    }
    .unit-input span {
        font-size: 0.9em;
        color: #bdc3c7;
    }
    .setting-item input[type="time"] {
        width: 100%;
        padding: 8px;
        font-size: 0.9em;
    }
    /* [MỚI] CSS cho Hướng dẫn nhỏ */
    .input-helper-text {
        font-size: 0.75em;
        color: #7f8c8d;
        font-style: italic;
        margin-top: 4px;
        text-align: right;
    }
    .copy-button-container {
        padding: 5px 5px 15px 5px;
    }
    .copy-button {
        padding: 8px 12px;
        font-size: 0.8em;
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.18s;
        font-weight: 700;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        text-shadow: 0 1px 2px #00000044;
        width: 100%;
    }
    .copy-button:active {
        transform: scale(0.96);
        filter: brightness(0.95);
    }
    .copy-button.sang {
        background: linear-gradient(90deg, #16a085 0%, #43e97b 100%);
    }
    .copy-button.chieu {
        background: linear-gradient(90deg, #2980b9 0%, #6dd5fa 100%);
    }

    /* === Giao diện cho Modal Chung === */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
    }
    .modal-overlay.visible {
        opacity: 1;
        visibility: visible;
    }
    .modal-content {
        background: #2c3e50;
        padding: 20px;
        border-radius: 15px;
        border-top: 5px solid #f1c40f;
        width: 95%;
        max-width: 400px;
        box-shadow: 0 5px 25px rgba(0,0,0,0.4);
        transform: scale(0.9);
        transition: transform 0.3s;
    }
    .modal-overlay.visible .modal-content {
        transform: scale(1);
    }
    .modal-content h4 {
        margin-top: 0;
        margin-bottom: 20px;
        color: #f1c40f;
        text-align: center;
        font-size: 1.2em;
        text-transform: uppercase;
    }
    .modal-buttons {
        display: flex;
        gap: 15px;
        margin-top: 20px;
    }
    .modal-buttons button {
        flex-grow: 1;
        padding: 10px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.2s;
    }
    .modal-confirm-btn {
        background: #f1c40f;
        color: #232526;
    }
    /* [MỚI] CSS cho các nút ưu tiên trong modal cảnh báo */
    .modal-confirm-btn.priority-scenario {
        background: #27ae60;
        color: #fff;
    }
    .modal-confirm-btn.priority-schedule {
        background: #2980b9;
        color: #fff;
    }
    .modal-cancel-btn {
        background: #7f8c8d;
        color: #fff;
    }
    
    .modal-input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 2px solid #7f8c8d;
        background-color: #2c3e50;
        color: #ecf0f1;
        font-size: 1em;
        margin-bottom: 15px;
    }
    .modal-input:focus {
        outline: none;
        border-color: #f1c40f;
    }
    /* [MỚI] CSS cho phần mô tả trong modal */
    #conflict-modal-description {
        text-align: center; 
        margin-top: -10px; 
        margin-bottom: 20px; 
        color: #bdc3c7; 
        font-size: 0.9em; 
        line-height: 1.5;
    }
    #conflict-modal-description strong {
        color: #e74c3c;
    }

    /* === CSS CHO CẤU TRÚC TAB GỘP === */
    .tablinks-day {
        background: #414345;
        color: #bdc3c7;
        flex-grow: 1;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 10px 5px 8px 5px;
        transition: all 0.2s ease-out;
        font-size: 0.9em;
        font-weight: 700;
        border-radius: 8px;
        margin: 0 2px;
        border-bottom: 3px solid transparent;
    }
    .tablinks-day:hover {
        background: #2c3e50;
        color: #fff;
    }
    .tablinks-day.active {
        background: #f1c40f;
        color: #232526;
        border-bottom-color: #f39c12;
    }
    .tab-session {
        display: flex;
        padding: 0 15px;
        gap: 10px;
        margin-top: 15px;
        margin-bottom: 15px;
    }
    .tablinks-session {
        flex-grow: 1;
        padding: 12px 10px;
        border: 2px solid #414345;
        background: #232526;
        color: #bdc3c7;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
        font-size: 1em;
        text-transform: uppercase;
        transition: all 0.3s;
    }
    .tablinks-session.active[onclick*="'sang'"] {
        background: linear-gradient(90deg, #2ecc71 60%, #27ae60 100%);
        color: #fff;
        border-color: #2ecc71;
        box-shadow: 0 0 15px #2ecc7188;
    }
    .tablinks-session.active[onclick*="'chieu'"] {
        background: linear-gradient(90deg, #3498db 60%, #2980b9 100%);
        color: #fff;
        border-color: #3498db;
        box-shadow: 0 0 15px #3498db88;
    }

    /* === [MỚI] GIAO DIỆN LỊCH NGHỈ LỄ === */
    .holiday-calendar-container {
        padding: 0 15px;
        margin-top: 25px;
    }
    .holiday-calendar-container details summary {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 50px;
        border-radius: 10px;
        background: linear-gradient(90deg, #485563 0%, #29323c 100%);
        color: #e74c3c;
        border-left: 4px solid #e74c3c;
        border-right: 4px solid #e74c3c;
        text-shadow: 0 0 12px #e74c3c, 0 2px 8px #000;
        box-shadow: 0 4px 18px 0 #00000044;
    }
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background-color: #34495e;
        border-radius: 8px 8px 0 0;
    }
    .calendar-header button {
        background: none;
        border: none;
        color: #f1c40f;
        font-size: 1.5em;
        cursor: pointer;
    }
    #month-year-display {
        color: #f1c40f;
        font-weight: bold;
        font-size: 1.1em;
    }
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        padding: 10px;
        background-color: #2c3e50;
        border-radius: 0 0 8px 8px;
    }
    .calendar-day, .calendar-day-header {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 35px;
        border-radius: 6px;
        font-weight: bold;
    }
    .calendar-day-header {
        color: #bdc3c7;
        font-size: 0.8em;
    }
    .calendar-day {
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
    }
    .calendar-day:not(.empty):hover {
        background-color: #34495e;
        transform: scale(1.05);
    }
    .calendar-day.holiday {
        background-color: #c0392b;
        color: #fff;
        box-shadow: 0 0 10px #e74c3c88;
    }
    .calendar-day.today {
        border: 2px solid #f1c40f;
    }
    .calendar-day.empty {
        cursor: default;
        opacity: 0.3;
    }

    /* === [THÊM MỚI] CSS CHO TÍNH NĂNG HẸN GIỜ THEO KỊCH BẢN === */
    .scenario-timer-container {
        padding: 0 15px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .scenario-input-group {
        background: #232526;
        border: 1px solid #414345;
        border-radius: 8px;
        padding: 12px;
    }
    .scenario-input-group label {
        display: flex;
        align-items: center;
        font-size: 1em;
        font-weight: 600;
        color: #bdc3c7;
        margin-bottom: 8px;
    }
    .scenario-input-group label svg {
        width: 20px;
        height: 20px;
        margin-right: 8px;
        color: #f1c40f;
    }
    .scenario-input-group input {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #7f8c8d;
        background-color: #2c3e50;
        color: #ecf0f1;
        font-size: 1.1em;
    }
    .scenario-helper-text {
        font-size: 0.8em;
        color: #7f8c8d;
        font-style: italic;
        margin-top: 5px;
    }
    .scenario-actions {
    display: flex;
    flex-direction: column; /* <-- DÒNG MỚI THÊM VÀO */
    gap: 10px;
    margin-top: 10px;
}
    #scenario-preview-table-container {
        max-height: 250px;
        overflow-y: auto;
    }
    #scenario-preview-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 0.9em;
    }
    #scenario-preview-table th, #scenario-preview-table td {
        border: 1px solid #414345;
        padding: 8px;
        text-align: center;
    }
    #scenario-preview-table th {
        background: #f1c40f;
        color: #232526;
    }
    /* === [CHỈNH SỬA THEO YÊU CẦU] === */
    /* Biến #scenario-day-selector thành thanh tab */
    #scenario-day-selector {
        display: flex;
        justify-content: space-around;
        border-bottom: 2px solid #414345;
        position: relative;
        z-index: 1;
        background: transparent; /* Bỏ background cũ */
        padding: 0; /* Bỏ padding cũ */
        border-radius: 0; /* Bỏ border-radius cũ */
    }
    #scenario-day-selector label {
        flex-grow: 1;
        margin: 0 2px;
        padding: 0; /* Bỏ padding cũ */
        border-radius: 0; /* Bỏ border-radius cũ */
    }
    #scenario-day-selector span {
        display: block; /* Làm cho span chiếm toàn bộ không gian của label */
        border: none;
        outline: none;
        cursor: pointer;
        padding: 10px 5px 8px 5px;
        transition: all 0.2s ease-out;
        font-size: 0.9em;
        font-weight: 700;
        border-radius: 8px 8px 0 0;
        position: relative;
        top: 2px;
        border-bottom: 3px solid transparent;
        background: transparent;
        color: #bdc3c7;
        text-align: center;
    }
    #scenario-day-selector label:hover span {
        background: #414345;
        color: #fff;
        transform: translateY(-2px);
    }
    #scenario-day-selector input:checked + span {
        background: #f1c40f; /* Màu vàng như yêu cầu */
        color: #232526;
        border-bottom-color: #f39c12;
        /* Xóa các thuộc tính cũ không cần thiết */
        box-shadow: none;
        transform: none;
    }
    
  </style>
</head>
<body>
    <div id="notification-area"></div>

  <div id="main">
    <div id="content">
      <div style="text-align: center; padding: 15px 0 5px 0;">
        <h2 id="index-main-title" style="margin: 0; padding: 0;">CHUÔNG BÁO TỰ ĐỘNG</h2>
        <p id="school-name-status" style="margin: 5px 0 0 0; padding: 0; font-size: 1.1em; font-weight: bold; text-shadow: 0 2px 8px #000; letter-spacing: 1.2px;">THPT YÊN KHÁNH A</p>
      </div>
      <div class="clock-container" id="clock-wrapper" style="display: none;">
        <div id="clock" class="clock">--:--:--</div>
        <div id="date" class="date-display">Đang chờ đồng bộ...</div>
      </div>
      
      <div class="main-tabs">
        <button class="main-tab-button active" onclick="openMainTab(event, 'tab-lich-hoc')">🗓️ Lịch Học</button>
        <button class="main-tab-button" onclick="openMainTab(event, 'tab-hen-gio')">⏱️ Hẹn Giờ</button>
        <button class="main-tab-button" onclick="openMainTab(event, 'tab-cai-dat')">⚙️ Cài Đặt</button>
      </div>

      <div class="main-tab-content-container">
        <div id="tab-lich-hoc" class="main-tab-content active">
          <h3 id="index-schedule-title" style="text-align: center; font-size: 1.15em; font-weight: 900; text-transform: uppercase; letter-spacing: 1.5px; color: #ecf0f1; background: none; border: none; box-shadow: none; margin-bottom: 10px; margin-top: 5px;">
            CÀI ĐẶT LỊCH HỌC
          </h3>
          
          <div class="tab" id="tab_day">
            <button class="tablinks-day" onclick="selectDay(event, 't2')">T2</button>
            <button class="tablinks-day" onclick="selectDay(event, 't3')">T3</button>
            <button class="tablinks-day" onclick="selectDay(event, 't4')">T4</button>
            <button class="tablinks-day" onclick="selectDay(event, 't5')">T5</button>
            <button class="tablinks-day" onclick="selectDay(event, 't6')">T6</button>
            <button class="tablinks-day" onclick="selectDay(event, 't7')">T7</button>
            <button class="tablinks-day" onclick="selectDay(event, 'cn')">CN</button>
          </div>

          <div class="tab-session" id="tab_session">
            <button class="tablinks-session" onclick="selectSession(event, 'sang')">Sáng</button>
            <button class="tablinks-session" onclick="selectSession(event, 'chieu')">Chiều</button>
          </div>
          
          <div id="tab-content-wrapper"></div>
        </div>

        <div id="tab-hen-gio" class="main-tab-content">
            <h3 style="text-align: center; font-size: 1.15em; font-weight: 900; text-transform: uppercase; letter-spacing: 1.5px; color: #ecf0f1; background: none; border: none; box-shadow: none; margin-bottom: 15px; margin-top: 5px;">
                HẸN GIỜ THEO KỊCH BẢN
            </h3>

           <div class="scenario-timer-container">
    
    <details class="scenario-setup-details">
        <summary>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v5.414l3.293 3.293 1.414-1.414L13 11.586z"></path></svg>
            THIẾT LẬP KỊCH BẢN MỚI
        </summary>
        
        <div class="details-content" style="padding-top: 20px; display: flex; flex-direction: column; gap: 15px;">
            <div class="scenario-input-group">
                <label for="scenario-start-time">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v5.414l3.293 3.293 1.414-1.414L13 11.586z"></path></svg>
                    Thời gian bắt đầu
                </label>
                <input type="time" id="scenario-start-time">
            </div>

            <div class="scenario-input-group">
                <label for="scenario-intervals">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 9a3 3 0 0 0-3 3h6a3 3 0 0 0-3-3z"></path><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path></svg>
                    Lặp lại sau (phút)
                </label>
                <input type="text" id="scenario-intervals" placeholder="Ví dụ: 45,7,4,10">
                <p class="scenario-helper-text">Nhập các khoảng thời gian chờ, cách nhau bằng dấu phẩy (,)</p>
            </div>

            <div class="scenario-input-group">
                <label for="scenario-bells">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13.586V10c0-3.217-2.185-5.927-5-6.758V2h-4v1.242C7.185 4.073 5 6.783 5 10v3.586l-1.707 1.707A.996.996 0 0 0 3 16v2a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1v-2a.996.996 0 0 0-.293-.707L19 13.586zM19 17H5v-.586l1.707-1.707A.996.996 0 0 0 7 14v-4c0-2.757 2.243-5 5-5s5 2.243 5 5v4c0 .266.105.52.293.707L19 16.414V17zM12 22a2.98 2.98 0 0 0 2.818-2H9.182A2.98 2.98 0 0 0 12 22z"></path></svg>
                    Số hồi chuông tương ứng
                </label>
                <input type="text" id="scenario-bells" placeholder="Ví dụ: 6,3,2,6,3">
                <p class="scenario-helper-text">Nhập số hồi chuông cho giờ bắt đầu và các lần lặp lại</p>
            </div>

            <div class="scenario-input-group">
                <label>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 4h-2V2h-2v2H9V2H7v2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2zm-1 15H6V7h12v12z"></path></svg>
                    Áp dụng cho các ngày
                </label>
                <div class="day-selector" id="scenario-day-selector">
                    <label><input type="checkbox" name="scenario-day" value="t2"><span>T2</span></label>
                    <label><input type="checkbox" name="scenario-day" value="t3"><span>T3</span></label>
                    <label><input type="checkbox" name="scenario-day" value="t4"><span>T4</span></label>
                    <label><input type="checkbox" name="scenario-day" value="t5"><span>T5</span></label>
                    <label><input type="checkbox" name="scenario-day" value="t6"><span>T6</span></label>
                    <label><input type="checkbox" name="scenario-day" value="t7"><span>T7</span></label>
                    <label><input type="checkbox" name="scenario-day" value="cn"><span>CN</span></label>
                </div>
            </div>
            <div class="scenario-actions">
                <button class="modern-btn test-button" onclick="previewScenario()">Xem Trước Kịch Bản</button>
                <button class="modern-btn save-button" onclick="sendScenario()" style="background: linear-gradient(90deg, #27ae60, #2ecc71); border-color: #2ecc71; color: white;">Gửi Lệnh Lên Thiết Bị</button>
            </div>
        </div>
    </details>
    <div id="scenario-preview-table-container" style="margin-top: 20px;">
    </div>

    <div id="saved-scenario-container" style="padding: 0; margin-top: 20px;">
        <h5 style="text-align: center; color: #3498db; text-transform: uppercase; margin: 10px 0 15px 0;">
            KỊCH BẢN HIỆN TẠI ĐANG LƯU TRÊN THIẾT BỊ
        </h5>
        <div id="saved-scenario-table-wrapper" style="max-height: 250px; overflow-y: auto; display: none;">
        </div>
        <p id="saved-scenario-placeholder" class="list-placeholder" style="padding: 10px; display: block;">
            Đang chờ dữ liệu từ thiết bị...
        </p>
        <div id="saved-scenario-priority" style="text-align: center; font-size: 0.9em; color: #bdc3c7; margin-top: 10px; font-style: italic;">
        </div>
        <div id="saved-scenario-days-display" class="saved-days-container">
        </div>
    </div>
   </div>
  </div>
        <div id="tab-cai-dat" class="main-tab-content">
            <div class="sohoi-container" style="margin-top: 5px;">
              <details> <summary id="header-sohoi">
                      <div id="sohoi-title">CÀI ĐẶT CHUÔNG BÁO & ÂM THANH</div>
                      <span id="sohoi-subtitle" style="font-size: 0.8em; font-weight: normal; color: #ccc; margin-top: 2px;">(CHUNG CHO TẤT CẢ CÁC NGÀY)</span>
                  </summary>
                  <div class="details-content">
                      <div class="settings-grid" style="grid-template-columns: 1fr; gap: 12px;"> 
                          <div class="setting-item">
                              <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13.586V10c0-3.217-2.185-5.927-5-6.758V2h-4v1.242C7.185 4.073 5 6.783 5 10v3.586l-1.707 1.707A.996.996 0 0 0 3 16v2a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1v-2a.996.996 0 0 0-.293-.707L19 13.586zM19 17H5v-.586l1.707-1.707A.996.996 0 0 0 7 14v-4c0-2.757 2.243-5 5-5s5 2.243 5 5v4c0 .266.105.52.293.707L19 16.414V17zM12 22a2.98 2.98 0 0 0 2.818-2H9.182A2.98 2.98 0 0 0 12 22z"></path></svg></div>
                              <div class="input-wrapper">
                                  <label for="sohoi_batdau" id="label-sohoi-batdau">Bắt đầu buổi học</label>
                                  <div class="unit-input"><input id="sohoi_batdau" type="number" value="6"><span>hồi</span></div>
                              </div>
                          </div>
                          <div class="setting-item">
                               <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13 16.438V7.562a1 1 0 0 0-1.555-.832L8 9.562v4.876l3.445 2.832A1 1 0 0 0 13 16.438zM12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path></svg></div>
                              <div class="input-wrapper">
                                  <label for="sohoi_vaotiet" id="label-sohoi-vaotiet">Vào tiết</label>
                                  <div class="unit-input"><input id="sohoi_vaotiet" type="number" value="5"><span>hồi</span></div>
                              </div>
                          </div>
                          <div class="setting-item">
                               <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18 5h-2V2H8v3H6c-1.654 0-3 1.346-3 3v6c0 1.654 1.346 3 3 3h1v1c0 .552.447 1 1 1h6c.553 0 1-.448 1-1v-1h1c1.654 0 3-1.346 3-3V8c0-1.654-1.346-3-3-3zm1 9c0 .552-.447 1-1 1H6c-.553 0-1-.448-1-1V8c0-.552.447-1 1-1h12c.553 0 1 .448 1 1v6z"></path></svg></div>
                              <div class="input-wrapper">
                                  <label for="sohoi_rachoi" id="label-sohoi-rachoi">Ra chơi</label>
                                  <div class="unit-input"><input id="sohoi_rachoi" type="number" value="3"><span>hồi</span></div>
                              </div>
                          </div>
                          <div class="setting-item">
                               <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M14 12V8h-4v4H8l4 4 4-4h-2z"></path></svg></div>
                              <div class="input-wrapper">
                                  <label for="sohoi_duvao" id="label-sohoi-duvao">Dự vào lớp</label>
                                  <div class="unit-input"><input id="sohoi_duvao" type="number" value="2"><span>hồi</span></div>
                              </div>
                          </div>
                          <hr style="margin: 10px 0; background: #414345; height: 1px; opacity: 0.8;">

                          <h5 style="text-align: center; color: #f1c40f; margin: 10px 0;">CÀI ĐẶT CHUNG CHO CHUÔNG REO</h5>
                          <div class="settings-grid" style="grid-template-columns: 1fr 1fr; padding: 0;">
                              <div class="setting-item">
                                  <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v5.414l3.293 3.293 1.414-1.414L13 11.586z"></path></svg></div>
                                  <div class="input-wrapper">
                                      <label for="sohoi_tg_reo" id="label-sohoi-tgreo">Thời gian reo (ms)</label>
                                      <div class="unit-input"><input id="sohoi_tg_reo" type="number" value="1000"><span>ms</span></div>
                                  </div>
                              </div>
                              <div class="setting-item">
                                  <div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M12 12.586-8.707 9.293l-1.414 1.414L12 15.414l7.121-7.121-1.414-1.414z"></path></svg></div>
                                  <div class="input-wrapper">
                                      <label for="sohoi_tg_nghi" id="label-sohoi-tgnghi">Thời gian nghỉ (ms)</label>
                                      <div class="unit-input"><input id="sohoi_tg_nghi" type="number" value="1000"><span>ms</span></div>
                                  </div>
                              </div>
                          </div>
                          <div style="padding: 15px 0 0 0;">
                          <button class="modern-btn test-button" onclick="publishTestBell()">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                              <span id="btn-test-bell">Thử Chuông Báo Chung</span>
                          </button>
                      </div>
                  </div>
              </details>
            </div>
            <div class="holiday-calendar-container">
                <details>
                    <summary>
                        <div>LỊCH NGHỈ LỄ</div>
                    </summary>
                    <div class="details-content">
                        <div class="calendar-header">
                            <button onclick="changeMonth(-1)">&#8249;</button>
                            <div id="month-year-display">Tháng 9 2024</div>
                            <button onclick="changeMonth(1)">&#8250;</button>
                        </div>
                        <div class="calendar-grid" id="calendar-grid">
                            </div>
                    </div>
                </details>
            </div>
        </div>

      </div>
      </div>
  </div>
<div class="sticky-action-bar">
  <button class="modern-btn save-button" onclick="publishUpdate()">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
      <span id="btn-save-schedule">Lưu và gửi cập nhật</span>
  </button>
</div>

  <div class="modal-overlay" id="conflict-modal-overlay">
      <div class="modal-content" style="border-top-color: #e74c3c;">
          <h4 style="color: #e74c3c;">Cảnh báo: Phát hiện xung đột!</h4>
          <div id="conflict-modal-description">Nội dung xung đột sẽ được hiển thị ở đây.</div>
          <p style="text-align: center; font-size: 0.9em; color: #f1c40f; font-weight: bold;">Ông muốn ưu tiên thực hiện lệnh nào?</p>
          <div class="modal-buttons" style="flex-direction: column; gap: 10px;">
              <button class="modal-confirm-btn priority-scenario" onclick="handleConflictChoice('scenario')">Ưu tiên Kịch Bản Hẹn Giờ</button>
              <button class="modal-confirm-btn priority-schedule" onclick="handleConflictChoice('schedule')">Ưu tiên Lịch Học Hôm Nay</button>
              <button class="modal-cancel-btn" onclick="handleConflictChoice('cancel')">Hủy bỏ</button>
          </div>
      </div>
  </div>

  <script>
   // [MỚI] HÀM ĐIỀU KHIỂN CÁC TAB CHÍNH
    function openMainTab(evt, tabName) {
        // Lấy tất cả các phần tử có class="main-tab-content" và ẩn chúng đi
        const tabcontent = document.getElementsByClassName("main-tab-content");
        for (let i = 0; i < tabcontent.length; i++) {
            tabcontent[i].classList.remove("active");
        }

        // Lấy tất cả các phần tử có class="main-tab-button" và xóa class "active"
        const tablinks = document.getElementsByClassName("main-tab-button");
        for (let i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
        }

        // Hiển thị tab hiện tại và thêm một class "active" vào nút đã mở tab
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");

        // [SỬA ĐỔI] Ẩn/hiện thanh hành động tùy theo tab
        const actionBar = document.querySelector('.sticky-action-bar');
        if (tabName === 'tab-lich-hoc' || tabName === 'tab-cai-dat') {
            actionBar.style.display = 'flex';
        } else {
            actionBar.style.display = 'none';
        }
    }
    
    // =======================================================
    // === [BẮT ĐẦU] JS MỚI CHO HẸN GIỜ & CẢNH BÁO XUNG ĐỘT ===
    // =======================================================

    // Biến toàn cục để xử lý Promise của modal
    let resolveConflictPromise = null;
    // [CHỈNH SỬA THEO YÊU CẦU] Biến toàn cục để lưu kịch bản xem trước
    let previewedScenarioData = null;


    /**
     * Mở modal cảnh báo xung đột và trả về một Promise
     * @param {string} message - Nội dung HTML của cảnh báo
     * @returns {Promise<string>} - Promise sẽ resolve với lựa chọn của người dùng ('scenario', 'schedule', 'cancel')
     */
    function openConflictModal(message) {
        const modal = document.getElementById('conflict-modal-overlay');
        const description = document.getElementById('conflict-modal-description');
        
        description.innerHTML = message;
        modal.classList.add('visible');

        return new Promise(resolve => {
            resolveConflictPromise = resolve;
        });
    }

    /**
     * Đóng modal cảnh báo xung đột
     */
    function closeConflictModal() {
        const modal = document.getElementById('conflict-modal-overlay');
        modal.classList.remove('visible');
    }

    /**
     * Xử lý lựa chọn của người dùng từ modal cảnh báo
     * @param {string} choice - Lựa chọn ('scenario', 'schedule', 'cancel')
     */
    function handleConflictChoice(choice) {
        if (resolveConflictPromise) {
            resolveConflictPromise(choice);
            resolveConflictPromise = null;
        }
        closeConflictModal();
    }
    
    /**
     * [NÂNG CẤP] Hàm hỗ trợ tính toán khoảng thời gian hoạt động của một buổi học.
     * Trả về object chứa thời gian bắt đầu và kết thúc (tính bằng phút).
     */
    function getSessionTimeRange(scheduleObject) {
        if (!scheduleObject || !scheduleObject.enabled) return null;

        const hasSpecial = scheduleObject.has_special_event || false;
        const hasDuVao = scheduleObject.has_duvao_bell === undefined ? true : scheduleObject.has_duvao_bell;

        const startTime = timeToMinute(scheduleObject.gio);
        const lessonTime = scheduleObject.tiethoc || 45;
        const lessonCount = scheduleObject.sotiet || 0;
        const prepareTime = hasDuVao ? (scheduleObject.duvaotiet || 3) : 0;

        const breakTimeStr = scheduleObject.rachoi || '5';
        const breakTimes = breakTimeStr.split(',').map(s => parseInt(s.trim()) || 0);

        const specialEventTime = hasSpecial ? (scheduleObject.chaoco || scheduleObject.chunhiem || 0) : 0;
        const specialPrepareTime = hasSpecial ? (scheduleObject.prepare_after_special || 2) : 0;

        if (startTime === 0 || lessonTime === 0 || lessonCount === 0) return null;

        let totalDuration = 0;
        if (hasSpecial && specialEventTime > 0) {
            totalDuration += specialEventTime;
            if (specialPrepareTime > 0) {
                totalDuration += specialPrepareTime;
            }
        }
        
        totalDuration += lessonTime * lessonCount;

        for (let i = 0; i < lessonCount - 1; i++) {
            const currentBreakTime = breakTimes[i] ?? breakTimes[breakTimes.length - 1];
            if (currentBreakTime > 0) {
                totalDuration += currentBreakTime;
                if (prepareTime > 0) {
                    totalDuration += prepareTime;
                }
            }
        }

        const endTime = startTime + totalDuration;
        return { start: startTime, end: endTime };
    }


    /**
     * [NÂNG CẤP] Kiểm tra xung đột giữa kịch bản và lịch học của những ngày đã chọn.
     * Logic mới sẽ kiểm tra xem thời gian kịch bản có nằm TRONG KHOẢNG thời gian bận rộn không.
     */
    async function checkForConflicts(scenario, selectedDays) {
        if (!scenario || scenario.length === 0 || !window.allData || !selectedDays || selectedDays.length === 0) {
            return { conflicting: false };
        }

        for (const dayId of selectedDays) {
            const morningScheduleData = window.allData.lich.sang[dayId];
            const afternoonScheduleData = window.allData.lich.chieu[dayId];

            const morningRange = getSessionTimeRange(morningScheduleData);
            const afternoonRange = getSessionTimeRange(afternoonScheduleData);

            for (const scenarioEvent of scenario) {
                const scenarioTimeInMinutes = timeToMinute(scenarioEvent.time);
                
                let conflictFound = false;
                let conflictSession = '';

                if (morningRange && scenarioTimeInMinutes >= morningRange.start && scenarioTimeInMinutes <= morningRange.end) {
                    conflictFound = true;
                    conflictSession = 'buổi sáng';
                } else if (afternoonRange && scenarioTimeInMinutes >= afternoonRange.start && scenarioTimeInMinutes <= afternoonRange.end) {
                    conflictFound = true;
                    conflictSession = 'buổi chiều';
                }

                if (conflictFound) {
                    const dayNameMap = {t2: 'Thứ Hai', t3: 'Thứ Ba', t4: 'Thứ Tư', t5: 'Thứ Năm', t6: 'Thứ Sáu', t7: 'Thứ Bảy', cn: 'Chủ Nhật'};
                    const dayName = dayNameMap[dayId] || dayId;
                    const message = `Cảnh báo: Thời gian <strong>${scenarioEvent.time}</strong> trong kịch bản của ông trùng với lịch học <strong>${conflictSession}</strong> của ngày <strong>${dayName}</strong>.`;
                    return { conflicting: true, message: message };
                }
            }
        }

        return { conflicting: false };
    }

    function calculateScenario() {
        const startTimeEl = document.getElementById('scenario-start-time');
        const intervalsEl = document.getElementById('scenario-intervals');
        const bellsEl = document.getElementById('scenario-bells');

        if (!startTimeEl.value) {
            showNotification("Vui lòng nhập thời gian bắt đầu!", "error");
            return null;
        }

        const intervalsStr = intervalsEl.value.trim();
        const bellsStr = bellsEl.value.trim();

        if (!bellsStr) {
            showNotification("Vui lòng nhập chuỗi số hồi chuông!", "error");
            return null;
        }
        
        const intervals = intervalsStr === '' ? [] : intervalsStr.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
        const bells = bellsStr.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
        
        let currentTimeInMinutes = timeToMinute(startTimeEl.value);
        let scenario = [];

        if (bells.length === 0) {
            showNotification("Chuỗi số hồi chuông không hợp lệ!", "error");
            return null;
        }

        scenario.push({
            time: minuteToTime(currentTimeInMinutes),
            bell: bells[0]
        });

        const loopCount = Math.min(intervals.length, bells.length - 1);
        for (let i = 0; i < loopCount; i++) {
            currentTimeInMinutes += intervals[i];
            scenario.push({
                time: minuteToTime(currentTimeInMinutes),
                bell: bells[i + 1]
            });
        }

        return scenario;
    }
    
    // [CHỈNH SỬA THEO YÊU CẦU] Hàm mới chỉ để xem trước
    function previewScenario() {
        const scenario = calculateScenario();
        // SỬA LỖI: Hiển thị bảng xem trước
        const previewContainer = document.getElementById('scenario-preview-table-container');

        if (!scenario || scenario.length === 0) {
            previewContainer.innerHTML = ''; // Xóa xem trước cũ nếu có lỗi
            // Hàm calculateScenario đã tự thông báo lỗi
            return;
        }
        const selectedDays = Array.from(document.querySelectorAll('input[name="scenario-day"]:checked')).map(cb => cb.value);

        // Lưu dữ liệu đã tính toán vào biến toàn cục để hàm "sendScenario" sử dụng
        previewedScenarioData = {
            scenario: scenario,
            days: selectedDays
        };

        // Tạo HTML cho bảng xem trước
        let tableHTML = `<h5 style="text-align: center; color: #f1c40f; text-transform: uppercase; margin: 10px 0 15px 0;">BẢNG XEM TRƯỚC</h5>
                         <table class="scenario-table">
                            <thead>
                                <tr><th>STT</th><th>Thời gian</th><th>Số hồi</th></tr>
                            </thead>
                            <tbody>`;
        scenario.forEach((event, index) => {
            tableHTML += `<tr>
                            <td>${index + 1}</td>
                            <td>${event.time}</td>
                            <td>${event.bell} hồi</td>
                        </tr>`;
        });
        tableHTML += `</tbody></table>`;
        
        previewContainer.innerHTML = tableHTML;
        showNotification("Đã tạo kịch bản xem trước. Nhấn 'Gửi Lệnh' để lưu.", "info");
    }

    // [CHỈNH SỬA THEO YÊU CẦU] Hàm mới dùng để gửi lệnh (trước đây là addScenario)
    async function sendScenario() {
    if (!client || !client.connected) {
        return showNotification("Chưa kết nối máy chủ!", 'error');
    }

    if (!previewedScenarioData) {
        showNotification("Vui lòng nhấn 'Xem Trước Kịch Bản' trước khi gửi lệnh.", "error");
        return;
    }

    const { scenario, days } = previewedScenarioData;

    if (days.length === 0) {
        return showNotification("Vui lòng chọn ít nhất một ngày để áp dụng kịch bản!", "error");
    }
    if (!scenario || scenario.length === 0) {
        return;
    }

    let userPriority = 'none'; 
    const conflict = await checkForConflicts(scenario, days);

    if (conflict.conflicting) {
        const userChoice = await openConflictModal(conflict.message);
        if (userChoice === 'cancel') {
            showNotification("Đã hủy gửi lệnh do có xung đột.", "info");
            return;
        }
        userPriority = userChoice;
    }

    const payload = {
        scenario: scenario,
        priority: userPriority,
        days: days
    };

    const SCENARIO_SET_TOPIC = "esp32/bell/scenario/set"; 
    client.publish(SCENARIO_SET_TOPIC, JSON.stringify(payload), { qos: 1 });
    
    // [SỬA LỖI] Cập nhật giao diện và LƯU VÀO BỘ NHỚ TRÌNH DUYỆT NGAY LẬP TỨC
    renderSavedScenario(payload);
    try {
        localStorage.setItem('savedScenario', JSON.stringify(payload));
    } catch (e) {
        console.error("Lỗi khi lưu kịch bản vào localStorage:", e);
    }

    document.getElementById('scenario-preview-table-container').innerHTML = '';
    previewedScenarioData = null;
}
    // =======================================================
    // PHẦN MÃ GỐC (ĐÃ TINH GIẢN CHO ESP8266)
    // =======================================================
    if("true"!==sessionStorage.getItem("isLoggedIn"))window.location.href="login.html";
    
    let client, serverTime = null;
    let selectedDay = 't2', selectedSession = 'sang';
    
    const brokerUrl="wss://8bdef73996bb4030affe9483eecde31b.s1.eu.hivemq.cloud:8884/mqtt";
    const options={username:"ngoctuyka",password:"Tu12345678@",clientId:"WebAppClient_"+parseInt(1e3*Math.random()),reconnectPeriod:2e3,protocolVersion: 4};
    
    // [ĐÃ TINH GIẢN] TOPICS MQTT
    const ONLINE_STATUS_TOPIC = "esp32/bell/status/online";
    const DATA_STATUS_TOPIC = "esp32/bell/data/status";
    const SET_DATA_TOPIC = "esp32/bell/data/set";
    const GET_DATA_TOPIC = "esp32/bell/data/get";
    const CONTROL_TOPIC = "esp32/bell/control";
    const COMMAND_ACK_TOPIC = "esp32/bell/command/ack"; 
    const TIME_DATA_TOPIC = "esp32/bell/data/time"; // <-- Thêm dòng định nghĩa này

    function connectToMqtt(){
        console.log("Đang kết nối đến MQTT broker...");
        const schoolNameStatus = document.getElementById("school-name-status");
        schoolNameStatus.className = 'status-color-connecting';
        
        client=mqtt.connect(brokerUrl,options);
        
        client.on("connect",()=>{
            console.log("Đã kết nối thành công đến MQTT broker!");
            // [ĐÃ TINH GIẢN] Chỉ subscribe các topic cần thiết
            

            const topicsToSubscribe = [
                DATA_STATUS_TOPIC, 
                ONLINE_STATUS_TOPIC,
                COMMAND_ACK_TOPIC,
                TIME_DATA_TOPIC // <-- Thêm topic mới vào danh sách
            ];
            client.subscribe(topicsToSubscribe, {qos:1}, (err)=>{
                if(err) {
                    console.error("Lỗi khi đăng ký topic:", err);
                } else {
                    console.log("Đăng ký nhận các topic thành công!");
                    client.publish(GET_DATA_TOPIC, '1', { qos: 1 });
                }
            });
        });
        
        client.on("message",(topic, payload)=>{
            const payloadString = payload.toString();
            if (topic === COMMAND_ACK_TOPIC) {
    try {
        const ack = JSON.parse(payloadString);
        // Dựa trên hàm publishAck [cite: 59, 60] của ESP, ack.status là 'success', 'error', 'info'
        // và ack.message là nội dung tin nhắn.
        showNotification(ack.message, ack.status);
    } catch (e) {
        console.error("Loi parse ACK JSON:", e);
    }
}
 else if (topic === "esp32/bell/data/time") {
                try {
                    const data = JSON.parse(payloadString);
                    if (data.time) {
                        const parts = data.time.split(" "); // Tách chuỗi thành ["HH:MM:SS", "DD-MM-YYYY"]
                        
                        // Kích hoạt đồng hồ (quan trọng nhất)
                        document.getElementById("clock-wrapper").style.display = "block"; 
                        
                        // Cập nhật nội dung
                        document.getElementById("clock").innerText = parts[0]; // Đặt Giờ
                        document.getElementById("date").innerText = parts[1]; // Đặt Ngày
                        
                        // Hủy bỏ biến serverTime cũ để nó không ghi đè
                        serverTime = null; 
                    }
                } catch (e) {
                    console.error("Loi parse JSON thoi gian:", e);
                }
            }      
                if (topic === ONLINE_STATUS_TOPIC) {
                const schoolNameStatus = document.getElementById("school-name-status");
                if (payloadString === 'online') {
                    schoolNameStatus.className = "status-color-connected";
                    document.getElementById('clock-wrapper').style.display = 'block';
                } else {
                    schoolNameStatus.className = "status-color-disconnected";
                    document.getElementById('clock-wrapper').style.display = 'none';
                    serverTime = null;
                }
            }
            
            if (topic === DATA_STATUS_TOPIC && payloadString) {
                _load(payloadString);
            }

            // [ĐÃ XÓA] Các handler cho topic hệ thống, OTA, nhạc...
        });
        
        client.on("error", e => console.error("Lỗi kết nối MQTT:", e));
        
        client.on("close",()=>{
            console.log("Mất kết nối MQTT. Đang thử kết nối lại...");
            document.getElementById("school-name-status").className = "status-color-disconnected";
            document.getElementById('clock-wrapper').style.display = 'none';
            serverTime = null;
        });
    }

    // [ĐÃ XÓA] Các hàm liên quan đến Phát Nhạc, Cài đặt nâng cao, Giao diện...

    function showNotification(message, type = 'success') {
        const area = document.getElementById('notification-area');
        const notif = document.createElement('div');
        notif.className = `notification ${type}`;
        notif.textContent = message;
        area.appendChild(notif);
        
        setTimeout(() => { notif.classList.add('show'); }, 10);

        setTimeout(() => {
            notif.classList.remove('show');
            setTimeout(() => {
                if(area.contains(notif)) {
                    area.removeChild(notif);
                }
            }, 300);
        }, 4000);
    }

function _load(e) {
    try {
        const t = JSON.parse(e);
        window.allData = null; 

        if (t.data) { // Cấu trúc mới
            if (t.data.epoch) setTime(t.data.epoch);
            if (t.data.schedule) {
                window.allData = t.data.schedule;
                populateForm(t.data.schedule);
            }
            if (t.data.holidays) loadHolidayData(t.data.holidays);
            if (t.data.scenario) {
                console.log("Nhan du lieu scenario tu MQTT, dang cap nhat UI...");
                renderSavedScenario(t.data.scenario);
                
                // Đồng bộ lại localStorage với dữ liệu mới nhất từ thiết bị
                localStorage.setItem('savedScenario', JSON.stringify(t.data.scenario));
            }

        } else { // Cấu trúc cũ (dự phòng)
             if (t.epoch) setTime(t.epoch);
             if (t.schedule) {
                window.allData = t.schedule;
                populateForm(t.schedule);
             }
             if (t.holidays) loadHolidayData(t.holidays);
             // Cấu trúc cũ không có kịch bản nên không cần làm gì thêm.
        }

    } catch (error) {
        console.error("Lỗi parse JSON từ MQTT:", error);
    }
}
    // =======================================================
// === [THÊM MỚI] HÀM XỬ LÝ LỊCH NGHỈ LỄ KHI TẢI TRANG ===
// =======================================================
function loadHolidayData(holidays) {
    if (holidays) {
        console.log("Nhan du lieu lich nghi le tu ESP32:", holidays);
        // Lưu dữ liệu vào biến toàn cục để các hàm khác sử dụng
        holidayData = holidays;

        // Vẽ lại giao diện lịch với dữ liệu mới
        // Hàm này sẽ tự động đọc biến holidayData và tô màu đúng các ngày nghỉ
        generateCalendar(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth());
    }
}
    function publishUpdate() {
    if (!client || !client.connected) return showNotification("Chưa kết nối máy chủ!", 'error');
    try {
        const scheduleData = gatherDataFromForm();
        const payload = {
            schedule: scheduleData,
            holidays: holidayData
        };
        const payloadString = JSON.stringify(payload);
        client.publish(SET_DATA_TOPIC, payloadString, { qos: 1, retain: true });
        } catch (e) {
        showNotification("Lỗi: " + e.message, 'error');
        console.error(e)
    }
}
    
    function publishTestBell(){
        if(client&&client.connected) {
            const payload = { command: "TEST_BELL" };
            client.publish(CONTROL_TOPIC, JSON.stringify(payload), {qos:1});
            showNotification("Đã gửi lệnh thử chuông chung...");
        } else {
            showNotification("Chưa kết nối máy chủ!", 'error');
        }
    }

    function logout(){sessionStorage.removeItem("isLoggedIn"),window.location.href="login.html"}
    function setTime(e){isNaN(e)||e<1e5?(console.log("Invalid epoch received, clock not set:",e),serverTime=null):(serverTime=new Date(1e3*e),document.getElementById("date").innerHTML=serverTime.toLocaleDateString("vi-VN",{weekday:"long",year:"numeric",month:"long",day:"numeric",timeZone:"Asia/Ho_Chi_Minh"}),updateLocalClock())}
    function updateLocalClock(){serverTime&&(serverTime.setSeconds(serverTime.getSeconds()+1),document.getElementById("clock").innerHTML=serverTime.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:"Asia/Ho_Chi_Minh",hour12:!1}))}
    
    function toggleSettings(headerElement) {
        const content = headerElement.nextElementSibling;
        if (content && content.classList.contains('collapsible-settings')) {
            headerElement.classList.toggle('expanded');
            content.classList.toggle('expanded');
        }
    }

    function toggleScheduleActivation(dayId) {
        const isEnabled = document.getElementById(`enable_${dayId}`).checked;
        const enableItem = document.getElementById(`toggle_item_enable_${dayId}`);
        const specialItem = document.getElementById(`toggle_item_special_${dayId}`);
        const duvaoItem = document.getElementById(`toggle_item_duvao_${dayId}`);
        const settingsContainer = document.getElementById(`settings_container_${dayId}`);
        const isChieu = dayId.includes('_chieu');

        if (isEnabled) {
            if (enableItem) {
                enableItem.classList.add('active');
                if (isChieu) enableItem.classList.add('chieu-style');
            }
            if (specialItem) specialItem.classList.remove('disabled');
            if (duvaoItem) duvaoItem.classList.remove('disabled');
            if (settingsContainer) settingsContainer.classList.remove('hidden');
        } else {
            if (enableItem) {
                enableItem.classList.remove('active', 'chieu-style');
            }
            if (specialItem) specialItem.classList.add('disabled');
            if (duvaoItem) duvaoItem.classList.add('disabled');
            if (settingsContainer) settingsContainer.classList.add('hidden');
        }
    }

    function toggleSpecialEvent(dayId) {
        const checkbox = document.getElementById(`has_special_${dayId}`);
        const container = document.getElementById(`special_event_container_${dayId}`);
        if (container) {
            container.style.display = checkbox.checked ? 'grid' : 'none'; // Use grid for consistency
        }
    }

    function toggleDuVao(dayId) {
        const checkbox = document.getElementById(`has_duvao_${dayId}`);
        const inputWrapper = document.getElementById(`duvao_wrapper_${dayId}`);
        if (inputWrapper) {
            inputWrapper.style.display = checkbox.checked ? 'flex' : 'none';
        }
    }

    // =======================================================
    // === [NÂNG CẤP] CÁC HÀM TẠO GIAO DIỆN VÀ TÍNH TOÁN LỊCH HỌC ===
    // =======================================================

    const createDayContent = (e, t, o) => {
        const isMondayMorning = (e === 't2_sang');
        
        // Icons
        const d = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v5.414l3.293 3.293 1.414-1.414L13 11.586z"></path></svg></div>`;
        const r = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 4h-2V2h-2v2H9V2H7v2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2zm-1 15H6V7h12v12z"></path></svg></div>`;
        const l = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 2H6c-1.206 0-3 .799-3 3v14c0 2.201 1.794 3 3 3h15v-2H6.012C5.55 19.988 5 19.806 5 19s.55-.988 1.012-1H21V4c0-1.103-.897-2-2-2zm0 13H6V5h13v10z"></path></svg></div>`;
        const c = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18 5h-2V2H8v3H6c-1.654 0-3 1.346-3 3v6c0 1.654 1.346 3 3 3h1v1c0 .552.447 1 1 1h6c.553 0 1-.448 1-1v-1h1c1.654 0 3-1.346 3-3V8c0-1.654-1.346-3-3-3zm1 9c0 .552-.447 1-1 1H6c-.553 0-1-.448-1-1V8c0-.552.447-1 1-1h12c.553 0 1 .448 1 1v6z"></path></svg></div>`;
        const m = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M14 12V8h-4v4H8l4 4 4-4h-2z"></path></svg></div>`;
        const p = `<div class="setting-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h2v2H4zm0 5h2v2H4zm0 5h2v2H4zm16-8V6H8v2h12zm0 5H8v2h12zm0 5H8v2h12z"></path></svg></div>`;
        
        // [NÂNG CẤP] Tạo HTML cho khu vực sự kiện đặc biệt, bao gồm cả ô nhập thời gian chuẩn bị
        const specialEventInput = isMondayMorning 
            ? `<div class="setting-item full-width">${r}<div class="input-wrapper"><label for="chaoco_${e}">TG Chào cờ</label><div class="unit-input"><input id="chaoco_${e}" type="number" value="40"><span>phút</span></div></div></div>`
            : `<div class="setting-item full-width">${r}<div class="input-wrapper"><label for="chunhiem_${e}">TG Sinh hoạt</label><div class="unit-input"><input id="chunhiem_${e}" type="number" value="15"><span>phút</span></div></div></div>`;
        const prepareAfterSpecialInput = `<div class="setting-item full-width">${m}<div class="input-wrapper"><label for="prepare_after_special_${e}">TG chuẩn bị sau SH/CC</label><div class="unit-input"><input id="prepare_after_special_${e}" type="number" value="2"><span>phút</span></div></div></div>`;
        const u = specialEventInput + prepareAfterSpecialInput;

        let g = ""; // Copy button HTML
        if (!isMondayMorning) {
            if (o === 'sang') {
                g = `<div class="copy-button-container"><button class="copy-button sang" onclick="copyMorningSchedule('${e}')">Sao chép đến T3-CN (Sáng)</button></div>`;
            } else { // 'chieu'
                g = `<div class="copy-button-container"><button class="copy-button chieu" onclick="copyAfternoonSchedule('${e}')">Sao chép đến các ngày Chiều</button></div>`;
            }
        }
        
        return `
        <div id="${e}" class="tabcontent">
            <h3 onclick="toggleSettings(this)">Cài đặt Lịch ${t}<br><span class="session-subtitle">(Buổi ${"sang"===o?"Sáng":"Chiều"})</span></h3>
            
            <div class="collapsible-settings">
                <div class="toggle-actions-group">
                    <div id="toggle_item_enable_${e}" class="toggle-action-item">
                        <div class="toggle-action-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42A6.92 6.92 0 0 1 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-1.93.78-3.68 2-4.95L5.59 5.64A8.96 8.96 0 0 0 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.49-1-4.73-2.67-6.41z"/></svg></div>
                        <div class="toggle-action-text">Kích hoạt Lịch</div>
                        <label class="switch ${"chieu"===o?"chieu-toggle":""}">
                            <input type="checkbox" id="enable_${e}" onchange="toggleScheduleActivation('${e}')" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="toggle_item_special_${e}" class="toggle-action-item">
                        <div class="toggle-action-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></div>
                        <div class="toggle-action-text">${isMondayMorning ? 'Có Giờ Chào cờ' : 'Có Giờ Sinh hoạt'}</div>
                        <label class="switch ${"chieu"===o?"chieu-toggle":""}">
                            <input type="checkbox" id="has_special_${e}" onchange="toggleSpecialEvent('${e}')">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="toggle_item_duvao_${e}" class="toggle-action-item">
                        <div class="toggle-action-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M10 20h4c0 1.1-.9 2-2 2s-2-.9-2-2zm10-2.64V11c0-3.35-2.36-6.15-5.5-6.83V3.5c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5V4.17C8.36 4.85 6 7.65 6 11v6.36L4 19.72V20h16v-.28l-2-2.36zM15 11h2v2h-2v-2zm-4 0h2v2h-2v-2zm-4 0h2v2H7v-2z"/></svg></div>
                        <div class="toggle-action-text">Có Chuông Dự vào lớp</div>
                        <label class="switch ${"chieu"===o?"chieu-toggle":""}">
                            <input type="checkbox" id="has_duvao_${e}" onchange="toggleDuVao('${e}')" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div id="settings_container_${e}" class="settings-grid-container">
                    ${g}
                    <hr style="margin: 15px; background: #414345; height: 1px; opacity: 0.5;">

                    <div class="settings-grid">
                        <div class="setting-item full-width">${d}<div class="input-wrapper"><label for="gio_${e}">Giờ vào học</label><input id="gio_${e}" type="time"></div></div>
                        
                        <div id="special_event_container_${e}" class="settings-grid full-width" style="display: none; grid-template-columns: 1fr; gap: 8px; padding: 0;">${u}</div>
                        
                        <div class="setting-item">${l}<div class="input-wrapper"><label for="tiethoc_${e}">TG Tiết học</label><div class="unit-input"><input id="tiethoc_${e}" type="number" value="45"><span>phút</span></div></div></div>
                        <div class="setting-item">${c}<div class="input-wrapper"><label for="rachoi_${e}">TG Ra chơi</label><div class="unit-input"><input id="rachoi_${e}" type="text" value="5"><span>phút</span></div><div class="input-helper-text">VD: 5,15,5,5</div></div></div>
                        <div class="setting-item" id="duvao_wrapper_${e}">${m}<div class="input-wrapper"><label for="duvaotiet_${e}">TG Dự vào</label><div class="unit-input"><input id="duvaotiet_${e}" type="number" value="3"><span>phút</span></div></div></div>
                        <div class="setting-item">${p}<div class="input-wrapper"><label for="sotiet_${e}">Số tiết học</label><div class="unit-input"><input id="sotiet_${e}" type="number" value="5"><span>tiết</span></div></div></div>
                    </div>
                    
                    <button class="modern-btn preview-button" onclick="updatePreviewTable('${e}')" style="height: 40px; font-size: 0.85em; background: #34495e; color: #f1c40f; border: 1px solid #f1c40f; margin-top: 15px;">Cập nhật bảng chi tiết</button>

                </div>
            </div>

            <details style="margin-top: 15px;">
                <summary>Xem chi tiết lịch</summary>
                <div class="details-container" id="details-${e}"></div>
            </details>
        </div>`
    }
    
    const contentWrapper = document.getElementById("tab-content-wrapper");
    const days=[{id:"t2",name:"Thứ 2"},{id:"t3",name:"Thứ 3"},{id:"t4",name:"Thứ 4"},{id:"t5",name:"Thứ 5"},{id:"t6",name:"Thứ 6"},{id:"t7",name:"Thứ 7"},{id:"cn",name:"Chủ Nhật"}];
    
    function populateForm(e){
        const t = e;
        if(t&&t.sohoi&&t.lich){
            document.querySelectorAll('#tab-content-wrapper .tabcontent').forEach(el => el.remove());
            console.log("Bat dau cap nhat form voi du lieu:",t);

            // [ĐÃ ĐƠN GIẢN HÓA CHO ESP8266]
            const bellTypes = ["batdau","vaotiet","rachoi","duvao"];
            bellTypes.forEach(type => {
                const numInput = document.getElementById(`sohoi_${type}`);
                // Hỗ trợ cả cấu trúc cũ (chỉ có số) và cấu trúc mới (object .num)
                if(numInput) numInput.value = t.sohoi[type]?.num || (t.sohoi[type] || "");
            });
            // [KẾT THÚC ĐƠN GIẢN HÓA]
            
            ["tg_reo", "tg_nghi"].forEach(e=>{
                const o=document.getElementById(`sohoi_${e}`);
                o&&(o.value=t.sohoi[e]||"")
            });
            
            days.forEach(day => {
                contentWrapper.innerHTML += createDayContent(`${day.id}_sang`, day.name, "sang");
                contentWrapper.innerHTML += createDayContent(`${day.id}_chieu`, day.name, "chieu");
            });

            ["sang","chieu"].forEach(e=>{
                days.forEach(o=>{
                    const n=t.lich?.[e]?.[o.id];
                    if(n){
                        const dayId = `${o.id}_${e}`;
                        document.getElementById(`enable_${dayId}`).checked=n.enabled;
                        document.getElementById(`gio_${dayId}`).value=n.gio||"";
                        document.getElementById(`tiethoc_${dayId}`).value=n.tiethoc||"";
                        document.getElementById(`rachoi_${dayId}`).value=n.rachoi||"5"; // [NÂNG CẤP]
                        document.getElementById(`duvaotiet_${dayId}`).value=n.duvaotiet||"";
                        document.getElementById(`sotiet_${dayId}`).value=n.sotiet||"";
                        
                        const chaocoInput = document.getElementById(`chaoco_${dayId}`);
                        if(chaocoInput) chaocoInput.value=n.chaoco||0;
                        
                        const chunhiemInput = document.getElementById(`chunhiem_${dayId}`);
                        if(chunhiemInput) chunhiemInput.value=n.chunhiem||0;
                        
                        // [NÂNG CẤP & SỬA LỖI] Tải dữ liệu cho trường mới và xử lý đúng giá trị 0
                        const prepareSpecialInput = document.getElementById(`prepare_after_special_${dayId}`);
                        if(prepareSpecialInput) prepareSpecialInput.value = n.prepare_after_special ?? 0;
                        
                        const hasSpecialCheckbox = document.getElementById(`has_special_${dayId}`);
                        if (hasSpecialCheckbox) {
                            hasSpecialCheckbox.checked = n.has_special_event || false;
                            toggleSpecialEvent(dayId);
                        }
                        
                        const hasDuVaoCheckbox = document.getElementById(`has_duvao_${dayId}`);
                        if (hasDuVaoCheckbox) {
                            hasDuVaoCheckbox.checked = n.has_duvao_bell === undefined ? true : n.has_duvao_bell;
                            toggleDuVao(dayId);
                        }
                        
                        toggleScheduleActivation(dayId);
                        updatePreviewTable(dayId);
                    }
                })
            });
             showActiveTab();
        } else {
            console.error("Dữ liệu lịch học nhận được không hợp lệ hoặc không đầy đủ:",e)
        }
    }

    function gatherDataFromForm(){
        const e={sohoi:{},lich:{sang:{},chieu:{}}};
        
        // [ĐÃ ĐƠN GIẢN HÓA CHO ESP8266]
        const bellTypes = ["batdau","vaotiet","rachoi","duvao"];
        bellTypes.forEach(type => {
            // Gửi đi object với action 'bell' mặc định để tương thích
            // với firmware có thể vẫn mong đợi object, nhưng không có tùy chọn nhạc
            e.sohoi[type] = {
                num: parseInt(document.getElementById(`sohoi_${type}`).value) || 0,
                action: "bell",
                track: "",
                volume: 0,
                random: false
            };
        });
        // [KẾT THÚC ĐƠN GIẢN HÓA]
        
        ["tg_reo", "tg_nghi"].forEach(t=>{
            e.sohoi[t]=parseInt(document.getElementById(`sohoi_${t}`).value)||0
        });

        ["sang","chieu"].forEach(t=>{
            days.forEach(o=>{
                const dayId = `${o.id}_${t}`;
                const n=e.lich[t][o.id]={};
                n.enabled=document.getElementById(`enable_${dayId}`).checked;
                n.gio=document.getElementById(`gio_${dayId}`).value;
                n.tiethoc=parseInt(document.getElementById(`tiethoc_${dayId}`).value)||0;
                n.rachoi=document.getElementById(`rachoi_${dayId}`).value || "5"; // [NÂNG CẤP]
                n.duvaotiet=parseInt(document.getElementById(`duvaotiet_${dayId}`).value)||0;
                n.sotiet=parseInt(document.getElementById(`sotiet_${dayId}`).value)||0;
                
                const chaocoInput = document.getElementById(`chaoco_${dayId}`);
                if(chaocoInput) n.chaoco=parseInt(chaocoInput.value)||0;
                
                const chunhiemInput = document.getElementById(`chunhiem_${dayId}`);
                if(chunhiemInput) n.chunhiem=parseInt(chunhiemInput.value)||0;
                
                // [NÂNG CẤP & SỬA LỖI] Thu thập dữ liệu từ trường mới và xử lý đúng giá trị 0
                const prepareSpecialInput = document.getElementById(`prepare_after_special_${dayId}`);
                if(prepareSpecialInput) {
                    const val = parseInt(prepareSpecialInput.value);
                    n.prepare_after_special = isNaN(val) ? 0 : val;
                }

                const hasSpecialCheckbox = document.getElementById(`has_special_${dayId}`);
                if (hasSpecialCheckbox) n.has_special_event = hasSpecialCheckbox.checked;

                const hasDuVaoCheckbox = document.getElementById(`has_duvao_${dayId}`);
                if (hasDuVaoCheckbox) n.has_duvao_bell = hasDuVaoCheckbox.checked;
            })
        });
        return e;
    }

    function selectDay(evt, day) {
        selectedDay = day;
        document.querySelectorAll('.tablinks-day').forEach(btn => btn.classList.remove('active'));
        evt.currentTarget.classList.add('active');
        showActiveTab();
    }

    function selectSession(evt, session) {
        selectedSession = session;
        document.querySelectorAll('.tablinks-session').forEach(btn => btn.classList.remove('active'));
        evt.currentTarget.classList.add('active');
        showActiveTab();
    }

    function showActiveTab() {
        document.querySelectorAll('.tabcontent').forEach(content => {
            content.classList.remove('active');
        });
        const activeTabId = `${selectedDay}_${selectedSession}`;
        const activeContent = document.getElementById(activeTabId);
        if (activeContent) {
            activeContent.classList.add('active');
        }
    }

    function timeToMinute(e){if(!e)return 0;const[t,o]=e.split(":").map(Number);return 60*t+o}function minuteToTime(e){const t=Math.floor(e/60).toString().padStart(2,"0"),o=(e%60).toString().padStart(2,"0");return`${t}:${o}`}
    
    // [SỬA LỖI] Hàm getVal được viết lại để xử lý đúng giá trị 0
    const getVal = (id, defaultValue = 0) => {
        const el = document.getElementById(id);
        if (!el) return defaultValue;
        const parsedValue = parseInt(el.value);
        return isNaN(parsedValue) ? defaultValue : parsedValue;
    };

    // [NÂNG CẤP TOÀN BỘ] Hàm tính toán lịch học được viết lại để linh hoạt hơn
    function calculateSchedule(dayId) {
        const isEnabled = document.getElementById(`enable_${dayId}`)?.checked;
        if (!isEnabled) return []; // [MỚI] Trả về mảng rỗng nếu lịch bị tắt

        const hasSpecial = document.getElementById(`has_special_${dayId}`)?.checked;
        const hasDuVao = document.getElementById(`has_duvao_${dayId}`)?.checked;
        
        const startTime = timeToMinute(document.getElementById(`gio_${dayId}`).value);
        const lessonTime = getVal(`tiethoc_${dayId}`, 45);
        const lessonCount = getVal(`sotiet_${dayId}`, 5);
        const prepareTime = hasDuVao ? getVal(`duvaotiet_${dayId}`, 3) : 0;
        
        const breakTimeStr = document.getElementById(`rachoi_${dayId}`).value || '5';
        const breakTimes = breakTimeStr.split(',').map(s => parseInt(s.trim()) || 0);

        const isMondayMorning = dayId.includes('t2_sang');
        const specialEventTime = hasSpecial ? getVal(isMondayMorning ? `chaoco_${dayId}` : `chunhiem_${dayId}`) : 0;
        
        // [SỬA LỖI] Mặc định thời gian chuẩn bị là 0 nếu để trống, theo yêu cầu
        const specialPrepareTime = hasSpecial ? getVal(`prepare_after_special_${dayId}`, 0) : 0;
        
        if (startTime === 0 || lessonTime === 0 || lessonCount === 0) return [];

        let schedule = [];
        let currentTime = startTime;

        // 1. Xử lý sự kiện đặc biệt (Chào cờ/Sinh hoạt) nếu có
        if (hasSpecial && specialEventTime > 0) {
            schedule.push({ time: currentTime, description: isMondayMorning ? "Chào cờ" : "Sinh hoạt" });
            currentTime += specialEventTime;
            
            if (specialPrepareTime > 0) {
                schedule.push({ time: currentTime, description: "Nghỉ sau SH/CC" });
                currentTime += specialPrepareTime;
            }
        }

        // 2. Vòng lặp qua các tiết học và giờ ra chơi
        for (let i = 1; i <= lessonCount; i++) {
            schedule.push({ time: currentTime, description: `Vào tiết ${i}` });
            currentTime += lessonTime;

            if (i < lessonCount) {
                const currentBreakTime = breakTimes[i - 1] ?? breakTimes[breakTimes.length - 1]; 
                
                if (currentBreakTime > 0) {
                    schedule.push({ time: currentTime, description: `Ra chơi tiết ${i}` });
                    currentTime += currentBreakTime;

                    if (prepareTime > 0) {
                        schedule.push({ time: currentTime, description: `Dự vào tiết ${i + 1}` });
                        currentTime += prepareTime;
                    }
                }
            }
        }

        // 3. Thêm sự kiện "Ra về"
        schedule.push({ time: currentTime, description: "Ra về" });
        
        const uniqueSchedule = Array.from(new Map(schedule.map(item => [item.time, item])).values());
        return uniqueSchedule
            .map(item => ({ ...item, timeInMinutes: item.time, time: minuteToTime(item.time) }))
            .sort((a, b) => a.timeInMinutes - b.timeInMinutes);
    }

    function updatePreviewTable(e){const t=document.getElementById(`enable_${e}`).checked,o=document.getElementById("details-"+e);if(!o)return;if(!t)return void(o.innerHTML="<p style='text-align:center; padding: 10px;'>Lịch này đang tắt.</p>");const n=calculateSchedule(e);let a="<table><thead><tr><th>STT</th><th>Thời gian</th><th>Nội dung</th></tr></thead><tbody>";n.forEach((e,t)=>{a+=`<tr><td>${t+1}</td><td>${e.time}</td><td>${e.description}</td></tr>`}),a+="</tbody></table>",o.innerHTML=a}
    
    // [NÂNG CẤP] Các hàm sao chép để bao gồm cả trường dữ liệu mới
    function copyAfternoonSchedule(sourceDayId) {
        const sourceDayName = sourceDayId.split('_')[0].toUpperCase();
        if (!confirm(`Bạn có chắc muốn sao chép lịch của ${sourceDayName} (chiều) đến TẤT CẢ các ngày còn lại của buổi chiều không?`)) return;

        const sourceData = {
            enabled: document.getElementById(`enable_${sourceDayId}`).checked,
            gio: document.getElementById(`gio_${sourceDayId}`).value,
            has_special_event: document.getElementById(`has_special_${sourceDayId}`).checked,
            chunhiem: document.getElementById(`chunhiem_${sourceDayId}`).value,
            prepare_after_special: document.getElementById(`prepare_after_special_${sourceDayId}`).value,
            has_duvao_bell: document.getElementById(`has_duvao_${sourceDayId}`).checked,
            tiethoc: document.getElementById(`tiethoc_${sourceDayId}`).value,
            rachoi: document.getElementById(`rachoi_${sourceDayId}`).value,
            duvaotiet: document.getElementById(`duvaotiet_${sourceDayId}`).value,
            sotiet: document.getElementById(`sotiet_${sourceDayId}`).value
        };

        const sourceId = sourceDayId.replace('_chieu', '');
        days.filter(d => d.id !== sourceId).forEach(day => {
            const targetDayId = `${day.id}_chieu`;
            document.getElementById(`enable_${targetDayId}`).checked = sourceData.enabled;
            document.getElementById(`gio_${targetDayId}`).value = sourceData.gio;
            document.getElementById(`has_special_${targetDayId}`).checked = sourceData.has_special_event;
            document.getElementById(`chunhiem_${targetDayId}`).value = sourceData.chunhiem;
            document.getElementById(`prepare_after_special_${targetDayId}`).value = sourceData.prepare_after_special;
            document.getElementById(`has_duvao_${targetDayId}`).checked = sourceData.has_duvao_bell;
            document.getElementById(`tiethoc_${targetDayId}`).value = sourceData.tiethoc;
            document.getElementById(`rachoi_${targetDayId}`).value = sourceData.rachoi;
            document.getElementById(`duvaotiet_${targetDayId}`).value = sourceData.duvaotiet;
            document.getElementById(`sotiet_${targetDayId}`).value = sourceData.sotiet;
            
            toggleSpecialEvent(targetDayId);
            toggleDuVao(targetDayId);
            toggleScheduleActivation(targetDayId);
            updatePreviewTable(targetDayId);
        });
        showNotification('Sao chép thành công! Hãy nhấn "Lưu và gửi cập nhật" để áp dụng.', "success");
    }

    function copyMorningSchedule(sourceDayId) {
        const sourceDayName = sourceDayId.split('_')[0].toUpperCase();
        if (!confirm(`Bạn có chắc muốn sao chép lịch của ${sourceDayName} (sáng) đến các ngày còn lại (T3-CN) không?`)) return;

        const sourceData = {
            enabled: document.getElementById(`enable_${sourceDayId}`).checked,
            gio: document.getElementById(`gio_${sourceDayId}`).value,
            has_special_event: document.getElementById(`has_special_${sourceDayId}`).checked,
            chunhiem: document.getElementById(`chunhiem_${sourceDayId}`).value,
            prepare_after_special: document.getElementById(`prepare_after_special_${sourceDayId}`).value,
            has_duvao_bell: document.getElementById(`has_duvao_${sourceDayId}`).checked,
            tiethoc: document.getElementById(`tiethoc_${sourceDayId}`).value,
            rachoi: document.getElementById(`rachoi_${sourceDayId}`).value,
            duvaotiet: document.getElementById(`duvaotiet_${sourceDayId}`).value,
            sotiet: document.getElementById(`sotiet_${sourceDayId}`).value
        };
        
        const sourceId = sourceDayId.replace('_sang', '');
        const targetDays = ["t3", "t4", "t5", "t6", "t7", "cn"].filter(id => id !== sourceId);
        
        targetDays.forEach(dayId => {
            const targetDayId = `${dayId}_sang`;
            document.getElementById(`enable_${targetDayId}`).checked = sourceData.enabled;
            document.getElementById(`gio_${targetDayId}`).value = sourceData.gio;
            document.getElementById(`has_special_${targetDayId}`).checked = sourceData.has_special_event;
            document.getElementById(`chunhiem_${targetDayId}`).value = sourceData.chunhiem;
            document.getElementById(`prepare_after_special_${targetDayId}`).value = sourceData.prepare_after_special;
            document.getElementById(`has_duvao_${targetDayId}`).checked = sourceData.has_duvao_bell;
            document.getElementById(`tiethoc_${targetDayId}`).value = sourceData.tiethoc;
            document.getElementById(`rachoi_${targetDayId}`).value = sourceData.rachoi;
            document.getElementById(`duvaotiet_${targetDayId}`).value = sourceData.duvaotiet;
            document.getElementById(`sotiet_${targetDayId}`).value = sourceData.sotiet;

            toggleSpecialEvent(targetDayId);
            toggleDuVao(targetDayId);
            toggleScheduleActivation(targetDayId);
            updatePreviewTable(targetDayId);
        });
        showNotification('Sao chép thành công! Hãy nhấn "Lưu và gửi cập nhật" để áp dụng.',"success");
    }
    // =======================================================
    // === KẾT THÚC PHẦN NÂNG CẤP ===
    // =======================================================
    
    function initializeTabs() {
        const dayMap = ['cn', 't2', 't3', 't4', 't5', 't6', 't7'];
        const today = new Date();
        const currentDayId = dayMap[today.getDay()];

        selectedDay = currentDayId;

        const todayButton = document.querySelector(`.tablinks-day[onclick*="'${currentDayId}'"]`);
        if (todayButton) {
            document.querySelectorAll('.tablinks-day').forEach(btn => btn.classList.remove('active'));
            todayButton.classList.add('active');
        } else {
            document.querySelector('.tablinks-day').classList.add('active');
        }

        document.querySelector(`.tablinks-session[onclick*="'${selectedSession}'"]`).classList.add('active');
        
        days.forEach(day => {
            contentWrapper.innerHTML += createDayContent(`${day.id}_sang`, day.name, "sang");
            contentWrapper.innerHTML += createDayContent(`${day.id}_chieu`, day.name, "chieu");
        });

        showActiveTab();
    }
    
    // =======================================================
    // [MỚI] SCRIPT CHO LỊCH NGHỈ LỄ
    // =======================================================
    let holidayData = {}; 
    let currentDisplayDate = new Date();

    function generateCalendar(year, month) {
        const grid = document.getElementById('calendar-grid');
        const display = document.getElementById('month-year-display');
        grid.innerHTML = '';

        const today = new Date();
        const firstDayOfMonth = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        display.textContent = `Tháng ${month + 1} ${year}`;
        currentDisplayDate = new Date(year, month, 1);

        ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'].forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'calendar-day-header';
            dayHeader.textContent = day;
            grid.appendChild(dayHeader);
        });

        for (let i = 0; i < firstDayOfMonth.getDay(); i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'calendar-day empty';
            grid.appendChild(emptyCell);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';
            dayCell.textContent = day;
            
            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            dayCell.setAttribute('data-date', dateString);

            if (holidayData[dateString]) {
                dayCell.classList.add('holiday');
            }
            if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                dayCell.classList.add('today');
            }

            dayCell.onclick = () => toggleHoliday(dateString);
            grid.appendChild(dayCell);
        }
    }

    function changeMonth(offset) {
        currentDisplayDate.setMonth(currentDisplayDate.getMonth() + offset);
        generateCalendar(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth());
    }

    // File: index full.html

function toggleHoliday(dateString) {
    function loadHolidayData(data) {
    if (data) {
        holidayData = data; // Cập nhật biến toàn cục với dữ liệu từ thiết bị
        // Vẽ lại giao diện lịch với dữ liệu mới
        generateCalendar(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth());
    }
}
    const cell = document.querySelector(`.calendar-day[data-date="${dateString}"]`);
    if (holidayData[dateString]) {
        delete holidayData[dateString];
        if(cell) cell.classList.remove('holiday');
    } else {
        holidayData[dateString] = true; // Giá trị có thể là true hoặc một object rỗng
        if(cell) cell.classList.add('holiday');
    }

    // [THÊM MỚI] Gửi cập nhật lịch nghỉ lễ ngay lập tức
    if (!client || !client.connected) {
        return showNotification("Chưa kết nối máy chủ! Thay đổi chưa được lưu.", 'error');
    }

    // Tạo một payload chỉ chứa thông tin ngày nghỉ
    const payload = {
        holidays: holidayData 
    };

    // Gửi lên topic SET_DATA_TOPIC, ESP32 sẽ tự biết cách xử lý
    client.publish(SET_DATA_TOPIC, JSON.stringify(payload), { qos: 1, retain: true });
}
    // =======================================================

    window.onload = function() { 
        // [ĐÃ XÓA] loadInterfaceSettings();
        connectToMqtt();
        setInterval(updateLocalClock, 1000);

        // [SỬA LỖI] Tải kịch bản đã lưu từ bộ nhớ trình duyệt ngay khi vào trang
        try {
            const lastScenario = localStorage.getItem('savedScenario');
            if (lastScenario) {
                renderSavedScenario(JSON.parse(lastScenario));
            }
        } catch (e) {
            console.error("Không thể tải kịch bản từ localStorage:", e);
        }
        
        // [ĐÃ XÓA] Các event listener cho OTA, Giao diện, Phát nhạc...

        initializeTabs();
        generateCalendar(currentDisplayDate.getFullYear(), currentDisplayDate.getMonth());
        document.querySelector('.sticky-action-bar').style.display = 'flex';
    };

// === [PHƯƠNG ÁN MỚI] THAY THẾ TOÀN BỘ HÀM renderSavedScenario ===
// File: index 4.html (bên trong thẻ <script>)

// === [GIẢI PHÁP DỨT ĐIỂM] THAY THẾ TOÀN BỘ HÀM NÀY ===
function renderSavedScenario(savedData) {
    const wrapper = document.getElementById('saved-scenario-table-wrapper');
    const priorityDiv = document.getElementById('saved-scenario-priority');
    const placeholder = document.getElementById('saved-scenario-placeholder');
    const daysDisplayContainer = document.getElementById('saved-scenario-days-display');

    // Luôn xóa nội dung cũ của các phần tử có thể thay đổi
    priorityDiv.innerHTML = '';
    daysDisplayContainer.innerHTML = '';

    // Nếu không có dữ liệu, hoặc dữ liệu rỗng:
    if (!savedData || !savedData.scenario || savedData.scenario.length === 0) {
        // Ẩn bảng và hiện placeholder.
        wrapper.style.display = 'none';
        placeholder.style.display = 'block';
        return; // Dừng hàm tại đây
    }

    // Nếu có dữ liệu hợp lệ:
    // Hiện bảng và ẩn placeholder.
    wrapper.style.display = 'block';
    placeholder.style.display = 'none';

    // 1. Hiển thị bảng kịch bản
    let tableHTML = `<table class="scenario-table"><thead><tr><th>STT</th><th>Thời gian</th><th>Số hồi</th></tr></thead><tbody>`;
    savedData.scenario.forEach((event, index) => {
        tableHTML += `<tr><td>${index + 1}</td><td>${event.time}</td><td>${event.bell} hồi</td></tr>`;
    });
    tableHTML += `</tbody></table>`;
    wrapper.innerHTML = tableHTML; // Đặt nội dung cho bảng

    // 2. Hiển thị trạng thái ưu tiên
    if (savedData.priority === 'scenario') {
        priorityDiv.textContent = 'Ưu tiên hiện tại: Kịch Bản';
        priorityDiv.style.color = '#2ecc71';
    } else if (savedData.priority === 'schedule') {
        priorityDiv.textContent = 'Ưu tiên hiện tại: Lịch Học';
        priorityDiv.style.color = '#3498db';
    }

    // 3. Hiển thị các huy hiệu ngày đã lưu
    if (savedData.days && savedData.days.length > 0) {
        const label = document.createElement('span');
        label.className = 'day-badge-label';
        label.textContent = 'Đang áp dụng cho:';
        daysDisplayContainer.appendChild(label);
        
        const dayNameMap = {t2: 'T2', t3: 'T3', t4: 'T4', t5: 'T5', t6: 'T6', t7: 'T7', cn: 'CN'};
        
        savedData.days.forEach(dayId => {
            const badge = document.createElement('span');
            badge.className = 'day-badge';
            badge.textContent = dayNameMap[dayId] || dayId.toUpperCase();
            daysDisplayContainer.appendChild(badge);
        });
    }
}
  </script>
  
<script>
// This is a remnant script block from the original file. It is being kept for 100% file integrity,
// but the main logic is handled by the larger script block above. The functions here are overridden.
function addScenario() {
  const startTime = document.getElementById("scenario-start-time").value;
  const intervals = document.getElementById("scenario-intervals").value;
  const bells = document.getElementById("scenario-bells").value;

  if (!startTime || !bells) {
    showNotification("Vui lòng nhập đủ thông tin!", "error");
    return;
  }

  const scenario = { startTime, intervals, bells };

  if (typeof client !== 'undefined' && client && client.connected) {
    client.publish("device/command/saveScenario", JSON.stringify(scenario));
    showNotification("Đã gửi kịch bản lên thiết bị", "success");
  } else {
    showNotification("Mất kết nối MQTT", "error");
  }

  const tableHtml = `
    <table class="scenario-table">
      <thead>
        <tr><th>STT</th><th>Thời gian</th><th>Số hồi</th></tr>
      </thead>
      <tbody>
        <tr>
          <td>1</td>
          <td>${startTime}${intervals ? " +" + intervals : ""}</td>
          <td>${bells} hồi</td>
        </tr>
      </tbody>
    </table>
  `;
  document.getElementById("saved-scenario-table-wrapper").innerHTML = tableHtml;
}

function showNotification(msg, type="info") {
  const area = document.getElementById("notification-area");
  if (!area) return;
  const div = document.createElement("div");
  div.className = `notification ${type}`;
  div.textContent = msg;
  area.appendChild(div);
  setTimeout(() => div.classList.add("show"), 50);
  setTimeout(() => {
    div.classList.remove("show");
    if (div.parentNode) div.parentNode.removeChild(div);
  }, 3000);
}
</script>

</body>
</html>
